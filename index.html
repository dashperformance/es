<!DOCTYPE html><html lang="pt-BR"><head> <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>Dashboard de Performance</title> <script src="https://cdn.tailwindcss.com"></script> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script> <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> <style> :root{ --c1:#3D405B; --c2:#81B29A; --c3:#F2CC8F; --c4:#E07A5F; --bg:#F7F9FC; --card-bg: #FFFFFF; --text-primary: #1f2937; --text-secondary: #3D405B; --text-muted: #6B7280; --border-color: #E5E7EB; } .dark-mode:root { --c1:#4a4e69; --c2:#6a994e; --c3:#f2cc8f; --c4:#e07a5f; --bg:#121212; --card-bg: #1e1e1e; --text-primary: #e0e0e0; --text-secondary: #f2f2f2; --text-muted: #9ca3af; --border-color: #374151; }
html { scroll-behavior: smooth; } *{box-sizing:border-box} body{ font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif; background:var(--bg); color:var(--text-primary); transition: background-color 0.3s, color 0.3s; } .card{ background: var(--card-bg); border-radius: 1rem; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s, border-color 0.3s; } .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07); } .btn{ border-radius:.75rem; font-weight:600; transition: all 0.2s ease; padding-top: 0.625rem; padding-bottom: 0.625rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1); } .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1); filter: brightness(1.05); } .btn-primary{background:var(--c2);color:#fff} .btn-primary:hover{filter: brightness(0.9);} .btn-secondary{background:var(--c3);color:var(--c1)} .btn-secondary:hover{filter: brightness(0.9);} .btn-danger{background:var(--c4);color:#fff} .btn-danger:hover{filter: brightness(0.9);}
input, select, textarea { background-color: var(--card-bg); color: var(--text-primary); border-color: var(--border-color); } input::placeholder { color: var(--text-muted); } input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], select { border-radius: 0.75rem; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s; } input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus { border-color: var(--c2); box-shadow: 0 0 0 3px rgba(129, 178, 154, 0.3); outline: none; }
.nav-link{ position: relative; border-bottom:2px solid transparent; transition:all .25s ease; padding-bottom: 4px; color: var(--text-muted); } .nav-link:hover, .nav-link.active { color: var(--text-primary); } .nav-link:after { content: ''; position: absolute; width: 0; height: 2px; bottom: -2px; left: 50%; background-color: var(--c2); transition: all 0.3s ease; } .nav-link:hover:after { width: 100%; left: 0; } .nav-link.active{ border-bottom-color:var(--c2); font-weight:600; } .nav-link.active:after { width: 0; }
.chart-container{position:relative;width:100%;height:320px;max-height:420px} @media (min-width: 768px){.chart-container{height:360px}} .progress-bar{background:var(--border-color);border-radius:9999px;overflow:hidden;height:.75rem} .progress-fill{height:100%;background:var(--c2);transition:width .5s} .mood-square-wrapper { display: flex; flex-direction: column; align-items: center; text-align: center; } .mood-square{width:42px;height:42px;border-radius:.5rem;border:2px solid transparent;opacity:.7;transition:.2s; cursor: pointer;} .mood-square.selected{opacity:1;outline:2px solid var(--text-secondary);outline-offset:2px} .mood-red{background:#ef4444} .mood-yellow{background:#f59e0b} .mood-green{background:#10b981} .cycle-dot{width:10px;height:10px;border-radius:9999px;background:var(--border-color)} .cycle-dot.done{background:var(--c2)} .cycle-dot.active{background:#3b82f6} .pill{font-size:.75rem;background:var(--card-bg);color:var(--text-muted);border:1px solid var(--border-color);border-radius:9999px;padding:.375rem .75rem; transition: all 0.2s ease; cursor: pointer;} .pill:hover { background-color: var(--border-color); } .pill.active { background-color: var(--c1); color: white; font-weight: 600; } .kpi h3{color:var(--text-muted);font-size:.85rem; text-transform: uppercase; letter-spacing: 0.5px;} .kpi p{font-weight:700;font-size:1.75rem; color: var(--text-secondary);} .kpi .record-date { font-size: 0.75rem; font-weight: 400; color: var(--text-muted); margin-top: -4px; } .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0} #session-modal-backdrop.hidden, #notification-modal-backdrop.hidden { display: none; } #session-modal-panel.hidden, #notification-modal-panel.hidden { transform: translateY(100%); opacity: 0; } .heatmap-level-0 { background-color: #37415140; } .dark-mode .heatmap-level-0 { background-color: #374151; } .heatmap-level-1 { background-color: #cce2d4; } .heatmap-level-2 { background-color: #a3cdb4; } .heatmap-level-3 { background-color: var(--c2); } .heatmap-level-4 { background-color: #5d8e76; } .performance-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background-color: var(--border-color); } .bar-correct { background-color: #10b981; } .bar-incorrect { background-color: #ef4444; } .chart-toggle-label { cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background-color 0.2s; } .chart-toggle-input:checked + .chart-toggle-label { background-color: var(--c1); color: white; } .day-tracker-dot { width: 24px; height: 24px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; background-color: var(--border-color); color: var(--text-muted); } .day-tracker-dot.done { background-color: var(--c2); color: white; } .day-tracker-dot.missed { background-color: #fee2e2; color: #b91c1c; } .dark-mode .day-tracker-dot.missed { background-color: #450a0a; color: #fecaca; } .day-tracker-dot.today { outline: 2px solid #3b82f6; outline-offset: 2px; } .flow-slider-container { position: relative; } .flow-slider-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); padding: 0 5px; } .subtopics-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; } .timer-pause-display { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; height: 1.5rem; /* prevent layout shift */ } .collapse-toggle-btn { transition: transform 0.3s; } .collapsible-content.hidden { display: none; } #pomodoro-timer-display, #stopwatch-display { color: var(--c1); } .dark-mode #pomodoro-timer-display, .dark-mode #stopwatch-display { color: var(--text-primary); }
.drag-handle { cursor: move; touch-action: none; } .dragging { opacity: 0.5; background: var(--border-color); }
.task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--bg); transition: all 0.2s ease; } .task-item.selected { border-color: var(--c2); box-shadow: 0 0 0 2px rgba(129, 178, 154, 0.3); } .task-item .task-name { flex-grow: 1; cursor: pointer; } .task-item.completed .task-name { text-decoration: line-through; color: var(--text-muted); } .task-item-pomodoros { font-size: 0.875rem; color: var(--text-muted); font-weight: 500; } .task-complete-btn { width: 24px; height: 24px; border-radius: 9999px; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; } .task-complete-btn:hover { border-color: var(--c2); } .task-item.completed .task-complete-btn { background-color: var(--c2); border-color: var(--c2); color: white; } .task-actions button { color: var(--text-muted); padding: 4px; border-radius: 4px; } .task-actions button:hover { background-color: var(--border-color); color: var(--text-primary); } .youtube-music-item.active { background-color: var(--c2) !important; color: white !important; } .youtube-music-item.active span { color: white !important; }
/* Estilos específicos para Lei Seca */
.lei-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(38px, 1fr)); gap: 8px; } .artigo-square { position: relative; display: flex; justify-content: center; align-items: center; width: 100%; aspect-ratio: 1 / 1; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); background-color: var(--bg); } .artigo-square:hover { transform: scale(1.08); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; } .tooltip { position: relative; } .tooltip .tooltip-text { visibility: hidden; width: 140px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -70px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; font-weight: 500; } .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; } .category-content.collapsed { display: none; } .control-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:0.75rem;overflow:hidden;font-size:0.9rem;background:var(--card-bg);} .control-table thead th{background:var(--bg);text-align:left;padding:0.75rem 1rem;font-weight:600;color:var(--text-secondary);border-bottom:1px solid var(--border-color);} .control-table tbody td{padding:0.65rem 1rem;border-bottom:1px solid var(--border-color);color:var(--text-primary);vertical-align:middle;} .control-table tbody tr:nth-child(even){background:rgba(129,178,154,0.08);} .control-table tbody tr:last-child td{border-bottom:none;} .control-editable{cursor:text;} .control-status-badge{display:inline-flex;align-items:center;gap:0.4rem;padding:0.35rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600;transition:all 0.2s ease;background:rgba(107,114,128,0.15);color:var(--text-secondary);} .control-status-not_started{background:rgba(239,68,68,0.15);color:#b91c1c;} .control-status-in_progress{background:rgba(251,191,36,0.22);color:#b45309;} .control-status-completed{background:rgba(16,185,129,0.2);color:#047857;} .control-progress{position:relative;height:8px;border-radius:999px;background:var(--border-color);overflow:hidden;} .control-progress-bar{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--c2),#3b82f6);transition:width 0.3s ease;} .control-checkbox{width:1.1rem;height:1.1rem;border-radius:0.35rem;border:1px solid var(--border-color);} .edital-table tbody tr td:first-child{font-weight:600;width:220px;} .edital-indent-1 td:first-child{padding-left:1.5rem;} .edital-indent-2 td:first-child{padding-left:3rem;} .edital-indent-3 td:first-child{padding-left:4.5rem;} .schedule-grid{display:grid;grid-template-columns:120px repeat(7,minmax(160px,1fr));border:1px solid var(--border-color);border-radius:0.75rem;overflow:hidden;} .schedule-grid-row{display:contents;} .schedule-grid-header{background:var(--bg);font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-secondary);} .schedule-grid-cell{padding:0.65rem 0.75rem;border-bottom:1px solid var(--border-color);border-right:1px solid var(--border-color);min-height:52px;position:relative;} .schedule-grid-cell:last-child{border-right:none;} .schedule-grid-row:last-child .schedule-grid-cell{border-bottom:none;} .schedule-activity{display:flex;flex-direction:column;gap:0.25rem;font-size:0.8rem;border-radius:0.5rem;padding:0.35rem 0.5rem;background:rgba(129,178,154,0.18);color:var(--text-secondary);} .schedule-activity-header{display:flex;align-items:center;justify-content:space-between;font-weight:600;} .schedule-add-btn{display:inline-flex;align-items:center;gap:0.25rem;font-size:0.75rem;color:var(--text-muted);}</style><style>.organization-discipline-item{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.75rem 1rem;border-radius:.75rem;border:1px solid var(--border-color);background:var(--card-bg);transition:all .2s ease;cursor:pointer}.organization-discipline-item:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.05)}.organization-discipline-item.active{border-color:var(--c2);box-shadow:0 0 0 2px rgba(129,178,154,.25)}.organization-discipline-count{font-size:.75rem;color:var(--text-muted)}.organization-progress-bar{width:48px;height:220px;border-radius:9999px;background:var(--border-color);overflow:hidden;display:flex;flex-direction:column-reverse}.organization-progress-segment{width:100%;transition:height .3s ease}.organization-status-dot{width:10px;height:10px;border-radius:9999px;display:inline-block}.organization-upcoming-item{border:1px solid var(--border-color);border-radius:.75rem;padding:.75rem 1rem;background:var(--bg)}.organization-upcoming-item.overdue{border-color:var(--c4)}.organization-status-badge{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .55rem;border-radius:9999px;font-size:.75rem;font-weight:600;background:rgba(129,178,154,.15);color:var(--text-secondary)}.organization-topic-card{border:1px solid var(--border-color);border-radius:.75rem;padding:1rem;background:var(--card-bg);transition:border-color .2s ease,box-shadow .2s ease}.organization-topic-card:hover{border-color:var(--c2);box-shadow:0 8px 18px rgba(0,0,0,.05)}.organization-topic-card .field-label{font-size:.75rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em}.organization-next-review{font-size:.875rem;font-weight:600}.organization-next-review.overdue{color:var(--c4)}.organization-next-review.soon{color:#f59e0b}</style></head><body class="antialiased">
<div id="app" class="min-h-screen flex flex-col"> <header class="bg-[var(--card-bg)]/80 backdrop-blur sticky top-0 z-20 shadow-sm border-b border-[var(--border-color)]"> <nav class="container mx-auto px-4 sm:px-6 lg:px-8"> <div class="flex items-center justify-between h-16"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-xl bg-[color:var(--c2)] flex items-center justify-center"> <i class="fa-solid fa-chart-line text-white"></i> </div> <h1 class="text-2xl font-bold tracking-tight text-[var(--text-secondary)]">Dashboard de performance</h1> </div> <div id="main-nav" class="hidden md:flex items-center gap-6"> <a href="#" data-view="dashboard" class="nav-link text-sm">Dashboard</a> <a href="#" data-view="foco" class="nav-link text-sm">Foco e registro</a> <a href="#" data-view="organizacao" class="nav-link text-sm">Organização</a> <a href="#" data-view="controle" class="nav-link text-sm">Controle</a> <a href="#" data-view="lei-seca" class="nav-link text-sm">Lei Seca</a> <a href="#" data-view="quadro-horario" class="nav-link text-sm">Quadro horário</a> <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"> <i class="fa-solid fa-moon"></i> </button> <button id="logout-btn" class="btn btn-secondary py-1 px-3 text-sm">Sair</button> </div> <button id="mobile-menu-button" class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:bg-gray-100"> <span class="sr-only">abrir menu</span> <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/> </svg> </button> </div> <div id="mobile-menu" class="md:hidden hidden pb-3"> <a href="#" data-view="dashboard" class="block nav-link px-3 py-2 text-base">Dashboard</a> <a href="#" data-view="foco" class="block nav-link px-3 py-2 text-base">Foco e registro</a> <a href="#" data-view="organizacao" class="block nav-link px-3 py-2 text-base">Organização</a> <a href="#" data-view="controle" class="block nav-link px-3 py-2 text-base">Controle</a> <a href="#" data-view="lei-seca" class="block nav-link px-3 py-2 text-base">Lei Seca</a> <a href="#" data-view="quadro-horario" class="block nav-link px-3 py-2 text-base">Quadro horário</a> <button id="dark-mode-toggle-mobile" class="mt-2 w-full btn btn-secondary py-2"> <i class="fa-solid fa-moon mr-2"></i>Modo Escuro </button> <button id="logout-btn-mobile" class="mt-2 w-full btn btn-secondary py-2">Sair</button> </div> </nav> </header>
<main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8"> <div id="auth-view" class="hidden"> <div class="max-w-md mx-auto mt-10"> <div class="card p-8"> <form id="login-form"> <h2 class="text-2xl font-bold text-center mb-6">Entrar</h2> <div class="space-y-4"> <div> <label for="login-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label> <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <div> <label for="login-password" class="block text-sm font-medium text-[var(--text-muted)]">Senha</label> <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <div class="flex items-center justify-end"> <div class="text-sm"> <a href="#" id="forgot-password-link" class="font-medium text-[color:var(--c2)] hover:underline">Esqueceu a senha?</a> </div> </div> <p id="login-error" class="text-sm text-red-600 h-5"></p> <div> <button type="submit" class="w-full btn btn-primary py-2">Entrar</button> </div> </div> <p class="mt-4 text-center text-sm"> Não tem uma conta? <a href="#" id="show-register" class="font-medium text-[color:var(--c2)] hover:underline">Cadastre-se</a> </p> </form>
<form id="register-form" class="hidden"> <h2 class="text-2xl font-bold text-center mb-6">Criar Conta</h2> <div class="space-y-4"> <div> <label for="register-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label> <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <div> <label for="register-password" class="block text-sm font-medium text-[var(--text-muted)]">Senha (mínimo 6 caracteres)</label> <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <p id="register-error" class="text-sm text-red-600 h-5"></p> <div> <button type="submit" class="w-full btn btn-primary py-2">Criar conta</button> </div> </div> <p class="mt-4 text-center text-sm"> Já tem uma conta? <a href="#" id="show-login" class="font-medium text-[color:var(--c2)] hover:underline">Entrar</a> </p> </form> </div> </div> </div>
<div id="loading-view" class="text-center py-20"> <p class="text-lg font-semibold text-gray-600">Conectando...</p> </div>
<div id="main-content" class="hidden"> <section id="dashboard-view" class="space-y-8"> <div> <div class="card p-4 sm:p-6"> <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end"> <div class="md:col-span-1 lg:col-span-2"> <label for="concurso-nome" class="block text-sm font-medium text-[var(--text-muted)]">Concurso</label> <input type="text" id="concurso-nome" placeholder="Ex: Jurídicos (Geral)" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="concurso-cargo" class="block text-sm font-medium text-[var(--text-muted)]">Cargo</label> <input type="text" id="concurso-cargo" placeholder="Ex: Em aberto" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="concurso-inicio" class="block text-sm font-medium text-[var(--text-muted)]">Início dos estudos</label> <input type="date" id="concurso-inicio" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="concurso-prova" class="block text-sm font-medium text-[var(--text-muted)]">Data da prova</label> <input type="date" id="concurso-prova" class="mt-1 block w-full shadow-sm"> </div> </div> <div id="concurso-countdown" class="text-center mt-4 font-bold text-lg text-[color:var(--c1)]"></div> </div> </div>

<div> <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"> <div> <h2 class="text-xl font-bold text-[var(--text-secondary)]">Visão geral</h2> <p id="dashboard-period-display" class="text-sm text-[var(--text-muted)]">Exibindo dados para o período selecionado.</p> </div> <div class="flex items-center gap-2 flex-wrap"> <button id="import-backup-btn" class="btn btn-secondary py-2 px-3"><i class="fa-solid fa-upload mr-2"></i>Importar</button> <button id="export-backup-btn" class="btn btn-secondary py-2 px-3"><i class="fa-solid fa-download mr-2"></i>Backup</button> <button id="export-pdf-btn" class="btn btn-secondary py-2 px-3"><i class="fa-solid fa-file-pdf mr-2"></i>Exportar PDF</button> <button id="save-all-btn" class="btn btn-primary py-2 px-3"><i class="fa-solid fa-save mr-2"></i>Salvar na Nuvem</button> </div> </div> <div class="card p-4 sm:p-6 mt-4"> <h3 class="text-lg font-semibold text-center mb-4 text-[var(--text-secondary)]">Filtros de análise</h3> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"> <div> <label for="filter-subject" class="block text-sm font-medium text-[var(--text-muted)]">Disciplina</label> <select id="filter-subject" class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="filter-activity" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de atividade</label> <select id="filter-activity" class="mt-1 block w-full shadow-sm"></select> </div> <div class="lg:col-span-2"> <label class="block text-sm font-medium text-[var(--text-muted)]">Período</label> <div class="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-4"> <input type="date" id="filter-start-date" class="block w-full shadow-sm"> <input type="date" id="filter-end-date" class="block w-full shadow-sm"> </div> <div id="period-pills" class="mt-2 flex flex-wrap gap-2"> <button data-period="today" class="pill">Hoje</button> <button data-period="week" class="pill">Esta semana</button> <button data-period="month" class="pill">Este mês</button> <button data-period="all" class="pill">Todo o período</button> </div> </div> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Indicadores</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="card p-4 kpi text-center"> <h3>Horas no período</h3> <p id="total-hours">00h00m</p> </div> <div class="card p-4 kpi text-center"> <h3>Média de acertos</h3> <p id="avg-accuracy">0%</p> </div> <div class="card p-4 kpi text-center"> <h3>Sessão média</h3> <p id="avg-session-duration">0h00m</p> </div> <div class="card p-4 kpi text-center"> <h3>% Horas focadas</h3> <p id="deep-work-ratio">0%</p> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Metas</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-1 lg:grid-cols-3 gap-6 items-stretch"> <div class="card p-4 sm:p-6 lg:col-span-2 flex flex-col"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Constância de estudos</h3> <div id="consistency-tracker" class="mt-4 flex-grow flex flex-col items-center justify-center w-full overflow-x-auto"> </div> </div> <div class="card p-4 sm:p-6 flex flex-col"> <h3 id="weekly-goals-title" class="text-lg font-semibold text-center text-[var(--text-secondary)]">Metas da semana</h3> <div id="weekly-days-tracker" class="flex justify-around items-center my-4"></div> <div id="goals-display-view" class="space-y-3 mt-2 flex-grow flex flex-col justify-center"> </div> <div id="goals-edit-view" class="hidden mt-4 space-y-3"> <div> <label for="goal-hours-input" class="block text-sm text-[var(--text-muted)]">Meta de horas</label> <input type="number" id="goal-hours-input" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="goal-questions-input" class="block text-sm text-[var(--text-muted)]">Meta de questões</label> <input type="number" id="goal-questions-input" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="goal-accuracy-input" class="block text-sm text-[var(--text-muted)]">Meta de acertos (%)</label> <input type="number" id="goal-accuracy-input" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="goal-days-input" class="block text-sm text-[var(--text-muted)]">Meta de dias/semana</label> <input type="number" id="goal-days-input" class="mt-1 block w-full shadow-sm"> </div> <button id="save-goals-btn" class="btn btn-primary py-2 px-3 w-full">Salvar Metas</button> </div> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Análise de desempenho</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-1 lg:grid-cols-2 gap-6"> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]" id="hours-by-subject-title">Distribuição de horas por disciplina</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="hoursBySubjectChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]" id="performance-by-subject-title">Desempenho médio por disciplina</h3> <div class="chart-container"> <canvas id="performanceBySubjectChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Porcentagem de foco</h3> <p class="text-sm text-center text-[var(--text-muted)]">Tempo de estudo efetivo vs. pausas no período</p> <div class="chart-container mx-auto max-w-sm"> <canvas id="focusPercentageChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Distribuição de tempo por atividade</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="activityDistributionChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6 lg:col-span-2"> <h3 class="text-lg font-semibold text-center mb-4 text-[var(--text-secondary)]">Forças e fraquezas por disciplina</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"> <div class="chart-container" style="height: 400px;"> <canvas id="strengthsWeaknessesChart"></canvas> </div> <div id="strengths-weaknesses-details" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"> </div> </div> </div> <div class="card p-4 sm:p-6 lg:col-span-2"> <div class="flex flex-col sm:flex-row justify-center items-center mb-4 gap-4"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução das questões</h3> <div id="questions-evolution-toggle" class="flex items-center text-sm p-1 bg-[var(--bg)] rounded-lg"> <input type="radio" name="questions-view" id="q-view-relative" value="relative" class="sr-only chart-toggle-input" checked> <label for="q-view-relative" class="chart-toggle-label">Desempenho relativo (%)</label> <input type="radio" name="questions-view" id="q-view-absolute" value="absolute" class="sr-only chart-toggle-input"> <label for="q-view-absolute" class="chart-toggle-label">Número de resoluções</label> </div> </div> <div class="overflow-x-auto"> <div class="chart-container" style="height: 360px; min-width: 700px;"> <canvas id="questionsEvolutionChart"></canvas> </div> </div> </div>
<div class="card p-4 sm:p-6 lg:col-span-2"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução das horas de estudo (diário)</h3> <p class="text-sm text-[var(--text-muted)] text-center">Média diária no período: <span id="average-time-display" class="font-semibold">00h00m</span></p> <div class="overflow-x-auto"> <div class="chart-container" style="height: 360px; min-width: 700px;"> <canvas id="studyEvolutionChart"></canvas> </div> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução das horas de estudo (mensal)</h3> <div class="overflow-x-auto"> <div class="chart-container" style="min-width: 500px;"> <canvas id="monthlyStudyEvolutionChart"></canvas> </div> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Rendimento por horário do dia</h3> <div class="chart-container"> <canvas id="performanceByTimeOfDayChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Produtividade por dia da semana</h3> <div class="chart-container"> <canvas id="productivityByDayChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Humor vs. desempenho</h3> <div class="chart-container"> <canvas id="moodVsPerformanceChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Contagem de sessões por humor</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="moodCountChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Contagem de sessões por flow</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="flowCountChart"></canvas> </div> </div> <div class="card p-4 sm:p-6 hidden"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Flow vs. desempenho</h3> <div class="chart-container"> <canvas id="flowVsPerformanceChart"></canvas> </div> </div> <div class="card p-4 sm:p-6 hidden"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Desempenho por Atividade</h3> <p class="text-sm text-center text-[var(--text-muted)]">Média de acertos por tipo de atividade</p> <div class="chart-container"> <canvas id="performanceByActivityChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6 lg:col-span-2"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução semanal (últimas 4 semanas)</h3> <div id="weekly-evolution-table" class="overflow-x-auto mt-4"></div> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Recordes</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="card p-4 kpi text-center"> <h3>Horas (dia)</h3> <p id="record-hours-day">00h00m</p> </div> <div class="card p-4 kpi text-center"> <h3>Acertos (%)</h3> <p id="record-accuracy">0%</p> </div> <div class="card p-4 kpi text-center"> <h3>Maior sequência</h3> <p id="record-streak">0 dias</p> </div> <div class="card p-4 kpi text-center"> <h3>Horas (mês)</h3> <p id="record-hours-month">00h00m</p> </div> </div> </div> <div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center mb-4 text-[var(--text-secondary)] flex justify-center items-center gap-4"> <span>Insights rápidos</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h3> <div id="insights-container" class="collapsible-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm text-[var(--text-muted)]"> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Histórico detalhado do período</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content card p-4 sm:p-6"> <div class="flex justify-end mb-4"> <input type="text" id="log-search-input" placeholder="Buscar por disciplina ou assunto..." class="block w-full md:w-1-3 shadow-sm"> </div> <div id="detailed-log-table-container" class="overflow-x-auto max-h-56"> </div> </div> </div>
<div id="backup-section"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-bold text-[var(--text-secondary)] flex justify-between items-center w-full"> <span>Backups salvos (Local)</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <button id="create-backup-now-btn" class="btn btn-secondary py-2 px-3 whitespace-nowrap ml-4"><i class="fa-solid fa-save mr-2"></i>Salvar backup local</button> </div> <div class="collapsible-content card p-4 sm:p-6"> <p class="text-sm text-[var(--text-muted)] mb-4">Seus backups são salvos localmente no navegador. Você pode baixá-los a qualquer momento. Um backup automático é criado diariamente.</p> <div id="backup-list" class="space-y-2"> </div> </div> </div> </section>
<section id="foco-view" class="hidden space-y-8"> <div class="max-w-7xl mx-auto space-y-8"> <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<div class="card p-6"> <h3 class="text-lg font-semibold text-center mb-6 text-[var(--text-secondary)]">Timer pomodoro</h3> <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6"> <div> <label for="pomodoro-subject" class="block text-sm font-medium text-[var(--text-muted)]">Matéria</label> <select id="pomodoro-subject" class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="pomodoro-subtopic" class="block text-sm font-medium text-[var(--text-muted)]">Assunto (opcional)</label> <select id="pomodoro-subtopic" class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="pomodoro-cycles" class="block text-sm font-medium text-[var(--text-muted)]">Ciclos (p/ pausa longa)</label> <input type="number" id="pomodoro-cycles" value="4" min="1" class="mt-1 block w-full shadow-sm"> </div> </div>
<div class="flex flex-col items-center gap-2"> <div id="pomodoro-timer-display" class="text-8xl font-black tracking-tighter">25:00</div> <div id="pomodoro-status" class="text-lg font-medium text-[var(--text-muted)]">Pronto para focar?</div> <div id="pomodoro-pause-display" class="timer-pause-display"></div> <div id="pomodoro-end-time" class="text-sm text-gray-400 h-5"></div> <div class="flex gap-1.5 items-center mt-2" id="pomodoro-cycle-dots"></div> <div id="current-task-display" class="mt-4 text-center text-lg font-semibold text-[var(--text-muted)] h-7"> </div> </div>
<div class="mt-8 flex flex-wrap justify-center items-center gap-4"> <button id="pomodoro-start-pause" class="btn btn-primary py-2 px-6">Iniciar</button> <button id="pomodoro-skip" class="btn btn-secondary py-2 px-6">Pular</button> <button id="pomodoro-reset" class="btn btn-secondary py-2 px-6">Resetar</button> <button id="pomodoro-open-mini" class="btn btn-secondary py-2 px-4" title="Abrir timer flutuante"><i class="fa-solid fa-window-restore"></i></button> </div>
<div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mt-8 pt-6 border-t border-[var(--border-color)]"> <div> <label for="pomodoro-work-duration" class="block text-sm font-medium text-[var(--text-muted)]">Foco (min)</label> <input type="number" id="pomodoro-work-duration" value="25" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-short-break-duration" class="block text-sm font-medium text-[var(--text-muted)]">Pausa curta</label> <input type="number" id="pomodoro-short-break-duration" value="5" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-long-break-duration" class="block text-sm font-medium text-[var(--text-muted)]">Pausa longa</label> <input type="number" id="pomodoro-long-break-duration" value="15" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-alert-time" class="block text-sm font-medium text-[var(--text-muted)]">Alerta (min)</label> <input type="number" id="pomodoro-alert-time" placeholder="Opcional" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-sound-select" class="block text-sm font-medium text-[var(--text-muted)]">Som do alerta</label> <select id="pomodoro-sound-select" class="mt-1 block w-full shadow-sm"> <option value="notification">Notificação</option> <option value="chime">Sino</option> <option value="simple">Simples</option> </select> </div> </div> <div class="mt-4 flex items-center justify-center gap-2"> <input id="pomodoro-auto-start" type="checkbox" class="h-4 w-4 text-[color:var(--c2)] rounded border-[var(--border-color)] focus:ring-[color:var(--c2)]"> <label for="pomodoro-auto-start" class="text-sm">Iniciar próximo ciclo automaticamente</label> </div> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Tarefas do Dia</h3> <form id="add-task-form" class="mt-4 flex items-center gap-3"> <input type="text" id="new-task-input" placeholder="Adicionar uma tarefa..." class="flex-grow shadow-sm"> <input type="number" id="new-task-pomodoros" min="1" value="1" class="w-20 text-center shadow-sm" title="Pomodoros estimados"> <button type="submit" class="btn btn-primary py-2 px-3 whitespace-nowrap">Adicionar</button> </form> <div id="task-list-container" class="mt-4 space-y-2 max-h-96 overflow-y-auto"> </div> <div class="mt-4 pt-4 border-t border-[var(--border-color)] flex justify-end gap-2 text-sm"> <button id="clear-completed-tasks-btn" class="btn btn-secondary py-1 px-3"><i class="fa-solid fa-check-double mr-2"></i>Limpar concluídas</button> <button id="clear-all-tasks-btn" class="btn btn-danger py-1 px-3"><i class="fa-solid fa-trash mr-2"></i>Limpar tudo</button> </div> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Cronômetro contínuo</h3> <p class="text-sm text-[var(--text-muted)] text-center">Use para sessões de estudo com tempo livre.</p> <div class="text-center my-6"> <div id="stopwatch-display" class="text-6xl md:text-7xl font-black tracking-tighter">00:00:00</div> <div id="stopwatch-pause-display" class="timer-pause-display"></div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-w-lg mx-auto mt-4"> <div> <label for="stopwatch-subject" class="sr-only">Matéria do cronômetro</label> <select id="stopwatch-subject" class="block w-full shadow-sm"></select> </div> <div> <label for="stopwatch-subtopic" class="sr-only">Assunto do cronômetro</label> <select id="stopwatch-subtopic" class="block w-full shadow-sm"></select> </div> </div> </div>
<div class="max-w-md mx-auto my-4 grid grid-cols-1 sm:grid-cols-2 gap-4 items-end"> <div> <label class="block text-sm font-medium text-[var(--text-muted)]">Alerta (opcional)</label> <div class="flex items-center gap-2 mt-1"> <input type="number" id="stopwatch-alert-hours" min="0" placeholder="h" class="block w-full shadow-sm text-center"> <input type="number" id="stopwatch-alert-minutes" min="0" max="59" placeholder="m" class="block w-full shadow-sm text-center"> </div> </div> <div> <label for="stopwatch-sound-select" class="block text-sm font-medium text-[var(--text-muted)]">Som do alerta</label> <select id="stopwatch-sound-select" class="mt-1 block w-full shadow-sm"> <option value="notification">Notificação</option> <option value="chime">Sino</option> <option value="simple">Simples</option> </select> </div> </div> <div class="mt-8 flex flex-wrap justify-center gap-4"> <button id="stopwatch-start-pause" class="btn btn-primary py-2 px-5">Iniciar</button> <button id="stopwatch-log" class="btn btn-secondary py-2 px-5">Registrar</button> <button id="stopwatch-reset" class="btn btn-secondary py-2 px-5">Resetar</button> <button id="stopwatch-open-mini" class="btn btn-secondary py-2 px-3" title="Abrir timer flutuante"><i class="fa-solid fa-window-restore"></i></button> </div> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Sons de Fundo</h3> <div class="mt-4 pt-4 border-t border-[var(--border-color)]"> <div class="flex items-center gap-4 mb-4"> <i class="fa-solid fa-volume-low text-lg text-[var(--text-muted)]"></i> <input type="range" id="background-sound-volume" min="-40" max="0" value="-20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"> <i class="fa-solid fa-volume-high text-lg text-[var(--text-muted)]"></i> </div> <div id="background-sound-controls" class="flex justify-center flex-wrap gap-3"> <button class="sound-btn btn btn-secondary active" data-sound="off"><i class="fa-solid fa-stop mr-2"></i>Silêncio</button> <button class="sound-btn btn btn-secondary" data-sound="white"><i class="fa-solid fa-wave-square mr-2"></i>Ruído Branco</button> <button class="sound-btn btn btn-secondary" data-sound="brown"><i class="fa-solid fa-wave-square mr-2"></i>Ruído Marrom</button> </div> </div> <div class="mt-4 pt-4 border-t border-[var(--border-color)]"> <div class="flex justify-between items-center"> <h4 class="text-md font-semibold text-center text-[var(--text-secondary)]">Músicas do YouTube</h4> <button id="skip-youtube-btn" class="btn btn-secondary p-2 text-xs"><i class="fa-solid fa-forward-step"></i></button> </div> <div class="mt-2 flex items-center gap-2"> <input type="text" id="youtube-url-input" placeholder="Cole a URL do YouTube aqui" class="flex-grow shadow-sm text-sm"> <button id="add-youtube-url-btn" class="btn btn-secondary py-2 px-3 text-sm">Add</button> </div> <div id="youtube-music-list" class="mt-2 space-y-1 text-sm max-h-24 overflow-y-auto"></div> </div> </div> </div>
<div class="space-y-8 mt-8"> <div class="card p-6" id="registration-card"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Registrar sessão manual</h3> <p class="text-sm text-[var(--text-muted)] text-center">Preencha os detalhes da sua sessão de estudo.</p> <form id="study-form" class="mt-6 space-y-6"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="date" class="block text-sm font-medium text-[var(--text-muted)]">Data</label> <input type="date" id="date" required class="mt-1 block w-full shadow-sm"> </div> <div> <label for="time-of-day" class="block text-sm font-medium text-[var(--text-muted)]">Período do dia</label> <select id="time-of-day" class="mt-1 block w-full shadow-sm"> <option value="madrugada">Madrugada (00-06)</option> <option value="manha">Manhã (06-12)</option> <option value="tarde">Tarde (12-18)</option> <option value="noite">Noite (18-00)</option> </select> </div> </div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="subject" class="block text-sm font-medium text-[var(--text-muted)]">Disciplina</label> <select id="subject" required class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="subtopic" class="block text-sm font-medium text-[var(--text-muted)]">Assunto (opcional)</label> <select id="subtopic" class="mt-1 block w-full shadow-sm"></select> </div> </div>
<div> <label class="block text-sm font-medium text-[var(--text-muted)]">Duração</label> <div class="flex items-center gap-2 mt-1"> <input type="number" id="manual-duration-hours" min="0" placeholder="0" class="block w-full shadow-sm text-center"> <span class="text-sm text-gray-500">horas</span> <input type="number" id="manual-duration-minutes" min="0" max="59" placeholder="0" class="block w-full shadow-sm text-center"> <span class="text-sm text-gray-500">min</span> </div> <div class="mt-2 flex flex-wrap justify-center gap-2 text-xs"> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="5">5m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="10">10m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="15">15m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="20">20m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="30">30m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="45">45m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="1">1h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="2">2h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="3">3h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="4">4h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="5">5h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="6">6h</button> </div> </div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="activity-type" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de atividade</label> <select id="activity-type" required class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="session-type" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de sessão</label> <select id="session-type" required class="mt-1 block w-full shadow-sm"> <option value="focada">Focada (deep work)</option> <option value="superficial">Superficial</option> </select> </div> </div>
<div id="questions-section" class="hidden space-y-4"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="questions-total" class="block text-sm font-medium text-[var(--text-muted)]">Nº de questões</label> <input type="number" id="questions-total" min="0" class="question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> <div> <label for="questions-correct" class="block text-sm font-medium text-[var(--text-muted)]">Nº de acertos</label> <input type="number" id="questions-correct" min="0" class="question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> </div> </div>
<div class="flex justify-between items-center"> <div> <span class="block text-sm text-center mb-2">Como foi seu estudo?</span> <div id="mood-tracker" class="flex items-start gap-4"> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-red" data-mood="ruim"></button> <span class="text-xs mt-1">Ruim</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-yellow" data-mood="medio"></button> <span class="text-xs mt-1">Médio</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-green" data-mood="bom"></button> <span class="text-xs mt-1">Bom</span> </div> </div> <input type="hidden" id="mood-input" name="mood"> </div> <div id="flow-score-section" class="space-y-2 w-1/2"> <label for="flow-score" class="block text-sm">Nível de flow</label> <div class="flow-slider-container"> <input type="range" id="flow-score" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"> <div class="flow-slider-labels"> <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span> </div> </div> </div> </div>
<div class="flex justify-end gap-3 pt-4"> <button type="button" id="cancel-edit-btn" class="btn btn-secondary py-2 px-4 hidden">Cancelar edição</button> <button type="submit" class="btn btn-primary py-2 px-4">Salvar sessão</button> </div> </form> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Histórico de sessões recentes</h3> <div id="session-history-list" class="mt-4 space-y-3 max-h-96 overflow-y-auto"> </div> </div> <div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Gerenciar matérias e assuntos</h3> <div class="mt-4 flex items-center gap-3"> <input type="text" id="new-subject-input" placeholder="Nome da nova matéria" class="flex-grow shadow-sm"> <button id="add-subject-btn" class="btn btn-primary py-2 px-3">Adicionar matéria</button> </div> <div id="subjects-management-container" class="mt-4 space-y-4"> </div> </div>

<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Configurações gerais</h3> <div class="mt-6 pt-6 border-t border-[var(--border-color)] space-y-4"> <div> <label for="week-start-day" class="block text-sm font-medium text-[var(--text-muted)]">Início da semana</label> <select id="week-start-day" class="mt-1 block w-full shadow-sm"> <option value="1">Segunda-feira</option> <option value="0">Domingo</option> </select> </div> <div> <h4 class="text-md font-semibold">Resetar todos os dados</h4> <p class="text-xs text-[var(--text-muted)]">Cuidado: esta ação é irreversível e apagará todos os seus dados da nuvem.</p> <button id="reset-all-data-btn" class="btn btn-danger mt-2 py-2 px-3 w-full">Resetar todos os dados da nuvem</button> </div> </div> </div> </div> </div> </section>
<section id="organizacao-view" class="hidden space-y-8">
    <div class="grid grid-cols-1 lg:grid-cols-[320px_1fr] gap-6 xl:gap-8">
        <div class="card p-6 space-y-5">
            <div>
                <h2 class="text-2xl font-bold text-[var(--text-secondary)]">Organização de estudos</h2>
                <p class="text-sm text-[var(--text-muted)]">Gerencie disciplinas, assuntos e revisões em um só lugar.</p>
            </div>
            <div id="organization-discipline-list" class="space-y-3">
                <div class="text-sm text-[var(--text-muted)]">Nenhuma disciplina adicionada ainda.</div>
            </div>
            <form id="organization-add-discipline-form" class="space-y-3">
                <div class="space-y-2">
                    <label for="organization-discipline-name" class="block text-sm font-medium text-[var(--text-muted)]">Nova disciplina</label>
                    <input type="text" id="organization-discipline-name" placeholder="Ex: Direito Constitucional" class="w-full shadow-sm">
                </div>
                <button type="submit" class="w-full btn btn-primary py-2">Adicionar disciplina</button>
            </form>
        </div>
        <div id="organization-discipline-details" class="space-y-6">
            <div class="card p-6 text-center text-[var(--text-muted)]">
                <p>Selecione ou adicione uma disciplina para visualizar seus assuntos e revisões.</p>
            </div>
        </div>
    </div>
</section>
<section id="controle-view" class="hidden space-y-8">
    <div class="card p-6 space-y-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-[var(--text-secondary)]">Tabela de Controle de Estudos</h2>
                <p class="text-sm text-[var(--text-muted)]">Acompanhe matérias, assuntos, subtópicos e status de revisão em tempo real.</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="study-control-sync-btn" class="btn btn-secondary py-2 px-4 flex items-center gap-2 text-sm"><i class="fa-solid fa-rotate"></i><span>Sincronizar matérias</span></button>
                <button id="study-control-add-row" class="btn btn-primary py-2 px-4 flex items-center gap-2 text-sm"><i class="fa-solid fa-plus"></i><span>Adicionar linha</span></button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="control-table" id="study-control-table">
                <thead>
                    <tr>
                        <th>Matéria</th>
                        <th>Assunto</th>
                        <th>Subtópico</th>
                        <th>Status</th>
                        <th>Precisa Revisar?</th>
                        <th>Revisado?</th>
                        <th>Progresso</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div class="card p-6 space-y-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-[var(--text-secondary)]">Edital em Foco</h2>
                <p class="text-sm text-[var(--text-muted)]">Cole o texto do edital e organize automaticamente por tópicos e subtópicos.</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="edital-organize-btn" class="btn btn-primary py-2 px-4 flex items-center gap-2 text-sm"><i class="fa-solid fa-wand-magic-sparkles"></i><span>Organizar conteúdo</span></button>
                <button id="edital-clear-btn" class="btn btn-secondary py-2 px-4 flex items-center gap-2 text-sm"><i class="fa-solid fa-eraser"></i><span>Limpar</span></button>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1fr)_320px] gap-4 items-start">
            <textarea id="edital-input" rows="8" class="shadow-sm w-full text-sm" placeholder="Cole aqui o edital para organizar..."></textarea>
            <div class="space-y-3 text-sm text-[var(--text-muted)]">
                <p><strong>Dicas rápidas:</strong></p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>Use numeração (1., 1.1, 1.1.1) ou letras (a), b), I, II)</li>
                    <li>Cada linha será identificada automaticamente</li>
                    <li>Edite manualmente após a geração, se necessário</li>
                </ul>
            </div>
        </div>
        <div id="edital-output" class="overflow-x-auto">
            <table class="control-table edital-table" id="edital-table">
                <thead>
                    <tr>
                        <th>Tópico</th>
                        <th>Conteúdo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="2" class="text-center text-sm text-[var(--text-muted)] py-4">Cole um edital para visualizar a tabela organizada.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>
<section id="quadro-horario-view" class="hidden space-y-8">
    <div class="card p-6 space-y-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-[var(--text-secondary)]">Quadro horário</h2>
                <p class="text-sm text-[var(--text-muted)]">Planeje as 24 horas do dia com blocos personalizados e atividades salvas automaticamente.</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="schedule-add-activity" class="btn btn-primary py-2 px-4 flex items-center gap-2 text-sm"><i class="fa-solid fa-plus"></i><span>Adicionar atividade</span></button>
                <button id="schedule-clear-btn" class="btn btn-secondary py-2 px-4 flex items-center gap-2 text-sm"><i class="fa-solid fa-trash"></i><span>Limpar quadro</span></button>
            </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label for="schedule-start-time" class="block text-sm font-medium text-[var(--text-muted)]">Horário de início</label>
                <input type="time" id="schedule-start-time" value="06:00" class="mt-1 block w-full shadow-sm">
            </div>
            <div>
                <label for="schedule-interval" class="block text-sm font-medium text-[var(--text-muted)]">Tempo de intervalo</label>
                <select id="schedule-interval" class="mt-1 block w-full shadow-sm">
                    <option value="15">15 minutos</option>
                    <option value="30">30 minutos</option>
                    <option value="45">45 minutos</option>
                    <option value="60" selected>60 minutos</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-[var(--text-muted)]">Tempo semanal previsto</label>
                <input type="text" id="schedule-week-total" class="mt-1 block w-full shadow-sm" readonly>
            </div>
            <div>
                <label class="block text-sm font-medium text-[var(--text-muted)]">Carga horária total</label>
                <input type="text" id="schedule-week-load" class="mt-1 block w-full shadow-sm" readonly>
            </div>
        </div>
    </div>
    <div class="card p-6 space-y-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-[var(--text-secondary)]">Estudo diário</h3>
            <span id="schedule-active-day" class="text-sm text-[var(--text-muted)]"></span>
        </div>
        <div class="overflow-x-auto" id="schedule-grid-container">
            <div id="schedule-grid" class="schedule-grid"></div>
        </div>
    </div>
</section>
<section id="lei-seca-view" class="hidden space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-bold text-[var(--text-secondary)]">Guia de Lei Seca</h2>
            <p class="text-sm text-[var(--text-muted)]">Acompanhe suas leituras e revisões dos artigos.</p>
        </div>
        <div class="flex items-center gap-2">
            <input type="text" id="lei-seca-search" placeholder="Buscar por lei..." class="shadow-sm w-48 text-sm">
            <button id="add-lei-btn" class="btn btn-primary py-2 px-4">Adicionar Lei</button>
        </div>
    </div>
    <div id="laws-container" class="space-y-6">
        <!-- As leis serão renderizadas aqui pelo JavaScript -->
    </div>
</section> </div> </main>
<footer class="bg-[var(--card-bg)] border-t border-[var(--border-color)]"> <div class="container mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-[var(--text-muted)]"> <p>Feito para transformar estudo em resultado.</p> </div> </footer> </div>
<div id="toast" class="fixed bottom-5 right-5 bg-[color:var(--c1)] text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-2 transition-all duration-300">ok</div>
<!-- Modal de Sessão -->
<div id="session-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden"></div> <div id="session-modal-panel" class="fixed bottom-0 left-0 right-0 bg-[var(--card-bg)] p-6 rounded-t-2xl shadow-lg z-50 transition-transform duration-300 ease-in-out hidden"> <form id="modal-session-form" class="max-w-xl mx-auto space-y-4"> <h3 class="text-lg font-semibold text-center">Como foi a sua sessão de foco?</h3> <p id="modal-session-info" class="text-center text-[var(--text-muted)]"></p> <div> <label for="modal-activity-type" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de atividade</label> <select id="modal-activity-type" required class="mt-1 block w-full shadow-sm"></select> </div>
<div id="modal-questions-section" class="hidden space-y-4"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="modal-questions-total" class="block text-sm font-medium text-[var(--text-muted)]">Nº de questões</label> <input type="number" id="modal-questions-total" min="0" class="modal-question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> <div> <label for="modal-questions-correct" class="block text-sm font-medium text-[var(--text-muted)]">Nº de acertos</label> <input type="number" id="modal-questions-correct" min="0" class="modal-question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> </div> </div>
<div class="flex justify-between items-center gap-6"> <div class="flex-grow"> <span class="block text-sm text-center mb-2">Como foi seu estudo?</span> <div id="modal-mood-tracker" class="flex items-start justify-center gap-4"> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-red" data-mood="ruim"></button> <span class="text-xs mt-1">Ruim</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-yellow" data-mood="medio"></button> <span class="text-xs mt-1">Médio</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-green" data-mood="bom"></button> <span class="text-xs mt-1">Bom</span> </div> </div> <input type="hidden" id="modal-mood-input" name="mood"> </div> <div class="space-y-2 w-1/2"> <label for="modal-flow-score" class="block text-sm">Nível de flow</label> <div class="flow-slider-container"> <input type="range" id="modal-flow-score" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"> <div class="flow-slider-labels"> <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span> </div> </div> </div> </div>
<div class="flex justify-end gap-3 pt-4"> <button type="button" id="modal-cancel-btn" class="btn btn-secondary py-2 px-4">Cancelar</button> <button type="submit" class="btn btn-primary py-2 px-4">Salvar sessão</button> </div> </form> </div>
<!-- Modal de Notificação -->
<div id="notification-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden"></div> <div id="notification-modal-panel" class="fixed bottom-0 left-0 right-0 bg-[var(--card-bg)] p-6 rounded-t-2xl shadow-lg z-50 transition-transform duration-300 ease-in-out hidden text-center"> <h3 id="notification-title" class="text-xl font-bold"></h3> <p id="notification-message" class="text-[var(--text-muted)] mt-2"></p> <button id="notification-ok-btn" class="btn btn-primary mt-6 py-2 px-8">OK</button> </div> <input type="file" id="backup-file-input" class="hidden" accept=".json">
<!-- Modal para Adicionar Lei Seca -->
<div id="add-lei-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden"></div>
<div id="add-lei-modal-panel" class="fixed bottom-0 left-0 right-0 bg-[var(--card-bg)] p-6 rounded-t-2xl shadow-lg z-50 transition-transform duration-300 ease-in-out hidden transform translate-y-full">
    <form id="add-lei-form" class="max-w-xl mx-auto space-y-4">
        <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Adicionar Nova Lei</h3>
        <div>
            <label for="lei-nome-input" class="block text-sm font-medium text-[var(--text-muted)]">Nome da Lei</label>
            <input type="text" id="lei-nome-input" required class="mt-1 block w-full shadow-sm" placeholder="Ex: Constituição Federal">
        </div>
        <div>
            <label for="lei-artigos-input" class="block text-sm font-medium text-[var(--text-muted)]">Número de Artigos</label>
            <input type="number" id="lei-artigos-input" required min="1" class="mt-1 block w-full shadow-sm" placeholder="Ex: 250">
        </div>
        <div>
            <label for="lei-categoria-input" class="block text-sm font-medium text-[var(--text-muted)]">Categoria</label>
            <input type="text" id="lei-categoria-input" class="mt-1 block w-full shadow-sm" placeholder="Ex: Direito Constitucional" list="lei-categorias-datalist">
            <datalist id="lei-categorias-datalist"></datalist>
        </div>
        <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="add-lei-modal-cancel-btn" class="btn btn-secondary py-2 px-4">Cancelar</button>
            <button type="submit" class="btn btn-primary py-2 px-4">Adicionar</button>
        </div>
    </form>
</div>
<video id="pip-video" class="hidden" muted playsinline></video> <canvas id="pip-canvas" width="300" height="200" class="hidden"></canvas><div id="youtube-player" class="fixed top-[-9999px] left-[-9999px]"></div><script> const firebaseConfig = { apiKey: "AIzaSyD0ZFxuLY452R6JENiRk-m3zJsuhj5GJaw", authDomain: "dashboard-b436d.firebaseapp.com", databaseURL: "https://dashboard-b436d-default-rtdb.firebaseio.com", projectId: "dashboard-b436d", storageBucket: "dashboard-b436d.firebasestorage.app", messagingSenderId: "501090317163", appId: "1:501090317163:web:a69822ae2e161a1bc3522e" };
class LeiSecaController {
    constructor(app) {
        this.app = app;
        this.GREEN_SCALE = [
            '#E9FBE8','#D5F5D1','#C0EFBA','#ACE9A3','#98E38D',
            '#84DD76','#70D760','#5DD24A','#4ACD34','#37C71E',
            '#2FB91B','#29A918','#239915','#1E8913','#197911',
            '#14690F','#0F590D','#0A490B','#053909','#002F07'
        ];
        this.selectors = {
            addBtn: '#add-lei-btn',
            searchInput: '#lei-seca-search',
            addForm: '#add-lei-form',
            cancelBtn: '#add-lei-modal-cancel-btn',
            backdrop: '#add-lei-modal-backdrop',
            container: '#laws-container',
            modal: '#add-lei-modal-panel'
        };
        this.init();
    }

    init() {
        this.bindEvents();
    }

    bindEvents() {
        this.getEl(this.selectors.addBtn)?.addEventListener('click', () => this.openAddLeiModal());
        this.getEl(this.selectors.searchInput)?.addEventListener('input', (e) => this.handleLeiSecaSearch(e));
        this.getEl(this.selectors.addForm)?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleAddNewLei();
        });
        this.getEl(this.selectors.cancelBtn)?.addEventListener('click', () => this.closeAddLeiModal());
        this.getEl(this.selectors.backdrop)?.addEventListener('click', () => this.closeAddLeiModal());

        const container = this.getEl(this.selectors.container);
        if (container) {
            container.addEventListener('click', (e) => this.handleContainerClick(e));
            container.addEventListener('contextmenu', (e) => this.handleContainerRightClick(e));
        }
    }

    handleContainerClick(e) {
        const square = e.target.closest('.artigo-square');
        if (square) {
            this.handleArticleClick(
                parseInt(square.dataset.lawId, 10),
                parseInt(square.dataset.articleNum, 10)
            );
            return;
        }

        const button = e.target.closest('button[data-action]');
        if (button) this.handleButtonAction(button);
    }

    handleContainerRightClick(e) {
        const square = e.target.closest('.artigo-square');
        if (square) {
            e.preventDefault();
            this.handleArticleRightClick(
                parseInt(square.dataset.lawId, 10),
                parseInt(square.dataset.articleNum, 10)
            );
        }
    }

    handleButtonAction(button) {
        const action = button.dataset.action;
        const lawId = parseInt(button.dataset.lawId, 10);

        const actions = {
            'delete-law': () => this.deleteLaw(lawId),
            'mark-all-read': () => this.updateArticles(lawId, 'mark-all'),
            'reset-all': () => this.updateArticles(lawId, 'reset'),
            'mark-interval': () => this.markInterval(lawId, button),
            'toggle-category': () => this.toggleCategory(button)
        };

        actions[action]?.();
    }
    
    openAddLeiModal() {
        this.getEl(this.selectors.addForm)?.reset();
        this.populateCategoryDatalist();
        this.showElement(this.selectors.backdrop);
        this.getEl(this.selectors.modal)?.classList.remove('hidden', 'translate-y-full');
    }

    closeAddLeiModal() {
        this.hideElement(this.selectors.backdrop);
        this.getEl(this.selectors.modal)?.classList.add('translate-y-full');
        // Add a delay to allow the animation to finish before hiding
        setTimeout(() => this.getEl(this.selectors.modal)?.classList.add('hidden'), 300);
    }

    populateCategoryDatalist() {
        const datalist = this.getEl('#lei-categorias-datalist');
        const laws = this.app.state.parameters.leiSeca?.laws || [];
        const categories = [...new Set(laws.map(l => l.category).filter(Boolean))];
        
        if (datalist) {
            datalist.innerHTML = categories
                .map(c => `<option value="${c}">`)
                .join('');
        }
    }

    handleAddNewLei() {
        const name = this.getEl('#lei-nome-input')?.value.trim();
        const count = parseInt(this.getEl('#lei-artigos-input')?.value, 10);
        const category = this.getEl('#lei-categoria-input')?.value.trim() || 'Geral';

        if (!name || isNaN(count) || count <= 0) {
            this.app.toast('Nome e/ou número de artigos inválido.', false);
            return;
        }

        const newLaw = this.createLawObject(name, count, category);
        this.addLawToState(newLaw);
        this.app.saveData(true, `Lei "${name}" adicionada.`);
        this.renderLeiSecaView();
        this.closeAddLeiModal();
    }

    createLawObject(name, count, category) {
        return {
            id: Date.now(),
            name,
            articleCount: count,
            category,
            articles: Array.from({ length: count }, (_, i) => ({
                num: i + 1,
                reads: 0
            }))
        };
    }

    addLawToState(law) {
        if (!this.app.state.parameters.leiSeca) {
            this.app.state.parameters.leiSeca = { laws: [] };
        }
        if (!this.app.state.parameters.leiSeca.laws) {
            this.app.state.parameters.leiSeca.laws = [];
        }
        this.app.state.parameters.leiSeca.laws.push(law);
    }

    deleteLaw(lawId) {
        if (confirm('Tem certeza que deseja excluir esta lei e todos os seus dados?')) {
            this.app.state.parameters.leiSeca.laws = 
                this.app.state.parameters.leiSeca.laws.filter(l => l.id !== lawId);
            this.app.saveData(true, 'Lei excluída.');
            this.renderLeiSecaView();
        }
    }

    handleArticleClick(lawId, articleNum) {
        const article = this.findArticle(lawId, articleNum);
        if (article) {
            article.reads++;
            this.app.saveData();
            this.updateLeiSecaDOM(lawId, articleNum);
        }
    }

    handleArticleRightClick(lawId, articleNum) {
        const article = this.findArticle(lawId, articleNum);
        if (article && article.reads > 0) {
            article.reads = 0;
            this.app.saveData();
            this.updateLeiSecaDOM(lawId, articleNum);
        }
    }

    findArticle(lawId, articleNum) {
        return this.app.state.parameters.leiSeca?.laws
            .find(l => l.id === lawId)
            ?.articles.find(a => a.num === articleNum);
    }

    updateArticles(lawId, mode, value = null) {
        const law = this.app.state.parameters.leiSeca?.laws.find(l => l.id === lawId);
        if (!law) return;

        const modes = {
            'mark-all': () => law.articles.forEach(a => a.reads = 20),
            'reset': () => law.articles.forEach(a => a.reads = 0),
            'interval': () => this.processInterval(law, value)
        };

        modes[mode]?.();

        if (modes[mode]) {
            this.app.saveData(true, 'Artigos atualizados.');
            this.renderLeiSecaView();
        }
    }

    processInterval(law, value) {
        const parts = value.split('-').map(s => parseInt(s.trim(), 10));
        const [start, end = start] = parts;

        if (isNaN(start) || isNaN(end) || start > end || start < 1) {
            this.app.toast('Intervalo inválido.', false);
            return;
        }

        law.articles.forEach(a => {
            if (a.num >= start && a.num <= end) a.reads++;
        });
    }

    markInterval(lawId, button) {
        const input = this.getEl(`#interval-input-${lawId}`);
        if (input?.value) {
            this.updateArticles(lawId, 'interval', input.value);
        }
    }

    getArticleStyle(readCount) {
        if (readCount === 0) return { bgColor: '', textColor: '' };
        
        const index = Math.min(readCount - 1, this.GREEN_SCALE.length - 1);
        return {
            bgColor: this.GREEN_SCALE[index],
            textColor: index >= 10 ? '#fff' : ''
        };
    }

    updateLeiSecaDOM(lawId, articleNum) {
        const article = this.findArticle(lawId, articleNum);
        const square = this.getEl(
            `.artigo-square[data-law-id='${lawId}'][data-article-num='${articleNum}']`
        );

        if (article && square) {
            const style = this.getArticleStyle(article.reads);
            square.style.backgroundColor = style.bgColor;
            square.classList.toggle('text-white', style.textColor === '#fff');
            
            const tooltip = square.querySelector('.tooltip-text');
            if (tooltip) {
                tooltip.textContent = `Lido ${article.reads} vez(es)${
                    article.reads >= 20 ? ' (Avançado)' : ''
                }`;
            }
        }
        this.updateLeiPanelSummary(lawId);
    }

    updateLeiPanelSummary(lawId) {
        const summaryEl = this.getEl(`#summary-${lawId}`);
        const law = this.app.state.parameters.leiSeca?.laws.find(l => l.id === lawId);

        if (!summaryEl || !law) return;

        const stats = this.calculateLawStats(law);
        summaryEl.innerHTML = `Artigos lidos: <strong>${stats.readArticles}</strong> de ${law.articleCount} (${stats.percentage}%) &mdash; Leituras: <strong>${stats.totalReads}</strong>`;
    }

    calculateLawStats(law) {
        const readArticles = law.articles.filter(a => a.reads > 0).length;
        const totalReads = law.articles.reduce((sum, a) => sum + a.reads, 0);
        const percentage = law.articleCount > 0
            ? (readArticles / law.articleCount * 100).toFixed(0)
            : 0;

        return { readArticles, totalReads, percentage };
    }
    
    handleLeiSecaSearch(event) {
        const searchTerm = event.target.value.toLowerCase();
        const laws = this.app.state.parameters.leiSeca?.laws || [];
        const container = this.getEl(this.selectors.container);
        if (!container) return;

        if (!searchTerm) {
            this.renderLeiSecaView();
            return;
        }

        const filteredLaws = laws.filter(law => law.name.toLowerCase().includes(searchTerm));
        const grouped = this.groupLawsByCategory(filteredLaws);
        container.innerHTML = '';
        if (Object.keys(grouped).length === 0) {
             container.innerHTML = `
            <div class="text-center text-[var(--text-muted)] card p-8">
                <h3 class="font-semibold text-lg">Nenhuma lei encontrada.</h3>
                <p class="mt-2">Verifique o termo buscado ou adicione novas leis.</p>
            </div>
            `;
            return;
        }
        this.renderCategoryContainers(container, grouped);
    }

    toggleCategory(button) {
        const categoryName = button.dataset.category;
        const content = this.getEl(
            `.category-content[data-category-content="${categoryName}"]`
        );
        if (content) {
            content.classList.toggle('collapsed');
            const icon = button.querySelector('i');
            icon?.classList.toggle('fa-chevron-up');
            icon?.classList.toggle('fa-chevron-down');
        }
    }

    renderLeiSecaView() {
        const container = this.getEl(this.selectors.container);
        if (!container) return;

        container.innerHTML = '';
        
        const laws = this.app.state.parameters.leiSeca?.laws || [];
        if (laws.length === 0) {
            this.renderEmptyState(container);
            return;
        }

        const grouped = this.groupLawsByCategory(laws);
        this.renderCategoryContainers(container, grouped);
    }

    renderEmptyState(container) {
        container.innerHTML = `
            <div class="text-center text-[var(--text-muted)] card p-8">
                <h3 class="font-semibold text-lg">Nenhuma lei adicionada.</h3>
                <p class="mt-2">Clique em "Adicionar Lei" para começar.</p>
            </div>
        `;
    }

    groupLawsByCategory(laws) {
        return laws.reduce((acc, law) => {
            const cat = law.category || 'Geral';
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(law);
            return acc;
        }, {});
    }

    renderCategoryContainers(container, grouped) {
        Object.keys(grouped).sort().forEach(category => {
            const catContainer = document.createElement('div');
            catContainer.className = 'category-container';
            catContainer.innerHTML = `
                <div class="category-header flex justify-between items-center p-3 rounded-lg bg-[var(--card-bg)] border border-[var(--border-color)] cursor-pointer" data-action="toggle-category" data-category="${category}">
                    <h3 class="text-lg font-semibold text-[var(--text-secondary)]">${category}</h3>
                    <button data-action="toggle-category" data-category="${category}" class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]">
                        <i class="fa-solid fa-chevron-up"></i>
                    </button>
                </div>
                <div class="category-content space-y-4 pt-4" data-category-content="${category}">
                    ${grouped[category].map(law => this.renderLeiPanel(law)).join('')}
                </div>
            `;
            container.appendChild(catContainer);
            catContainer.querySelector('.category-header').addEventListener('click', (e) => {
                if(e.target === e.currentTarget) {
                   this.toggleCategory(e.currentTarget.querySelector('button'));
                }
            })
        });
    }

    renderLeiPanel(law) {
        const stats = this.calculateLawStats(law);
        const gridHTML = law.articles
            .map(article => this.renderArticleSquare(law.id, article))
            .join('');

        return `
            <div class="card p-4 sm:p-6 lei-panel" id="lei-panel-${law.id}" data-law-id="${law.id}">
                <div class="lei-panel-header flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-[var(--text-secondary)]">${law.name}</h3>
                        <p id="summary-${law.id}" class="text-sm text-[var(--text-muted)] mt-1">
                            Artigos lidos: <strong>${stats.readArticles}</strong> de ${law.articleCount} (${stats.percentage}%) &mdash; Leituras: <strong>${stats.totalReads}</strong>
                        </p>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <input type="text" id="interval-input-${law.id}" placeholder="Ex: 1-45" class="shadow-sm w-24 text-sm">
                        <button data-action="mark-interval" data-law-id="${law.id}" class="btn btn-secondary text-xs py-1 px-2">Marcar</button>
                        <button data-action="mark-all-read" data-law-id="${law.id}" class="btn btn-secondary text-xs py-1 px-2">Avançado</button>
                        <button data-action="reset-all" data-law-id="${law.id}" class="btn btn-secondary text-xs py-1 px-2">Resetar</button>
                        <button data-action="delete-law" data-law-id="${law.id}" class="btn btn-danger text-xs py-1 px-2">Excluir</button>
                    </div>
                </div>
                <div class="lei-grid" data-grid-for-law="${law.id}">${gridHTML}</div>
            </div>
        `;
    }

    renderArticleSquare(lawId, article) {
        const style = this.getArticleStyle(article.reads);
        return `
            <div class="artigo-square tooltip ${style.textColor === '#fff' ? 'text-white' : ''}" 
                 style="background-color: ${style.bgColor || ''}"
                 data-law-id="${lawId}" data-article-num="${article.num}">
                <span>${article.num}</span>
                <span class="tooltip-text">Lido ${article.reads} vez(es)${
                    article.reads >= 20 ? ' (Avançado)' : ''
                }</span>
            </div>
        `;
    }

    getEl(selector) {
        return document.querySelector(selector);
    }

    showElement(selector) {
        this.getEl(selector)?.classList.remove('hidden');
    }

    hideElement(selector) {
        this.getEl(selector)?.classList.add('hidden');
    }
}

const App = { state: { currentView: 'dashboard', charts: {}, studyData: [], backups: [], parameters: { subjects: [ { name: "Direito Constitucional", subtopics: ["Controle de Constitucionalidade", "Direitos Fundamentais"] }, { name: "Raciocínio Lógico", subtopics: [] }, { name: "Português", subtopics: [] }, { name: "Direito Administrativo", subtopics: [] } ], tasks: [], youtubeMusic: [], subjectColors: {}, tiposDeAtividade: ["Teoria","Exercícios","Revisão","Simulado", "Lei Seca", "Jurisprudência", "Subjetivas", "Prova Oral"], weeklyGoals: { hours: 35, questions: 250, accuracy: 80, days: 5 }, weekStartDay: 1, concursoInfo: { nome: '', cargo: '', inicio: '', prova: '' }, darkMode: false, leiSeca: { laws: [] }, studyControlRows: [], editalEntries: [], scheduleBoard: { startTime: '06:00', interval: 60, activities: {}, history: [] } }, db: null, auth: null, userId: null, dataLoaded: false, COLOR_PALETTE: ['#3D405B', '#81B29A', '#F2CC8F', '#E07A5F', '#555B6E', '#89B0AE', '#BEE3DB', '#FFD6BA', '#F28F3B', '#C8553D', '#6A7FDB', '#A3A3A3', '#3E5641', '#A24936', '#D36135', '#2E294E', '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf', '#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab', '#003f5c', '#2f4b7c', '#665191', '#a05195', '#d45087', '#f95d6a', '#ff7c43', '#ffa600', '#488f31', '#de425b', '#69b3a2', '#f4a261', '#e76f51', '#2a9d8f', '#264653', '#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4', '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9', '#001219', '#005f73', '#0a9396', '#94d2bd', '#e9d8a6', '#ee9b00', '#ca6702', '#bb3e03', '#ae2012', '#9b2226' ], soundOptions: { notification: ["C5", "G5"], chime: ["C6", "E6", "G6"], simple: ["G5"] }, pomodoro: { isRunning: false, isSessionActive: false, mode: 'work', timeLeft: 25*60, cycleStart: null, intervalId: null, totalCycles: 4, cyclesCompleted: 0, settings: { work: 25, shortBreak: 5, longBreak: 15, autoStart: false, alertTime: null, sound: 'notification' }, sessionSubject: '', sessionSubtopic: '', pendingLogDuration: 0, totalPauseTime: 0, pauseStartTime: null, currentTaskId: null, }, stopwatch: { isRunning: false, startTime: null, elapsedTime: 0, intervalId: null, subject: '', subtopic: '', alertTime: null, alertTriggered: false, settings: { sound: 'notification' }, totalPauseTime: 0, pauseStartTime: null, }, pip: { canvas: null, video: null, ctx: null, isActive: false, }, backgroundAudio: { player: null, volume: null, }, youtubePlayer: null, currentMusicId: null, editingId: null, pendingSession: null, audioInitialized: false, synth: null, activeQuestionInputId: 'questions-total', activeModalQuestionInputId: 'modal-questions-total', questionsEvolutionView: 'relative', debounceTimer: null, lastBackupTime: 0, },
init(){ this.initFirebase(); this.bindAuthForms(); this.checkInitialDarkMode(); },
initFirebase() { try { firebase.initializeApp(firebaseConfig); this.state.db = firebase.database(); this.state.auth = firebase.auth();
this.state.auth.onAuthStateChanged(user => { if (user) { this.state.userId = user.uid; document.getElementById('loading-view').classList.remove('hidden'); document.getElementById('auth-view').classList.add('hidden'); document.getElementById('main-nav').style.display = 'flex'; if (!this.state.dataLoaded) { this.loadData(); } } else { this.state.userId = null; this.state.dataLoaded = false; this.resetState(); document.getElementById('loading-view').classList.add('hidden'); document.getElementById('main-content').classList.add('hidden'); document.getElementById('main-nav').style.display = 'none'; document.getElementById('auth-view').classList.remove('hidden'); } }); } catch (e) { console.error("Erro ao inicializar o Firebase:", e); alert("Erro na configuração do Firebase. Verifique o objeto 'firebaseConfig' no código e se os scripts do Firebase foram carregados."); } }, initializeApp() { document.getElementById('loading-view').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden');
this.leiSecaController = new LeiSecaController(this);
this.bindNav(); this.bindFilters(); this.bindGeneralActions(); this.bindBackup(); this.bindRegistro(); this.bindPomodoro(); this.bindStopwatch(); this.bindModal(); this.bindNotificationModal(); this.bindConcurso(); this.bindPip(); this.bindBackgroundSounds(); this.initCharts(); this.bindCollapsibleSections(); this.updateAllSubjectDropdowns(); this.updateActivityDropdowns(); this.renderSubjectsManagement(); this.bindSubjectManagement(); this.bindTasks(); this.renderTasks(); this.bindYouTubeMusic(); this.renderYouTubeMusicList(); this.resetPomodoro(true); this.setFilterPeriod('week'); this.navigateTo('dashboard'); this.scheduleDailyBackup(); this.renderBackupList();
const searchInput = document.getElementById('log-search-input'); searchInput.addEventListener('input', (e) => { clearTimeout(this.state.debounceTimer); this.state.debounceTimer = setTimeout(() => { this.renderDetailedLog(this.getFilteredData(), e.target.value); }, 300); }); },
bindCollapsibleSections() { document.querySelectorAll('.collapse-toggle-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const header = e.currentTarget.parentElement; const content = header.nextElementSibling; const icon = e.currentTarget.querySelector('i'); if (content && content.classList.contains('collapsible-content')) { content.classList.toggle('hidden'); icon.classList.toggle('fa-chevron-up'); icon.classList.toggle('fa-chevron-down'); } }); }); },
bindAuthForms() { const loginForm = document.getElementById('login-form'); const registerForm = document.getElementById('register-form'); const showRegisterBtn = document.getElementById('show-register'); const showLoginBtn = document.getElementById('show-login'); const logoutBtn = document.getElementById('logout-btn'); const logoutBtnMobile = document.getElementById('logout-btn-mobile'); const forgotPasswordLink = document.getElementById('forgot-password-link');
loginForm.addEventListener('submit', e => { e.preventDefault(); const email = loginForm['login-email'].value; const password = loginForm['login-password'].value; this.handleLogin(email, password); }); forgotPasswordLink.addEventListener('click', e => { e.preventDefault(); this.handleForgotPassword(); });
registerForm.addEventListener('submit', e => { e.preventDefault(); const email = registerForm['register-email'].value; const password = registerForm['register-password'].value; this.handleRegister(email, password); });
showRegisterBtn.addEventListener('click', e => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
showLoginBtn.addEventListener('click', e => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); }); logoutBtn.addEventListener('click', () => this.handleLogout()); logoutBtnMobile.addEventListener('click', () => this.handleLogout()); },
handleLogin(email, password) { const errorP = document.getElementById('login-error'); errorP.textContent = ''; this.state.auth.signInWithEmailAndPassword(email, password) .catch(error => { console.error("Erro de login:", error.message); errorP.textContent = "Email ou senha inválidos."; }); }, handleForgotPassword() { const emailInput = document.getElementById('login-email'); const email = emailInput.value; const errorP = document.getElementById('login-error'); errorP.textContent = '';
if (!email) { errorP.textContent = 'Por favor, insira seu email para redefinir a senha.'; return; }
this.state.auth.sendPasswordResetEmail(email) .then(() => { this.toast('Email de redefinição de senha enviado!'); }) .catch(error => { console.error("Erro ao enviar email de redefinição:", error); errorP.textContent = 'Falha ao enviar. Verifique o email digitado.'; }); },
handleRegister(email, password) { const errorP = document.getElementById('register-error'); errorP.textContent = ''; this.state.auth.createUserWithEmailAndPassword(email, password) .catch(error => { console.error("Erro de cadastro:", error.message); if (error.code == 'auth/weak-password') { errorP.textContent = 'A senha precisa ter no mínimo 6 caracteres.'; } else if (error.code == 'auth/email-already-in-use') { errorP.textContent = 'Este email já está em uso.'; } else { errorP.textContent = 'Ocorreu um erro ao criar a conta.'; } }); },
handleLogout() { this.state.auth.signOut(); },
resetState() { const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; this.state.studyData = []; this.state.parameters = { subjects: [ { name: "Direito Constitucional", subtopics: ["Controle de Constitucionalidade", "Direitos Fundamentais"] }, { name: "Raciocínio Lógico", subtopics: [] }, { name: "Português", subtopics: [] }, { name: "Direito Administrativo", subtopics: [] } ], tasks: [], youtubeMusic: [], subjectColors: {}, tiposDeAtividade: ["Teoria","Exercícios","Revisão","Simulado", "Lei Seca", "Jurisprudência", "Subjetivas", "Prova Oral"], weeklyGoals: { hours: 35, questions: 250, accuracy: 80, days: 5 }, weekStartDay: 1, concursoInfo: { nome: '', cargo: '', inicio: '', prova: '' }, darkMode: localStorage.getItem('darkMode') === 'true' || (localStorage.getItem('darkMode') === null && prefersDark), leiSeca: { laws: [] }, studyControlRows: [], editalEntries: [], scheduleBoard: { startTime: '06:00', interval: 60, activities: {}, history: [] } }; },
saveData(showToast = false, toastMessage = 'Dados salvos na nuvem!'){ if (!this.state.userId) { if (showToast) this.toast('Erro: Usuário não autenticado. Não foi possível salvar.', false); return; } const dataToSave = { studyData: this.state.studyData, parameters: this.state.parameters, }; this.state.db.ref('users/' + this.state.userId).set(dataToSave) .then(() => { if (showToast) { this.toast(toastMessage); } }) .catch(error => { console.error("Falha ao salvar dados no Firebase:", error); if (showToast) this.toast('Erro ao salvar na nuvem.', false); });
try { localStorage.setItem('studyDashBackupsV30', JSON.stringify(this.state.backups)); } catch(e){ console.error("Falha ao salvar backups locais:", e); } },
loadData(){ if (!this.state.userId) return;
try { const rawBackups = localStorage.getItem('studyDashBackupsV30'); if (rawBackups) { this.state.backups = JSON.parse(rawBackups); } } catch(e) { console.error("Falha ao carregar backups locais:", e); }
this.state.db.ref('users/' + this.state.userId).once('value', snapshot => { const data = snapshot.val(); this.resetState(); if(data){ this.state.studyData = data.studyData || []; if(data.parameters) { if (data.parameters.disciplinas && !data.parameters.subjects) { data.parameters.subjects = data.parameters.disciplinas.map(d => ({ name: d, subtopics: [] })); delete data.parameters.disciplinas; } Object.assign(this.state.parameters, data.parameters);

const defaultActivities = ["Teoria","Exercícios","Revisão","Simulado", "Lei Seca", "Jurisprudência", "Subjetivas", "Prova Oral"];
if (this.state.parameters.tiposDeAtividade && Array.isArray(this.state.parameters.tiposDeAtividade)) {
    const userActivities = new Set(this.state.parameters.tiposDeAtividade);
    defaultActivities.forEach(act => userActivities.add(act));
    this.state.parameters.tiposDeAtividade = [...userActivities].sort((a, b) => defaultActivities.indexOf(a) - defaultActivities.indexOf(b));
} else {
    this.state.parameters.tiposDeAtividade = defaultActivities;
}

if(!this.state.parameters.tasks) this.state.parameters.tasks = []; if(!this.state.parameters.youtubeMusic) this.state.parameters.youtubeMusic = []; if(!this.state.parameters.leiSeca) this.state.parameters.leiSeca = { laws: [] }; if(!this.state.parameters.studyControlRows) this.state.parameters.studyControlRows = []; if(!Array.isArray(this.state.parameters.studyControlRows)) this.state.parameters.studyControlRows = Object.values(this.state.parameters.studyControlRows || {}); if(!this.state.parameters.editalEntries) this.state.parameters.editalEntries = []; if(!Array.isArray(this.state.parameters.editalEntries)) this.state.parameters.editalEntries = Object.values(this.state.parameters.editalEntries || {}); if(!this.state.parameters.scheduleBoard || typeof this.state.parameters.scheduleBoard !== 'object') this.state.parameters.scheduleBoard = { startTime: '06:00', interval: 60, activities: {}, history: [] }; if(!this.state.parameters.scheduleBoard.activities || typeof this.state.parameters.scheduleBoard.activities !== 'object') this.state.parameters.scheduleBoard.activities = {}; if(!Array.isArray(this.state.parameters.scheduleBoard.history)) this.state.parameters.scheduleBoard.history = []; if (this.state.parameters.subjects && typeof this.state.parameters.subjects === 'object' && !Array.isArray(this.state.parameters.subjects)) { console.warn("'subjects' foi carregado como um objeto, convertendo para array."); this.state.parameters.subjects = Object.values(this.state.parameters.subjects); } if (Array.isArray(this.state.parameters.subjects)) { this.state.parameters.subjects.forEach(subject => { if (!subject.subtopics || !Array.isArray(subject.subtopics)) { subject.subtopics = []; } }); } } } this.ensureSubjectColors(); this.setDarkMode(this.state.parameters.darkMode, false); this.state.dataLoaded = true; this.initializeApp(); }); },
ensureSubjectColors() { if (!this.state.parameters.subjectColors) { this.state.parameters.subjectColors = {}; } const subjects = this.state.parameters.subjects.map(s => s.name); let colorIndex = 0; subjects.forEach(subjectName => { if (!this.state.parameters.subjectColors[subjectName]) { this.state.parameters.subjectColors[subjectName] = this.state.COLOR_PALETTE[colorIndex % this.state.COLOR_PALETTE.length]; colorIndex++; } }); },
bindNav(){ document.querySelectorAll('.nav-link').forEach(link=>{ link.addEventListener('click', (e)=>{ e.preventDefault(); this.navigateTo(e.target.dataset.view); document.getElementById('mobile-menu').classList.add('hidden'); }); }); document.getElementById('mobile-menu-button').addEventListener('click', ()=>{ document.getElementById('mobile-menu').classList.toggle('hidden'); }); document.getElementById('dark-mode-toggle').addEventListener('click', () => this.toggleDarkMode()); document.getElementById('dark-mode-toggle-mobile').addEventListener('click', () => this.toggleDarkMode()); }, navigateTo(view){ this.state.currentView = view; document.querySelectorAll('section[id$="-view"]').forEach(s=>s.classList.add('hidden')); document.getElementById(`${view}-view`).classList.remove('hidden'); document.querySelectorAll('.nav-link').forEach(l=>l.classList.toggle('active', l.dataset.view===view)); if(view==='dashboard'){ this.updateDashboard(); } if(view==='foco'){ this.renderSessionHistory(); this.renderTasks(); this.resetForm(); } if(view==='lei-seca') { this.leiSecaController.renderLeiSecaView(); } }, checkInitialDarkMode() { const savedMode = localStorage.getItem('darkMode'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; const useDark = savedMode === 'true' || (savedMode === null && prefersDark); this.setDarkMode(useDark, false); },
setDarkMode(isDark, shouldSave = true) { this.state.parameters.darkMode = isDark; const icon = isDark ? 'fa-sun' : 'fa-moon'; document.documentElement.classList.toggle('dark-mode', isDark); document.querySelectorAll('#dark-mode-toggle i, #dark-mode-toggle-mobile i').forEach(el => { el.classList.remove('fa-moon', 'fa-sun'); el.classList.add(icon); }); if (shouldSave) { localStorage.setItem('darkMode', isDark); this.saveData(); } if (this.state.dataLoaded) { Object.values(this.state.charts).forEach(chart => { if(chart) chart.destroy(); }); this.initCharts(); this.updateDashboard(); } },
toggleDarkMode() { this.setDarkMode(!this.state.parameters.darkMode); },
bindConcurso() { const fields = ['concurso-nome', 'concurso-cargo', 'concurso-inicio', 'concurso-prova']; const concursoInfo = this.state.parameters.concursoInfo;
document.getElementById('concurso-nome').value = concursoInfo.nome || ''; document.getElementById('concurso-cargo').value = concursoInfo.cargo || ''; document.getElementById('concurso-inicio').value = concursoInfo.inicio || ''; document.getElementById('concurso-prova').value = concursoInfo.prova || '';
const update = () => { concursoInfo.nome = document.getElementById('concurso-nome').value; concursoInfo.cargo = document.getElementById('concurso-cargo').value; concursoInfo.inicio = document.getElementById('concurso-inicio').value; concursoInfo.prova = document.getElementById('concurso-prova').value; this.updateCountdown(); this.saveData(); };
fields.forEach(id => document.getElementById(id).addEventListener('change', update)); this.updateCountdown(); },
updateCountdown() { const container = document.getElementById('concurso-countdown'); const provaDate = this.state.parameters.concursoInfo.prova; if (!provaDate) { container.innerHTML = ''; return; } const today = new Date(); today.setHours(0,0,0,0); const targetDate = new Date(provaDate); const userTimezoneOffset = targetDate.getTimezoneOffset() * 60000; const correctedTargetDate = new Date(targetDate.getTime() + userTimezoneOffset); const diffTime = correctedTargetDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
if (diffDays > 0) { container.innerHTML = `Faltam <span class="text-2xl">${diffDays}</span> dias para a prova.`; } else if (diffDays === 0) { container.innerHTML = `É hoje! Boa prova!`; } else { container.innerHTML = `A prova já passou.`; } },
toast(msg, ok=true){ const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('opacity-0','translate-y-2'); t.classList.toggle('bg-red-600', !ok); t.classList.toggle('bg-[color:var(--c1)]', ok); setTimeout(()=> t.classList.add('opacity-0','translate-y-2'), 2500); }, formatTime(seconds, format = 'hms') { if (isNaN(seconds) || seconds < 0) return '00h00m'; seconds = Math.round(seconds); const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = seconds % 60; const hh = String(h).padStart(2, '0'); const mm = String(m).padStart(2, '0'); const ss = String(s).padStart(2, '0'); if (format === 'hms') { return `${hh}h${mm}m`; } if (format === 'hms_seconds') { return `${hh}:${mm}:${ss}`; } if (format === 'ms') { return `${mm}:${ss}`; } return `${hh}h${mm}m`; }, bindGeneralActions() { document.getElementById('export-pdf-btn').addEventListener('click', ()=> this.exportPDF()); document.getElementById('save-all-btn').addEventListener('click', () => { this.saveData(true); }); }, bindBackup() { document.getElementById('export-backup-btn').addEventListener('click', () => this.createBackup('Manual', true)); document.getElementById('import-backup-btn').addEventListener('click', () => document.getElementById('backup-file-input').click()); document.getElementById('backup-file-input').addEventListener('change', (e) => this.importBackup(e)); document.getElementById('create-backup-now-btn').addEventListener('click', () => this.createBackup('Salvo Manualmente', false)); },
createBackup(reason = 'Manual', download = true) { const now = Date.now(); if (now - this.state.lastBackupTime < 2000) { console.warn("Backup request too soon, ignoring."); return; } this.state.lastBackupTime = now; try { const timestamp = new Date(); const dataToBackup = { studyData: this.state.studyData, parameters: this.state.parameters, }; const jsonString = JSON.stringify(dataToBackup, null, 2); const newBackup = { id: timestamp.getTime(), date: timestamp.toISOString(), reason: reason, content: jsonString, };
if (reason.startsWith('Automático')) { this.state.backups = this.state.backups.filter(b => !b.reason.startsWith('Automático')); }
this.state.backups.push(newBackup); this.state.backups.sort((a, b) => new Date(b.date) - new Date(a.date)); this.toast(`Backup local '${reason}' criado com sucesso!`); localStorage.setItem('studyDashBackupsV30', JSON.stringify(this.state.backups)); this.renderBackupList(); if(download) { const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dateStr = timestamp.toISOString().split('T')[0]; a.download = `backup-estudos-${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
} catch (error) { console.error('Erro ao criar backup:', error); this.toast('Falha ao criar backup.', false); } },
scheduleDailyBackup() { const now = new Date(); const noon = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0); let timeToNoon = noon - now; if (timeToNoon < 0) { noon.setDate(noon.getDate() + 1); timeToNoon = noon - now; }
setTimeout(() => { this.createBackup('Automático Diário', false); setInterval(() => { this.createBackup('Automático Diário', false); }, 24 * 60 * 60 * 1000); }, timeToNoon); },
renderBackupList() { const container = document.getElementById('backup-list'); if (!container) return;
if(this.state.backups.length === 0) { container.innerHTML = `<p class="text-sm text-gray-500">Nenhum backup salvo ainda.</p>`; return; }
container.innerHTML = this.state.backups.map(backup => { const date = new Date(backup.date); const formattedDate = `${date.toLocaleDateString('pt-BR')} às ${date.toLocaleTimeString('pt-BR')}`; return ` <div class="flex items-center justify-between bg-[var(--bg)] p-2 rounded-md"> <span class="text-sm"> <i class="fa-solid fa-database mr-2 text-[var(--text-muted)]"></i> Backup ${backup.reason} - ${formattedDate} </span> <div> <button data-backup-id="${backup.id}" class="download-backup-btn btn btn-secondary text-xs py-1 px-2"><i class="fa-solid fa-download"></i></button> <button data-backup-id="${backup.id}" class="delete-backup-btn btn btn-danger text-xs py-1 px-2"><i class="fa-solid fa-trash"></i></button> </div> </div> `; }).join('');
document.querySelectorAll('.download-backup-btn').forEach(btn => { btn.addEventListener('click', (e) => { const backupId = parseInt(e.currentTarget.dataset.backupId, 10); const backup = this.state.backups.find(b => b.id === backupId); if (backup) { const blob = new Blob([backup.content], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dateStr = new Date(backup.date).toISOString().split('T')[0]; a.download = `backup-estudos-${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } }); });
document.querySelectorAll('.delete-backup-btn').forEach(btn => { btn.addEventListener('click', (e) => { if (confirm('Tem certeza que deseja excluir este backup local?')) { const backupId = parseInt(e.currentTarget.dataset.backupId, 10); this.state.backups = this.state.backups.filter(b => b.id !== backupId); localStorage.setItem('studyDashBackupsV30', JSON.stringify(this.state.backups)); this.renderBackupList(); this.toast('Backup excluído.'); } }); }); },
importBackup(event) { const file = event.target.files[0]; if (!file) return;
const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.studyData && data.parameters) { if (confirm('Isso irá substituir seus dados na nuvem pelos dados do arquivo. Deseja continuar?')) { this.state.studyData = data.studyData; this.state.parameters = data.parameters; this.saveData(); this.toast('Backup importado com sucesso! Seus dados na nuvem foram atualizados.'); this.updateDashboard(); location.reload(); } } else { this.toast('Arquivo de backup inválido.', false); } } catch (error) { console.error('Erro ao importar backup:', error); this.toast('Erro ao ler o arquivo de backup.', false); } }; reader.readAsText(file); event.target.value = ''; },
bindFilters(){ document.getElementById('filter-subject').addEventListener('change', ()=> this.updateDashboard()); document.getElementById('filter-activity').addEventListener('change', ()=> this.updateDashboard()); document.getElementById('filter-start-date').addEventListener('change', ()=> this.updateDashboard()); document.getElementById('filter-end-date').addEventListener('change', ()=> this.updateDashboard()); document.querySelectorAll('#period-pills .pill').forEach(btn=>{ btn.addEventListener('click', (e)=> this.setFilterPeriod(e.target.dataset.period)); }); }, setFilterPeriod(period){ document.querySelectorAll('#period-pills .pill').forEach(p => p.classList.remove('active')); document.querySelector(`#period-pills .pill[data-period="${period}"]`).classList.add('active');
const sd = document.getElementById('filter-start-date'); const ed = document.getElementById('filter-end-date'); const today = new Date(); const fmt = d => d.toISOString().split('T')[0]; let start = new Date(); if(period==='today'){ start=today; } else if(period==='week'){ const day = today.getDay(); const weekStartDay = this.state.parameters.weekStartDay; const diff = today.getDate() - day + (day === 0 && weekStartDay === 1 ? -6 : weekStartDay); start = new Date(today.setDate(diff)); } else if(period==='month'){ start=new Date(today.getFullYear(), today.getMonth(), 1); } else if(period==='all'){ sd.value=''; ed.value=fmt(new Date()); this.updateDashboard(); return; } sd.value = fmt(start); ed.value = fmt(new Date()); this.updateDashboard(); }, getFilteredData(){ const subject = document.getElementById('filter-subject').value; const activity = document.getElementById('filter-activity').value; const start = document.getElementById('filter-start-date').value; const end = document.getElementById('filter-end-date').value; let data = this.state.studyData.slice(); if(subject && subject!=='all') data = data.filter(d=> d.subject===subject); if(activity && activity!=='all') data = data.filter(d=> d.activity===activity); if(start) data = data.filter(d=> d.date>=start); if(end) data = data.filter(d=> d.date<=end); return data; }, bindRegistro(){ const form = document.getElementById('study-form'); const cancelBtn = document.getElementById('cancel-edit-btn'); document.getElementById('activity-type').addEventListener('change', this.toggleQuestionsSection.bind(this)); document.getElementById('session-type').addEventListener('change', this.toggleFlowSection.bind(this)); document.getElementById('subject').addEventListener('change', () => this.populateSubtopicDropdown('subject', 'subtopic')); form.addEventListener('focusin', (e) => { if (e.target.matches('.question-input')) { this.state.activeQuestionInputId = e.target.id; } });
form.addEventListener('click', (e) => { if (e.target.classList.contains('duration-btn')) { const hoursInput = document.getElementById('manual-duration-hours'); const minutesInput = document.getElementById('manual-duration-minutes'); let currentH = parseInt(hoursInput.value) || 0; let currentM = parseInt(minutesInput.value) || 0;
if (e.target.dataset.h) { currentH += parseInt(e.target.dataset.h, 10); } if (e.target.dataset.m) { currentM += parseInt(e.target.dataset.m, 10); } hoursInput.value = currentH + Math.floor(currentM / 60); minutesInput.value = currentM % 60; }
if(e.target.classList.contains('question-btn-total') || e.target.classList.contains('question-btn-correct')) { if (this.state.activeQuestionInputId) { const input = document.getElementById(this.state.activeQuestionInputId); const amount = parseInt(e.target.dataset.q, 10); input.value = (parseInt(input.value, 10) || 0) + amount; } } });
document.querySelectorAll('#mood-tracker .mood-square-wrapper').forEach(wrapper => { wrapper.querySelector('button').addEventListener('click', (e) => { document.querySelectorAll('#mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); e.currentTarget.classList.add('selected'); document.getElementById('mood-input').value = e.currentTarget.dataset.mood; }); });
form.addEventListener('submit', (e)=>{ e.preventDefault(); const hours = parseInt(form['manual-duration-hours'].value, 10) || 0; const minutes = parseInt(form['manual-duration-minutes'].value, 10) || 0; const dur = (hours * 3600) + (minutes * 60);
if(dur <= 0) return this.toast('A duração deve ser maior que zero.', false);
const totalQ = parseInt(form['questions-total'].value, 10)||0; const correctQ = parseInt(form['questions-correct'].value, 10)||0; if(correctQ>totalQ) return this.toast('Nº de acertos não pode ser maior que o total.', false); const date = form.date.value; const timestamp = new Date(date); const timeOfDay = form['time-of-day'].value; if (timeOfDay === 'madrugada') timestamp.setHours(3, 0, 0, 0); else if (timeOfDay === 'manha') timestamp.setHours(9, 0, 0, 0); else if (timeOfDay === 'tarde') timestamp.setHours(15, 0, 0, 0); else if (timeOfDay === 'noite') timestamp.setHours(21, 0, 0, 0);
const itemData = { date: date, subject: form.subject.value, subtopic: form.subtopic.value || null, duration: dur, pauseDuration: 0, activity: form['activity-type'].value, totalQuestions: totalQ, correctQuestions: correctQ, accuracy: totalQ > 0 ? correctQ / totalQ : null, mood: form.mood.value || null, sessionType: form['session-type'].value, flowScore: form['session-type'].value === 'focada' ? parseInt(form['flow-score'].value, 10) : null, timestamp: timestamp.getTime(), timeOfDay: timeOfDay };
if(this.state.editingId) { const index = this.state.studyData.findIndex(s => s.id === this.state.editingId); if (index !== -1) { this.state.studyData[index] = { ...this.state.studyData[index], ...itemData }; } this.saveData(true, 'Sessão atualizada!'); this.resetForm(); } else { this.state.studyData.push({ ...itemData, id: Date.now() }); this.saveData(true, 'Sessão registrada!'); this.resetForm(); } this.renderSessionHistory(); if (this.state.currentView === 'dashboard') { this.updateDashboard(); } }); cancelBtn.addEventListener('click', () => this.resetForm()); }, resetForm() { const form = document.getElementById('study-form'); form.reset(); this.state.editingId = null; form.querySelector('button[type="submit"]').textContent = 'Salvar sessão'; document.getElementById('cancel-edit-btn').classList.add('hidden'); document.getElementById('mood-input').value=''; document.querySelectorAll('#mood-tracker .mood-square').forEach(b=> b.classList.remove('selected')); form.date.value = new Date().toISOString().split('T')[0]; this.populateSubtopicDropdown('subject', 'subtopic'); const hour = new Date().getHours(); const select = document.getElementById('time-of-day'); if(hour >= 0 && hour < 6) select.value = 'madrugada'; else if(hour >= 6 && hour < 12) select.value = 'manha'; else if(hour >= 12 && hour < 18) select.value = 'tarde'; else select.value = 'noite';
this.toggleQuestionsSection(); this.toggleFlowSection(); },
toggleQuestionsSection(){ const activity = document.getElementById('activity-type').value; const section = document.getElementById('questions-section'); const modalSection = document.getElementById('modal-questions-section'); const needed = (activity==='Exercícios' || activity==='Simulado'); section.classList.toggle('hidden', !needed); ['questions-total','questions-correct'].forEach(id=>{ const el = document.getElementById(id); el.required = needed; if(!needed){ el.value=''; } });
modalSection.classList.toggle('hidden', !needed); ['modal-questions-total','modal-questions-correct'].forEach(id=>{ const el = document.getElementById(id); el.required = needed; if(!needed){ el.value=''; } }); }, toggleFlowSection(){ const type = document.getElementById('session-type').value; document.getElementById('flow-score-section').classList.toggle('hidden', type!=='focada'); },
bindPomodoro(){ document.getElementById('pomodoro-start-pause').addEventListener('click', ()=> this.togglePomodoro()); document.getElementById('pomodoro-reset').addEventListener('click', ()=> this.resetPomodoro(true)); document.getElementById('pomodoro-skip').addEventListener('click', ()=> this.skipPomodoro()); document.getElementById('pomodoro-subject').addEventListener('change', () => this.populateSubtopicDropdown('pomodoro-subject', 'pomodoro-subtopic')); ['pomodoro-work-duration','pomodoro-short-break-duration','pomodoro-long-break-duration', 'pomodoro-alert-time', 'pomodoro-sound-select'].forEach(id=>{ const el = document.getElementById(id); if (el) el.addEventListener('change', ()=> this.savePomodoroSettings()); }); document.getElementById('pomodoro-auto-start').addEventListener('change', ()=> this.savePomodoroSettings()); }, updateAllSubjectDropdowns(){ const subjects = this.state.parameters.subjects.map(s => s.name); const opts = subjects.map(d=> `<option value="${d}">${d}</option>`).join(''); document.getElementById('subject').innerHTML = opts; this.populateSubtopicDropdown('subject', 'subtopic');
document.getElementById('pomodoro-subject').innerHTML = opts; this.populateSubtopicDropdown('pomodoro-subject', 'pomodoro-subtopic');
document.getElementById('stopwatch-subject').innerHTML = opts; this.populateSubtopicDropdown('stopwatch-subject', 'stopwatch-subtopic');
document.getElementById('filter-subject').innerHTML = '<option value="all">Todas as disciplinas</option>'+opts; }, populateSubtopicDropdown(subjectDropdownId, subtopicDropdownId) { const subjectName = document.getElementById(subjectDropdownId).value; const subtopicDropdown = document.getElementById(subtopicDropdownId); const subject = this.state.parameters.subjects.find(s => s.name === subjectName); subtopicDropdown.innerHTML = '<option value="">Nenhum</option>'; if(subject && subject.subtopics && subject.subtopics.length > 0) { const opts = subject.subtopics.map(sub => { const name = typeof sub === 'string' ? sub : sub.name; return `<option value="${name}">${name}</option>`; }).join(''); subtopicDropdown.innerHTML += opts; subtopicDropdown.disabled = false; } else { subtopicDropdown.disabled = true; } }, updateActivityDropdowns(){ const a = this.state.parameters.tiposDeAtividade; const opts = a.map(d=> `<option value="${d}">${d}</option>`).join(''); document.getElementById('activity-type').innerHTML = opts; document.getElementById('modal-activity-type').innerHTML = opts; document.getElementById('filter-activity').innerHTML = '<option value="all">Todos os tipos</option>'+opts; }, bindSubjectManagement() { document.getElementById('add-subject-btn').addEventListener('click', ()=>{ const input = document.getElementById('new-subject-input'); const name = input.value.trim(); const subjects = this.state.parameters.subjects; if(name && !subjects.find(s => s.name === name)){ subjects.push({ name: name, subtopics: [] }); this.ensureSubjectColors(); this.saveData(true, `Matéria "${name}" adicionada.`); this.renderSubjectsManagement(); this.updateAllSubjectDropdowns(); input.value=''; }else{ this.toast('Matéria já existe ou é inválida.', false); } });
const container = document.getElementById('subjects-management-container'); container.addEventListener('click', (e) => { const subjectCard = e.target.closest('[data-subject-name]'); if (!subjectCard) return; const subjectName = subjectCard.dataset.subjectName;
const shouldToggle = e.target.classList.contains('toggle-subtopics-btn') || (e.target.closest('.subject-header') && !e.target.closest('button, input, .drag-handle'));
if (shouldToggle) { const subtopicsContainer = subjectCard.querySelector('.subtopics-container'); if (subtopicsContainer.style.maxHeight) { subtopicsContainer.style.maxHeight = null; } else { subtopicsContainer.style.maxHeight = subtopicsContainer.scrollHeight + "px"; } }
if (e.target.classList.contains('remove-subject-btn')) { if(confirm(`Tem certeza que deseja remover a disciplina "${subjectName}" e TODOS os seus dados e assuntos associados?`)){ this.state.studyData = this.state.studyData.filter(d => d.subject !== subjectName); this.state.parameters.subjects = this.state.parameters.subjects.filter(s => s.name !== subjectName); delete this.state.parameters.subjectColors[subjectName]; this.saveData(true, `"${subjectName}" removida.`); this.renderSubjectsManagement(); this.updateAllSubjectDropdowns(); if (this.state.currentView === 'dashboard') this.updateDashboard(); } }
if (e.target.classList.contains('add-subtopic-btn')) { const input = container.querySelector(`input[data-subtopic-input-for="${subjectName}"]`); const subtopicName = input.value.trim(); const subject = this.state.parameters.subjects.find(s => s.name === subjectName); if (subtopicName && subject && !subject.subtopics.includes(subtopicName)) { subject.subtopics.push(subtopicName); subject.subtopics.sort(); this.saveData(true, `Assunto "${subtopicName}" adicionado.`); this.renderSubjectsManagement(); this.updateAllSubjectDropdowns(); input.value = ''; } else { this.toast('Assunto já existe ou é inválido.', false); } } if (e.target.classList.contains('remove-subtopic-btn')) { const subtopicName = e.target.dataset.subtopicName; const subject = this.state.parameters.subjects.find(s => s.name === subjectName); if (subject) { subject.subtopics = subject.subtopics.filter(st => st !== subtopicName); this.saveData(true, 'Assunto removido.'); this.renderSubjectsManagement(); this.updateAllSubjectDropdowns(); } } }); container.addEventListener('input', (e) => { if (e.target.classList.contains('subject-color-input')) { const subject = e.target.dataset.subject; const color = e.target.value; this.state.parameters.subjectColors[subject] = color; this.saveData(); this.updateCharts(this.getFilteredData()); } });
let draggedItem = null;
container.addEventListener('dragstart', (e) => { const target = e.target.closest('[draggable="true"]'); if (!target) return;
draggedItem = target;
setTimeout(() => { draggedItem.classList.add('dragging'); }, 0); });
container.addEventListener('dragend', () => { if(draggedItem) { draggedItem.classList.remove('dragging'); } draggedItem = null; });
const getDragAfterElement = (container, y) => { const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; };
container.addEventListener('dragover', e => { e.preventDefault(); if (!draggedItem) return;
const itemType = draggedItem.dataset.itemType; const dropZone = e.target.closest(itemType === 'subject' ? '#subjects-management-container' : '.subtopics-list'); if (!dropZone) return;
const afterElement = getDragAfterElement(dropZone, e.clientY); if (afterElement == null) { dropZone.appendChild(draggedItem); } else { dropZone.insertBefore(draggedItem, afterElement); } });
container.addEventListener('drop', (e) => { e.preventDefault(); if (!draggedItem) return;
const itemType = draggedItem.dataset.itemType; if (itemType === 'subject') { const newOrder = [...container.querySelectorAll('[data-item-type="subject"]')].map(el => el.dataset.subjectName); this.state.parameters.subjects.sort((a, b) => newOrder.indexOf(a.name) - newOrder.indexOf(b.name)); this.saveData(true, "Ordem das matérias atualizada."); } else if (itemType === 'subtopic') { const subtopicsList = draggedItem.closest('.subtopics-list'); const parentSubjectName = subtopicsList.dataset.parentSubject; const subject = this.state.parameters.subjects.find(s => s.name === parentSubjectName); if (subject) { const newOrder = [...subtopicsList.querySelectorAll('[data-item-type="subtopic"]')].map(el => el.dataset.subtopicName); subject.subtopics = newOrder; this.saveData(true, "Ordem dos assuntos atualizada."); } }
this.renderSubjectsManagement(); this.updateAllSubjectDropdowns(); });
const weekStartSelect = document.getElementById('week-start-day'); weekStartSelect.value = this.state.parameters.weekStartDay; weekStartSelect.addEventListener('change', (e) => { this.state.parameters.weekStartDay = parseInt(e.target.value, 10); this.saveData(true, 'Início da semana atualizado!'); this.updateDashboard(); });
document.getElementById('reset-all-data-btn').addEventListener('click', ()=>{ if(confirm('ATENÇÃO: Isso apagará TODOS os seus dados de estudo da NUVEM permanentemente. Deseja continuar?')){ const conf = prompt("Para confirmar, digite 'EXCLUIR' em maiúsculas."); if(conf==='EXCLUIR'){ if(this.state.userId) { this.state.db.ref('users/' + this.state.userId).remove() .then(() => { localStorage.removeItem('studyDashBackupsV30'); localStorage.removeItem('darkMode'); location.reload(); }) .catch(e => this.toast('Erro ao excluir dados da nuvem.', false)); } }else{ this.toast('Ação cancelada.', false); } } }); },
renderSubjectsManagement(){ const container = document.getElementById('subjects-management-container'); const openSubjects = new Set(); container.querySelectorAll('.subtopics-container').forEach(cont => { if (cont.style.maxHeight && cont.style.maxHeight !== '0px') { const subjectCard = cont.closest('[data-subject-name]'); if (subjectCard) { openSubjects.add(subjectCard.dataset.subjectName); } } });
container.innerHTML=''; this.state.parameters.subjects.forEach(subject => { const color = this.state.parameters.subjectColors[subject.name] || '#cccccc'; const subjectEl = document.createElement('div'); subjectEl.className = 'bg-[var(--bg)] p-3 rounded-md border border-[var(--border-color)]'; subjectEl.dataset.subjectName = subject.name; subjectEl.dataset.itemType = 'subject'; subjectEl.draggable = true;
const subtopicsHTML = subject.subtopics.map(st => { const name = typeof st === 'string' ? st : (st.name || ''); return ` <li class="flex justify-between items-center p-1 rounded-md hover:bg-[var(--border-color)]" draggable="true" data-item-type="subtopic" data-subtopic-name="${name}"> <span class="flex items-center gap-2"> <i class="fa-solid fa-grip-vertical text-[var(--text-muted)] drag-handle"></i> ${name} </span> <button data-subtopic-name="${name}" class="remove-subtopic-btn text-red-500 hover:text-red-700 text-xs font-bold p-1">&times;</button> </li> `; }).join('');
subjectEl.innerHTML = ` <div class="flex items-center justify-between subject-header cursor-pointer"> <span class="flex items-center gap-3 font-semibold"> <i class="fa-solid fa-grip-vertical text-[var(--text-muted)] drag-handle"></i> <input type="color" value="${color}" data-subject="${subject.name}" class="subject-color-input w-6 h-6 p-0 border-none rounded cursor-pointer"> ${subject.name} </span> <div> <button class="toggle-subtopics-btn btn btn-secondary text-xs py-1 px-2 mr-2">Assuntos</button> <button data-subject="${subject.name}" class="remove-subject-btn btn btn-danger text-xs py-1 px-2">Remover</button> </div> </div> <div class="subtopics-container"> <div class="pl-8 mt-3 pt-3 border-t"> <div class="flex items-center gap-2"> <input type="text" data-subtopic-input-for="${subject.name}" placeholder="Novo assunto" class="flex-grow text-sm shadow-sm"> <button class="add-subtopic-btn btn btn-secondary text-xs py-1 px-2">Adicionar</button> </div> <ul class="mt-2 space-y-1 text-sm text-[var(--text-muted)] subtopics-list" data-parent-subject="${subject.name}"> ${subtopicsHTML} </ul> </div> </div> `; container.appendChild(subjectEl);
if (openSubjects.has(subject.name)) { const subtopicsContainer = subjectEl.querySelector('.subtopics-container'); setTimeout(() => { if (subtopicsContainer) { subtopicsContainer.style.maxHeight = subtopicsContainer.scrollHeight + "px"; } }, 0); } }); },
async initAudio() { if (this.state.audioInitialized || typeof Tone === 'undefined') return; try { await Tone.start(); this.state.synth = new Tone.Synth().toDestination(); this.state.audioInitialized = true; this.state.backgroundAudio.volume = new Tone.Volume(-20).toDestination(); console.log('Audio context started.'); } catch(e) { console.error("Could not start audio context:", e); } },
playNotificationSound(timerType = 'pomodoro') { if (!this.state.audioInitialized || !this.state.synth) return; try { const soundSettings = timerType === 'pomodoro' ? this.state.pomodoro.settings : this.state.stopwatch.settings; const selectedSound = soundSettings.sound || 'notification'; const sequence = this.state.soundOptions[selectedSound]; const now = Tone.now(); sequence.forEach((note, i) => { this.state.synth.triggerAttackRelease(note, "8n", now + i * 0.2); }); } catch (e) { console.error("Error playing sound:", e); } },
resetPomodoro(resetCycles=false){ const p = this.state.pomodoro; clearInterval(p.intervalId); p.isRunning=false; p.isSessionActive=false; p.mode='work'; p.timeLeft = (p.settings.work*60); p.totalPauseTime = 0; p.pauseStartTime = null; p.currentTaskId = null; if(resetCycles){ p.cyclesCompleted = 0; p.pendingLogDuration = 0; } this.renderPomodoro(); this.renderTasks(); if (!this.state.stopwatch.isRunning) { document.title = 'Dashboard de Performance'; } }, savePomodoroSettings(){ const p = this.state.pomodoro; p.settings.work = parseInt(document.getElementById('pomodoro-work-duration').value, 10)||25; p.settings.shortBreak = parseInt(document.getElementById('pomodoro-short-break-duration').value, 10)||5; p.settings.longBreak = parseInt(document.getElementById('pomodoro-long-break-duration').value, 10)||15; p.settings.alertTime = parseInt(document.getElementById('pomodoro-alert-time').value, 10) || null; p.settings.sound = document.getElementById('pomodoro-sound-select').value; p.settings.autoStart = document.getElementById('pomodoro-auto-start').checked; this.saveData(); if(!p.isRunning){ if(p.mode==='work') p.timeLeft=p.settings.work*60; else if(p.mode==='short') p.timeLeft=p.settings.shortBreak*60; else if(p.mode==='long') p.timeLeft=p.settings.longBreak*60; this.renderPomodoro(); } }, togglePomodoro(){ this.initAudio(); const p = this.state.pomodoro; p.isRunning = !p.isRunning;
if(p.isRunning){ if(p.pauseStartTime) { p.totalPauseTime += Date.now() - p.pauseStartTime; p.pauseStartTime = null; } if(!p.isSessionActive){ p.isSessionActive=true; p.cycleStart = Date.now(); p.totalCycles = parseInt(document.getElementById('pomodoro-cycles').value, 10) || 4; p.sessionSubject = document.getElementById('pomodoro-subject').value; p.sessionSubtopic = document.getElementById('pomodoro-subtopic').value; } this.playNotificationSound('pomodoro'); p.intervalId = setInterval(()=> this.tickPomodoro(), 1000); }else{ clearInterval(p.intervalId); p.pauseStartTime = Date.now(); } this.renderPomodoro(); }, skipPomodoro(){ const p = this.state.pomodoro; clearInterval(p.intervalId); p.isRunning = false; p.pauseStartTime = null; this.playNotificationSound('pomodoro'); if(p.isSessionActive && p.mode === 'work'){ this.handlePomodoroWorkEnd(); } else { this.showNotificationModal('Pausa pulada!', ''); this.advancePomodoro(); } }, tickPomodoro(){ const p = this.state.pomodoro; if (!p.isRunning) return;
p.timeLeft--; const alertTimeInSeconds = p.settings.alertTime ? p.settings.alertTime * 60 : null; if(alertTimeInSeconds && p.timeLeft === alertTimeInSeconds) { this.playNotificationSound('pomodoro'); this.showNotificationModal('Atenção!', `Faltam ${p.settings.alertTime} minutos para acabar o ${p.mode === 'work' ? 'foco' : 'descanso'}.`); } if(p.timeLeft <= 0){ p.timeLeft = 0; this.renderPomodoro(); clearInterval(p.intervalId); p.isRunning = false; p.pauseStartTime = null; this.playNotificationSound('pomodoro'); if (p.mode === 'work') { this.handlePomodoroWorkEnd(); } else { this.showNotificationModal('Pausa finalizada!', 'Hora de voltar ao foco.'); this.advancePomodoro(); if(p.settings.autoStart){ setTimeout(() => this.togglePomodoro(), 500); } } return; } this.renderPomodoro(); }, handlePomodoroWorkEnd() { const p = this.state.pomodoro; const durationOfWorkCycle = p.settings.work * 60; p.pendingLogDuration += durationOfWorkCycle;
if(p.currentTaskId) { const task = this.state.parameters.tasks.find(t => t.id === p.currentTaskId); if(task) { task.completedPomodoros = (task.completedPomodoros || 0) + 1; if(task.completedPomodoros >= task.estPomodoros && !task.isComplete) { this.toggleTaskComplete(task.id); this.toast(`Tarefa "${task.name}" concluída!`);
const tasks = this.state.parameters.tasks; const currentIndex = tasks.findIndex(t => t.id === task.id); let nextTask = null;
for (let i = currentIndex + 1; i < tasks.length; i++) { if (!tasks[i].isComplete) { nextTask = tasks[i]; break; } }
if (!nextTask) { for (let i = 0; i < currentIndex; i++) { if (!tasks[i].isComplete) { nextTask = tasks[i]; break; } } }
if (nextTask) { p.currentTaskId = nextTask.id; this.toast(`Próxima tarefa: ${nextTask.name}`); } else { p.currentTaskId = null; } } this.renderTasks(); this.saveData(); } } this.advancePomodoro();
if(p.settings.autoStart && p.mode !== 'work'){ setTimeout(() => this.togglePomodoro(), 500); } }, advancePomodoro(){ const p = this.state.pomodoro; clearInterval(p.intervalId); p.isRunning = false; p.pauseStartTime = null; p.cycleStart = Date.now();
if(p.mode==='work'){ p.cyclesCompleted++; const isLongBreak = (p.cyclesCompleted > 0 && p.cyclesCompleted % p.totalCycles === 0); p.mode = isLongBreak ? 'long' : 'short'; if (isLongBreak && p.pendingLogDuration > 0) {
const totalDurationInSeconds = p.pendingLogDuration + (p.totalPauseTime / 1000); const pauseDurationInSeconds = p.totalPauseTime / 1000; this.openSessionModal(totalDurationInSeconds, p.sessionSubject, p.sessionSubtopic, pauseDurationInSeconds); p.pendingLogDuration = 0; p.totalPauseTime = 0; }
} else { p.mode='work'; } p.timeLeft = this.modeSeconds(p.mode); this.renderPomodoro(); }, modeSeconds(mode){ const s = this.state.pomodoro.settings; if(mode==='work') return s.work*60; if(mode==='short') return s.shortBreak*60; if(mode==='long') return s.longBreak*60; return 0; }, renderPomodoro(){ const p = this.state.pomodoro; document.getElementById('pomodoro-timer-display').textContent = this.formatTime(p.timeLeft, 'ms'); if(p.isRunning || p.isSessionActive) { document.title = `${this.formatTime(p.timeLeft, 'ms')} - ${p.mode==='work' ? 'Foco' : 'Pausa'}`; } else if (!this.state.stopwatch.isRunning) { document.title = 'Dashboard de Performance'; } const pauseDisplay = document.getElementById('pomodoro-pause-display'); if (p.totalPauseTime > 0 || p.pauseStartTime) { let currentPause = p.totalPauseTime; if (p.pauseStartTime) currentPause += Date.now() - p.pauseStartTime; pauseDisplay.textContent = `Pausa total: ${this.formatTime(currentPause / 1000, 'hms_seconds')}`; } else { pauseDisplay.textContent = ''; }
let statusText = 'Pronto para começar'; if(p.isSessionActive) { if (p.mode === 'work') statusText = 'Foco'; else if (p.mode === 'short') statusText = 'Pausa Curta'; else if (p.mode === 'long') statusText = 'Pausa Longa'; } document.getElementById('pomodoro-status').textContent = statusText;
if(p.isRunning){ document.getElementById('pomodoro-start-pause').textContent='Pausar'; const end = new Date(Date.now()+p.timeLeft*1000); const hh = String(end.getHours()).padStart(2,'0'); const mm2 = String(end.getMinutes()).padStart(2,'0'); document.getElementById('pomodoro-end-time').textContent = `Termina às ${hh}:${mm2}`; }else{ document.getElementById('pomodoro-start-pause').textContent= p.isSessionActive ? 'Retomar' : 'Iniciar'; document.getElementById('pomodoro-end-time').textContent = ''; }
const dots = document.getElementById('pomodoro-cycle-dots'); dots.innerHTML=''; const total = p.totalCycles; for(let i=0; i<total; i++){ const d = document.createElement('div'); d.className = 'cycle-dot' + (i < p.cyclesCompleted ? ' done' : '') + (i === p.cyclesCompleted && p.mode === 'work' && p.isSessionActive ? ' active':''); dots.appendChild(d); }
const currentTaskDisplay = document.getElementById('current-task-display'); if(p.currentTaskId) { const task = this.state.parameters.tasks.find(t => t.id === p.currentTaskId); if(task) { currentTaskDisplay.textContent = `Foco em: ${task.name}`; } else { currentTaskDisplay.textContent = 'Nenhuma tarefa selecionada'; } } else { currentTaskDisplay.textContent = 'Nenhuma tarefa selecionada'; }
this.updatePipView(); }, bindStopwatch() { document.getElementById('stopwatch-start-pause').addEventListener('click', () => this.toggleStopwatch()); document.getElementById('stopwatch-log').addEventListener('click', () => this.logStopwatch()); document.getElementById('stopwatch-reset').addEventListener('click', () => this.resetStopwatch()); document.getElementById('stopwatch-subject').addEventListener('change', () => this.populateSubtopicDropdown('stopwatch-subject', 'stopwatch-subtopic')); document.getElementById('stopwatch-alert-hours').addEventListener('change', () => this.setStopwatchAlert()); document.getElementById('stopwatch-alert-minutes').addEventListener('change', () => this.setStopwatchAlert()); document.getElementById('stopwatch-sound-select').addEventListener('change', (e) => { this.state.stopwatch.settings.sound = e.target.value; this.saveData(); }); }, toggleStopwatch() { this.initAudio(); const sw = this.state.stopwatch; sw.isRunning = !sw.isRunning; if (sw.isRunning) { if(sw.pauseStartTime) { const pauseDuration = Date.now() - sw.pauseStartTime; sw.totalPauseTime += pauseDuration; sw.startTime += pauseDuration; sw.pauseStartTime = null; } else { if(sw.elapsedTime === 0){ this.playNotificationSound('stopwatch'); } sw.startTime = Date.now() - sw.elapsedTime; } sw.intervalId = setInterval(() => this.tickStopwatch(), 1000); document.getElementById('stopwatch-start-pause').textContent = 'Pausar'; } else { clearInterval(sw.intervalId); sw.pauseStartTime = Date.now(); document.getElementById('stopwatch-start-pause').textContent = 'Retomar'; } }, resetStopwatch() { const sw = this.state.stopwatch; clearInterval(sw.intervalId); sw.isRunning = false; sw.elapsedTime = 0; sw.alertTime = null; sw.alertTriggered = false; sw.totalPauseTime = 0; sw.pauseStartTime = null; this.renderStopwatch(); document.getElementById('stopwatch-start-pause').textContent = 'Iniciar'; document.getElementById('stopwatch-alert-hours').value = ''; document.getElementById('stopwatch-alert-minutes').value = ''; document.title = 'Dashboard de Performance'; }, tickStopwatch() { const sw = this.state.stopwatch; if (!sw.isRunning) return; sw.elapsedTime = Date.now() - sw.startTime; if (sw.alertTime && !sw.alertTriggered && (sw.elapsedTime / 1000) >= sw.alertTime) { this.playNotificationSound('stopwatch'); this.showNotificationModal('Cronômetro', 'O tempo definido foi atingido!'); sw.alertTriggered = true; } this.renderStopwatch(); }, renderStopwatch() { const sw = this.state.stopwatch; const time = sw.elapsedTime; const timeString = this.formatTime(time / 1000, 'hms_seconds'); document.getElementById('stopwatch-display').textContent = timeString;
const pauseDisplay = document.getElementById('stopwatch-pause-display'); if (sw.totalPauseTime > 0 || sw.pauseStartTime) { let currentPause = sw.totalPauseTime; if (sw.pauseStartTime) currentPause += Date.now() - sw.pauseStartTime; pauseDisplay.textContent = `Pausa total: ${this.formatTime(currentPause / 1000, 'hms_seconds')}`; } else { pauseDisplay.textContent = ''; }
if (sw.isRunning || sw.elapsedTime > 0) { document.title = `${timeString} - Cronômetro`; } else if (!this.state.pomodoro.isRunning && !this.state.pomodoro.isSessionActive) { document.title = 'Dashboard de Performance'; }
this.updatePipView(); }, logStopwatch() { const sw = this.state.stopwatch; const totalDuration = sw.elapsedTime; if (totalDuration < 60000) return this.toast('A sessão precisa ter no mínimo 1 minuto de tempo total.', false); clearInterval(sw.intervalId); this.playNotificationSound('stopwatch'); const durationInSeconds = Math.floor(totalDuration / 1000); const pauseInSeconds = Math.floor(sw.totalPauseTime / 1000); const subject = document.getElementById('stopwatch-subject').value; const subtopic = document.getElementById('stopwatch-subtopic').value; this.openSessionModal(durationInSeconds, subject, subtopic, pauseInSeconds); this.resetStopwatch(); }, setStopwatchAlert() { const sw = this.state.stopwatch; const hours = parseInt(document.getElementById('stopwatch-alert-hours').value, 10) || 0;
const minutes = parseInt(document.getElementById('stopwatch-alert-minutes').value, 10) || 0; const totalSeconds = (hours * 3600) + (minutes * 60);
if (totalSeconds > 0 && totalSeconds > (sw.elapsedTime / 1000)) { sw.alertTime = totalSeconds; sw.alertTriggered = false; this.toast('Alerta definido!'); } else { sw.alertTime = null; sw.alertTriggered = false; if (hours > 0 || minutes > 0) { this.toast('Tempo de alerta inválido ou já passou.', false); } } }, bindModal() { const form = document.getElementById('modal-session-form'); document.getElementById('modal-cancel-btn').addEventListener('click', () => this.closeSessionModal(true)); document.getElementById('session-modal-backdrop').addEventListener('click', () => this.closeSessionModal(true)); document.getElementById('modal-activity-type').addEventListener('change', (e) => { const section = document.getElementById('modal-questions-section'); const needed = (e.target.value === 'Exercícios' || e.target.value === 'Simulado'); section.classList.toggle('hidden', !needed); });
form.addEventListener('focusin', (e) => { if (e.target.matches('.modal-question-input')) { this.state.activeModalQuestionInputId = e.target.id; } });
form.addEventListener('click', (e) => { if(e.target.classList.contains('modal-question-btn-total')) { const qTotalInput = document.getElementById('modal-questions-total'); const amount = parseInt(e.target.dataset.q, 10); qTotalInput.value = (parseInt(qTotalInput.value, 10) || 0) + amount; } if(e.target.classList.contains('modal-question-btn-correct')) { const qCorrectInput = document.getElementById('modal-questions-correct'); const amount = parseInt(e.target.dataset.q, 10); qCorrectInput.value = (parseInt(qCorrectInput.value, 10) || 0) + amount; } });
document.querySelectorAll('#modal-mood-tracker .mood-square-wrapper').forEach(wrapper => { wrapper.querySelector('button').addEventListener('click', (e) => { document.querySelectorAll('#modal-mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); e.currentTarget.classList.add('selected'); document.getElementById('modal-mood-input').value = e.currentTarget.dataset.mood; }); });
form.addEventListener('submit', (e) => { e.preventDefault(); const session = this.state.pendingSession; if (!session) return;
const totalQ = parseInt(form['modal-questions-total'].value, 10) || 0; const correctQ = parseInt(form['modal-questions-correct'].value, 10) || 0; if (correctQ > totalQ) return this.toast('Nº de acertos não pode ser maior que o total.', false); const hour = new Date().getHours(); let timeOfDay = 'manha'; if(hour >= 0 && hour < 6) timeOfDay = 'madrugada'; else if(hour >= 12 && hour < 18) timeOfDay = 'tarde'; else if (hour >= 18) timeOfDay = 'noite';
const finalSession = { ...session, activity: form['modal-activity-type'].value, totalQuestions: totalQ, correctQuestions: correctQ, accuracy: totalQ > 0 ? correctQ / totalQ : null, mood: form['modal-mood-input'].value || null, flowScore: parseInt(form['modal-flow-score'].value, 10), sessionType: 'focada', timestamp: Date.now(), timeOfDay: timeOfDay };
this.state.studyData.push(finalSession); this.saveData(true, 'Sessão registrada com sucesso!'); this.closeSessionModal(false); if (this.state.currentView === 'dashboard') { this.updateDashboard(); } this.renderSessionHistory(); }); },
openSessionModal(durationInSeconds, subject, subtopic = null, pauseDurationInSeconds = 0) { this.state.pendingSession = { id: Date.now(), date: new Date().toISOString().split('T')[0], duration: durationInSeconds, pauseDuration: pauseDurationInSeconds, subject: subject, subtopic: subtopic || null }; const subtopicText = subtopic ? ` (${subtopic})` : ''; document.getElementById('modal-session-info').textContent = `Registrando ${this.formatTime(durationInSeconds)} para ${subject}${subtopicText}`; document.getElementById('modal-session-form').reset(); document.querySelectorAll('#modal-mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); document.getElementById('modal-questions-section').classList.add('hidden');
document.getElementById('session-modal-backdrop').classList.remove('hidden'); document.getElementById('session-modal-panel').classList.remove('hidden'); },
closeSessionModal(isCancel) { this.state.pendingSession = null; document.getElementById('session-modal-backdrop').classList.add('hidden'); document.getElementById('session-modal-panel').classList.add('hidden'); if (this.state.pomodoro.isSessionActive) { if (isCancel) { this.toast('Sessão não registrada.', false); } if (this.state.pomodoro.settings.autoStart && this.state.pomodoro.mode !== 'work') { this.togglePomodoro(); } } }, bindNotificationModal() { document.getElementById('notification-ok-btn').addEventListener('click', () => this.closeNotificationModal()); document.getElementById('notification-modal-backdrop').addEventListener('click', () => this.closeNotificationModal()); }, showNotificationModal(title, message) { document.getElementById('notification-title').textContent = title; document.getElementById('notification-message').textContent = message; document.getElementById('notification-modal-backdrop').classList.remove('hidden'); document.getElementById('notification-modal-panel').classList.remove('hidden'); }, closeNotificationModal() { document.getElementById('notification-modal-backdrop').classList.add('hidden'); document.getElementById('notification-modal-panel').classList.add('hidden'); },
bindPip() { const pip = this.state.pip; pip.video = document.getElementById('pip-video'); pip.canvas = document.getElementById('pip-canvas'); pip.ctx = pip.canvas.getContext('2d'); document.getElementById('pomodoro-open-mini').addEventListener('click', () => this.togglePictureInPicture()); document.getElementById('stopwatch-open-mini').addEventListener('click', () => this.togglePictureInPicture());
pip.video.addEventListener('leavepictureinpicture', () => { pip.isActive = false; }); },
async togglePictureInPicture() { const pip = this.state.pip; this.updatePipView();
try { if (document.pictureInPictureElement) { await document.exitPictureInPicture(); pip.isActive = false; } else { if (!pip.video.srcObject) { const stream = pip.canvas.captureStream(); pip.video.srcObject = stream; } await pip.video.play(); await pip.video.requestPictureInPicture(); pip.isActive = true; } } catch (error) { console.error("Erro ao controlar Picture-in-Picture:", error); this.toast('Seu navegador não suporta o timer flutuante, ou a permissão foi negada.', false); } },
updatePipView() { if (!this.state.pip.canvas) return; const pip = this.state.pip; const ctx = pip.ctx; ctx.clearRect(0, 0, pip.canvas.width, pip.canvas.height); ctx.fillStyle = this.state.parameters.darkMode ? '#1e1e1e' : '#FDFBF7'; ctx.fillRect(0, 0, pip.canvas.width, pip.canvas.height);
let title = 'Timer'; let timeString = '00:00'; let subjectString = 'Nenhuma sessão ativa';
if (this.state.pomodoro.isSessionActive || this.state.pomodoro.isRunning) { const p = this.state.pomodoro; timeString = this.formatTime(p.timeLeft, 'ms'); title = p.mode === 'work' ? 'Foco' : (p.mode === 'short' ? 'Pausa Curta' : 'Pausa Longa'); subjectString = p.sessionSubject || 'Pomodoro'; } else if (this.state.stopwatch.isRunning || this.state.stopwatch.elapsedTime > 0) { const sw = this.state.stopwatch; timeString = this.formatTime(sw.elapsedTime/1000, 'hms_seconds'); title = 'Cronômetro'; subjectString = document.getElementById('stopwatch-subject').value || 'Sessão livre'; }
ctx.fillStyle = this.state.parameters.darkMode ? '#e0e0e0' : '#3D405B'; ctx.textAlign = 'center'; ctx.font = '600 24px Inter'; ctx.fillText(title, 150, 45); ctx.font = '900 80px Inter'; ctx.fillText(timeString, 150, 125); ctx.font = '500 18px Inter'; ctx.fillStyle = this.state.parameters.darkMode ? '#9ca3af' : '#6B7280'; ctx.fillText(subjectString, 150, 160); },
bindBackgroundSounds() { const controls = document.getElementById('background-sound-controls'); const volumeSlider = document.getElementById('background-sound-volume');
controls.addEventListener('click', async (e) => { const button = e.target.closest('.sound-btn'); if (!button) return;
await this.initAudio();
if(this.state.youtubePlayer && typeof this.state.youtubePlayer.stopVideo === 'function'){ this.state.youtubePlayer.stopVideo(); } document.querySelectorAll('.sound-btn, .youtube-music-item').forEach(btn => btn.classList.remove('active', 'bg-gray-200')); button.classList.add('active');
const sound = button.dataset.sound;
if (this.state.backgroundAudio.player) { this.state.backgroundAudio.player.stop(); this.state.backgroundAudio.player.dispose(); this.state.backgroundAudio.player = null; }
if (sound === 'off') { return; }
if (sound === 'white' || sound === 'brown') { this.state.backgroundAudio.player = new Tone.Noise(sound).connect(this.state.backgroundAudio.volume); this.state.backgroundAudio.player.start(); } });
volumeSlider.addEventListener('input', async (e) => { await this.initAudio(); if(this.state.backgroundAudio.volume) { this.state.backgroundAudio.volume.volume.value = e.target.value; } if(this.state.youtubePlayer && typeof this.state.youtubePlayer.setVolume === 'function') { const newVolume = 100 * Math.pow(10, e.target.value / 20); this.state.youtubePlayer.setVolume(newVolume); } }); },
bindTasks() { document.getElementById('add-task-form').addEventListener('submit', (e) => { e.preventDefault(); const nameInput = document.getElementById('new-task-input'); const pomodorosInput = document.getElementById('new-task-pomodoros'); const name = nameInput.value.trim(); const estPomodoros = parseInt(pomodorosInput.value, 10) || 1; if (name) { this.state.parameters.tasks.push({ id: Date.now(), name, estPomodoros, completedPomodoros: 0, isComplete: false }); nameInput.value = ''; pomodorosInput.value = '1'; this.renderTasks(); this.saveData(); } });
document.getElementById('task-list-container').addEventListener('click', (e) => { const taskItem = e.target.closest('.task-item'); if (!taskItem) return; const taskId = parseInt(taskItem.dataset.taskId, 10);
if (e.target.closest('.task-complete-btn')) { this.toggleTaskComplete(taskId); } else if (e.target.closest('.delete-task-btn')) { if (confirm('Tem certeza que deseja remover esta tarefa?')) { this.state.parameters.tasks = this.state.parameters.tasks.filter(t => t.id !== taskId); if (this.state.pomodoro.currentTaskId === taskId) { this.state.pomodoro.currentTaskId = null; } this.renderTasks(); this.renderPomodoro(); this.saveData(); } } else if (e.target.closest('.edit-task-btn')) { const task = this.state.parameters.tasks.find(t => t.id === taskId); if(task) { const newName = prompt('Editar nome da tarefa:', task.name); const newEst = prompt('Editar pomodoros estimados:', task.estPomodoros); if (newName !== null && newName.trim() !== '') { task.name = newName.trim(); } if (newEst !== null && !isNaN(parseInt(newEst, 10)) && parseInt(newEst, 10) > 0) { task.estPomodoros = parseInt(newEst, 10); } this.renderTasks(); this.saveData(); } } else { this.selectTask(taskId); } });
document.getElementById('clear-completed-tasks-btn').addEventListener('click', () => { this.state.parameters.tasks = this.state.parameters.tasks.filter(t => !t.isComplete); this.renderTasks(); this.saveData(); }); document.getElementById('clear-all-tasks-btn').addEventListener('click', () => { if (confirm('Tem certeza que deseja remover TODAS as tarefas?')) { this.state.parameters.tasks = []; this.state.pomodoro.currentTaskId = null; this.renderTasks(); this.renderPomodoro(); this.saveData(); } }); },
renderTasks() { const container = document.getElementById('task-list-container'); container.innerHTML = ''; const tasks = this.state.parameters.tasks; if (tasks.length === 0) { container.innerHTML = `<p class="text-sm text-center text-[var(--text-muted)]">Nenhuma tarefa adicionada ainda.</p>`; return; }
tasks.forEach(task => { const item = document.createElement('div'); item.className = 'task-item'; item.dataset.taskId = task.id; if (task.isComplete) item.classList.add('completed'); if (task.id === this.state.pomodoro.currentTaskId) item.classList.add('selected');
item.innerHTML = ` <button class="task-complete-btn"> ${task.isComplete ? '<i class="fa-solid fa-check"></i>' : ''} </button> <span class="task-name">${task.name}</span> <span class="task-item-pomodoros">${task.completedPomodoros} / ${task.estPomodoros}</span> <div class="task-actions"> <button class="edit-task-btn" title="Editar tarefa"><i class="fa-solid fa-pencil"></i></button> <button class="delete-task-btn" title="Remover tarefa"><i class="fa-solid fa-trash"></i></button> </div> `;
container.appendChild(item); }); },
selectTask(taskId) { this.state.pomodoro.currentTaskId = taskId; this.renderTasks(); this.renderPomodoro(); },
toggleTaskComplete(taskId) { const task = this.state.parameters.tasks.find(t => t.id === taskId); if (task) { task.isComplete = !task.isComplete; } this.renderTasks(); this.saveData(); },
async bindYouTubeMusic() { document.getElementById('add-youtube-url-btn').addEventListener('click', async () => { const input = document.getElementById('youtube-url-input'); const url = input.value.trim(); const videoId = this.extractYouTubeVideoID(url); if (videoId) { try { const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`); const data = await response.json(); const title = data.title || videoId; this.state.parameters.youtubeMusic.push({ id: Date.now(), videoId, name: title }); this.saveData(); this.renderYouTubeMusicList(); input.value = ''; } catch(e) { this.toast('Não foi possível buscar o título do vídeo.', false); this.state.parameters.youtubeMusic.push({ id: Date.now(), videoId, name: videoId }); this.saveData(); this.renderYouTubeMusicList(); input.value = ''; } } else { this.toast('URL do YouTube inválida.', false); } });
document.getElementById('youtube-music-list').addEventListener('click', e => { const item = e.target.closest('.youtube-music-item'); if(!item) return; const musicId = parseInt(item.dataset.musicId, 10);
if(e.target.closest('.play-youtube-btn')) { const videoId = item.dataset.videoId; this.playYouTubeVideo(videoId, musicId); document.querySelectorAll('.sound-btn, .youtube-music-item').forEach(btn => btn.classList.remove('active', 'bg-gray-200')); item.classList.add('active', 'bg-gray-200'); } else if (e.target.closest('.delete-youtube-btn')) { if(this.state.currentMusicId === musicId) this.stopYouTubeVideo(); this.state.parameters.youtubeMusic = this.state.parameters.youtubeMusic.filter(m => m.id !== musicId); this.saveData(); this.renderYouTubeMusicList(); } else if(e.target.closest('.edit-youtube-btn')) { const music = this.state.parameters.youtubeMusic.find(m => m.id === musicId); if(music) { const newName = prompt('Editar nome da música:', music.name); if(newName && newName.trim() !== ''){ music.name = newName.trim(); this.saveData(); this.renderYouTubeMusicList(); } } } }); document.getElementById('skip-youtube-btn').addEventListener('click', () => this.playNextYouTubeVideo()); },
renderYouTubeMusicList() { const container = document.getElementById('youtube-music-list'); if (!container) return; container.innerHTML = ''; if (this.state.parameters.youtubeMusic.length === 0) { container.innerHTML = '<p class="text-xs text-center text-gray-400">Nenhuma música salva.</p>'; return; }
this.state.parameters.youtubeMusic.forEach(music => { const item = document.createElement('div'); item.className = 'youtube-music-item flex justify-between items-center p-1 rounded hover:bg-[var(--border-color)]'; item.dataset.videoId = music.videoId; item.dataset.musicId = music.id; if(music.id === this.state.currentMusicId) item.classList.add('active'); item.innerHTML = ` <span class="truncate text-xs flex-grow ml-2">${music.name}</span> <div class="flex-shrink-0"> <button class="play-youtube-btn p-1 text-gray-500 hover:text-green-500"><i class="fa-solid fa-play"></i></button> <button class="edit-youtube-btn p-1 text-gray-500 hover:text-blue-500"><i class="fa-solid fa-pencil"></i></button> <button class="delete-youtube-btn p-1 text-gray-500 hover:text-red-500"><i class="fa-solid fa-trash"></i></button> </div> `; container.appendChild(item); }); },
playYouTubeVideo(videoId, musicId) { if (this.state.backgroundAudio.player) { this.state.backgroundAudio.player.stop(); }
if(this.state.youtubePlayer && typeof this.state.youtubePlayer.loadVideoById === 'function') { this.state.youtubePlayer.loadVideoById(videoId); this.state.youtubePlayer.playVideo(); this.state.currentMusicId = musicId; this.renderYouTubeMusicList(); } },
stopYouTubeVideo(){ if(this.state.youtubePlayer && typeof this.state.youtubePlayer.stopVideo === 'function'){ this.state.youtubePlayer.stopVideo(); this.state.currentMusicId = null; this.renderYouTubeMusicList(); } },
onPlayerStateChange(event) { if (event.data === YT.PlayerState.ENDED) { this.playNextYouTubeVideo(); } },
playNextYouTubeVideo() { const musicList = this.state.parameters.youtubeMusic; if (musicList.length === 0) return; const currentIndex = musicList.findIndex(m => m.id === this.state.currentMusicId); let nextIndex = currentIndex + 1; if (nextIndex >= musicList.length) { nextIndex = 0; } if(musicList[nextIndex]) { const nextMusic = musicList[nextIndex]; this.playYouTubeVideo(nextMusic.videoId, nextMusic.id); } },
extractYouTubeVideoID(url) { const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?/; const match = url.match(regex); return match ? match[1] : null; },
renderSessionHistory() { const listContainer = document.getElementById('session-history-list'); if (!listContainer) return; listContainer.innerHTML = '';
const sortedData = [...this.state.studyData].sort((a, b) => b.id - a.id);
if (sortedData.length === 0) { listContainer.innerHTML = '<p class="text-sm text-[var(--text-muted)]">Nenhuma sessão registrada ainda.</p>'; return; }
sortedData.slice(0, 10).forEach(session => { const el = document.createElement('div'); el.className = 'flex items-center justify-between bg-[var(--bg)] p-3 rounded-md text-sm transition-all hover:bg-[var(--border-color)]'; const sessionDate = new Date(session.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); const sessionTime = this.formatTime(session.duration); const subtopicText = session.subtopic ? ` <span class="text-[var(--text-muted)] text-xs">(${session.subtopic})</span>` : ''; el.innerHTML = ` <div> <span class="font-semibold">${session.subject}</span>${subtopicText} <span class="text-[var(--text-muted)] ml-2">${sessionDate} - ${sessionTime}</span> </div> <div class="flex gap-2"> <button class="edit-btn btn btn-secondary text-xs py-1 px-2">Editar</button> <button class="delete-btn btn btn-danger text-xs py-1 px-2">Excluir</button> </div> `;
el.querySelector('.delete-btn').addEventListener('click', () => { if (confirm('Tem certeza que deseja excluir esta sessão?')) { this.state.studyData = this.state.studyData.filter(s => s.id !== session.id); this.saveData(true, 'Sessão excluída.'); this.renderSessionHistory(); this.updateDashboard(); } });
el.querySelector('.edit-btn').addEventListener('click', () => { this.state.editingId = session.id; const form = document.getElementById('study-form'); form.date.value = session.date; form.subject.value = session.subject; this.populateSubtopicDropdown('subject', 'subtopic'); form.subtopic.value = session.subtopic || '';
form['manual-duration-hours'].value = Math.floor(session.duration / 3600); form['manual-duration-minutes'].value = Math.round((session.duration % 3600) / 60); form['activity-type'].value = session.activity; form['session-type'].value = session.sessionType; form['time-of-day'].value = session.timeOfDay || 'manha'; this.toggleQuestionsSection(); this.toggleFlowSection(); form['questions-total'].value = session.totalQuestions || ''; form['questions-correct'].value = session.correctQuestions || ''; form['flow-score'].value = session.flowScore || 3; document.querySelectorAll('#mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); if (session.mood) { const moodBtn = document.querySelector(`#mood-tracker .mood-square[data-mood="${session.mood}"]`); if (moodBtn) moodBtn.classList.add('selected'); } document.getElementById('mood-input').value = session.mood || '';
form.querySelector('button[type="submit"]').textContent = 'Atualizar Sessão'; document.getElementById('cancel-edit-btn').classList.remove('hidden'); document.getElementById('registration-card').scrollIntoView({ behavior: 'smooth', block: 'center' }); });
listContainer.appendChild(el); }); },
updateDashboard(){ if(this.state.currentView !== 'dashboard' || !this.state.dataLoaded) return; const data = this.getFilteredData(); const allData = this.state.studyData; const sd = document.getElementById('filter-start-date').value; const ed = document.getElementById('filter-end-date').value; const pd = document.getElementById('dashboard-period-display'); if(sd && ed){ const start = new Date(sd).toLocaleDateString('pt-BR',{timeZone:'UTC'}); const end = new Date(ed).toLocaleDateString('pt-BR',{timeZone:'UTC'}); pd.textContent = `Exibindo dados de ${start} a ${end}.`; } else { pd.textContent = `Exibindo todos os dados.`; }
const metrics = this.precomputeMetrics(data, allData); document.getElementById('total-hours').textContent = this.formatTime(metrics.totalSec); document.getElementById('avg-accuracy').textContent = `${(metrics.accAvg*100).toFixed(0)}%`; document.getElementById('avg-session-duration').textContent = this.formatTime(metrics.avgSessSec); document.getElementById('deep-work-ratio').textContent = `${metrics.deepRatio.toFixed(0)}%`;
this.updatePersonalBests(allData); this.updateWeeklyGoals(allData); this.updateStreaksAndHeatmap(allData); this.updateCharts(data, allData); this.updateStrengthsWeaknessesDetails(allData); this.generateInsights(data, allData); this.renderDetailedLog(data); this.renderBackupList(); }, precomputeMetrics(data, allData) { const totalSec = data.reduce((s,i)=>s+i.duration,0); const sessionsWithAcc = data.filter(i => typeof i.accuracy === 'number'); const totalAccuracySum = sessionsWithAcc.reduce((sum, item) => sum + item.accuracy, 0); const accAvg = sessionsWithAcc.length > 0 ? totalAccuracySum / sessionsWithAcc.length : 0;
const avgSessSec = data.length? totalSec/data.length : 0; const deepSec = data.filter(s=> s.sessionType==='focada').reduce((x,y)=>x+y.duration,0); const deepRatio = totalSec? (deepSec/totalSec)*100:0; return { totalSec, accAvg, avgSessSec, deepRatio }; },
updatePersonalBests(allData) { const records = { hoursDay: { value: 0, date: '-' }, accuracy: { value: 0, date: '-' }, hoursMonth: { value: 0, date: '-' } };
if (allData.length > 0) { const hoursByDay = allData.reduce((acc, s) => { acc[s.date] = (acc[s.date] || 0) + s.duration; return acc; }, {}); for (const date in hoursByDay) { if (hoursByDay[date] > records.hoursDay.value) { records.hoursDay.value = hoursByDay[date]; records.hoursDay.date = new Date(date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); } } allData.forEach(s => { if (s.accuracy !== null && s.accuracy > records.accuracy.value) { records.accuracy.value = s.accuracy; records.accuracy.date = new Date(s.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); } }); const hoursByMonth = allData.reduce((acc, s) => { const month = s.date.substring(0, 7); acc[month] = (acc[month] || 0) + s.duration; return acc; }, {}); for (const month in hoursByMonth) { if (hoursByMonth[month] > records.hoursMonth.value) { records.hoursMonth.value = hoursByMonth[month]; records.hoursMonth.date = month; } } }
document.getElementById('record-hours-day').innerHTML = `${this.formatTime(records.hoursDay.value)} <div class="record-date">${records.hoursDay.date}</div>`; document.getElementById('record-accuracy').innerHTML = `${(records.accuracy.value * 100).toFixed(0)}% <div class="record-date">${records.accuracy.date}</div>`; document.getElementById('record-hours-month').innerHTML = `${this.formatTime(records.hoursMonth.value)} <div class="record-date">${records.hoursMonth.date}</div>`; }, getWeekDateRange(date = new Date()) { const d = new Date(date); const startDay = this.state.parameters.weekStartDay; const currentDay = d.getDay(); const diff = d.getDate() - currentDay + (currentDay === 0 && startDay === 1 ? -6 : startDay); const startDate = new Date(d.setDate(diff)); startDate.setHours(0, 0, 0, 0);
const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999);
return { startDate, endDate }; }, updateWeeklyGoals(allData){ const g = this.state.parameters.weeklyGoals; const displayContainer = document.getElementById('goals-display-view'); const daysTrackerContainer = document.getElementById('weekly-days-tracker'); const { startDate, endDate } = this.getWeekDateRange(); const fmt = d => d.toISOString().split('T')[0]; const todayStr = new Date().toISOString().split('T')[0];
document.getElementById('weekly-goals-title').textContent = `Metas da Semana (${startDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})} - ${endDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})})`;
const weekData = allData.filter(s => s.date >= fmt(startDate) && s.date <= fmt(endDate)); const studiedDays = new Set(weekData.map(s => s.date));
daysTrackerContainer.innerHTML = ''; const dayLabels = this.state.parameters.weekStartDay === 1 ? ['S', 'T', 'Q', 'Q', 'S', 'S', 'D'] : ['D', 'S', 'T', 'Q', 'Q', 'S', 'S']; for (let i = 0; i < 7; i++) { const day = new Date(startDate); day.setDate(startDate.getDate() + i); const dayStr = fmt(day); const dot = document.createElement('div'); dot.textContent = dayLabels[i]; dot.className = 'day-tracker-dot';
if (studiedDays.has(dayStr)) { dot.classList.add('done'); } else if (dayStr < todayStr) { dot.classList.add('missed'); } if (dayStr === todayStr) { dot.classList.add('today'); } daysTrackerContainer.appendChild(dot); } displayContainer.innerHTML = '';
const goals = [ { id: 'hours', label: 'Horas de estudo', unit: 'h' }, { id: 'questions', label: 'Questões', unit: '' }, { id: 'accuracy', label: '% de acerto', unit: '%' }, { id: 'days', label: 'Dias/semana', unit: ' dias' } ];
const currentValues = { hours: weekData.reduce((a, b) => a + b.duration, 0) / 3600, questions: weekData.reduce((a, b) => a + (b.totalQuestions || 0), 0), accuracy: (() => { const sessionsWithAcc = weekData.filter(s => typeof s.accuracy === 'number'); return sessionsWithAcc.length > 0 ? (sessionsWithAcc.reduce((sum, s) => sum + s.accuracy, 0) / sessionsWithAcc.length * 100) : 0; })(), days: studiedDays.size };
goals.forEach(goalInfo => { const target = g[goalInfo.id]; const current = currentValues[goalInfo.id]; const progress = target > 0 ? Math.min(100, (current / target) * 100) : 0; const el = document.createElement('div'); el.innerHTML = ` <div class="flex justify-between text-sm font-medium text-[var(--text-muted)]"> <span>${goalInfo.label}</span> <span>${current.toFixed(goalInfo.id === 'hours' ? 1 : 0)}${goalInfo.unit} / ${target}${goalInfo.unit} (${progress.toFixed(0)}%)</span> </div> <div class="progress-bar mt-1"> <div class="progress-fill" style="width:${progress}%"></div> </div> `; displayContainer.appendChild(el); }); const buttonContainer = document.createElement('div'); buttonContainer.className = 'pt-2'; buttonContainer.innerHTML = `<button id="edit-goals-btn" class="btn btn-secondary py-2 px-3 w-full">Editar Metas</button>`; displayContainer.appendChild(buttonContainer);
document.getElementById('edit-goals-btn').onclick = ()=>{ document.getElementById('goal-hours-input').value = g.hours; document.getElementById('goal-questions-input').value = g.questions; document.getElementById('goal-accuracy-input').value = g.accuracy; document.getElementById('goal-days-input').value = g.days; document.getElementById('goals-display-view').classList.add('hidden'); document.getElementById('weekly-days-tracker').classList.add('hidden'); document.getElementById('goals-edit-view').classList.remove('hidden'); }; document.getElementById('save-goals-btn').onclick = ()=>{ g.hours = parseInt(document.getElementById('goal-hours-input').value, 10) || 0; g.questions = parseInt(document.getElementById('goal-questions-input').value, 10) || 0; g.accuracy = parseInt(document.getElementById('goal-accuracy-input').value, 10) || 0; g.days = parseInt(document.getElementById('goal-days-input').value, 10) || 0; this.saveData(true, 'Metas atualizadas!'); document.getElementById('goals-edit-view').classList.add('hidden'); document.getElementById('goals-display-view').classList.remove('hidden'); document.getElementById('weekly-days-tracker').classList.remove('hidden'); this.updateWeeklyGoals(allData); }; }, calculateStreak(allData) { if (allData.length === 0) return { current: 0, longest: 0 }; const allDates = [...new Set(allData.map(s => s.date))].sort(); let longestStreak = 0; let currentStreak = 0;
if (allDates.length > 0) { longestStreak = 1; currentStreak = 1; const today = new Date(); const yesterday = new Date(); yesterday.setDate(today.getDate() - 1); const todayStr = today.toISOString().split('T')[0]; const yesterdayStr = yesterday.toISOString().split('T')[0]; const lastDate = allDates[allDates.length - 1]; if (lastDate !== todayStr && lastDate !== yesterdayStr) { currentStreak = 0; }
for (let i = allDates.length - 1; i > 0; i--) { const currDate = new Date(allDates[i]); const prevDate = new Date(allDates[i-1]); const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24)); if (diffDays === 1) { if(lastDate === todayStr || lastDate === yesterdayStr) currentStreak++; } else { break; } } } let overallLongest = 0; if (allDates.length > 0) { overallLongest = 1; let tempStreak = 1; for (let i = 1; i < allDates.length; i++) { const prevDate = new Date(allDates[i-1]); const currDate = new Date(allDates[i]); const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24)); if (diffDays === 1) { tempStreak++; } else { overallLongest = Math.max(overallLongest, tempStreak); tempStreak = 1; } } overallLongest = Math.max(overallLongest, tempStreak); }
return { current: currentStreak, longest: overallLongest }; }, updateStreaksAndHeatmap(allData){ const { longest } = this.calculateStreak(allData); document.getElementById('record-streak').innerHTML = `${longest} dias`;
const container = document.getElementById('consistency-tracker'); container.innerHTML = '';
const today = new Date(); const startDate = new Date(); startDate.setDate(today.getDate() - 364);
const studyByDate = allData.reduce((acc, session) => { const date = session.date; acc[date] = (acc[date] || 0) + session.duration; return acc; }, {});
const allSeconds = Object.values(studyByDate).filter(s => s > 0); const maxSeconds = allSeconds.length > 0 ? Math.max(...allSeconds) : 1;
const getColorLevel = (seconds) => { if (!seconds || seconds === 0) return 0; const ratio = seconds / maxSeconds; if (ratio > 0.75) return 4; if (ratio > 0.50) return 3; if (ratio > 0.25) return 2; return 1; };
const heatmapGrid = document.createElement('div'); heatmapGrid.className = 'grid grid-flow-col grid-rows-7 gap-1'; const tempDate = new Date(startDate); const dayOfWeekOffset = tempDate.getUTCDay(); for (let i = 0; i < dayOfWeekOffset; i++) { const pad = document.createElement('div'); pad.className = 'w-3 h-3'; heatmapGrid.appendChild(pad); }
for (let i = 0; i < 365; i++) { const dateString = tempDate.toISOString().split('T')[0]; const seconds = studyByDate[dateString] || 0; const colorLevel = getColorLevel(seconds);
const cell = document.createElement('div'); cell.className = `w-3 h-3 rounded-sm heatmap-level-${colorLevel}`; cell.title = `${tempDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' })}: ${this.formatTime(seconds)}`; heatmapGrid.appendChild(cell);
tempDate.setDate(tempDate.getDate() + 1); } container.appendChild(heatmapGrid);
const legend = document.createElement('div'); legend.className = 'flex items-center justify-end gap-2 text-xs text-[var(--text-muted)] mt-2 w-full pr-4'; legend.innerHTML = ` <span>Menos</span> <div class="w-3 h-3 rounded-sm heatmap-level-0 border border-gray-400"></div> <div class="w-3 h-3 rounded-sm heatmap-level-1"></div> <div class="w-3 h-3 rounded-sm heatmap-level-2"></div> <div class="w-3 h-3 rounded-sm heatmap-level-3"></div> <div class="w-3 h-3 rounded-sm heatmap-level-4"></div> <span>Mais</span> `; container.appendChild(legend); },
initCharts(){ const isDark = this.state.parameters.darkMode; const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; const textColor = isDark ? '#e0e0e0' : '#6B7280'; Chart.defaults.color = textColor; const base = { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{font:{family:'Inter'}, color: textColor}}}, scales:{y:{beginAtZero:true,ticks:{font:{family:'Inter'}, color: textColor}, grid: {color: gridColor}},x:{ticks:{font:{family:'Inter'}, color: textColor}, grid: {color: gridColor}}} }; this.state.charts.hoursBySubject = new Chart(document.getElementById('hoursBySubjectChart'), { type:'pie', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.performanceBySubject = new Chart(document.getElementById('performanceBySubjectChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.studyEvolution = new Chart(document.getElementById('studyEvolutionChart'), { type:'line', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}, elements:{line:{tension:.1}}} }); this.state.charts.productivityByDay = new Chart(document.getElementById('productivityByDayChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.moodVsPerformance = new Chart(document.getElementById('moodVsPerformanceChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}, scales:{...base.scales, y:{...base.scales.y, max:1, ticks:{...base.scales.y.ticks, callback: v => `${(v*100)}%`}}}} }); this.state.charts.monthlyStudyEvolution = new Chart(document.getElementById('monthlyStudyEvolutionChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.performanceByTimeOfDay = new Chart(document.getElementById('performanceByTimeOfDayChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.strengthsWeaknesses = new Chart(document.getElementById('strengthsWeaknessesChart'), { type:'radar', data:{labels:[],datasets:[]}, options: {...base, scales: { r: { beginAtZero: true, max: 100, ticks: { backdropColor: 'transparent', color: textColor }, pointLabels: { color: textColor }, grid: {color: gridColor}, angleLines: {color: gridColor} } }} }); this.state.charts.questionsEvolution = new Chart(document.getElementById('questionsEvolutionChart'), { type:'line', data:{labels:[],datasets:[]}, options: {...base, elements:{line:{tension:.2, fill: 'start'}}} }); this.state.charts.activityDistribution = new Chart(document.getElementById('activityDistributionChart'), { type:'doughnut', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.flowVsPerformance = new Chart(document.getElementById('flowVsPerformanceChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins: {...base.plugins, legend:{display:false}}, scales:{...base.scales, x:{...base.scales.x, title:{display:true, text:'Nível de Flow', color: textColor}}, y:{...base.scales.y, max: 1, ticks:{...base.scales.y.ticks, callback: v => `${(v*100)}%`}, title: {display: true, text: 'Desempenho Médio', color: textColor}}}}});
this.state.charts.moodCount = new Chart(document.getElementById('moodCountChart'), { type:'pie', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.flowCount = new Chart(document.getElementById('flowCountChart'), { type:'pie', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.focusPercentage = new Chart(document.getElementById('focusPercentageChart'), { type:'doughnut', data:{labels:[],datasets:[]}, options:{...base, cutout: '70%', plugins:{...base.plugins, legend:{position:'bottom'}}} }); this.state.charts.performanceByActivity = new Chart(document.getElementById('performanceByActivityChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins: {...base.plugins, legend:{display:false}}, scales:{...base.scales, y:{...base.scales.y, max: 1, ticks:{...base.scales.y.ticks, callback: v => `${(v*100)}%`}}}}}); document.getElementById('questions-evolution-toggle').addEventListener('change', e => { this.state.questionsEvolutionView = e.target.value; this.updateQuestionsEvolutionChart(this.state.studyData); }); }, updateCharts(data, allData){ this.updateHoursBySubjectChart(data); this.updatePerformanceBySubjectChart(data); this.updateStudyEvolutionChart(data); this.updateProductivityByDayChart(data); this.updateMoodVsPerformanceChart(data); this.updateMonthlyStudyEvolutionChart(data); this.updatePerformanceByTimeOfDayChart(data); this.updateWeeklyEvolutionTable(allData); this.updateStrengthsWeaknessesChart(allData); this.updateQuestionsEvolutionChart(allData); this.updateActivityDistributionChart(data); this.updateFlowVsPerformanceChart(data); this.updateMoodCountChart(data); this.updateFlowCountChart(data); this.updateFocusPercentageChart(data); this.updatePerformanceByActivityChart(data); }, updateHoursBySubjectChart(data){ const filterSubject = document.getElementById('filter-subject').value; const ch = this.state.charts.hoursBySubject; let map, labels, values, bgColors;
if (filterSubject && filterSubject !== 'all') { document.getElementById('hours-by-subject-title').textContent = `Distribuição de horas por assunto (${filterSubject})`; map = data.filter(i => i.subject === filterSubject) .reduce((acc, i) => { const key = i.subtopic || 'Geral'; acc[key] = (acc[key] || 0) + i.duration; return acc; }, {}); labels = Object.keys(map); bgColors = labels.map((_, index) => this.state.COLOR_PALETTE[index % this.state.COLOR_PALETTE.length]); } else { document.getElementById('hours-by-subject-title').textContent = 'Distribuição de horas por disciplina'; map = data.reduce((acc,i)=>{ acc[i.subject]=(acc[i.subject]||0)+i.duration; return acc; },{}); labels = Object.keys(map); bgColors = labels.map(label => this.state.parameters.subjectColors[label] || '#cccccc'); } values = Object.values(map); const totalDuration = values.reduce((sum, val) => sum + val, 0);
ch.data.labels = labels.map(l => { const percentage = totalDuration > 0 ? ((map[l] / totalDuration) * 100).toFixed(0) : 0; return `${l} (${percentage}%)`; }); ch.data.datasets = [{ label:'Horas de estudo', data:values, borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth:2, backgroundColor: bgColors }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.chart.data.labels[context.dataIndex].split(' (')[0]; const value = context.chart.data.datasets[0].data[context.dataIndex]; const percentage = totalDuration > 0 ? ((value / totalDuration) * 100).toFixed(1) : 0; return `${label}: ${this.formatTime(value)} (${percentage}%)`; }; ch.update(); }, updatePerformanceBySubjectChart(data){ const filterSubject = document.getElementById('filter-subject').value; const ch = this.state.charts.performanceBySubject; let perf = {}; let labels, values, bgColors;
if (filterSubject && filterSubject !== 'all') { document.getElementById('performance-by-subject-title').textContent = `Desempenho por assunto (${filterSubject})`; data.filter(d => d.subject === filterSubject && typeof d.accuracy === 'number').forEach(i => { const key = i.subtopic || 'Geral'; if (!perf[key]) perf[key] = { sum: 0, cnt: 0 }; perf[key].sum += i.accuracy; perf[key].cnt += 1; }); labels = Object.keys(perf); bgColors = labels.map((_, index) => this.state.COLOR_PALETTE[index % this.state.COLOR_PALETTE.length]); } else { document.getElementById('performance-by-subject-title').textContent = 'Desempenho médio por disciplina'; data.filter(d => typeof d.accuracy === "number").forEach(i=>{ if(!perf[i.subject]) perf[i.subject]={sum:0,cnt:0}; perf[i.subject].sum += i.accuracy; perf[i.subject].cnt += 1; }); labels = Object.keys(perf); bgColors = labels.map(label => this.state.parameters.subjectColors[label] || '#cccccc'); } values = labels.map(s=> perf[s] && perf[s].cnt > 0 ? perf[s].sum / perf[s].cnt : 0); ch.data.labels = labels; ch.data.datasets = [{label:'% de acertos', data:values, backgroundColor: bgColors}]; ch.options.scales.y.max = 1; ch.options.scales.y.ticks.callback = v=> `${(v*100).toFixed(0)}%`; ch.update(); },
updateStrengthsWeaknessesChart(allData) {
    const ch = this.state.charts.strengthsWeaknesses;
    const labels = this.state.parameters.subjects.map(s => s.name);

    const accuracyData = labels.map(subject => {
        const subjectSessions = allData.filter(s => s.subject === subject && typeof s.accuracy === 'number');
        if (subjectSessions.length === 0) return 0;
        const avgAccuracy = subjectSessions.reduce((sum, s) => sum + s.accuracy, 0) / subjectSessions.length;
        return avgAccuracy * 100;
    });

    ch.data.labels = labels;
    ch.data.datasets = [
        {
            label: 'Desempenho (%)',
            data: accuracyData,
            backgroundColor: 'rgba(129, 178, 154, 0.2)',
            borderColor: 'rgba(129, 178, 154, 1)',
            pointBackgroundColor: 'rgba(129, 178, 154, 1)',
        }
    ];
    ch.options.plugins.legend.display = false;
    ch.update();
},
updateStrengthsWeaknessesDetails(allData) { const container = document.getElementById('strengths-weaknesses-details'); container.innerHTML = '';
this.state.parameters.subjects.forEach(subject => { const subjectData = allData.filter(s => s.subject === subject.name && (s.activity === 'Exercícios' || s.activity === 'Simulado')); const totalQuestions = subjectData.reduce((sum, s) => sum + (s.totalQuestions || 0), 0); if (totalQuestions === 0) return;
const correctQuestions = subjectData.reduce((sum, s) => sum + (s.correctQuestions || 0), 0); const incorrectQuestions = totalQuestions - correctQuestions; const performance = totalQuestions > 0 ? (correctQuestions / totalQuestions) * 100 : 0;
const correctPercent = totalQuestions > 0 ? (correctQuestions / totalQuestions) * 100 : 0; const incorrectPercent = totalQuestions > 0 ? (incorrectQuestions / totalQuestions) * 100 : 0;
const el = document.createElement('div'); el.innerHTML = ` <div class="flex justify-between items-center text-sm mb-1"> <span class="font-semibold">${subject.name}</span> <span class="text-xs text-[var(--text-muted)]">${totalQuestions} questões</span> </div> <div class="performance-bar"> <div class="bar-correct" style="width: ${correctPercent}%"></div> <div class="bar-incorrect" style="width: ${incorrectPercent}%"></div> </div> <div class="flex justify-between items-center text-xs text-[var(--text-muted)] mt-1"> <span>Desempenho: <span class="font-bold text-green-600">${performance.toFixed(0)}%</span></span> <span>${correctQuestions} acertos / ${incorrectQuestions} erros</span> </div> `; container.appendChild(el); });
if (container.innerHTML === '') { container.innerHTML = `<p class="text-sm text-[var(--text-muted)] text-center">Sem dados de exercícios ou simulados para exibir.</p>`; } }, updateStudyEvolutionChart(data){ const map = data.reduce((acc,i)=>{ acc[i.date]=(acc[i.date]||0)+i.duration; return acc; },{}); const dates = Object.keys(map).sort((a,b)=> new Date(a)-new Date(b)); const ch = this.state.charts.studyEvolution; ch.data.labels = dates.map(d=> new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit', timeZone:'UTC'})); ch.data.datasets = [{ label:'Horas estudadas', data: dates.map(d=> map[d]), borderColor:'#81B29A', backgroundColor:'rgba(129,178,154,.12)', fill:true, pointBackgroundColor:'#81B29A', pointRadius:4, pointHoverRadius:6 }]; ch.options.scales.y.ticks.callback = (value) => this.formatTime(value); ch.options.plugins.tooltip.callbacks.label = (context) => `Tempo: ${this.formatTime(context.raw)}`; ch.update(); const totalSec = data.reduce((s,i)=>s+i.duration,0); const uniqueDays = new Set(data.map(i=> i.date)).size; const avg = uniqueDays? totalSec/uniqueDays : 0; document.getElementById('average-time-display').textContent = this.formatTime(avg); }, updateQuestionsEvolutionChart(allData) { const ch = this.state.charts.questionsEvolution; const view = this.state.questionsEvolutionView;
const dataByMonth = allData.reduce((acc, s) => { if (s.totalQuestions > 0) { const month = s.date.substring(0, 7); if (!acc[month]) { acc[month] = { total: 0, correct: 0 }; } acc[month].total += s.totalQuestions || 0; acc[month].correct += s.correctQuestions || 0; } return acc; }, {});
const labels = Object.keys(dataByMonth).sort(); if (view === 'absolute') { const correctData = labels.map(m => dataByMonth[m].correct); const incorrectData = labels.map(m => dataByMonth[m].total - dataByMonth[m].correct); ch.data.datasets = [ { label: 'Acertos', data: correctData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)' }, { label: 'Erros', data: incorrectData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)' } ]; ch.options.scales.y.ticks.callback = value => value; ch.options.plugins.tooltip.callbacks.label = context => `${context.dataset.label}: ${context.raw}`;
} else { const performanceData = labels.map(m => { const month = dataByMonth[m]; return month.total > 0 ? (month.correct / month.total) * 100 : 0; }); const totalData = labels.map(m => dataByMonth[m].total); ch.data.datasets = [ { label: 'Desempenho (%)', data: performanceData, borderColor: '#81B29A', backgroundColor: 'rgba(129, 178, 154, 0.2)' }, { label: 'Total de Questões', data: totalData, borderColor: '#F2CC8F', backgroundColor: 'rgba(242, 204, 143, 0.2)', yAxisID: 'y1' } ]; ch.options.scales.y.ticks.callback = value => `${value.toFixed(0)}%`; ch.options.plugins.tooltip.callbacks.label = context => { if(context.dataset.label === 'Desempenho (%)') return `${context.dataset.label}: ${context.raw.toFixed(1)}%`; return `${context.dataset.label}: ${context.raw}`; }; } ch.data.labels = labels; ch.update(); }, updateProductivityByDayChart(data){ const arr = [0,0,0,0,0,0,0]; data.forEach(i=>{ const d=new Date(i.date).getUTCDay(); arr[d]+= i.duration; }); const ch = this.state.charts.productivityByDay; ch.data.labels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb']; ch.data.datasets = [{ label:'Horas', data:arr, backgroundColor:'#F2CC8F'}]; ch.options.scales.y.ticks.callback = (value) => this.formatTime(value); ch.options.plugins.tooltip.callbacks.label = (context) => `Tempo: ${this.formatTime(context.raw)}`; ch.update(); }, updateMoodVsPerformanceChart(data){ const perf = { ruim: { sum: 0, cnt: 0 }, medio: { sum: 0, cnt: 0 }, bom: { sum: 0, cnt: 0 }}; data.filter(s => s.mood && typeof s.accuracy === 'number').forEach(s => { perf[s.mood].sum += s.accuracy; perf[s.mood].cnt++; }); const labels = ['Ruim', 'Médio', 'Bom']; const values = [ perf.ruim.cnt > 0 ? perf.ruim.sum / perf.ruim.cnt : 0, perf.medio.cnt > 0 ? perf.medio.sum / perf.medio.cnt : 0, perf.bom.cnt > 0 ? perf.bom.sum / perf.bom.cnt : 0, ]; const ch = this.state.charts.moodVsPerformance; ch.data.labels = labels; ch.data.datasets = [{ label: '% de Acertos', data: values, backgroundColor: ['#E07A5F', '#F2CC8F', '#81B29A'] }]; ch.update(); }, updateMonthlyStudyEvolutionChart(data) { const map = data.reduce((acc, i) => { const month = i.date.substring(0, 7); acc[month] = (acc[month] || 0) + i.duration; return acc; }, {}); const labels = Object.keys(map).sort(); const values = labels.map(m => map[m]); const ch = this.state.charts.monthlyStudyEvolution; ch.data.labels = labels; ch.data.datasets = [{ label: 'Horas Estudadas', data: values, backgroundColor: '#3D405B' }]; ch.options.scales.y.ticks.callback = (value) => this.formatTime(value); ch.options.plugins.tooltip.callbacks.label = (context) => `Tempo: ${this.formatTime(context.raw)}`; ch.update(); }, updatePerformanceByTimeOfDayChart(data) { const periods = { 'madrugada': { sum: 0, cnt: 0 }, 'manha': { sum: 0, cnt: 0 }, 'tarde': { sum: 0, cnt: 0 }, 'noite': { sum: 0, cnt: 0 } }; data.filter(d => typeof d.accuracy === 'number' && d.timeOfDay).forEach(s => { periods[s.timeOfDay].sum += s.accuracy; periods[s.timeOfDay].cnt++; }); const labels = ['Madrugada (0-6)', 'Manhã (6-12)', 'Tarde (12-18)', 'Noite (18-24)']; const values = ['madrugada', 'manha', 'tarde', 'noite'].map(p => periods[p].cnt > 0 ? periods[p].sum / periods[p].cnt : 0); const ch = this.state.charts.performanceByTimeOfDay; ch.data.labels = labels; ch.data.datasets = [{ label: '% de Acertos', data: values, backgroundColor: '#F2CC8F' }]; ch.options.scales.y.max = 1; ch.options.scales.y.ticks.callback = v => `${(v * 100).toFixed(0)}%`; ch.update(); }, updateWeeklyEvolutionTable(allData) { const tableContainer = document.getElementById('weekly-evolution-table'); tableContainer.innerHTML = ''; const today = new Date(); let weeksData = [];
for (let i = 0; i < 4; i++) { const currentWeekDate = new Date(); currentWeekDate.setDate(today.getDate() - (i * 7)); const { startDate, endDate } = this.getWeekDateRange(currentWeekDate);
const weekData = allData.filter(s => { const sessionDate = new Date(s.date); return sessionDate >= startDate && sessionDate <= endDate; });
const hours = weekData.reduce((sum, s) => sum + s.duration, 0); const totalQ = weekData.reduce((sum, s) => sum + (s.totalQuestions || 0), 0); const correctQ = weekData.reduce((sum, s) => sum + (s.correctQuestions || 0), 0); const accuracy = totalQ > 0 ? (correctQ / totalQ) * 100 : 0;
weeksData.push({ period: `${startDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})} - ${endDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})}`, hours: this.formatTime(hours), questions: totalQ, accuracy: `${accuracy.toFixed(0)}%` }); } let tableHTML = `<table class="w-full text-sm text-left text-[var(--text-muted)]"> <thead class="text-xs text-[var(--text-primary)] uppercase bg-[var(--bg)]"> <tr> <th scope="col" class="px-6 py-3">Período</th> <th scope="col" class="px-6 py-3">Horas</th> <th scope="col" class="px-6 py-3">Questões</th> <th scope="col" class="px-6 py-3">Acertos</th> </tr> </thead> <tbody>`; weeksData.forEach(w => { tableHTML += `<tr class="border-b border-[var(--border-color)]"> <td class="px-6 py-4 font-medium text-[var(--text-secondary)] whitespace-nowrap">${w.period}</td> <td class="px-6 py-4">${w.hours}</td> <td class="px-6 py-4">${w.questions}</td> <td class="px-6 py-4">${w.accuracy}</td> </tr>`; }); tableHTML += `</tbody></table>`; tableContainer.innerHTML = tableHTML; }, updateActivityDistributionChart(data) { const ch = this.state.charts.activityDistribution; const map = data.reduce((acc, i) => { acc[i.activity] = (acc[i.activity] || 0) + i.duration; return acc; }, {}); const labels = Object.keys(map); const values = Object.values(map); const totalDuration = values.reduce((sum, val) => sum + val, 0); ch.data.labels = labels.map(l => { const percentage = totalDuration > 0 ? ((map[l] / totalDuration) * 100).toFixed(0) : 0; return `${l} (${percentage}%)`; });
ch.data.datasets = [{ label: 'Horas por Atividade', data: values, backgroundColor: ['#555B6E', '#89B0AE', '#BEE3DB', '#FFD6BA'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.chart.data.labels[context.dataIndex].split(' (')[0]; const value = context.chart.data.datasets[0].data[context.dataIndex]; const percentage = totalDuration > 0 ? ((value / totalDuration) * 100).toFixed(1) : 0; return `${label}: ${this.formatTime(value)} (${percentage}%)`; }; ch.update(); },
updateFlowVsPerformanceChart(data) { const ch = this.state.charts.flowVsPerformance; const perfByFlow = {};
data.filter(s => s.flowScore && typeof s.accuracy === 'number').forEach(s => { const score = s.flowScore; if (!perfByFlow[score]) { perfByFlow[score] = { sum: 0, cnt: 0 }; } perfByFlow[score].sum += s.accuracy; perfByFlow[score].cnt++; });
const labels = ['1', '2', '3', '4', '5']; const values = labels.map(score => { const stats = perfByFlow[score]; return (stats && stats.cnt > 0) ? (stats.sum / stats.cnt) : 0; }); ch.data.labels = labels; ch.data.datasets = [{ label: 'Desempenho Médio', data: values, backgroundColor: '#81B29A', borderColor: '#6A947E', borderWidth: 1 }]; ch.update(); },
updateMoodCountChart(data) { const ch = this.state.charts.moodCount; const counts = { bom: 0, medio: 0, ruim: 0, 'N/A': 0 }; data.forEach(s => { if (s.mood) counts[s.mood]++; else counts['N/A']++; }); const totalWithMood = counts.bom + counts.medio + counts.ruim; if (totalWithMood === 0 && counts['N/A'] > 0) { ch.data.labels = ['N/A (100%)']; ch.data.datasets = [{ data: [counts['N/A']], backgroundColor: ['#a9a9a9'] }]; } else { const labelsWithPercentages = { 'Bom': `Bom (${totalWithMood > 0 ? (counts.bom / totalWithMood * 100).toFixed(0) : 0}%)`, 'Médio': `Médio (${totalWithMood > 0 ? (counts.medio / totalWithMood * 100).toFixed(0) : 0}%)`, 'Ruim': `Ruim (${totalWithMood > 0 ? (counts.ruim / totalWithMood * 100).toFixed(0) : 0}%)`, }; ch.data.labels = [labelsWithPercentages.Bom, labelsWithPercentages.Médio, labelsWithPercentages.Ruim]; ch.data.datasets = [{ data: [counts.bom, counts.medio, counts.ruim], backgroundColor: ['#81B29A', '#F2CC8F', '#E07A5F'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; } ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.label.split(' (')[0]; const value = context.raw; const percentage = totalWithMood > 0 ? (value / totalWithMood * 100).toFixed(1) : 0; return `${label}: ${value} sessões (${percentage}%)`; }; ch.update(); },
updateFlowCountChart(data) { const ch = this.state.charts.flowCount; const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0}; const sessionsWithFlow = data.filter(s => s.sessionType === 'focada' && s.flowScore); const total = sessionsWithFlow.length;
sessionsWithFlow.forEach(s => { if (s.flowScore) counts[s.flowScore]++; });
const labelsWithPercentages = [1,2,3,4,5].map(level => { const count = counts[level]; const percentage = total > 0 ? (count / total * 100).toFixed(0) : 0; return `Flow ${level} (${percentage}%)`; });
ch.data.labels = labelsWithPercentages; ch.data.datasets = [{ data: [counts[1], counts[2], counts[3], counts[4], counts[5]], backgroundColor: ['#E07A5F', '#F2CC8F', '#BEE3DB', '#81B29A', '#3D405B'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.label.split(' (')[0]; const value = context.raw; const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0; return `${label}: ${value} sessões (${percentage}%)`; }; ch.update(); }, updateFocusPercentageChart(data) { const ch = this.state.charts.focusPercentage; const totalDuration = data.reduce((sum, s) => sum + (s.duration || 0), 0); const totalPause = data.reduce((sum, s) => sum + (s.pauseDuration || 0), 0);
const focusTime = totalDuration - totalPause;
if (totalDuration > 0) { const focusPercentage = ((focusTime / totalDuration) * 100).toFixed(0); const pausePercentage = ((totalPause / totalDuration) * 100).toFixed(0);
ch.data.labels = [`Foco (${focusPercentage}%)`, `Pausa (${pausePercentage}%)`]; ch.data.datasets = [{ data: [focusTime, totalPause], backgroundColor: ['#81B29A', '#E07A5F'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.label.split(' (')[0]; const value = context.raw; return `${label}: ${this.formatTime(value)}`; }; } else { ch.data.labels = ['Sem dados']; ch.data.datasets = [{ data: [1], backgroundColor: ['#9ca3af'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; } ch.update(); },

updatePerformanceByActivityChart(data) {
    const ch = this.state.charts.performanceByActivity;
    const perf = {};
    const activitiesWithQuestions = data.filter(s => typeof s.accuracy === 'number');
    activitiesWithQuestions.forEach(s => {
        if (!perf[s.activity]) perf[s.activity] = { sum: 0, count: 0 };
        perf[s.activity].sum += s.accuracy;
        perf[s.activity].count++;
    });
    const labels = Object.keys(perf);
    const values = labels.map(activity => perf[activity].sum / perf[activity].count);
    ch.data.labels = labels;
    ch.data.datasets = [{
        label: 'Desempenho Médio',
        data: values,
        backgroundColor: '#89B0AE',
    }];
    ch.update();
},

generateInsights(data, allData) { const container = document.getElementById('insights-container'); container.innerHTML = ''; let insights = []; if(data.length > 0) { const hoursBySubject = data.reduce((acc, i) => { acc[i.subject] = (acc[i.subject] || 0) + i.duration; return acc; }, {}); if(Object.keys(hoursBySubject).length > 0) { const [topSubject, topHours] = Object.entries(hoursBySubject).sort(([,a],[,b]) => b-a)[0]; insights.push({title: 'Foco Principal', text: `Sua disciplina mais estudada foi <strong>${topSubject}</strong> com ${this.formatTime(topHours)}.`}); }
const hoursByDay = [0,0,0,0,0,0,0]; data.forEach(i=>{ const d=new Date(i.date).getUTCDay(); hoursByDay[d]+= i.duration; }); if(hoursByDay.some(h => h > 0)) { const bestDayIndex = hoursByDay.indexOf(Math.max(...hoursByDay)); const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado']; insights.push({title: 'Pico de Produtividade', text: `Seu dia mais produtivo é <strong>${days[bestDayIndex]}</strong>.`}); } const perfBySubject = {}; data.filter(d => typeof d.accuracy === 'number' && d.totalQuestions >= 10).forEach(i => { if (!perfBySubject[i.subject]) perfBySubject[i.subject] = { sum: 0, cnt: 0 }; perfBySubject[i.subject].sum += i.accuracy; perfBySubject[i.subject].cnt++; }); const subjectsWithPerf = Object.entries(perfBySubject).map(([sub, stats]) => ({ subject: sub, avg: stats.sum / stats.cnt })); if (subjectsWithPerf.length > 1) { const bestPerf = subjectsWithPerf.sort((a,b) => b.avg - a.avg)[0]; const worstPerf = subjectsWithPerf.sort((a,b) => a.avg - b.avg)[0]; if (bestPerf.subject !== worstPerf.subject) { insights.push({title: 'Pontos de Atenção', text: `Seu melhor desempenho é em <strong>${bestPerf.subject}</strong> (${(bestPerf.avg*100).toFixed(0)}%). Considere revisar <strong>${worstPerf.subject}</strong>.`}); } } const perfByTime = { 'madrugada': { sum: 0, cnt: 0 }, 'manha': { sum: 0, cnt: 0 }, 'tarde': { sum: 0, cnt: 0 }, 'noite': { sum: 0, cnt: 0 } }; data.filter(d => typeof d.accuracy === 'number' && d.timeOfDay).forEach(s => { perfByTime[s.timeOfDay].sum += s.accuracy; perfByTime[s.timeOfDay].cnt++; }); const perfByTimeArray = Object.entries(perfByTime).map(([p, s]) => ({period: p, avg: s.cnt > 0 ? s.sum/s.cnt : 0, count: s.cnt})); if(perfByTimeArray.some(p => p.count > 0)) { const bestTime = perfByTimeArray.sort((a,b) => b.avg - a.avg)[0]; if(bestTime.count > 0) insights.push({title: 'Melhor Horário', text: `Você tende a ter um melhor desempenho no período da <strong>${bestTime.period}</strong>.`}); } const timeByActivity = data.reduce((acc, i) => { acc[i.activity] = (acc[i.activity] || 0) + i.duration; return acc; }, {}); if(Object.keys(timeByActivity).length > 0) { const [topActivity] = Object.entries(timeByActivity).sort(([,a],[,b]) => b-a)[0]; insights.push({title: 'Tipo de Estudo', text: `A maior parte do seu tempo é dedicada a <strong>${topActivity}</strong>.`}); } const { startDate } = this.getWeekDateRange(); const lastWeekStartDate = new Date(startDate); lastWeekStartDate.setDate(startDate.getDate() - 7); const currentWeekHours = allData.filter(s => new Date(s.date) >= startDate).reduce((sum, s) => sum + s.duration, 0); const lastWeekHours = allData.filter(s => new Date(s.date) >= lastWeekStartDate && new Date(s.date) < startDate).reduce((sum, s) => sum + s.duration, 0); if(lastWeekHours > 0) { const diff = ((currentWeekHours - lastWeekHours) / lastWeekHours) * 100; const trend = diff > 5 ? `<strong class="text-green-600">aumentando</strong>` : (diff < -5 ? `<strong class="text-red-600">diminuindo</strong>` : '<strong>mantendo</strong>'); insights.push({title: 'Consistência Semanal', text: `Você está ${trend} seu volume de estudos em relação à semana passada.`}); } }
if (insights.length === 0) { container.innerHTML = `<p class="col-span-full text-center text-gray-500">Registre mais sessões para receber insights detalhados.</p>`; } else { insights.sort(() => 0.5 - Math.random()); container.innerHTML = insights.slice(0,3).map(i => `<div class="border-l-4 border-[color:var(--c2)] pl-3 py-1 bg-[var(--c2)]/10 rounded-r-md"> <h4 class="font-semibold text-[var(--text-secondary)]">${i.title}</h4> <p>${i.text}</p> </div>`).join(''); } },
renderDetailedLog(data, searchTerm = '') { const container = document.getElementById('detailed-log-table-container'); container.innerHTML = ` <table class="w-full text-left text-[var(--text-muted)]"> <thead class="text-xs text-[var(--text-primary)] uppercase bg-[var(--bg)] sticky top-0"> <tr> <th class="px-4 py-3">Data</th> <th class="px-4 py-3">Disciplina/Assunto</th> <th class="px-4 py-3">Duração</th> <th class="px-4 py-3">Atividade</th> <th class="px-4 py-3">Questões (C/T)</th> <th class="px-4 py-3">Acertos</th> </tr> </thead> <tbody></tbody> </table> `; const newTableBody = container.querySelector('tbody'); let filteredData = data; if (searchTerm) { const term = searchTerm.toLowerCase(); filteredData = data.filter(s => s.subject.toLowerCase().includes(term) || (s.subtopic && s.subtopic.toLowerCase().includes(term)) ); }
if (filteredData.length === 0) { const row = newTableBody.insertRow(); const cell = row.insertCell(); cell.colSpan = 6; cell.className = 'text-center text-gray-500 py-4'; cell.textContent = 'Nenhuma sessão encontrada.'; return; } const fragment = document.createDocumentFragment(); filteredData.sort((a, b) => b.id - a.id).forEach(s => { const row = document.createElement('tr'); row.className = 'border-b border-[var(--border-color)] hover:bg-[var(--bg)] text-sm'; const subtopicText = s.subtopic ? `<br><span class="text-xs text-[var(--text-muted)]">${s.subtopic}</span>` : ''; row.innerHTML = ` <td class="px-4 py-3">${new Date(s.date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td> <td class="px-4 py-3 font-semibold">${s.subject}${subtopicText}</td> <td class="px-4 py-3">${this.formatTime(s.duration)}</td> <td class="px-4 py-3">${s.activity}</td> <td class="px-4 py-3">${s.totalQuestions > 0 ? `${s.correctQuestions}/${s.totalQuestions}` : '-'}</td> <td class="px-4 py-3">${typeof s.accuracy === 'number' ? `${(s.accuracy*100).toFixed(0)}%` : '-'}</td> `; fragment.appendChild(row); }); newTableBody.appendChild(fragment); },

async exportPDF(){ this.toast('Gerando PDF, por favor aguarde...'); const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit: 'pt', format: 'a4' }); const margin = 40; let y = margin; const tableOptions = { startY: y, theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [61, 64, 91] } };
const addTitle = (t, size=14) => { if (y > doc.internal.pageSize.getHeight() - 80) { doc.addPage(); y = margin; } doc.setFont('helvetica', 'bold'); doc.setFontSize(size); doc.text(t, margin, y); y += (size * 1.5); }; const addSubTitle = (t) => { doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.text(t, margin, y); y += 16; }; addTitle('Relatório de performance de estudos', 18); const sd = document.getElementById('filter-start-date').value; const ed = document.getElementById('filter-end-date').value; const range = (sd && ed) ? `Período: ${new Date(sd).toLocaleDateString('pt-BR',{timeZone:'UTC'})} a ${new Date(ed).toLocaleDateString('pt-BR',{timeZone:'UTC'})}` : 'Período: todos os dados'; addSubTitle(range); const now = new Date(); addSubTitle(`Gerado em: ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR')}`); y += 10; const data = this.getFilteredData(); const totalSec = data.reduce((s, i) => s + i.duration, 0);
addTitle('Novas estatísticas do período'); const reviewTime = data.filter(s => s.activity === 'Revisão').reduce((sum, s) => sum + s.duration, 0); const reviewRate = totalSec > 0 ? (reviewTime / totalSec) * 100 : 0; const questionTimeHours = data.filter(s => ['Exercícios', 'Simulado'].includes(s.activity)).reduce((sum, s) => sum + s.duration, 0) / 3600; const totalQuestions = data.reduce((sum, s) => sum + (s.totalQuestions || 0), 0); const efficiency = questionTimeHours > 0 ? (totalQuestions / questionTimeHours) : 0;
doc.autoTable({ ...tableOptions, startY: y, head: [['Estatística', 'Valor']], body: [ ['Taxa de Revisão', `${reviewRate.toFixed(1)}% do tempo total`], ['Eficiência (Questões)', `${efficiency.toFixed(1)} questões por hora`], ] }); y = doc.lastAutoTable.finalY + 25;
addTitle('Ranking pessoal de disciplinas'); const subjectStats = {}; this.state.parameters.subjects.forEach(s => subjectStats[s.name] = { time: 0, accuracy: [], totalQ: 0 }); data.forEach(s => { subjectStats[s.subject].time += s.duration; if (typeof s.accuracy === 'number') subjectStats[s.subject].accuracy.push(s.accuracy); subjectStats[s.subject].totalQ += s.totalQuestions || 0; });
const maxTime = Math.max(...Object.values(subjectStats).map(s => s.time)); const rankedSubjects = Object.entries(subjectStats) .filter(([,stats]) => stats.time > 0) .map(([name, stats]) => { const avgAccuracy = stats.accuracy.length > 0 ? stats.accuracy.reduce((a, b) => a + b, 0) / stats.accuracy.length : 0; const normalizedTime = maxTime > 0 ? (stats.time / maxTime) : 0; const score = (normalizedTime * 0.4) + (avgAccuracy * 0.6); return { name, score, time: stats.time, accuracy: avgAccuracy, totalQ: stats.totalQ }; }) .sort((a, b) => b.score - a.score);
doc.autoTable({ ...tableOptions, startY: y, head: [['#', 'Disciplina', 'Pontuação', 'Tempo', '% Acertos', 'Questões']], body: rankedSubjects.map((s, i) => [ i + 1, s.name, s.score.toFixed(2), this.formatTime(s.time), `${(s.accuracy * 100).toFixed(0)}%`, s.totalQ ]) }); y = doc.lastAutoTable.finalY + 25;
if (y > doc.internal.pageSize.getHeight() - 150) { doc.addPage(); y = margin; } const moodCounts = data.reduce((acc, s) => { acc[s.mood || 'N/A'] = (acc[s.mood || 'N/A'] || 0) + 1; return acc; }, {}); const flowCounts = data.reduce((acc, s) => { acc[s.flowScore || 'N/A'] = (acc[s.flowScore || 'N/A'] || 0) + 1; return acc; }, {}); addTitle('Sessões por humor'); doc.autoTable({ ...tableOptions, startY: y, head: [['Humor', 'Nº de Sessões']], body: Object.entries(moodCounts) }); y = doc.lastAutoTable.finalY + 25;
addTitle('Sessões por flow'); doc.autoTable({ ...tableOptions, startY: y, head: [['Nível de Flow', 'Nº de Sessões']], body: Object.entries(flowCounts).sort() }); y = doc.lastAutoTable.finalY + 25; doc.addPage(); y = margin; addTitle('Indicadores chave do período'); const sessionsWithAcc = data.filter(i => typeof i.accuracy === 'number'); const accAvg = sessionsWithAcc.length ? (sessionsWithAcc.reduce((s,i)=>s+i.accuracy,0)/sessionsWithAcc.length) : 0; const avgSessSec = data.length ? totalSec/data.length : 0; doc.autoTable({ ...tableOptions, startY: y, head: [['Indicador', 'Valor']], body: [ ['Total de horas', this.formatTime(totalSec)], ['Média de acertos', `${(accAvg*100).toFixed(0)}%`], ['Sessão média', this.formatTime(avgSessSec)], ['Total de questões', data.reduce((s, i) => s + (i.totalQuestions || 0), 0).toString()], ] }); y = doc.lastAutoTable.finalY + 25;
addTitle('Desempenho por disciplina'); const perSubject = {}; this.state.parameters.subjects.forEach(s => perSubject[s.name] = { sec: 0, qTotal: 0, qCorrect: 0, sessions: 0 }); data.forEach(d => { if (!perSubject[d.subject]) perSubject[d.subject] = { sec: 0, qTotal: 0, qCorrect: 0, sessions: 0 }; perSubject[d.subject].sec += d.duration; perSubject[d.subject].qTotal += d.totalQuestions || 0; perSubject[d.subject].qCorrect += d.correctQuestions || 0; perSubject[d.subject].sessions++; }); const subjectRows = Object.entries(perSubject).map(([sub, stats]) => { const acc = stats.qTotal > 0 ? (stats.qCorrect / stats.qTotal * 100).toFixed(0) + '%' : 'N/A'; return [sub, this.formatTime(stats.sec), stats.sessions, stats.qTotal, acc]; }).filter(row => row[2] > 0);
doc.autoTable({ ...tableOptions, startY: y, head: [['Disciplina', 'Tempo total', 'Nº de sessões', 'Nº de questões', '% Acertos']], body: subjectRows.length ? subjectRows : [['Nenhum dado no período', '', '', '', '']], }); y = doc.lastAutoTable.finalY + 25; if (y > doc.internal.pageSize.getHeight() - 100) { doc.addPage(); y = margin; }
addTitle('Evolução diária'); const byDate = {}; data.forEach(d => { if (!byDate[d.date]) byDate[d.date] = { sec: 0, qTotal: 0, qCorrect: 0 }; byDate[d.date].sec += d.duration; byDate[d.date].qTotal += d.totalQuestions || 0; byDate[d.date].qCorrect += d.correctQuestions || 0; }); const evolutionRows = Object.keys(byDate).sort().map(date => { const stats = byDate[date]; const acc = stats.qTotal > 0 ? (stats.qCorrect / stats.qTotal * 100).toFixed(0) + '%' : 'N/A'; const fDate = new Date(date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); return [fDate, this.formatTime(stats.sec), stats.qTotal, acc]; }); doc.autoTable({ ...tableOptions, startY: y, head: [['Data', 'Tempo de estudo', 'Nº de questões', '% Acertos']], body: evolutionRows.length ? evolutionRows : [['Nenhum dado no período', '', '', '']], }); doc.save(`relatorio_estudos_${new Date().toISOString().split('T')[0]}.pdf`); } };

function onYouTubeIframeAPIReady() {
    App.state.youtubePlayer = new YT.Player('youtube-player', {
        height: '0',
        width: '0',
        events: {
            'onStateChange': (event) => App.onPlayerStateChange(event)
        }
    });
}

window.addEventListener('DOMContentLoaded', ()=> App.init());
</script>
<script>
(function() {
    const STATUS_CONFIG = {
        pendente: { label: 'Pendente', color: '#fbbf24', badgeColor: 'rgba(251, 191, 36, 0.18)' },
        em_andamento: { label: 'Em andamento', color: '#3b82f6', badgeColor: 'rgba(59, 130, 246, 0.18)' },
        revisar: { label: 'Revisar', color: '#ef4444', badgeColor: 'rgba(239, 68, 68, 0.18)' },
        concluido: { label: 'Concluído', color: '#10b981', badgeColor: 'rgba(16, 185, 129, 0.18)' },
        dominado: { label: 'Dominado', color: '#8b5cf6', badgeColor: 'rgba(139, 92, 246, 0.18)' },
        ignorar: { label: 'Ignorar', color: '#6b7280', badgeColor: 'rgba(107, 114, 128, 0.2)' }
    };
    const STATUS_ORDER = ['pendente', 'em_andamento', 'revisar', 'concluido', 'dominado', 'ignorar'];
    const DEFAULT_TOPIC_STATUS = 'pendente';
    const DEFAULT_FREQUENCY_DAYS = 7;
    const MS_PER_DAY = 86400000;

    function escapeHtml(value) {
        if (typeof value !== 'string') {
            return '';
        }
        return value.replace(/[&<>"']/g, (char) => {
            const escapes = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return escapes[char] || char;
        });
    }

    function generateId() {
        return 'cc-' + Math.random().toString(36).slice(2, 9) + Date.now().toString(36);
    }

    function ensurePositiveNumber(value, fallback) {
        const parsed = parseInt(value, 10);
        return Number.isFinite(parsed) && parsed > 0 ? parsed : fallback;
    }

    function toISODateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function parseISODate(value) {
        if (!value) return null;
        const [year, month, day] = value.split('-').map(Number);
        if (!year || !month || !day) return null;
        return new Date(year, month - 1, day);
    }

    function ensureContentControl(parameters) {
        if (!parameters.contentControl || typeof parameters.contentControl !== 'object') {
            parameters.contentControl = {
                disciplines: [],
                lastSelectedDisciplineId: null
            };
        }

        const control = parameters.contentControl;

        if (!Array.isArray(control.disciplines)) {
            control.disciplines = [];
        }

        control.disciplines = control.disciplines.filter(discipline => discipline && typeof discipline === 'object');

        control.disciplines.forEach((discipline) => {
            if (!discipline.id) {
                discipline.id = generateId();
            }
            discipline.name = typeof discipline.name === 'string' && discipline.name.trim()
                ? discipline.name.trim()
                : 'Nova disciplina';
            if (!Array.isArray(discipline.topics)) {
                discipline.topics = [];
            }
            discipline.defaultFrequencyDays = ensurePositiveNumber(discipline.defaultFrequencyDays, DEFAULT_FREQUENCY_DAYS);
            discipline.topics = discipline.topics.filter(topic => topic && typeof topic === 'object');
            discipline.topics.forEach((topic) => {
                if (!topic.id) {
                    topic.id = generateId();
                }
                topic.name = typeof topic.name === 'string' && topic.name.trim()
                    ? topic.name.trim()
                    : 'Novo assunto';
                topic.status = STATUS_CONFIG[topic.status] ? topic.status : DEFAULT_TOPIC_STATUS;
                topic.frequencyDays = ensurePositiveNumber(topic.frequencyDays, discipline.defaultFrequencyDays);
                topic.nextReview = typeof topic.nextReview === 'string' && topic.nextReview.trim()
                    ? topic.nextReview
                    : null;
                topic.lastReviewDate = typeof topic.lastReviewDate === 'string' && topic.lastReviewDate.trim()
                    ? topic.lastReviewDate
                    : null;
            });
        });

        if (!('lastSelectedDisciplineId' in control)) {
            control.lastSelectedDisciplineId = null;
        }

        return control;
    }

    class ContentControlManager {
        constructor(app) {
            this.app = app;
            this.statusConfig = STATUS_CONFIG;
            this.statusOrder = STATUS_ORDER;
            this.selectedDisciplineId = null;
            this.isSetup = false;
        }

        setup() {
            if (this.isSetup) {
                this.refresh();
                return;
            }

            this.isSetup = true;
            this.listEl = document.getElementById('organization-discipline-list');
            this.detailsEl = document.getElementById('organization-discipline-details');
            this.addForm = document.getElementById('organization-add-discipline-form');
            this.addInput = document.getElementById('organization-discipline-name');

            this.addForm?.addEventListener('submit', (event) => {
                event.preventDefault();
                this.addDiscipline();
            });

            this.listEl?.addEventListener('click', (event) => {
                const item = event.target.closest('[data-discipline-id]');
                if (item) {
                    this.setSelectedDiscipline(item.dataset.disciplineId, true);
                }
            });

            this.detailsEl?.addEventListener('submit', (event) => {
                if (event.target.id === 'organization-add-topic-form') {
                    event.preventDefault();
                    this.addTopicFromForm(event.target);
                }
            });

            this.detailsEl?.addEventListener('change', (event) => this.handleDetailsChange(event));
            this.detailsEl?.addEventListener('click', (event) => this.handleDetailsClick(event));

            this.refresh();
        }

        onViewEnter() {
            this.refresh();
        }

        getContentControl() {
            return ensureContentControl(this.app.state.parameters);
        }

        getDisciplines() {
            return this.getContentControl().disciplines;
        }

        getSelectedDiscipline() {
            if (!this.selectedDisciplineId) return null;
            return this.getDisciplines().find(discipline => discipline.id === this.selectedDisciplineId) || null;
        }

        restoreSelection() {
            const control = this.getContentControl();
            const disciplines = this.getDisciplines();

            if (this.selectedDisciplineId && disciplines.some(d => d.id === this.selectedDisciplineId)) {
                return;
            }

            const persistedId = control.lastSelectedDisciplineId;
            if (persistedId && disciplines.some(d => d.id === persistedId)) {
                this.selectedDisciplineId = persistedId;
                return;
            }

            this.selectedDisciplineId = disciplines[0]?.id || null;
            control.lastSelectedDisciplineId = this.selectedDisciplineId;
        }

        setSelectedDiscipline(id, persist = false) {
            this.selectedDisciplineId = id;
            if (persist) {
                this.getContentControl().lastSelectedDisciplineId = id;
            }
            this.renderDisciplineList();
            this.renderSelectedDiscipline();
        }

        refresh() {
            ensureContentControl(this.app.state.parameters);
            this.restoreSelection();
            this.renderDisciplineList();
            this.renderSelectedDiscipline();
        }

        addDiscipline() {
            const name = this.addInput?.value.trim();
            if (!name) {
                this.app.toast?.('Informe um nome para a disciplina.', false);
                return;
            }

            const disciplines = this.getDisciplines();
            if (disciplines.some(d => d.name.toLowerCase() === name.toLowerCase())) {
                this.app.toast?.('Essa disciplina já existe.', false);
                return;
            }

            const newDiscipline = {
                id: generateId(),
                name,
                topics: [],
                createdAt: new Date().toISOString(),
                defaultFrequencyDays: DEFAULT_FREQUENCY_DAYS
            };
            disciplines.push(newDiscipline);
            this.selectedDisciplineId = newDiscipline.id;
            this.getContentControl().lastSelectedDisciplineId = newDiscipline.id;
            if (this.addInput) {
                this.addInput.value = '';
            }
            this.commit({ showToast: true, message: `Disciplina "${name}" adicionada!` });
        }

        addTopicFromForm(form) {
            const discipline = this.getSelectedDiscipline();
            if (!discipline) {
                this.app.toast?.('Selecione uma disciplina para adicionar assuntos.', false);
                return;
            }

            const nameInput = form.querySelector('[name="topic-name"]');
            const statusInput = form.querySelector('[name="topic-status"]');
            const nextReviewInput = form.querySelector('[name="topic-next-review"]');
            const frequencyInput = form.querySelector('[name="topic-frequency"]');

            const name = nameInput?.value.trim();
            if (!name) {
                this.app.toast?.('Informe o nome do assunto.', false);
                return;
            }

            const status = statusInput?.value || DEFAULT_TOPIC_STATUS;
            const frequency = ensurePositiveNumber(frequencyInput?.value, discipline.defaultFrequencyDays);
            const nextReview = nextReviewInput?.value ? nextReviewInput.value : null;

            const duplicate = discipline.topics.some(topic => topic.name.toLowerCase() === name.toLowerCase());
            if (duplicate) {
                this.app.toast?.('Esse assunto já existe nessa disciplina.', false);
                return;
            }

            discipline.topics.push({
                id: generateId(),
                name,
                status: STATUS_CONFIG[status] ? status : DEFAULT_TOPIC_STATUS,
                frequencyDays: frequency,
                nextReview,
                lastReviewDate: null,
                createdAt: new Date().toISOString()
            });

            form.reset();
            if (frequencyInput) {
                frequencyInput.value = discipline.defaultFrequencyDays;
            }
            if (statusInput) {
                statusInput.value = DEFAULT_TOPIC_STATUS;
            }

            this.commit({ showToast: true, message: `Assunto "${name}" adicionado!` });
        }

        handleDetailsChange(event) {
            const target = event.target;
            const topicCard = target.closest('[data-topic-id]');
            const topicId = topicCard?.dataset.topicId;
            const discipline = this.getSelectedDiscipline();
            if (!discipline) return;

            if (target.classList.contains('organization-topic-status') && topicId) {
                const topic = discipline.topics.find(t => t.id === topicId);
                if (topic) {
                    topic.status = STATUS_CONFIG[target.value] ? target.value : topic.status;
                    this.commit();
                }
            } else if (target.classList.contains('organization-topic-next-review') && topicId) {
                const topic = discipline.topics.find(t => t.id === topicId);
                if (topic) {
                    topic.nextReview = target.value ? target.value : null;
                    this.commit();
                }
            } else if (target.classList.contains('organization-topic-frequency') && topicId) {
                const topic = discipline.topics.find(t => t.id === topicId);
                if (topic) {
                    topic.frequencyDays = ensurePositiveNumber(target.value, topic.frequencyDays || discipline.defaultFrequencyDays);
                    target.value = topic.frequencyDays;
                    this.commit();
                }
            } else if (target.classList.contains('organization-topic-name') && topicId) {
                const topic = discipline.topics.find(t => t.id === topicId);
                if (!topic) return;
                const value = target.value.trim();
                if (!value) {
                    target.value = topic.name;
                    this.app.toast?.('O nome do assunto não pode ficar vazio.', false);
                    return;
                }
                const duplicate = discipline.topics.some(t => t.id !== topicId && t.name.toLowerCase() === value.toLowerCase());
                if (duplicate) {
                    this.app.toast?.('Já existe um assunto com esse nome.', false);
                    target.value = topic.name;
                    return;
                }
                topic.name = value;
                this.commit();
            }
        }

        handleDetailsClick(event) {
            const button = event.target.closest('[data-organization-action]');
            if (!button) return;

            const action = button.dataset.organizationAction;
            const topicId = button.dataset.topicId || button.closest('[data-topic-id]')?.dataset.topicId;
            const discipline = this.getSelectedDiscipline();
            if (!discipline && action !== 'remove-discipline') {
                return;
            }

            if (action === 'remove-discipline') {
                if (!discipline) return;
                if (confirm(`Remover a disciplina "${discipline.name}" e todos os seus assuntos?`)) {
                    const disciplines = this.getDisciplines();
                    this.app.state.parameters.contentControl.disciplines = disciplines.filter(d => d.id !== discipline.id);
                    this.selectedDisciplineId = null;
                    this.commit({ showToast: true, message: 'Disciplina removida.' });
                }
            } else if (action === 'remove-topic' && topicId) {
                if (confirm('Remover este assunto?')) {
                    discipline.topics = discipline.topics.filter(topic => topic.id !== topicId);
                    this.commit({ showToast: true, message: 'Assunto removido.' });
                }
            } else if (action === 'complete-review' && topicId) {
                this.completeReview(topicId);
            } else if (action === 'clear-review' && topicId) {
                const topic = discipline.topics.find(t => t.id === topicId);
                if (topic) {
                    topic.nextReview = null;
                    this.commit({ showToast: true, message: 'Revisão cancelada.' });
                }
            }
        }

        completeReview(topicId) {
            const discipline = this.getSelectedDiscipline();
            if (!discipline) return;
            const topic = discipline.topics.find(t => t.id === topicId);
            if (!topic) return;

            const today = new Date();
            topic.lastReviewDate = toISODateString(today);
            const frequency = ensurePositiveNumber(topic.frequencyDays, discipline.defaultFrequencyDays);
            const nextDate = new Date(today.getTime() + frequency * MS_PER_DAY);
            topic.nextReview = toISODateString(nextDate);

            this.commit({ showToast: true, message: `Próxima revisão agendada para ${this.formatDate(topic.nextReview)}.` });
        }

        commit({ showToast = false, message } = {}) {
            this.app.saveData?.(showToast, message);
            this.restoreSelection();
            this.renderDisciplineList();
            this.renderSelectedDiscipline();
        }

        computeStatusCounts(discipline) {
            const counts = {};
            this.statusOrder.forEach(status => {
                counts[status] = 0;
            });
            discipline.topics.forEach(topic => {
                const status = STATUS_CONFIG[topic.status] ? topic.status : DEFAULT_TOPIC_STATUS;
                counts[status] = (counts[status] || 0) + 1;
            });
            return counts;
        }

        renderDisciplineList() {
            if (!this.listEl) return;
            const disciplines = this.getDisciplines();
            if (disciplines.length === 0) {
                this.listEl.innerHTML = '<div class="text-sm text-[var(--text-muted)]">Nenhuma disciplina adicionada ainda.</div>';
                return;
            }

            const items = disciplines.map((discipline) => {
                const counts = this.computeStatusCounts(discipline);
                const total = discipline.topics.length || 0;
                const completed = (counts.concluido || 0) + (counts.dominado || 0);
                const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
                return `<div class="organization-discipline-item ${discipline.id === this.selectedDisciplineId ? 'active' : ''}" data-discipline-id="${discipline.id}">
                    <div>
                        <p class="font-semibold text-[var(--text-secondary)]">${escapeHtml(discipline.name)}</p>
                        <p class="organization-discipline-count">${total} assunto${total === 1 ? '' : 's'}</p>
                    </div>
                    <div class="text-right text-xs text-[var(--text-muted)]">
                        <span>${percent}% concluído</span>
                    </div>
                </div>`;
            }).join('');

            this.listEl.innerHTML = items;
        }

        renderSelectedDiscipline() {
            if (!this.detailsEl) return;
            const discipline = this.getSelectedDiscipline();
            if (!discipline) {
                this.detailsEl.innerHTML = '<div class="card p-6 text-center text-[var(--text-muted)]"><p>Selecione ou adicione uma disciplina para visualizar seus assuntos e revisões.</p></div>';
                return;
            }

            const counts = this.computeStatusCounts(discipline);
            const total = discipline.topics.length || 0;
            const progressSegments = this.statusOrder.map((status) => {
                const percent = total > 0 ? (counts[status] / total) * 100 : 0;
                return `<div class="organization-progress-segment" style="height:${percent}%; background:${this.statusConfig[status].color}"></div>`;
            }).join('');

            const statusSummary = this.statusOrder.map((status) => {
                const label = this.statusConfig[status].label;
                const count = counts[status] || 0;
                const percent = total > 0 ? Math.round((count / total) * 100) : 0;
                return `<div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <span class="organization-status-dot" style="background:${this.statusConfig[status].color}"></span>
                        <span>${label}</span>
                    </div>
                    <span class="text-[var(--text-muted)]">${count} • ${percent}%</span>
                </div>`;
            }).join('');

            const upcomingTopics = [...discipline.topics]
                .filter(topic => topic.nextReview)
                .sort((a, b) => {
                    const aDate = parseISODate(a.nextReview)?.getTime() || Infinity;
                    const bDate = parseISODate(b.nextReview)?.getTime() || Infinity;
                    return aDate - bDate;
                });

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcomingList = upcomingTopics.length > 0
                ? upcomingTopics.map((topic) => {
                    const nextDate = parseISODate(topic.nextReview);
                    const isOverdue = nextDate && nextDate.getTime() < today.getTime();
                    const diffDays = nextDate ? Math.round((nextDate.getTime() - today.getTime()) / MS_PER_DAY) : null;
                    const isSoon = diffDays !== null && diffDays >= 0 && diffDays <= 3;
                    const reviewClass = isOverdue ? 'overdue' : isSoon ? 'soon' : '';
                    return `<div class="organization-upcoming-item ${isOverdue ? 'overdue' : ''}" data-topic-id="${topic.id}">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <p class="font-semibold text-[var(--text-secondary)]">${escapeHtml(topic.name)}</p>
                                <p class="text-xs text-[var(--text-muted)]">${this.statusConfig[topic.status].label}</p>
                            </div>
                            <div class="text-right space-y-1">
                                <p class="organization-next-review ${reviewClass}">Próxima revisão: ${this.formatDate(topic.nextReview)}</p>
                                <p class="text-xs text-[var(--text-muted)]">Frequência: ${topic.frequencyDays} dia${topic.frequencyDays > 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-3">
                            <button type="button" class="btn btn-primary py-1 px-3 text-xs" data-organization-action="complete-review" data-topic-id="${topic.id}">Registrar revisão</button>
                            <button type="button" class="btn btn-secondary py-1 px-3 text-xs" data-organization-action="clear-review" data-topic-id="${topic.id}">Cancelar alerta</button>
                        </div>
                    </div>`;
                }).join('')
                : '<p class="text-sm text-[var(--text-muted)]">Nenhuma revisão agendada ainda.</p>';

            const topicCards = discipline.topics.length > 0
                ? discipline.topics.map((topic) => {
                    const options = this.statusOrder.map((status) => `<option value="${status}" ${topic.status === status ? 'selected' : ''}>${this.statusConfig[status].label}</option>`).join('');
                    return `<div class="organization-topic-card space-y-4" data-topic-id="${topic.id}">
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                            <div class="flex-1">
                                <label class="field-label block mb-2">Assunto</label>
                                <input type="text" class="organization-topic-name shadow-sm w-full" value="${escapeHtml(topic.name)}">
                            </div>
                            <button type="button" class="btn btn-danger py-2 px-3 text-sm self-start" data-organization-action="remove-topic" data-topic-id="${topic.id}"><i class="fa-solid fa-trash-can mr-1"></i>Remover</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <span class="field-label block mb-2">Status</span>
                                <select class="organization-topic-status shadow-sm w-full">${options}</select>
                            </div>
                            <div>
                                <span class="field-label block mb-2">Próxima revisão</span>
                                <input type="date" class="organization-topic-next-review shadow-sm w-full" value="${topic.nextReview || ''}">
                            </div>
                            <div>
                                <span class="field-label block mb-2">Frequência (dias)</span>
                                <input type="number" min="1" class="organization-topic-frequency shadow-sm w-full" value="${topic.frequencyDays}">
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="organization-status-badge" style="background:${this.statusConfig[topic.status].badgeColor}">${this.statusConfig[topic.status].label}</span>
                                <span class="text-[var(--text-muted)]">${topic.lastReviewDate ? `Última revisão em ${this.formatDate(topic.lastReviewDate)}` : 'Nenhuma revisão registrada.'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" class="btn btn-secondary py-1 px-3 text-xs" data-organization-action="complete-review" data-topic-id="${topic.id}">Registrar revisão</button>
                                ${topic.nextReview ? `<button type="button" class="btn btn-secondary py-1 px-3 text-xs" data-organization-action="clear-review" data-topic-id="${topic.id}">Cancelar alerta</button>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('')
                : '<div class="text-sm text-[var(--text-muted)]">Nenhum assunto cadastrado ainda.</div>';

            this.detailsEl.innerHTML = `
                <div class="space-y-6">
                    <div class="card p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div>
                                <h3 class="text-2xl font-bold text-[var(--text-secondary)]">${escapeHtml(discipline.name)}</h3>
                                <p class="text-sm text-[var(--text-muted)]">${discipline.topics.length} assunto${discipline.topics.length === 1 ? '' : 's'} cadastrados</p>
                            </div>
                            <button type="button" class="btn btn-danger py-2 px-4" data-organization-action="remove-discipline"><i class="fa-solid fa-trash-can mr-2"></i>Remover disciplina</button>
                        </div>
                        <div class="grid grid-cols-1 xl:grid-cols-[120px_1fr] gap-6 mt-6">
                            <div class="flex flex-col items-center gap-4">
                                <div class="organization-progress-bar">${progressSegments}</div>
                                <div class="w-full space-y-3">${statusSummary}</div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-lg font-semibold text-[var(--text-secondary)] mb-2">Próximas revisões</h4>
                                    <div class="space-y-3">${upcomingList}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card p-6 space-y-4">
                        <h4 class="text-lg font-semibold text-[var(--text-secondary)]">Adicionar novo assunto</h4>
                        <form id="organization-add-topic-form" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 items-end">
                            <div class="md:col-span-2">
                                <label class="field-label block mb-2" for="organization-topic-name">Nome do assunto</label>
                                <input type="text" id="organization-topic-name" name="topic-name" class="shadow-sm w-full" placeholder="Ex: Controle difuso">
                            </div>
                            <div>
                                <label class="field-label block mb-2" for="organization-topic-status">Status inicial</label>
                                <select id="organization-topic-status" name="topic-status" class="shadow-sm w-full">${this.statusOrder.map((status) => `<option value="${status}" ${status === DEFAULT_TOPIC_STATUS ? 'selected' : ''}>${this.statusConfig[status].label}</option>`).join('')}</select>
                            </div>
                            <div>
                                <label class="field-label block mb-2" for="organization-topic-frequency">Frequência (dias)</label>
                                <input type="number" id="organization-topic-frequency" name="topic-frequency" min="1" value="${discipline.defaultFrequencyDays}" class="shadow-sm w-full">
                            </div>
                            <div>
                                <label class="field-label block mb-2" for="organization-topic-next-review">Primeira revisão</label>
                                <input type="date" id="organization-topic-next-review" name="topic-next-review" class="shadow-sm w-full">
                            </div>
                            <div class="md:col-span-2 xl:col-span-4 flex justify-end">
                                <button type="submit" class="btn btn-primary py-2 px-4">Adicionar assunto</button>
                            </div>
                        </form>
                    </div>
                    <div class="space-y-4">${topicCards}</div>
                </div>
            `;
        }

        formatDate(value) {
            if (!value) return '-';
            const date = parseISODate(value);
            if (!date) return '-';
            return date.toLocaleDateString('pt-BR');
        }
    }

    ensureContentControl(App.state.parameters);

    const originalResetState = App.resetState;
    App.resetState = function(...args) {
        originalResetState.apply(this, args);
        ensureContentControl(this.state.parameters);
        if (this.contentControlManager) {
            this.contentControlManager.selectedDisciplineId = null;
            this.contentControlManager.refresh();
        }
    };

    App.getContentControl = function() {
        return ensureContentControl(this.state.parameters);
    };

    const originalInitializeApp = App.initializeApp;
    App.initializeApp = function(...args) {
        ensureContentControl(this.state.parameters);
        const result = originalInitializeApp.apply(this, args);
        if (!this.contentControlManager) {
            this.contentControlManager = new ContentControlManager(this);
        }
        this.contentControlManager.setup();
        return result;
    };

    const originalNavigateTo = App.navigateTo;
    App.navigateTo = function(view) {
        originalNavigateTo.call(this, view);
        if (view === 'organizacao') {
            this.contentControlManager?.onViewEnter();
        }
    };
})();

<script>
(function() {
    const STUDY_STATUS_ORDER = ['not_started', 'in_progress', 'completed'];
    Object.assign(App, {
        ensureStudyControlDefaults() {
            if (!Array.isArray(this.state.parameters.studyControlRows)) {
                this.state.parameters.studyControlRows = [];
            }
            this.state.parameters.studyControlRows = this.state.parameters.studyControlRows.map(row => ({
                id: row.id || Date.now() + Math.random(),
                subject: row.subject || '',
                topic: row.topic || '',
                subtopic: row.subtopic || '',
                status: STUDY_STATUS_ORDER.includes(row.status) ? row.status : 'not_started',
                needsReview: Boolean(row.needsReview),
                reviewed: Boolean(row.reviewed),
                progress: typeof row.progress === 'number' ? Math.max(0, Math.min(100, row.progress)) : (row.status === 'completed' ? 100 : row.status === 'in_progress' ? 50 : 0),
            }));
        },
        renderStudyControlTable() {
            const tbody = document.querySelector('#study-control-table tbody');
            if (!tbody) return;
            const rows = this.state.parameters.studyControlRows || [];
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-sm text-[var(--text-muted)] py-4">Nenhum registro ainda. Clique em "Adicionar linha" para começar.</td></tr>';
                return;
            }
            const statusMeta = {
                not_started: { label: 'Não iniciado', className: 'control-status-not_started', progress: 0 },
                in_progress: { label: 'Em andamento', className: 'control-status-in_progress', progress: 50 },
                completed: { label: 'Concluído', className: 'control-status-completed', progress: 100 },
            };
            const fragment = document.createDocumentFragment();
            rows.forEach(row => {
                const meta = statusMeta[row.status] || statusMeta.not_started;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td contenteditable="true" data-field="subject" data-id="${row.id}" class="control-editable">${row.subject || ''}</td>
                    <td contenteditable="true" data-field="topic" data-id="${row.id}" class="control-editable">${row.topic || ''}</td>
                    <td contenteditable="true" data-field="subtopic" data-id="${row.id}" class="control-editable">${row.subtopic || ''}</td>
                    <td><button class="control-status-badge ${meta.className}" data-action="cycle-status" data-id="${row.id}">${meta.label}</button></td>
                    <td class="text-center"><input type="checkbox" class="control-checkbox" data-field="needsReview" data-id="${row.id}" ${row.needsReview ? 'checked' : ''}></td>
                    <td class="text-center"><input type="checkbox" class="control-checkbox" data-field="reviewed" data-id="${row.id}" ${row.reviewed ? 'checked' : ''}></td>
                    <td><div class="control-progress"><div class="control-progress-bar" style="width:${row.progress}%"></div></div></td>
                    <td class="text-right"><button class="text-red-500 hover:text-red-600 text-sm" data-action="remove-row" data-id="${row.id}"><i class="fa-solid fa-trash"></i></button></td>
                `;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        },
        createEmptyStudyControlRow() {
            return { id: Date.now() + Math.random(), subject: '', topic: '', subtopic: '', status: 'not_started', needsReview: false, reviewed: false, progress: 0 };
        },
        addStudyControlRow(row = null) {
            this.ensureStudyControlDefaults();
            const newRow = { ...this.createEmptyStudyControlRow(), ...(row || {}) };
            this.state.parameters.studyControlRows.push(newRow);
            this.saveData();
            this.renderStudyControlTable();
        },
        removeStudyControlRow(id) {
            this.state.parameters.studyControlRows = this.state.parameters.studyControlRows.filter(r => r.id !== id);
            this.saveData(true, 'Linha removida.');
            this.renderStudyControlTable();
        },
        cycleStudyControlStatus(id) {
            const row = this.state.parameters.studyControlRows.find(r => r.id === id);
            if (!row) return;
            const currentIndex = STUDY_STATUS_ORDER.indexOf(row.status || 'not_started');
            row.status = STUDY_STATUS_ORDER[(currentIndex + 1) % STUDY_STATUS_ORDER.length];
            row.progress = row.status === 'completed' ? 100 : row.status === 'in_progress' ? 50 : 0;
            this.saveData();
            this.renderStudyControlTable();
        },
        updateStudyControlField(id, field, value) {
            const row = this.state.parameters.studyControlRows.find(r => r.id === id);
            if (!row) return;
            if (field === 'needsReview' || field === 'reviewed') {
                row[field] = Boolean(value);
            } else if (field === 'progress') {
                row.progress = Math.max(0, Math.min(100, Number(value) || 0));
            } else {
                row[field] = value;
            }
            if (['subject', 'topic', 'subtopic'].includes(field)) {
                this.ensureSubjectHierarchy(row.subject, row.topic, row.subtopic);
                this.updateAllSubjectDropdowns();
            }
            this.saveData();
        },
        ensureSubjectHierarchy(subjectName, topicName = '', subtopicName = '') {
            if (!subjectName) return;
            let subject = this.state.parameters.subjects.find(s => s.name === subjectName);
            if (!subject) {
                subject = { name: subjectName, subtopics: [], topicDetails: {} };
                this.state.parameters.subjects.push(subject);
                this.ensureSubjectColors();
            }
            if (!Array.isArray(subject.subtopics)) subject.subtopics = [];
            if (!subject.topicDetails || typeof subject.topicDetails !== 'object') subject.topicDetails = {};
            if (topicName) {
                if (!subject.subtopics.includes(topicName)) subject.subtopics.push(topicName);
                if (!Array.isArray(subject.topicDetails[topicName])) subject.topicDetails[topicName] = [];
                if (subtopicName && !subject.topicDetails[topicName].includes(subtopicName)) {
                    subject.topicDetails[topicName].push(subtopicName);
                }
            }
        },
        syncStudyControlWithSubjects() {
            this.ensureStudyControlDefaults();
            const existingKeys = new Set(this.state.parameters.studyControlRows.map(r => `${r.subject}|||${r.topic}|||${r.subtopic}`));
            this.state.parameters.subjects.forEach(subject => {
                const topics = Array.isArray(subject.subtopics) ? subject.subtopics : [];
                if (!subject.topicDetails || typeof subject.topicDetails !== 'object') subject.topicDetails = {};
                if (topics.length === 0) {
                    const key = `${subject.name}|||${''}|||${''}`;
                    if (!existingKeys.has(key)) {
                        this.addStudyControlRow({ subject: subject.name });
                        existingKeys.add(key);
                    }
                }
                topics.forEach(topic => {
                    const subtopics = Array.isArray(subject.topicDetails[topic]) ? subject.topicDetails[topic] : [];
                    if (subtopics.length === 0) {
                        const key = `${subject.name}|||${topic}|||${''}`;
                        if (!existingKeys.has(key)) {
                            this.addStudyControlRow({ subject: subject.name, topic });
                            existingKeys.add(key);
                        }
                    }
                    subtopics.forEach(subtopic => {
                        const key = `${subject.name}|||${topic}|||${subtopic}`;
                        if (!existingKeys.has(key)) {
                            this.addStudyControlRow({ subject: subject.name, topic, subtopic });
                            existingKeys.add(key);
                        }
                    });
                });
            });
            this.saveData(true, 'Sincronização concluída!');
            this.renderStudyControlTable();
        },
        bindStudyControl() {
            const table = document.getElementById('study-control-table');
            if (!table) return;
            this.ensureStudyControlDefaults();
            this.renderStudyControlTable();
            table.addEventListener('blur', (event) => {
                const target = event.target;
                if (target.matches('[contenteditable="true"]')) {
                    const id = Number(target.dataset.id);
                    const field = target.dataset.field;
                    const value = target.textContent.trim();
                    this.updateStudyControlField(id, field, value);
                    this.renderStudyControlTable();
                }
            }, true);
            table.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-action]');
                if (!button) return;
                const id = Number(button.dataset.id);
                const action = button.dataset.action;
                if (action === 'cycle-status') {
                    this.cycleStudyControlStatus(id);
                } else if (action === 'remove-row') {
                    this.removeStudyControlRow(id);
                }
            });
            table.addEventListener('change', (event) => {
                const checkbox = event.target;
                if (!checkbox.matches('input.control-checkbox')) return;
                const id = Number(checkbox.dataset.id);
                const field = checkbox.dataset.field;
                this.updateStudyControlField(id, field, checkbox.checked);
                this.renderStudyControlTable();
            });
            const addBtn = document.getElementById('study-control-add-row');
            const syncBtn = document.getElementById('study-control-sync-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.addStudyControlRow());
            if (syncBtn) syncBtn.addEventListener('click', () => this.syncStudyControlWithSubjects());
        },
        parseEditalInput(text) {
            const lines = text.split(/
?
/).map(line => line.trim()).filter(Boolean);
            const entries = [];
            const regex = /^(\d+(?:\.\d+)*|[IVXLCDM]+|[A-Za-z]\)|\([A-Za-z]\)|\d+\))/;
            lines.forEach((line, index) => {
                const match = line.match(regex);
                let level = 0;
                let title = line;
                if (match) {
                    const token = match[0].replace(/[\)\.]+$/, '');
                    if (/^\d+(?:\.\d+)*$/.test(token)) {
                        level = token.split('.').length - 1;
                    } else if (/^[A-Za-z]\)$/.test(match[0]) || /^\([A-Za-z]\)$/.test(match[0])) {
                        level = 1;
                    } else if (/^[IVXLCDM]+$/.test(token)) {
                        level = 0;
                    }
                    title = line.substring(match[0].length).trim() || line;
                }
                entries.push({ id: Date.now() + index, raw: match ? match[0] : '', content: title, level: Math.min(level, 3) });
            });
            return entries;
        },
        renderEditalTable() {
            const tbody = document.querySelector('#edital-table tbody');
            if (!tbody) return;
            const entries = this.state.parameters.editalEntries || [];
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-sm text-[var(--text-muted)] py-4">Cole um edital para visualizar a tabela organizada.</td></tr>';
                return;
            }
            const fragment = document.createDocumentFragment();
            entries.forEach(entry => {
                const tr = document.createElement('tr');
                tr.className = entry.level ? `edital-indent-${entry.level}` : '';
                tr.innerHTML = `<td>${entry.raw || ''}</td><td>${entry.content || ''}</td>`;
                fragment.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        },
        bindEdital() {
            const textarea = document.getElementById('edital-input');
            const organizeBtn = document.getElementById('edital-organize-btn');
            const clearBtn = document.getElementById('edital-clear-btn');
            if (!textarea || !organizeBtn || !clearBtn) return;
            organizeBtn.addEventListener('click', () => {
                const text = textarea.value.trim();
                if (!text) {
                    this.toast('Cole um edital para organizar.', false);
                    return;
                }
                this.state.parameters.editalEntries = this.parseEditalInput(text);
                this.saveData(true, 'Edital organizado!');
                this.renderEditalTable();
            });
            clearBtn.addEventListener('click', () => {
                textarea.value = '';
                this.state.parameters.editalEntries = [];
                this.saveData();
                this.renderEditalTable();
            });
            this.renderEditalTable();
        },
        getScheduleDays() {
            return ['Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado','Domingo'];
        },
        getScheduleSlots() {
            const board = this.state.parameters.scheduleBoard || { startTime: '06:00', interval: 60 };
            const interval = Number(board.interval) || 60;
            const [startHour, startMinute] = (board.startTime || '06:00').split(':').map(Number);
            const slots = [];
            for (let minutes = startHour * 60 + startMinute; minutes < 24 * 60; minutes += interval) {
                const hour = Math.floor(minutes / 60) % 24;
                const minute = minutes % 60;
                slots.push(`${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`);
                if (slots.length > 200) break;
            }
            return slots;
        },
        renderQuadroHorario() {
            const container = document.getElementById('schedule-grid');
            if (!container) return;
            const board = this.state.parameters.scheduleBoard;
            if (!board.activities || typeof board.activities !== 'object') board.activities = {};
            const days = this.getScheduleDays();
            const slots = this.getScheduleSlots();
            const fragment = document.createDocumentFragment();
            const header = document.createElement('div');
            header.className = 'schedule-grid-row';
            header.innerHTML = `<div class="schedule-grid-cell schedule-grid-header">Hora</div>${days.map(day => `<div class="schedule-grid-cell schedule-grid-header text-center">${day}</div>`).join('')}`;
            fragment.appendChild(header);
            slots.forEach(time => {
                const row = document.createElement('div');
                row.className = 'schedule-grid-row';
                let html = `<div class="schedule-grid-cell font-semibold text-sm">${time}</div>`;
                days.forEach((day, dayIndex) => {
                    const key = `${dayIndex}|${time}`;
                    const activity = board.activities[key];
                    if (activity) {
                        html += `<div class="schedule-grid-cell"><div class="schedule-activity" style="background:${activity.color || 'rgba(129,178,154,0.18)'}"><div class="schedule-activity-header"><span>${activity.title || 'Atividade'}</span><button class="schedule-add-btn" data-key="${key}"><i class='fa-solid fa-pen'></i></button></div><span>${activity.subject || ''}</span></div></div>`;
                    } else {
                        html += `<div class="schedule-grid-cell"><button class="schedule-add-btn" data-key="${key}"><i class='fa-solid fa-plus'></i> adicionar</button></div>`;
                    }
                });
                row.innerHTML = html;
                fragment.appendChild(row);
            });
            container.innerHTML = '';
            container.appendChild(fragment);
            this.updateScheduleSummary();
        },
        promptScheduleActivity(key) {
            const board = this.state.parameters.scheduleBoard;
            if (!board.activities) board.activities = {};
            const current = board.activities[key] || {};
            const title = prompt('Descrição da atividade:', current.title || 'Estudar');
            if (title === null) return;
            const subject = prompt('Matéria/assunto (opcional):', current.subject || '');
            if (subject === null) return;
            const color = prompt('Cor (ex: #81B29A ou rgba(129,178,154,0.5))', current.color || 'rgba(129,178,154,0.18)');
            board.activities[key] = {
                title: title.trim() || 'Atividade',
                subject: subject.trim(),
                color: color && color.trim() ? color.trim() : 'rgba(129,178,154,0.18)'
            };
            this.saveData();
            this.renderQuadroHorario();
        },
        removeScheduleActivity(key) {
            const board = this.state.parameters.scheduleBoard;
            if (board.activities && board.activities[key]) {
                delete board.activities[key];
                this.saveData();
                this.renderQuadroHorario();
            }
        },
        bindQuadroHorario() {
            const startInput = document.getElementById('schedule-start-time');
            const intervalSelect = document.getElementById('schedule-interval');
            const addBtn = document.getElementById('schedule-add-activity');
            const clearBtn = document.getElementById('schedule-clear-btn');
            const container = document.getElementById('schedule-grid-container');
            if (!startInput || !intervalSelect || !container) return;
            const board = this.state.parameters.scheduleBoard;
            startInput.value = board.startTime || '06:00';
            intervalSelect.value = String(board.interval || 60);
            startInput.addEventListener('change', () => {
                this.state.parameters.scheduleBoard.startTime = startInput.value || '06:00';
                this.saveData();
                this.renderQuadroHorario();
            });
            intervalSelect.addEventListener('change', () => {
                this.state.parameters.scheduleBoard.interval = Number(intervalSelect.value) || 60;
                this.saveData();
                this.renderQuadroHorario();
            });
            if (addBtn) addBtn.addEventListener('click', () => {
                const input = prompt('Informe o dia (0=Segunda ... 6=Domingo) e horário (HH:MM)', '0 06:00');
                if (!input) return;
                const [dayStr, time] = input.split(/\s+/);
                const dayIndex = Number(dayStr);
                if (Number.isNaN(dayIndex) || dayIndex < 0 || dayIndex >= this.getScheduleDays().length) {
                    this.toast('Dia inválido.', false);
                    return;
                }
                const slots = this.getScheduleSlots();
                const normalizedTime = slots.includes(time) ? time : slots[0];
                this.promptScheduleActivity(`${dayIndex}|${normalizedTime}`);
            });
            if (clearBtn) clearBtn.addEventListener('click', () => {
                if (confirm('Deseja limpar todas as atividades do quadro?')) {
                    this.state.parameters.scheduleBoard.activities = {};
                    this.saveData(true, 'Quadro limpo.');
                    this.renderQuadroHorario();
                }
            });
            container.addEventListener('click', (event) => {
                const button = event.target.closest('.schedule-add-btn');
                if (!button) return;
                const key = button.dataset.key;
                if (!key) return;
                const board = this.state.parameters.scheduleBoard;
                if (board.activities && board.activities[key]) {
                    const choice = confirm('Editar atividade? (OK) ou remover (Cancelar)');
                    if (choice) {
                        this.promptScheduleActivity(key);
                    } else if (confirm('Remover esta atividade?')) {
                        this.removeScheduleActivity(key);
                    }
                } else {
                    this.promptScheduleActivity(key);
                }
            });
            this.renderQuadroHorario();
        },
        updateScheduleSummary() {
            const board = this.state.parameters.scheduleBoard;
            const interval = Number(board.interval) || 60;
            const totalMinutes = Object.keys(board.activities || {}).length * interval;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const weekTotal = document.getElementById('schedule-week-total');
            const weekLoad = document.getElementById('schedule-week-load');
            if (weekTotal) weekTotal.value = `${String(hours).padStart(2,'0')}h${String(minutes).padStart(2,'0')}m`;
            if (weekLoad) weekLoad.value = `${(totalMinutes / 60).toFixed(2)} horas`;
            const activeDay = document.getElementById('schedule-active-day');
            if (activeDay) {
                const today = new Date();
                const dayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
                activeDay.textContent = `Hoje: ${this.getScheduleDays()[dayIndex]}`;
            }
        },
    });

    const originalInitializeApp = App.initializeApp;
    App.initializeApp = function(...args) {
        const result = originalInitializeApp.apply(this, args);
        this.ensureStudyControlDefaults();
        this.bindStudyControl();
        this.bindEdital();
        this.bindQuadroHorario();
        return result;
    };

    const originalNavigateTo = App.navigateTo;
    App.navigateTo = function(view) {
        originalNavigateTo.call(this, view);
        if (view === 'controle') {
            this.renderStudyControlTable();
            this.renderEditalTable();
        }
        if (view === 'quadro-horario') {
            this.renderQuadroHorario();
        }
    };
})();
</script>
</script>
</body></html>
