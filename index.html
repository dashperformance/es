
<!DOCTYPE html><html lang="pt-BR"><head> <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>Dashboard de Performance</title> <script src="https://cdn.tailwindcss.com"></script> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script> <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> <style> :root{ --c1:#3D405B; --c2:#81B29A; --c3:#F2CC8F; --c4:#E07A5F; --bg:#F7F9FC; --card-bg: #FFFFFF; --text-primary: #1f2937; --text-secondary: #3D405B; --text-muted: #6B7280; --border-color: #E5E7EB; } .dark-mode:root { --c1:#4a4e69; --c2:#6a994e; --c3:#f2cc8f; --c4:#e07a5f; --bg:#121212; --card-bg: #1e1e1e; --text-primary: #e0e0e0; --text-secondary: #f2f2f2; --text-muted: #9ca3af; --border-color: #374151; }
html { scroll-behavior: smooth; } *{box-sizing:border-box} body{ font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif; background:var(--bg); color:var(--text-primary); transition: background-color 0.3s, color 0.3s; } .card{ background: var(--card-bg); border-radius: 1rem; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s, border-color 0.3s; } .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07); } .btn{ border-radius:.75rem; font-weight:600; transition: all 0.2s ease; padding-top: 0.625rem; padding-bottom: 0.625rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1); } .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1); filter: brightness(1.05); } .btn-primary{background:var(--c2);color:#fff} .btn-primary:hover{filter: brightness(0.9);} .btn-secondary{background:var(--c3);color:var(--c1)} .btn-secondary:hover{filter: brightness(0.9);} .btn-danger{background:var(--c4);color:#fff} .btn-danger:hover{filter: brightness(0.9);}
input, select, textarea { background-color: var(--card-bg); color: var(--text-primary); border-color: var(--border-color); } input::placeholder { color: var(--text-muted); } input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], select { border-radius: 0.75rem; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s; } input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus { border-color: var(--c2); box-shadow: 0 0 0 3px rgba(129, 178, 154, 0.3); outline: none; }
.nav-link{ position: relative; border-bottom:2px solid transparent; transition:all .25s ease; padding-bottom: 4px; color: var(--text-muted); } .nav-link:hover, .nav-link.active { color: var(--text-primary); } .nav-link:after { content: ''; position: absolute; width: 0; height: 2px; bottom: -2px; left: 50%; background-color: var(--c2); transition: all 0.3s ease; } .nav-link:hover:after { width: 100%; left: 0; } .nav-link.active{ border-bottom-color:var(--c2); font-weight:600; } .nav-link.active:after { width: 0; }
.chart-container{position:relative;width:100%;height:320px;max-height:420px} @media (min-width: 768px){.chart-container{height:360px}} .progress-bar{background:var(--border-color);border-radius:9999px;overflow:hidden;height:.75rem} .progress-fill{height:100%;background:var(--c2);transition:width .5s} .mood-square-wrapper { display: flex; flex-direction: column; align-items: center; text-align: center; } .mood-square{width:42px;height:42px;border-radius:.5rem;border:2px solid transparent;opacity:.7;transition:.2s; cursor: pointer;} .mood-square.selected{opacity:1;outline:2px solid var(--text-secondary);outline-offset:2px} .mood-red{background:#ef4444} .mood-yellow{background:#f59e0b} .mood-green{background:#10b981} .cycle-dot{width:10px;height:10px;border-radius:9999px;background:var(--border-color)} .cycle-dot.done{background:var(--c2)} .cycle-dot.active{background:#3b82f6} .pill{font-size:.75rem;background:var(--card-bg);color:var(--text-muted);border:1px solid var(--border-color);border-radius:9999px;padding:.375rem .75rem; transition: all 0.2s ease; cursor: pointer;} .pill:hover { background-color: var(--border-color); } .pill.active { background-color: var(--c1); color: white; font-weight: 600; } .kpi h3{color:var(--text-muted);font-size:.85rem; text-transform: uppercase; letter-spacing: 0.5px;} .kpi p{font-weight:700;font-size:1.75rem; color: var(--text-secondary);} .kpi .record-date { font-size: 0.75rem; font-weight: 400; color: var(--text-muted); margin-top: -4px; } .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0} #session-modal-backdrop.hidden, #notification-modal-backdrop.hidden { display: none; } #session-modal-panel.hidden, #notification-modal-panel.hidden { transform: translateY(100%); opacity: 0; } .heatmap-level-0 { background-color: #37415140; } .dark-mode .heatmap-level-0 { background-color: #374151; } .heatmap-level-1 { background-color: #cce2d4; } .heatmap-level-2 { background-color: #a3cdb4; } .heatmap-level-3 { background-color: var(--c2); } .heatmap-level-4 { background-color: #5d8e76; } .performance-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background-color: var(--border-color); } .bar-correct { background-color: #10b981; } .bar-incorrect { background-color: #ef4444; } .chart-toggle-label { cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background-color 0.2s; } .chart-toggle-input:checked + .chart-toggle-label { background-color: var(--c1); color: white; } .day-tracker-dot { width: 24px; height: 24px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; background-color: var(--border-color); color: var(--text-muted); } .day-tracker-dot.done { background-color: var(--c2); color: white; } .day-tracker-dot.missed { background-color: #fee2e2; color: #b91c1c; } .dark-mode .day-tracker-dot.missed { background-color: #450a0a; color: #fecaca; } .day-tracker-dot.today { outline: 2px solid #3b82f6; outline-offset: 2px; } .flow-slider-container { position: relative; } .flow-slider-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); padding: 0 5px; } .subtopics-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; } .timer-pause-display { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; height: 1.5rem; /* prevent layout shift */ } .collapse-toggle-btn { transition: transform 0.3s; } .collapsible-content.hidden { display: none; } #pomodoro-timer-display, #stopwatch-display { color: var(--c1); } .dark-mode #pomodoro-timer-display, .dark-mode #stopwatch-display { color: var(--text-primary); }
.drag-handle { cursor: move; touch-action: none; } .dragging { opacity: 0.5; background: var(--border-color); }
.task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--bg); transition: all 0.2s ease; } .task-item.selected { border-color: var(--c2); box-shadow: 0 0 0 2px rgba(129, 178, 154, 0.3); } .task-item .task-name { flex-grow: 1; cursor: pointer; } .task-item.completed .task-name { text-decoration: line-through; color: var(--text-muted); } .task-item-pomodoros { font-size: 0.875rem; color: var(--text-muted); font-weight: 500; } .task-complete-btn { width: 24px; height: 24px; border-radius: 9999px; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; } .task-complete-btn:hover { border-color: var(--c2); } .task-item.completed .task-complete-btn { background-color: var(--c2); border-color: var(--c2); color: white; } .task-actions button { color: var(--text-muted); padding: 4px; border-radius: 4px; } .task-actions button:hover { background-color: var(--border-color); color: var(--text-primary); } .youtube-music-item.active { background-color: var(--c2) !important; color: white !important; } .youtube-music-item.active span { color: white !important; }
/* Estilos específicos para Lei Seca */
.lei-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(38px, 1fr)); gap: 8px; } .artigo-square { position: relative; display: flex; justify-content: center; align-items: center; width: 100%; aspect-ratio: 1 / 1; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); background-color: var(--bg); } .artigo-square:hover { transform: scale(1.08); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; } .tooltip { position: relative; } .tooltip .tooltip-text { visibility: hidden; width: 140px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -70px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; font-weight: 500; } .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; } .category-content.collapsed { display: none; } .sound-btn{min-width:150px;padding:0.75rem 1.25rem;display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;font-size:0.95rem;white-space:nowrap;}
 .sound-btn i{margin-right:0;}
.youtube-music-item.paused{background-color:rgba(129,178,154,0.18);color:var(--text-secondary);}

    .study-tracker-wrapper {
      width: 100%;
      max-width: 72rem;
      margin: 0 auto;
    }

    @media (min-width: 1536px) {
      .study-tracker-wrapper {
        max-width: 80rem;
      }
    }

    .study-tracker-grid {
      width: 100%;
      display: grid;
      grid-template-columns: clamp(280px, 28%, 360px) minmax(0, 1fr);
      gap: 1.5rem;
      align-items: start;
    }

    .study-tracker-column {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .study-tracker-subjects {
      border-right: 1px solid var(--border-color);
      padding-right: 1.25rem;
    }

    .study-tracker-main-column {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .study-tracker-scroll-area {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 0.25rem;
    }

    .study-tracker-topics-header {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(160px, 1fr) repeat(2, minmax(120px, 0.75fr));
      gap: 0.65rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .study-tracker-topics-header span:first-child {
      text-align: left;
    }

    .study-tracker-topics-header span:not(:first-child) {
      text-align: center;
    }

    .study-tracker-topics-container {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .study-tracker-column-header {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .study-tracker-column-body {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    #study-tracker-subjects-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .study-tracker-subject-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      min-height: 3.75rem;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }

    .study-tracker-subject-btn:hover {
      background-color: var(--border-color);
    }

    .study-tracker-subject-btn.active {
      background-color: var(--c2);
      border-color: var(--c2);
      color: #fff;
    }

    .study-tracker-subject-count {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: 0.5rem;
    }

    .study-tracker-subject-btn.active .study-tracker-subject-count {
      color: #fff;
      opacity: 0.9;
    }

    .study-tracker-subject-remove-btn {
      border-radius: 0.75rem;
      border: 1px solid rgba(239, 68, 68, 0.25);
      background: rgba(239, 68, 68, 0.08);
      color: #f87171;
      min-height: 3rem;
      padding: 0.65rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85rem;
      letter-spacing: 0.02em;
      transition: all 0.2s ease;
    }

    .study-tracker-subject-remove-btn:hover {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.45);
      background-color: rgba(239, 68, 68, 0.16);
    }

    .study-tracker-add-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-radius: 0.75rem;
      border: 1px dashed var(--border-color);
      background: var(--bg);
      color: var(--text-secondary);
      font-weight: 600;
      padding: 0.65rem 0.75rem;
      transition: all 0.2s ease;
    }

    .study-tracker-add-button:hover {
      border-color: var(--c2);
      color: var(--c1);
      background: rgba(129, 178, 154, 0.15);
    }

    .study-tracker-subject-form,
    .study-tracker-topic-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .study-tracker-subject-form input,
    .study-tracker-topic-form input {
      flex: 1;
      padding: 0.6rem 0.75rem;
      border-radius: 0.65rem;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    .study-tracker-form-actions {
      display: flex;
      gap: 0.5rem;
    }

    .study-tracker-save-btn {
      border-radius: 0.65rem;
      border: none;
      background: var(--c2);
      color: #fff;
      font-weight: 600;
      padding: 0.55rem 0.9rem;
      cursor: pointer;
      transition: filter 0.2s ease;
    }

    .study-tracker-save-btn:hover {
      filter: brightness(0.95);
    }

    .study-tracker-cancel-btn {
      border-radius: 0.65rem;
      border: 1px solid var(--border-color);
      background: var(--bg);
      color: var(--text-muted);
      font-weight: 600;
      padding: 0.55rem 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .study-tracker-cancel-btn:hover {
      border-color: #ef4444;
      color: #ef4444;
    }

    .study-tracker-topic-form button[type='submit'] {
      border-radius: 0.65rem;
      border: none;
      background: var(--c2);
      color: #fff;
      font-weight: 600;
      width: 42px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: filter 0.2s ease;
    }

    .study-tracker-topic-form button[type='submit']:hover {
      filter: brightness(0.95);
    }

    #study-tracker-topics-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .study-tracker-topic-row {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(160px, 1fr) repeat(2, minmax(120px, 0.75fr));
      gap: 0.65rem;
      align-items: stretch;
    }

    .study-tracker-topic-cell {
      border-radius: 0.75rem;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      padding: 0.9rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-height: 68px;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .study-tracker-topic-cell.topic-main {
      justify-content: flex-start;
      align-items: flex-start;
      flex-wrap: wrap;
      text-align: left;
    }

    .study-tracker-topic-row.status-falha .topic-main {
      background: rgba(239, 68, 68, 0.16);
      border-color: rgba(239, 68, 68, 0.45);
    }

    .study-tracker-topic-row.status-pendente .topic-main {
      background: rgba(250, 204, 21, 0.16);
      border-color: rgba(250, 204, 21, 0.45);
    }

    .study-tracker-topic-row.status-concluido .topic-main {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(34, 197, 94, 0.45);
    }

    .study-tracker-status-group {
      display: flex;
      gap: 0.35rem;
      align-items: center;
    }

    .study-tracker-status-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid transparent;
      background: rgba(148, 163, 184, 0.35);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .study-tracker-status-dot[data-status='falha'] {
      background: rgba(248, 113, 113, 0.25);
      border-color: rgba(248, 113, 113, 0.45);
    }

    .study-tracker-status-dot[data-status='pendente'] {
      background: rgba(250, 204, 21, 0.25);
      border-color: rgba(250, 204, 21, 0.45);
    }

    .study-tracker-status-dot[data-status='concluido'] {
      background: rgba(34, 197, 94, 0.25);
      border-color: rgba(34, 197, 94, 0.45);
    }

    .study-tracker-status-dot.active {
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.12);
      transform: scale(1.05);
    }

    .topic-name {
      flex: 1;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.9rem;
      min-width: 0;
      word-break: break-word;
      overflow-wrap: anywhere;
      line-height: 1.45;
    }

    .topic-remove {
      border: none;
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      cursor: pointer;
      padding: 0.4rem 0.75rem;
      border-radius: 0.6rem;
      font-weight: 600;
      font-size: 0.75rem;
      transition: all 0.2s ease;
    }

    .topic-remove:hover {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.18);
    }

    .study-tracker-topic-cell:not(.topic-main) {
      justify-content: center;
      text-align: center;
    }

    .study-tracker-topic-cell.study-tracker-questions {
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      gap: 0.5rem;
      text-align: left;
      width: 100%;
    }

    .study-tracker-questions-detail {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .study-tracker-accuracy {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .study-tracker-questions-progress {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: var(--border-color);
      overflow: hidden;
      display: flex;
    }

    .questions-progress-fill {
      height: 100%;
      flex-shrink: 0;
      flex-grow: 0;
    }

    .questions-progress-fill.correct {
      background: rgba(34, 197, 94, 0.9);
    }

    .questions-progress-fill.incorrect {
      background: rgba(239, 68, 68, 0.85);
    }

    .study-tracker-review-button,
    .study-tracker-reviewed-button {
      border-radius: 0.75rem;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-weight: 600;
      padding: 0.6rem 0.75rem;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      transition: all 0.2s ease;
    }

    @media (max-width: 1280px) {
      .study-tracker-grid {
        grid-template-columns: clamp(260px, 32%, 340px) minmax(0, 1fr);
        gap: 1.25rem;
      }

      .study-tracker-topics-header,
      .study-tracker-topic-row {
        grid-template-columns: minmax(0, 1.8fr) minmax(150px, 1fr) repeat(2, minmax(110px, 0.7fr));
        gap: 0.6rem;
      }

      .study-tracker-topic-cell {
        padding: 0.85rem 0.9rem;
      }

      .topic-name {
        font-size: 0.85rem;
      }

      .study-tracker-accuracy {
        font-size: 0.9rem;
      }
    }

    .study-tracker-review-button.active {
      background: rgba(239, 68, 68, 0.18);
      color: #b91c1c;
      border-color: rgba(239, 68, 68, 0.4);
    }

    .study-tracker-reviewed-button.active {
      background: rgba(34, 197, 94, 0.18);
      color: #15803d;
      border-color: rgba(34, 197, 94, 0.4);
    }

    .study-tracker-empty {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      font-style: italic;
    }

    .study-tracker-stats-panel {
      display: grid;
      gap: 1rem;
      padding-top: 1rem;
      margin-top: 1rem;
      border-top: 1px solid var(--border-color);
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .study-tracker-stats-group strong {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .study-tracker-stats-group p {
      margin: 0.15rem 0;
    }

    @media (min-width: 768px) {
      .study-tracker-stats-panel {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .dark-mode .study-tracker-subject-btn {
      background: rgba(17, 24, 39, 0.9);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text-primary);
    }

    .dark-mode .study-tracker-subject-btn:hover {
      background: rgba(30, 41, 59, 0.95);
    }

    .dark-mode .study-tracker-subject-btn.active {
      background: linear-gradient(135deg, rgba(129, 178, 154, 0.92), rgba(99, 150, 128, 0.9));
      color: #0f172a;
    }

    .dark-mode .study-tracker-subject-remove-btn {
      background: rgba(248, 113, 113, 0.14);
      border-color: rgba(248, 113, 113, 0.45);
      color: #fecaca;
    }

    .dark-mode .study-tracker-subject-remove-btn:hover {
      background: rgba(248, 113, 113, 0.24);
      color: #ffe4e6;
    }

    .dark-mode .study-tracker-add-button {
      background: rgba(17, 24, 39, 0.9);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text-primary);
    }

    .dark-mode .study-tracker-subject-form input,
    .dark-mode .study-tracker-topic-form input {
      background: rgba(17, 24, 39, 0.9);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text-primary);
    }

    .dark-mode .study-tracker-cancel-btn {
      background: rgba(17, 24, 39, 0.9);
      border-color: rgba(148, 163, 184, 0.25);
      color: rgba(203, 213, 225, 0.8);
    }

    .dark-mode .study-tracker-topic-cell {
      background: rgba(17, 24, 39, 0.85);
      border-color: rgba(148, 163, 184, 0.22);
      color: var(--text-primary);
    }

    .dark-mode .study-tracker-topic-row.status-falha .topic-main {
      background: rgba(185, 28, 28, 0.4);
      border-color: rgba(248, 113, 113, 0.55);
    }

    .dark-mode .study-tracker-topic-row.status-pendente .topic-main {
      background: rgba(217, 119, 6, 0.35);
      border-color: rgba(251, 191, 36, 0.55);
    }

    .dark-mode .study-tracker-topic-row.status-concluido .topic-main {
      background: rgba(22, 163, 74, 0.4);
      border-color: rgba(34, 197, 94, 0.55);
    }

    .dark-mode .topic-remove {
      background: rgba(248, 113, 113, 0.2);
      color: #fecaca;
    }

    .dark-mode .topic-remove:hover {
      background: rgba(248, 113, 113, 0.3);
      color: #ffe4e6;
    }

    .dark-mode .study-tracker-status-dot {
      border-color: rgba(148, 163, 184, 0.35);
    }

    .dark-mode .study-tracker-review-button,
    .dark-mode .study-tracker-reviewed-button {
      background: rgba(17, 24, 39, 0.85);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text-primary);
    }

    .dark-mode .study-tracker-review-button.active {
      background: rgba(185, 28, 28, 0.45);
      color: #fee2e2;
      border-color: rgba(248, 113, 113, 0.5);
    }

    .dark-mode .study-tracker-reviewed-button.active {
      background: rgba(22, 101, 52, 0.45);
      color: #d1fae5;
      border-color: rgba(34, 197, 94, 0.5);
    }

    .dark-mode .study-tracker-stats-panel {
      border-color: rgba(148, 163, 184, 0.25);
      color: rgba(203, 213, 225, 0.85);
    }

    .dark-mode .study-tracker-stats-group strong {
      color: var(--text-secondary);
    }

 .lei-panel.dragging{opacity:0.6;}
 .category-content.drag-over{outline:2px dashed var(--c2);outline-offset:4px;}
 .dark-mode .sound-btn.btn-secondary{background-color:rgba(129,178,154,0.2);color:var(--text-primary);}
 .dark-mode .sound-btn.active{background-color:var(--c2);color:#fff;}
 .dark-mode .category-header{background-color:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.15);}
 .dark-mode .lei-panel{background-color:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.12);}
 .dark-mode .artigo-square{background-color:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.15);color:var(--text-primary);}
 .dark-mode .tooltip .tooltip-text{background-color:rgba(31,41,55,0.95);color:#f9fafb;}
 </style></head><body class="antialiased">
<div id="app" class="min-h-screen flex flex-col"> <header class="bg-[var(--card-bg)]/80 backdrop-blur sticky top-0 z-20 shadow-sm border-b border-[var(--border-color)]"> <nav class="container mx-auto px-4 sm:px-6 lg:px-8"> <div class="flex items-center justify-between h-16"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-xl bg-[color:var(--c2)] flex items-center justify-center"> <i class="fa-solid fa-chart-line text-white"></i> </div> <h1 class="text-2xl font-bold tracking-tight text-[var(--text-secondary)]">Dashboard de performance</h1> </div> <div id="main-nav" class="hidden md:flex items-center gap-6"> <a href="#" data-view="dashboard" class="nav-link text-sm">Dashboard</a> <a href="#" data-view="foco" class="nav-link text-sm">Foco e registro</a> <a href="#" data-view="study-tracker" class="nav-link text-sm">Rastreador</a> <a href="#" data-view="lei-seca" class="nav-link text-sm">Lei Seca</a> <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"> <i class="fa-solid fa-moon"></i> </button> <button id="logout-btn" class="btn btn-secondary py-1 px-3 text-sm">Sair</button> </div> <button id="mobile-menu-button" class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:bg-gray-100"> <span class="sr-only">abrir menu</span> <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/> </svg> </button> </div> <div id="mobile-menu" class="md:hidden hidden pb-3"> <a href="#" data-view="dashboard" class="block nav-link px-3 py-2 text-base">Dashboard</a> <a href="#" data-view="foco" class="block nav-link px-3 py-2 text-base">Foco e registro</a> <a href="#" data-view="study-tracker" class="block nav-link px-3 py-2 text-base">Rastreador</a> <a href="#" data-view="lei-seca" class="block nav-link px-3 py-2 text-base">Lei Seca</a> <button id="dark-mode-toggle-mobile" class="mt-2 w-full btn btn-secondary py-2"> <i class="fa-solid fa-moon mr-2"></i>Modo Escuro </button> <button id="logout-btn-mobile" class="mt-2 w-full btn btn-secondary py-2">Sair</button> </div> </nav> </header>
<main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8"> <div id="auth-view" class="hidden"> <div class="max-w-md mx-auto mt-10"> <div class="card p-8"> <form id="login-form"> <h2 class="text-2xl font-bold text-center mb-6">Entrar</h2> <div class="space-y-4"> <div> <label for="login-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label> <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <div> <label for="login-password" class="block text-sm font-medium text-[var(--text-muted)]">Senha</label> <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <div class="flex items-center justify-end"> <div class="text-sm"> <a href="#" id="forgot-password-link" class="font-medium text-[color:var(--c2)] hover:underline">Esqueceu a senha?</a> </div> </div> <p id="login-error" class="text-sm text-red-600 h-5"></p> <div> <button type="submit" class="w-full btn btn-primary py-2">Entrar</button> </div> </div> <p class="mt-4 text-center text-sm"> Não tem uma conta? <a href="#" id="show-register" class="font-medium text-[color:var(--c2)] hover:underline">Cadastre-se</a> </p> </form>
<form id="register-form" class="hidden"> <h2 class="text-2xl font-bold text-center mb-6">Criar Conta</h2> <div class="space-y-4"> <div> <label for="register-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label> <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <div> <label for="register-password" class="block text-sm font-medium text-[var(--text-muted)]">Senha (mínimo 6 caracteres)</label> <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 shadow-sm placeholder-gray-400 sm:text-sm"> </div> <p id="register-error" class="text-sm text-red-600 h-5"></p> <div> <button type="submit" class="w-full btn btn-primary py-2">Criar conta</button> </div> </div> <p class="mt-4 text-center text-sm"> Já tem uma conta? <a href="#" id="show-login" class="font-medium text-[color:var(--c2)] hover:underline">Entrar</a> </p> </form> </div> </div> </div>
<div id="loading-view" class="text-center py-20"> <p class="text-lg font-semibold text-gray-600">Conectando...</p> </div>
<div id="main-content" class="hidden"> <section id="dashboard-view" class="space-y-8"> <div> <div class="card p-4 sm:p-6"> <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end"> <div class="md:col-span-1 lg:col-span-2"> <label for="concurso-nome" class="block text-sm font-medium text-[var(--text-muted)]">Concurso</label> <input type="text" id="concurso-nome" placeholder="Ex: Jurídicos (Geral)" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="concurso-cargo" class="block text-sm font-medium text-[var(--text-muted)]">Cargo</label> <input type="text" id="concurso-cargo" placeholder="Ex: Em aberto" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="concurso-inicio" class="block text-sm font-medium text-[var(--text-muted)]">Início dos estudos</label> <input type="date" id="concurso-inicio" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="concurso-prova" class="block text-sm font-medium text-[var(--text-muted)]">Data da prova</label> <input type="date" id="concurso-prova" class="mt-1 block w-full shadow-sm"> </div> </div> <div id="concurso-countdown" class="text-center mt-4 font-bold text-lg text-[color:var(--c1)]"></div> </div> </div>

<div> <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"> <div> <h2 class="text-xl font-bold text-[var(--text-secondary)]">Visão geral</h2> <p id="dashboard-period-display" class="text-sm text-[var(--text-muted)]">Exibindo dados para o período selecionado.</p> </div> <div class="flex items-center gap-2 flex-wrap"> <button id="import-backup-btn" class="btn btn-secondary py-2 px-3"><i class="fa-solid fa-upload mr-2"></i>Importar</button> <button id="export-backup-btn" class="btn btn-secondary py-2 px-3"><i class="fa-solid fa-download mr-2"></i>Backup</button> <button id="export-pdf-btn" class="btn btn-secondary py-2 px-3"><i class="fa-solid fa-file-pdf mr-2"></i>Exportar PDF</button> <button id="save-all-btn" class="btn btn-primary py-2 px-3"><i class="fa-solid fa-save mr-2"></i>Salvar na Nuvem</button> </div> </div> <div class="card p-4 sm:p-6 mt-4"> <h3 class="text-lg font-semibold text-center mb-4 text-[var(--text-secondary)]">Filtros de análise</h3> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"> <div> <label for="filter-subject" class="block text-sm font-medium text-[var(--text-muted)]">Disciplina</label> <select id="filter-subject" class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="filter-activity" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de atividade</label> <select id="filter-activity" class="mt-1 block w-full shadow-sm"></select> </div> <div class="lg:col-span-2"> <label class="block text-sm font-medium text-[var(--text-muted)]">Período</label> <div class="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-4"> <input type="date" id="filter-start-date" class="block w-full shadow-sm"> <input type="date" id="filter-end-date" class="block w-full shadow-sm"> </div> <div id="period-pills" class="mt-2 flex flex-wrap gap-2"> <button data-period="today" class="pill">Hoje</button> <button data-period="week" class="pill">Esta semana</button> <button data-period="month" class="pill">Este mês</button> <button data-period="all" class="pill">Todo o período</button> </div> </div> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Indicadores</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="card p-4 kpi text-center"> <h3>Horas no período</h3> <p id="total-hours">00h00m</p> </div> <div class="card p-4 kpi text-center"> <h3>Média de acertos</h3> <p id="avg-accuracy">0%</p> </div> <div class="card p-4 kpi text-center"> <h3>Sessão média</h3> <p id="avg-session-duration">0h00m</p> </div> <div class="card p-4 kpi text-center"> <h3>% Horas focadas</h3> <p id="deep-work-ratio">0%</p> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Metas</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-1 lg:grid-cols-3 gap-6 items-stretch"> <div class="card p-4 sm:p-6 lg:col-span-2 flex flex-col"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Constância de estudos</h3> <div id="consistency-tracker" class="mt-4 flex-grow flex flex-col items-center justify-center w-full overflow-x-auto"> </div> </div> <div class="card p-4 sm:p-6 flex flex-col"> <h3 id="weekly-goals-title" class="text-lg font-semibold text-center text-[var(--text-secondary)]">Metas da semana</h3> <div id="weekly-days-tracker" class="flex justify-around items-center my-4"></div> <div id="goals-display-view" class="space-y-3 mt-2 flex-grow flex flex-col justify-center"> </div> <div id="goals-edit-view" class="hidden mt-4 space-y-3"> <div> <label for="goal-hours-input" class="block text-sm text-[var(--text-muted)]">Meta de horas</label> <input type="number" id="goal-hours-input" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="goal-questions-input" class="block text-sm text-[var(--text-muted)]">Meta de questões</label> <input type="number" id="goal-questions-input" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="goal-accuracy-input" class="block text-sm text-[var(--text-muted)]">Meta de acertos (%)</label> <input type="number" id="goal-accuracy-input" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="goal-days-input" class="block text-sm text-[var(--text-muted)]">Meta de dias/semana</label> <input type="number" id="goal-days-input" class="mt-1 block w-full shadow-sm"> </div> <button id="save-goals-btn" class="btn btn-primary py-2 px-3 w-full">Salvar Metas</button> </div> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Análise de desempenho</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-1 lg:grid-cols-2 gap-6"> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]" id="hours-by-subject-title">Distribuição de horas por disciplina</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="hoursBySubjectChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]" id="performance-by-subject-title">Desempenho médio por disciplina</h3> <div class="chart-container"> <canvas id="performanceBySubjectChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Porcentagem de foco</h3> <p class="text-sm text-center text-[var(--text-muted)]">Tempo de estudo efetivo vs. pausas no período</p> <div class="chart-container mx-auto max-w-sm"> <canvas id="focusPercentageChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Distribuição de tempo por atividade</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="activityDistributionChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6 lg:col-span-2"> <h3 class="text-lg font-semibold text-center mb-4 text-[var(--text-secondary)]">Forças e fraquezas por disciplina</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"> <div class="chart-container" style="height: 400px;"> <canvas id="strengthsWeaknessesChart"></canvas> </div> <div id="strengths-weaknesses-details" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"> </div> </div> </div> <div class="card p-4 sm:p-6 lg:col-span-2"> <div class="flex flex-col sm:flex-row justify-center items-center mb-4 gap-4"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução das questões</h3> <div id="questions-evolution-toggle" class="flex items-center text-sm p-1 bg-[var(--bg)] rounded-lg"> <input type="radio" name="questions-view" id="q-view-relative" value="relative" class="sr-only chart-toggle-input" checked> <label for="q-view-relative" class="chart-toggle-label">Desempenho relativo (%)</label> <input type="radio" name="questions-view" id="q-view-absolute" value="absolute" class="sr-only chart-toggle-input"> <label for="q-view-absolute" class="chart-toggle-label">Número de resoluções</label> </div> </div> <div class="overflow-x-auto"> <div class="chart-container" style="height: 360px; min-width: 700px;"> <canvas id="questionsEvolutionChart"></canvas> </div> </div> </div>
<div class="card p-4 sm:p-6 lg:col-span-2"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução das horas de estudo (diário)</h3> <p class="text-sm text-[var(--text-muted)] text-center">Média diária no período: <span id="average-time-display" class="font-semibold">00h00m</span></p> <div class="overflow-x-auto"> <div class="chart-container" style="height: 360px; min-width: 700px;"> <canvas id="studyEvolutionChart"></canvas> </div> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução das horas de estudo (mensal)</h3> <div class="overflow-x-auto"> <div class="chart-container" style="min-width: 500px;"> <canvas id="monthlyStudyEvolutionChart"></canvas> </div> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Rendimento por horário do dia</h3> <div class="chart-container"> <canvas id="performanceByTimeOfDayChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Produtividade por dia da semana</h3> <div class="chart-container"> <canvas id="productivityByDayChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Humor vs. desempenho</h3> <div class="chart-container"> <canvas id="moodVsPerformanceChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Contagem de sessões por humor</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="moodCountChart"></canvas> </div> </div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Contagem de sessões por flow</h3> <div class="chart-container mx-auto max-w-sm"> <canvas id="flowCountChart"></canvas> </div> </div> <div class="card p-4 sm:p-6 hidden"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Flow vs. desempenho</h3> <div class="chart-container"> <canvas id="flowVsPerformanceChart"></canvas> </div> </div> <div class="card p-4 sm:p-6 hidden"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Desempenho por Atividade</h3> <p class="text-sm text-center text-[var(--text-muted)]">Média de acertos por tipo de atividade</p> <div class="chart-container"> <canvas id="performanceByActivityChart"></canvas> </div> </div>
<div class="card p-4 sm:p-6 lg:col-span-2"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Evolução semanal (últimas 4 semanas)</h3> <div id="weekly-evolution-table" class="overflow-x-auto mt-4"></div> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Recordes</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="card p-4 kpi text-center"> <h3>Horas (dia)</h3> <p id="record-hours-day">00h00m</p> </div> <div class="card p-4 kpi text-center"> <h3>Acertos (%)</h3> <p id="record-accuracy">0%</p> </div> <div class="card p-4 kpi text-center"> <h3>Maior sequência</h3> <p id="record-streak">0 dias</p> </div> <div class="card p-4 kpi text-center"> <h3>Horas (mês)</h3> <p id="record-hours-month">00h00m</p> </div> </div> </div> <div> <div class="card p-4 sm:p-6"> <h3 class="text-lg font-semibold text-center mb-4 text-[var(--text-secondary)] flex justify-center items-center gap-4"> <span>Insights rápidos</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h3> <div id="insights-container" class="collapsible-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm text-[var(--text-muted)]"> </div> </div> </div>
<div> <h2 class="text-xl font-bold text-[var(--text-secondary)] mb-4 flex justify-between items-center"> <span>Histórico detalhado do período</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <div class="collapsible-content card p-4 sm:p-6"> <div class="flex justify-end mb-4"> <input type="text" id="log-search-input" placeholder="Buscar por disciplina ou assunto..." class="block w-full md:w-1-3 shadow-sm"> </div> <div id="detailed-log-table-container" class="overflow-x-auto max-h-56"> </div> </div> </div>
<div id="backup-section"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-bold text-[var(--text-secondary)] flex justify-between items-center w-full"> <span>Backups salvos (Local)</span> <button class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]"><i class="fa-solid fa-chevron-up"></i></button> </h2> <button id="create-backup-now-btn" class="btn btn-secondary py-2 px-3 whitespace-nowrap ml-4"><i class="fa-solid fa-save mr-2"></i>Salvar backup local</button> </div> <div class="collapsible-content card p-4 sm:p-6"> <p class="text-sm text-[var(--text-muted)] mb-4">Seus backups são salvos localmente no navegador. Você pode baixá-los a qualquer momento. Um backup automático é criado diariamente.</p> <div id="backup-list" class="space-y-2"> </div> </div> </div> </section>
<section id="foco-view" class="hidden space-y-8"> <div class="max-w-7xl mx-auto space-y-8"> <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<div class="card p-6"> <h3 class="text-lg font-semibold text-center mb-6 text-[var(--text-secondary)]">Timer pomodoro</h3> <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6"> <div> <label for="pomodoro-subject" class="block text-sm font-medium text-[var(--text-muted)]">Matéria</label> <select id="pomodoro-subject" class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="pomodoro-subtopic" class="block text-sm font-medium text-[var(--text-muted)]">Assunto (opcional)</label> <select id="pomodoro-subtopic" class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="pomodoro-cycles" class="block text-sm font-medium text-[var(--text-muted)]">Ciclos (p/ pausa longa)</label> <input type="number" id="pomodoro-cycles" value="4" min="1" class="mt-1 block w-full shadow-sm"> </div> </div>
<div class="flex flex-col items-center gap-2"> <div id="pomodoro-timer-display" class="text-8xl font-black tracking-tighter">25:00</div> <div id="pomodoro-status" class="text-lg font-medium text-[var(--text-muted)]">Pronto para focar?</div> <div id="pomodoro-pause-display" class="timer-pause-display"></div> <div id="pomodoro-end-time" class="text-sm text-gray-400 h-5"></div> <div class="flex gap-1.5 items-center mt-2" id="pomodoro-cycle-dots"></div> <div id="current-task-display" class="mt-4 text-center text-lg font-semibold text-[var(--text-muted)] h-7"> </div> </div>
<div class="mt-8 flex flex-wrap justify-center items-center gap-4"> <button id="pomodoro-start-pause" class="btn btn-primary py-2 px-6">Iniciar</button> <button id="pomodoro-skip" class="btn btn-secondary py-2 px-6">Pular</button> <button id="pomodoro-reset" class="btn btn-secondary py-2 px-6">Resetar</button> <button id="pomodoro-open-mini" class="btn btn-secondary py-2 px-4" title="Abrir timer flutuante"><i class="fa-solid fa-window-restore"></i></button> </div>
<div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mt-8 pt-6 border-t border-[var(--border-color)]"> <div> <label for="pomodoro-work-duration" class="block text-sm font-medium text-[var(--text-muted)]">Foco (min)</label> <input type="number" id="pomodoro-work-duration" value="25" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-short-break-duration" class="block text-sm font-medium text-[var(--text-muted)]">Pausa curta</label> <input type="number" id="pomodoro-short-break-duration" value="5" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-long-break-duration" class="block text-sm font-medium text-[var(--text-muted)]">Pausa longa</label> <input type="number" id="pomodoro-long-break-duration" value="15" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-alert-time" class="block text-sm font-medium text-[var(--text-muted)]">Alerta (min)</label> <input type="number" id="pomodoro-alert-time" placeholder="Opcional" class="mt-1 block w-full shadow-sm"> </div> <div> <label for="pomodoro-sound-select" class="block text-sm font-medium text-[var(--text-muted)]">Som do alerta</label> <select id="pomodoro-sound-select" class="mt-1 block w-full shadow-sm"> <option value="notification">Notificação</option> <option value="chime">Sino</option> <option value="simple">Simples</option> </select> </div> </div> <div class="mt-4 flex items-center justify-center gap-2"> <input id="pomodoro-auto-start" type="checkbox" class="h-4 w-4 text-[color:var(--c2)] rounded border-[var(--border-color)] focus:ring-[color:var(--c2)]"> <label for="pomodoro-auto-start" class="text-sm">Iniciar próximo ciclo automaticamente</label> </div> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Tarefas do Dia</h3> <form id="add-task-form" class="mt-4 flex items-center gap-3"> <input type="text" id="new-task-input" placeholder="Adicionar uma tarefa..." class="flex-grow shadow-sm"> <input type="number" id="new-task-pomodoros" min="1" value="1" class="w-20 text-center shadow-sm" title="Pomodoros estimados"> <button type="submit" class="btn btn-primary py-2 px-3 whitespace-nowrap">Adicionar</button> </form> <div id="task-list-container" class="mt-4 space-y-2 max-h-96 overflow-y-auto"> </div> <div class="mt-4 pt-4 border-t border-[var(--border-color)] flex justify-end gap-2 text-sm"> <button id="clear-completed-tasks-btn" class="btn btn-secondary py-1 px-3"><i class="fa-solid fa-check-double mr-2"></i>Limpar concluídas</button> <button id="clear-all-tasks-btn" class="btn btn-danger py-1 px-3"><i class="fa-solid fa-trash mr-2"></i>Limpar tudo</button> </div> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Cronômetro contínuo</h3> <p class="text-sm text-[var(--text-muted)] text-center">Use para sessões de estudo com tempo livre.</p> <div class="text-center my-6"> <div id="stopwatch-display" class="text-6xl md:text-7xl font-black tracking-tighter">00:00:00</div> <div id="stopwatch-pause-display" class="timer-pause-display"></div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-w-lg mx-auto mt-4"> <div> <label for="stopwatch-subject" class="sr-only">Matéria do cronômetro</label> <select id="stopwatch-subject" class="block w-full shadow-sm"></select> </div> <div> <label for="stopwatch-subtopic" class="sr-only">Assunto do cronômetro</label> <select id="stopwatch-subtopic" class="block w-full shadow-sm"></select> </div> </div> </div>
<div class="max-w-md mx-auto my-4 grid grid-cols-1 sm:grid-cols-2 gap-4 items-end"> <div> <label class="block text-sm font-medium text-[var(--text-muted)]">Alerta (opcional)</label> <div class="flex items-center gap-2 mt-1"> <input type="number" id="stopwatch-alert-hours" min="0" placeholder="h" class="block w-full shadow-sm text-center"> <input type="number" id="stopwatch-alert-minutes" min="0" max="59" placeholder="m" class="block w-full shadow-sm text-center"> </div> </div> <div> <label for="stopwatch-sound-select" class="block text-sm font-medium text-[var(--text-muted)]">Som do alerta</label> <select id="stopwatch-sound-select" class="mt-1 block w-full shadow-sm"> <option value="notification">Notificação</option> <option value="chime">Sino</option> <option value="simple">Simples</option> </select> </div> </div> <div class="mt-8 flex flex-wrap justify-center gap-4"> <button id="stopwatch-start-pause" class="btn btn-primary py-2 px-5">Iniciar</button> <button id="stopwatch-log" class="btn btn-secondary py-2 px-5">Registrar</button> <button id="stopwatch-reset" class="btn btn-secondary py-2 px-5">Resetar</button> <button id="stopwatch-open-mini" class="btn btn-secondary py-2 px-3" title="Abrir timer flutuante"><i class="fa-solid fa-window-restore"></i></button> </div> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Sons de Fundo</h3> <div class="mt-4 pt-4 border-t border-[var(--border-color)]"> <div class="flex items-center gap-4 mb-4"> <i class="fa-solid fa-volume-low text-lg text-[var(--text-muted)]"></i> <input type="range" id="background-sound-volume" min="-60" max="0" step="1" value="-20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" title="Ajuste o volume ou deixe no mínimo para silenciar"> <i class="fa-solid fa-volume-high text-lg text-[var(--text-muted)]"></i> </div> <div id="background-sound-controls" class="flex justify-center flex-wrap gap-3"> <button class="sound-btn btn btn-secondary active" data-sound="off" data-sound-type="off"><i class="fa-solid fa-stop"></i>Silêncio</button> <button class="sound-btn btn btn-secondary" data-sound="white" data-sound-type="noise"><i class="fa-solid fa-wave-square"></i>Ruído Branco</button> <button class="sound-btn btn btn-secondary" data-sound="pink" data-sound-type="noise"><i class="fa-solid fa-wave-square"></i>Ruído Rosa</button> <button class="sound-btn btn btn-secondary" data-sound="brown" data-sound-type="noise"><i class="fa-solid fa-wave-square"></i>Ruído Marrom</button> </div> </div> <div class="mt-4 pt-4 border-t border-[var(--border-color)]"> <div class="flex justify-between items-center"> <h4 class="text-md font-semibold text-center text-[var(--text-secondary)]">Músicas do YouTube</h4> <button id="skip-youtube-btn" class="btn btn-secondary p-2 text-xs"><i class="fa-solid fa-forward-step"></i></button> </div> <div class="mt-2 flex items-center gap-2"> <input type="text" id="youtube-url-input" placeholder="Cole a URL do YouTube aqui" class="flex-grow shadow-sm text-sm"> <button id="add-youtube-url-btn" class="btn btn-secondary py-2 px-3 text-sm">Add</button> </div> <div id="youtube-music-list" class="mt-2 space-y-1 text-sm max-h-24 overflow-y-auto"></div> </div> </div> </div>
<div class="space-y-8 mt-8"> <div class="card p-6" id="registration-card"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Registrar sessão manual</h3> <p class="text-sm text-[var(--text-muted)] text-center">Preencha os detalhes da sua sessão de estudo.</p> <form id="study-form" class="mt-6 space-y-6"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="date" class="block text-sm font-medium text-[var(--text-muted)]">Data</label> <input type="date" id="date" required class="mt-1 block w-full shadow-sm"> </div> <div> <label for="time-of-day" class="block text-sm font-medium text-[var(--text-muted)]">Período do dia</label> <select id="time-of-day" class="mt-1 block w-full shadow-sm"> <option value="madrugada">Madrugada (00-06)</option> <option value="manha">Manhã (06-12)</option> <option value="tarde">Tarde (12-18)</option> <option value="noite">Noite (18-00)</option> </select> </div> </div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="subject" class="block text-sm font-medium text-[var(--text-muted)]">Disciplina</label> <select id="subject" required class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="subtopic" class="block text-sm font-medium text-[var(--text-muted)]">Assunto (opcional)</label> <select id="subtopic" class="mt-1 block w-full shadow-sm"></select> </div> </div>
<div> <label class="block text-sm font-medium text-[var(--text-muted)]">Duração</label> <div class="flex items-center gap-2 mt-1"> <input type="number" id="manual-duration-hours" min="0" placeholder="0" class="block w-full shadow-sm text-center"> <span class="text-sm text-gray-500">horas</span> <input type="number" id="manual-duration-minutes" min="0" max="59" placeholder="0" class="block w-full shadow-sm text-center"> <span class="text-sm text-gray-500">min</span> </div> <div class="mt-2 flex flex-wrap justify-center gap-2 text-xs"> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="5">5m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="10">10m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="15">15m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="20">20m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="30">30m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-m="45">45m</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="1">1h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="2">2h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="3">3h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="4">4h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="5">5h</button> <button type="button" class="duration-btn btn btn-secondary py-1 px-2" data-h="6">6h</button> </div> </div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="activity-type" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de atividade</label> <select id="activity-type" required class="mt-1 block w-full shadow-sm"></select> </div> <div> <label for="session-type" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de sessão</label> <select id="session-type" required class="mt-1 block w-full shadow-sm"> <option value="focada">Focada (deep work)</option> <option value="superficial">Superficial</option> </select> </div> </div>
<div id="questions-section" class="hidden space-y-4"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="questions-total" class="block text-sm font-medium text-[var(--text-muted)]">Nº de questões</label> <input type="number" id="questions-total" min="0" class="question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> <div> <label for="questions-correct" class="block text-sm font-medium text-[var(--text-muted)]">Nº de acertos</label> <input type="number" id="questions-correct" min="0" class="question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> </div> </div>
<div class="flex justify-between items-center"> <div> <span class="block text-sm text-center mb-2">Como foi seu estudo?</span> <div id="mood-tracker" class="flex items-start gap-4"> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-red" data-mood="ruim"></button> <span class="text-xs mt-1">Ruim</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-yellow" data-mood="medio"></button> <span class="text-xs mt-1">Médio</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-green" data-mood="bom"></button> <span class="text-xs mt-1">Bom</span> </div> </div> <input type="hidden" id="mood-input" name="mood"> </div> <div id="flow-score-section" class="space-y-2 w-1/2"> <label for="flow-score" class="block text-sm">Nível de flow</label> <div class="flow-slider-container"> <input type="range" id="flow-score" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"> <div class="flow-slider-labels"> <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span> </div> </div> </div> </div>
<div class="flex justify-end gap-3 pt-4"> <button type="button" id="cancel-edit-btn" class="btn btn-secondary py-2 px-4 hidden">Cancelar edição</button> <button type="submit" class="btn btn-primary py-2 px-4">Salvar sessão</button> </div> </form> </div>
<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Histórico de sessões recentes</h3> <div id="session-history-list" class="mt-4 space-y-3 max-h-96 overflow-y-auto"> </div> </div> <div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Gerenciar matérias e assuntos</h3> <div class="mt-4 flex items-center gap-3"> <input type="text" id="new-subject-input" placeholder="Nome da nova matéria" class="flex-grow shadow-sm"> <button id="add-subject-btn" class="btn btn-primary py-2 px-3">Adicionar matéria</button> </div> <div id="subjects-management-container" class="mt-4 space-y-4"> </div> </div>

<div class="card p-6"> <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Configurações gerais</h3> <div class="mt-6 pt-6 border-t border-[var(--border-color)] space-y-4"> <div> <label for="week-start-day" class="block text-sm font-medium text-[var(--text-muted)]">Início da semana</label> <select id="week-start-day" class="mt-1 block w-full shadow-sm"> <option value="1">Segunda-feira</option> <option value="0">Domingo</option> </select> </div> <div> <h4 class="text-md font-semibold">Resetar todos os dados</h4> <p class="text-xs text-[var(--text-muted)]">Cuidado: esta ação é irreversível e apagará todos os seus dados da nuvem.</p> <button id="reset-all-data-btn" class="btn btn-danger mt-2 py-2 px-3 w-full">Resetar todos os dados da nuvem</button> </div> </div> </div> </div> </div> </section>

    <section id="study-tracker-view" class="hidden space-y-8">
      <div class="space-y-6 max-w-7xl mx-auto w-full">
        <div class="card p-4 sm:p-6">
          <div class="flex flex-col gap-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <h2 class="text-lg sm:text-xl font-bold text-[var(--text-secondary)]">Rastreador de Estudos</h2>
              <p class="text-xs text-[var(--text-muted)]">Matéria selecionada: <span id="study-tracker-selected-subject" class="font-semibold text-[var(--text-secondary)]"></span></p>
            </div>
            <div class="study-tracker-wrapper overflow-x-auto">
              <div class="study-tracker-grid">
                <div class="study-tracker-column study-tracker-subjects">
                  <div class="study-tracker-column-header">Matérias</div>
                  <div id="study-tracker-subjects-list" class="study-tracker-column-body study-tracker-scroll-area"></div>
                  <button id="study-tracker-remove-subject-btn" type="button" class="study-tracker-subject-remove-btn hidden">Excluir matéria</button>
                  <button id="study-tracker-toggle-subject-form" class="study-tracker-add-button"><i class="fa-solid fa-plus"></i> Nova matéria</button>
                  <form id="study-tracker-add-subject-form" class="study-tracker-subject-form hidden">
                    <input type="text" id="study-tracker-new-subject-name" placeholder="Nome da matéria">
                    <div class="study-tracker-form-actions">
                      <button type="submit" class="study-tracker-save-btn">Salvar</button>
                      <button type="button" data-action="cancel-new-subject" class="study-tracker-cancel-btn">Cancelar</button>
                    </div>
                  </form>
                </div>
                <div class="study-tracker-main-column">
                  <div class="study-tracker-topics-header">
                    <span>Assuntos</span>
                    <span>Questões (% acerto)</span>
                    <span>Revisar</span>
                    <span>Revisado</span>
                  </div>
                  <div id="study-tracker-topics-container" class="study-tracker-topics-container study-tracker-scroll-area"></div>
                  <form id="study-tracker-add-topic-form" class="study-tracker-topic-form">
                    <input type="text" id="study-tracker-new-topic" placeholder="Novo assunto">
                    <button type="submit"><i class="fa-solid fa-plus"></i></button>
                  </form>
                </div>
              </div>
            </div>
            <div id="study-tracker-stats-panel" class="study-tracker-stats-panel"></div>
          </div>
        </div>
      </div>
    </section>

<section id="lei-seca-view" class="hidden space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-bold text-[var(--text-secondary)]">Guia de Lei Seca</h2>
            <p class="text-sm text-[var(--text-muted)]">Acompanhe suas leituras e revisões dos artigos.</p>
        </div>
        <div class="flex items-center gap-2">
            <input type="text" id="lei-seca-search" placeholder="Buscar por lei..." class="shadow-sm w-48 text-sm">
            <button id="add-lei-btn" class="btn btn-primary py-2 px-4">Adicionar Lei</button>
        </div>
    </div>
    <div id="laws-container" class="space-y-6">
        <!-- As leis serão renderizadas aqui pelo JavaScript -->
    </div>
</section> </div> </main>
<footer class="bg-[var(--card-bg)] border-t border-[var(--border-color)]"> <div class="container mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-[var(--text-muted)]"> <p>Feito para transformar estudo em resultado.</p> </div> </footer> </div>
<div id="toast" class="fixed bottom-5 right-5 bg-[color:var(--c1)] text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-2 transition-all duration-300">ok</div>
<!-- Modal de Sessão -->
<div id="session-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden"></div> <div id="session-modal-panel" class="fixed bottom-0 left-0 right-0 bg-[var(--card-bg)] p-6 rounded-t-2xl shadow-lg z-50 transition-transform duration-300 ease-in-out hidden"> <form id="modal-session-form" class="max-w-xl mx-auto space-y-4"> <h3 class="text-lg font-semibold text-center">Como foi a sua sessão de foco?</h3> <p id="modal-session-info" class="text-center text-[var(--text-muted)]"></p> <div> <label for="modal-activity-type" class="block text-sm font-medium text-[var(--text-muted)]">Tipo de atividade</label> <select id="modal-activity-type" required class="mt-1 block w-full shadow-sm"></select> </div>
<div id="modal-questions-section" class="hidden space-y-4"> <div class="grid grid-cols-1 sm:grid-cols-2 gap-6"> <div> <label for="modal-questions-total" class="block text-sm font-medium text-[var(--text-muted)]">Nº de questões</label> <input type="number" id="modal-questions-total" min="0" class="modal-question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="modal-question-btn-total btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> <div> <label for="modal-questions-correct" class="block text-sm font-medium text-[var(--text-muted)]">Nº de acertos</label> <input type="number" id="modal-questions-correct" min="0" class="modal-question-input mt-1 block w-full shadow-sm"> <div class="flex flex-wrap justify-center gap-1 mt-1"> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="5">+5</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="10">+10</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="25">+25</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="50">+50</button> <button type="button" class="modal-question-btn-correct btn btn-secondary py-1 px-2 text-xs" data-q="100">+100</button> </div> </div> </div> </div>
<div class="flex justify-between items-center gap-6"> <div class="flex-grow"> <span class="block text-sm text-center mb-2">Como foi seu estudo?</span> <div id="modal-mood-tracker" class="flex items-start justify-center gap-4"> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-red" data-mood="ruim"></button> <span class="text-xs mt-1">Ruim</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-yellow" data-mood="medio"></button> <span class="text-xs mt-1">Médio</span> </div> <div class="mood-square-wrapper"> <button type="button" class="mood-square mood-green" data-mood="bom"></button> <span class="text-xs mt-1">Bom</span> </div> </div> <input type="hidden" id="modal-mood-input" name="mood"> </div> <div class="space-y-2 w-1/2"> <label for="modal-flow-score" class="block text-sm">Nível de flow</label> <div class="flow-slider-container"> <input type="range" id="modal-flow-score" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"> <div class="flow-slider-labels"> <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span> </div> </div> </div> </div>
<div class="flex justify-end gap-3 pt-4"> <button type="button" id="modal-cancel-btn" class="btn btn-secondary py-2 px-4">Cancelar</button> <button type="submit" class="btn btn-primary py-2 px-4">Salvar sessão</button> </div> </form> </div>
<!-- Modal de Notificação -->
<div id="notification-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden"></div> <div id="notification-modal-panel" class="fixed bottom-0 left-0 right-0 bg-[var(--card-bg)] p-6 rounded-t-2xl shadow-lg z-50 transition-transform duration-300 ease-in-out hidden text-center"> <h3 id="notification-title" class="text-xl font-bold"></h3> <p id="notification-message" class="text-[var(--text-muted)] mt-2"></p> <button id="notification-ok-btn" class="btn btn-primary mt-6 py-2 px-8">OK</button> </div> <input type="file" id="backup-file-input" class="hidden" accept=".json">
<!-- Modal para Adicionar Lei Seca -->
<div id="add-lei-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden"></div>
<div id="add-lei-modal-panel" class="fixed bottom-0 left-0 right-0 bg-[var(--card-bg)] p-6 rounded-t-2xl shadow-lg z-50 transition-transform duration-300 ease-in-out hidden transform translate-y-full">
    <form id="add-lei-form" class="max-w-xl mx-auto space-y-4">
        <h3 class="text-lg font-semibold text-center text-[var(--text-secondary)]">Adicionar Nova Lei</h3>
        <div>
            <label for="lei-nome-input" class="block text-sm font-medium text-[var(--text-muted)]">Nome da Lei</label>
            <input type="text" id="lei-nome-input" required class="mt-1 block w-full shadow-sm" placeholder="Ex: Constituição Federal">
        </div>
        <div>
            <label for="lei-artigos-input" class="block text-sm font-medium text-[var(--text-muted)]">Número de Artigos</label>
            <input type="number" id="lei-artigos-input" required min="1" class="mt-1 block w-full shadow-sm" placeholder="Ex: 250">
        </div>
        <div>
            <label for="lei-categoria-input" class="block text-sm font-medium text-[var(--text-muted)]">Categoria</label>
            <input type="text" id="lei-categoria-input" class="mt-1 block w-full shadow-sm" placeholder="Ex: Direito Constitucional" list="lei-categorias-datalist">
            <datalist id="lei-categorias-datalist"></datalist>
        </div>
        <div>
            <label for="lei-url-input" class="block text-sm font-medium text-[var(--text-muted)]">Link da Lei (opcional)</label>
            <input type="url" id="lei-url-input" class="mt-1 block w-full shadow-sm" placeholder="https://www.planalto.gov.br/...">
        </div>
        <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="add-lei-modal-cancel-btn" class="btn btn-secondary py-2 px-4">Cancelar</button>
            <button type="submit" class="btn btn-primary py-2 px-4">Adicionar</button>
        </div>
    </form>
</div>
<video id="pip-video" class="hidden" muted playsinline></video> <canvas id="pip-canvas" width="300" height="200" class="hidden"></canvas><div id="youtube-player" class="fixed top-[-9999px] left-[-9999px]"></div><script> const firebaseConfig = { apiKey: "AIzaSyD0ZFxuLY452R6JENiRk-m3zJsuhj5GJaw", authDomain: "dashboard-b436d.firebaseapp.com", databaseURL: "https://dashboard-b436d-default-rtdb.firebaseio.com", projectId: "dashboard-b436d", storageBucket: "dashboard-b436d.firebasestorage.app", messagingSenderId: "501090317163", appId: "1:501090317163:web:a69822ae2e161a1bc3522e" };
class LeiSecaController {
    constructor(app) {
        this.app = app;
        this.GREEN_SCALE = [
            '#E9FBE8','#D5F5D1','#C0EFBA','#ACE9A3','#98E38D',
            '#84DD76','#70D760','#5DD24A','#4ACD34','#37C71E',
            '#2FB91B','#29A918','#239915','#1E8913','#197911',
            '#14690F','#0F590D','#0A490B','#053909','#002F07'
        ];
        this.selectors = {
            addBtn: '#add-lei-btn',
            searchInput: '#lei-seca-search',
            addForm: '#add-lei-form',
            cancelBtn: '#add-lei-modal-cancel-btn',
            backdrop: '#add-lei-modal-backdrop',
            container: '#laws-container',
            modal: '#add-lei-modal-panel'
        };
        this.draggedLawId = null;
        this.init();
    }

    init() {
        this.bindEvents();
    }

    bindEvents() {
        this.getEl(this.selectors.addBtn)?.addEventListener('click', () => this.openAddLeiModal());
        this.getEl(this.selectors.searchInput)?.addEventListener('input', (e) => this.handleLeiSecaSearch(e));
        this.getEl(this.selectors.addForm)?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleAddNewLei();
        });
        this.getEl(this.selectors.cancelBtn)?.addEventListener('click', () => this.closeAddLeiModal());
        this.getEl(this.selectors.backdrop)?.addEventListener('click', () => this.closeAddLeiModal());

        const container = this.getEl(this.selectors.container);
        if (container) {
            container.addEventListener('click', (e) => this.handleContainerClick(e));
            container.addEventListener('contextmenu', (e) => this.handleContainerRightClick(e));
        }
    }

    handleContainerClick(e) {
        const square = e.target.closest('.artigo-square');
        if (square) {
            this.handleArticleClick(
                parseInt(square.dataset.lawId, 10),
                parseInt(square.dataset.articleNum, 10)
            );
            return;
        }

        const button = e.target.closest('button[data-action]');
        if (button) this.handleButtonAction(button);
    }

    handleContainerRightClick(e) {
        const square = e.target.closest('.artigo-square');
        if (square) {
            e.preventDefault();
            this.handleArticleRightClick(
                parseInt(square.dataset.lawId, 10),
                parseInt(square.dataset.articleNum, 10)
            );
        }
    }

    handleButtonAction(button) {
        const action = button.dataset.action;
        const lawId = parseInt(button.dataset.lawId, 10);

        const actions = {
            'delete-law': () => this.deleteLaw(lawId),
            'mark-all-read': () => this.updateArticles(lawId, 'mark-all'),
            'reset-all': () => this.updateArticles(lawId, 'reset'),
            'mark-interval': () => this.markInterval(lawId, button),
            'toggle-category': () => this.toggleCategory(button)
        };

        actions[action]?.();
    }
    
    openAddLeiModal() {
        this.getEl(this.selectors.addForm)?.reset();
        this.populateCategoryDatalist();
        this.showElement(this.selectors.backdrop);
        this.getEl(this.selectors.modal)?.classList.remove('hidden', 'translate-y-full');
    }

    closeAddLeiModal() {
        this.hideElement(this.selectors.backdrop);
        this.getEl(this.selectors.modal)?.classList.add('translate-y-full');
        // Add a delay to allow the animation to finish before hiding
        setTimeout(() => this.getEl(this.selectors.modal)?.classList.add('hidden'), 300);
    }

    populateCategoryDatalist() {
        const datalist = this.getEl('#lei-categorias-datalist');
        const laws = this.app.state.parameters.leiSeca?.laws || [];
        const categories = [...new Set(laws.map(l => l.category).filter(Boolean))];
        
        if (datalist) {
            datalist.innerHTML = categories
                .map(c => `<option value="${c}">`)
                .join('');
        }
    }

    handleAddNewLei() {
        const name = this.getEl('#lei-nome-input')?.value.trim();
        const count = parseInt(this.getEl('#lei-artigos-input')?.value, 10);
        const category = this.getEl('#lei-categoria-input')?.value.trim() || 'Geral';
        const rawUrl = this.getEl('#lei-url-input')?.value || '';
        const normalizedUrl = this.normalizeLeiUrl(rawUrl);

        if (!name || isNaN(count) || count <= 0) {
            this.app.toast('Nome e/ou número de artigos inválido.', false);
            return;
        }
        if (normalizedUrl === null) {
            this.app.toast('Link da lei inválido.', false);
            return;
        }

        const newLaw = this.createLawObject(name, count, category, normalizedUrl);
        this.addLawToState(newLaw);
        this.app.saveData(true, `Lei "${name}" adicionada.`);
        this.renderLeiSecaView();
        this.closeAddLeiModal();
    }

    normalizeLeiUrl(url) {
        const trimmed = (url || '').trim();
        if (!trimmed) return '';
        const withProtocol = /^https?:\/\//i.test(trimmed) ? trimmed : `https://${trimmed}`;
        try {
            const formatted = new URL(withProtocol);
            return formatted.href;
        } catch (error) {
            console.warn('URL inválida fornecida para lei:', url, error);
            return null;
        }
    }

    createLawObject(name, count, category, url) {
        return {
            id: Date.now(),
            name,
            articleCount: count,
            category,
            url: url || '',
            articles: Array.from({ length: count }, (_, i) => ({
                num: i + 1,
                reads: 0
            }))
        };
    }

    addLawToState(law) {
        if (!this.app.state.parameters.leiSeca) {
            this.app.state.parameters.leiSeca = { laws: [] };
        }
        if (!this.app.state.parameters.leiSeca.laws) {
            this.app.state.parameters.leiSeca.laws = [];
        }
        this.app.state.parameters.leiSeca.laws.push(law);
    }

    deleteLaw(lawId) {
        if (confirm('Tem certeza que deseja excluir esta lei e todos os seus dados?')) {
            this.app.state.parameters.leiSeca.laws = 
                this.app.state.parameters.leiSeca.laws.filter(l => l.id !== lawId);
            this.app.saveData(true, 'Lei excluída.');
            this.renderLeiSecaView();
        }
    }

    handleArticleClick(lawId, articleNum) {
        const article = this.findArticle(lawId, articleNum);
        if (article) {
            article.reads++;
            this.app.saveData();
            this.updateLeiSecaDOM(lawId, articleNum);
        }
    }

    handleArticleRightClick(lawId, articleNum) {
        const article = this.findArticle(lawId, articleNum);
        if (article && article.reads > 0) {
            article.reads = 0;
            this.app.saveData();
            this.updateLeiSecaDOM(lawId, articleNum);
        }
    }

    findArticle(lawId, articleNum) {
        return this.app.state.parameters.leiSeca?.laws
            .find(l => l.id === lawId)
            ?.articles.find(a => a.num === articleNum);
    }

    updateArticles(lawId, mode, value = null) {
        const law = this.app.state.parameters.leiSeca?.laws.find(l => l.id === lawId);
        if (!law) return;

        const modes = {
            'mark-all': () => law.articles.forEach(a => a.reads = 20),
            'reset': () => law.articles.forEach(a => a.reads = 0),
            'interval': () => this.processInterval(law, value)
        };

        modes[mode]?.();

        if (modes[mode]) {
            this.app.saveData(true, 'Artigos atualizados.');
            this.renderLeiSecaView();
        }
    }

    processInterval(law, value) {
        const parts = value.split('-').map(s => parseInt(s.trim(), 10));
        const [start, end = start] = parts;

        if (isNaN(start) || isNaN(end) || start > end || start < 1) {
            this.app.toast('Intervalo inválido.', false);
            return;
        }

        law.articles.forEach(a => {
            if (a.num >= start && a.num <= end) a.reads++;
        });
    }

    markInterval(lawId, button) {
        const input = this.getEl(`#interval-input-${lawId}`);
        if (input?.value) {
            this.updateArticles(lawId, 'interval', input.value);
        }
    }

    handleDragStart(e) {
        const panel = e.target.closest('.lei-panel');
        if (!panel) return;
        this.draggedLawId = parseInt(panel.dataset.lawId, 10);
        panel.classList.add('dragging');
    }

    handleDragEnd(e) {
        const panel = e.target.closest('.lei-panel');
        if (panel) panel.classList.remove('dragging');
        document.querySelectorAll('.category-content.drag-over').forEach(el => el.classList.remove('drag-over'));
        this.draggedLawId = null;
    }

    handleDragOver(e) {
        e.preventDefault();
        const container = e.currentTarget;
        container.classList.add('drag-over');
        const dragging = container.querySelector('.lei-panel.dragging');
        if (!dragging) return;
        const afterElement = this.getDragAfterElement(container, e.clientY);
        if (!afterElement) {
            container.appendChild(dragging);
        } else if (afterElement !== dragging) {
            container.insertBefore(dragging, afterElement);
        }
    }

    handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    handleDrop(e) {
        e.preventDefault();
        const container = e.currentTarget;
        container.classList.remove('drag-over');
        if (this.draggedLawId === null) return;
        const dragging = container.querySelector('.lei-panel.dragging');
        if (dragging) dragging.classList.remove('dragging');
        const category = container.dataset.categoryContent;
        if (!category) return;
        const orderedIds = Array.from(container.querySelectorAll('.lei-panel')).map(panel => parseInt(panel.dataset.lawId, 10));
        this.applyLawOrder(category, orderedIds);
        this.draggedLawId = null;
    }

    getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.lei-panel:not(.dragging)')];
        let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
        draggableElements.forEach(child => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                closest = { offset, element: child };
            }
        });
        return closest.element;
    }

    applyLawOrder(categoryName, orderedIds) {
        const laws = this.app.state.parameters.leiSeca?.laws || [];
        const otherLaws = laws.filter(law => law.category !== categoryName);
        const categoryLaws = laws.filter(law => law.category === categoryName);
        const idToLaw = new Map(laws.map(law => [law.id, law]));
        const reordered = orderedIds
            .map(id => idToLaw.get(id))
            .filter(law => law && law.category === categoryName);
        const existingIds = new Set(reordered.map(law => law.id));
        const remaining = categoryLaws.filter(law => !existingIds.has(law.id));
        const sameOrder = reordered.length === categoryLaws.length && remaining.length === 0 && reordered.every((law, index) => law.id === categoryLaws[index].id);
        if (sameOrder) return;
        this.app.state.parameters.leiSeca.laws = otherLaws.concat(reordered, remaining);
        this.app.saveData(true, 'Ordem das leis atualizada.');
        this.renderLeiSecaView();
    }

    getArticleStyle(readCount) {
        if (readCount === 0) return { bgColor: '', textColor: '' };
        
        const index = Math.min(readCount - 1, this.GREEN_SCALE.length - 1);
        return {
            bgColor: this.GREEN_SCALE[index],
            textColor: index >= 10 ? '#fff' : ''
        };
    }

    updateLeiSecaDOM(lawId, articleNum) {
        const article = this.findArticle(lawId, articleNum);
        const square = this.getEl(
            `.artigo-square[data-law-id='${lawId}'][data-article-num='${articleNum}']`
        );

        if (article && square) {
            const style = this.getArticleStyle(article.reads);
            square.style.backgroundColor = style.bgColor;
            square.classList.toggle('text-white', style.textColor === '#fff');
            
            const tooltip = square.querySelector('.tooltip-text');
            if (tooltip) {
                tooltip.textContent = `Lido ${article.reads} vez(es)${
                    article.reads >= 20 ? ' (Avançado)' : ''
                }`;
            }
        }
        this.updateLeiPanelSummary(lawId);
    }

    updateLeiPanelSummary(lawId) {
        const summaryEl = this.getEl(`#summary-${lawId}`);
        const law = this.app.state.parameters.leiSeca?.laws.find(l => l.id === lawId);

        if (!summaryEl || !law) return;

        const stats = this.calculateLawStats(law);
        summaryEl.innerHTML = `Artigos lidos: <strong>${stats.readArticles}</strong> de ${law.articleCount} (${stats.percentage}%) &mdash; Leituras completas: <strong>${stats.fullReads}</strong>`;
    }

    calculateLawStats(law) {
        const readArticles = law.articles.filter(a => a.reads > 0).length;
        const percentage = law.articleCount > 0
            ? (readArticles / law.articleCount * 100).toFixed(0)
            : 0;
        const readCounts = law.articles.map(a => a.reads);
        const fullReads = readCounts.length > 0 ? Math.min(...readCounts) : 0;

        return { readArticles, fullReads, percentage };
    }
    
    handleLeiSecaSearch(event) {
        const searchTerm = event.target.value.toLowerCase();
        const laws = this.app.state.parameters.leiSeca?.laws || [];
        const container = this.getEl(this.selectors.container);
        if (!container) return;

        if (!searchTerm) {
            this.renderLeiSecaView();
            return;
        }

        const filteredLaws = laws.filter(law => law.name.toLowerCase().includes(searchTerm));
        const grouped = this.groupLawsByCategory(filteredLaws);
        container.innerHTML = '';
        if (Object.keys(grouped).length === 0) {
             container.innerHTML = `
            <div class="text-center text-[var(--text-muted)] card p-8">
                <h3 class="font-semibold text-lg">Nenhuma lei encontrada.</h3>
                <p class="mt-2">Verifique o termo buscado ou adicione novas leis.</p>
            </div>
            `;
            return;
        }
        this.renderCategoryContainers(container, grouped);
    }

    toggleCategory(button) {
        const categoryName = button.dataset.category;
        const content = this.getEl(
            `.category-content[data-category-content="${categoryName}"]`
        );
        if (content) {
            content.classList.toggle('collapsed');
            const icon = button.querySelector('i');
            icon?.classList.toggle('fa-chevron-up');
            icon?.classList.toggle('fa-chevron-down');
        }
    }

    renderLeiSecaView() {
        const container = this.getEl(this.selectors.container);
        if (!container) return;

        container.innerHTML = '';
        
        const laws = this.app.state.parameters.leiSeca?.laws || [];
        if (laws.length === 0) {
            this.renderEmptyState(container);
            return;
        }

        const grouped = this.groupLawsByCategory(laws);
        this.renderCategoryContainers(container, grouped);
    }

    renderEmptyState(container) {
        container.innerHTML = `
            <div class="text-center text-[var(--text-muted)] card p-8">
                <h3 class="font-semibold text-lg">Nenhuma lei adicionada.</h3>
                <p class="mt-2">Clique em "Adicionar Lei" para começar.</p>
            </div>
        `;
    }

    groupLawsByCategory(laws) {
        return laws.reduce((acc, law) => {
            const cat = law.category || 'Geral';
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(law);
            return acc;
        }, {});
    }

    renderCategoryContainers(container, grouped) {
        Object.keys(grouped).sort().forEach(category => {
            const catContainer = document.createElement('div');
            catContainer.className = 'category-container';
            catContainer.innerHTML = `
                <div class="category-header flex justify-between items-center p-3 rounded-lg bg-[var(--card-bg)] border border-[var(--border-color)] cursor-pointer" data-action="toggle-category" data-category="${category}">
                    <h3 class="text-lg font-semibold text-[var(--text-secondary)]">${category}</h3>
                    <button data-action="toggle-category" data-category="${category}" class="collapse-toggle-btn p-2 rounded-full hover:bg-[var(--border-color)] text-[var(--text-muted)]">
                        <i class="fa-solid fa-chevron-up"></i>
                    </button>
                </div>
                <div class="category-content space-y-4 pt-4" data-category-content="${category}">
                    ${grouped[category].map(law => this.renderLeiPanel(law)).join('')}
                </div>
            `;
            container.appendChild(catContainer);
            const contentEl = catContainer.querySelector('.category-content');
            if (contentEl) {
                contentEl.addEventListener('dragstart', (e) => this.handleDragStart(e));
                contentEl.addEventListener('dragend', (e) => this.handleDragEnd(e));
                contentEl.addEventListener('dragover', (e) => this.handleDragOver(e));
                contentEl.addEventListener('drop', (e) => this.handleDrop(e));
                contentEl.addEventListener('dragleave', (e) => this.handleDragLeave(e));
            }
            catContainer.querySelector('.category-header').addEventListener('click', (e) => {
                if(e.target === e.currentTarget) {
                   this.toggleCategory(e.currentTarget.querySelector('button'));
                }
            })
        });
    }

    renderLeiPanel(law) {
        const stats = this.calculateLawStats(law);
        const gridHTML = law.articles
            .map(article => this.renderArticleSquare(law.id, article))
            .join('');
        const lawTitle = law.url ? `<a href="${law.url}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-inherit hover:text-[color:var(--c2)] focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[color:var(--c2)]">${law.name}<i class="fa-solid fa-arrow-up-right-from-square text-sm"></i></a>` : law.name;

        return `
            <div class="card p-4 sm:p-6 lei-panel" id="lei-panel-${law.id}" data-law-id="${law.id}" data-category="${law.category || "Geral"}" draggable="true">
                <div class="lei-panel-header flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="drag-handle text-[var(--text-muted)] cursor-move" title="Arrastar para reordenar"><i class="fa-solid fa-grip-lines"></i></span>
                            <h3 class="text-xl font-bold text-[var(--text-secondary)]">${lawTitle}</h3>
                        </div>
                        <p id="summary-${law.id}" class="text-sm text-[var(--text-muted)] mt-1">
                            Artigos lidos: <strong>${stats.readArticles}</strong> de ${law.articleCount} (${stats.percentage}%) &mdash; Leituras completas: <strong>${stats.fullReads}</strong>
                        </p>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <input type="text" id="interval-input-${law.id}" placeholder="Ex: 1-45" class="shadow-sm w-24 text-sm">
                        <button data-action="mark-interval" data-law-id="${law.id}" class="btn btn-secondary text-xs py-1 px-2">Marcar</button>
                        <button data-action="mark-all-read" data-law-id="${law.id}" class="btn btn-secondary text-xs py-1 px-2">Avançado</button>
                        <button data-action="reset-all" data-law-id="${law.id}" class="btn btn-secondary text-xs py-1 px-2">Resetar</button>
                        <button data-action="delete-law" data-law-id="${law.id}" class="btn btn-danger text-xs py-1 px-2">Excluir</button>
                    </div>
                </div>
                <div class="lei-grid" data-grid-for-law="${law.id}">${gridHTML}</div>
            </div>
        `;
    }

    renderArticleSquare(lawId, article) {
        const style = this.getArticleStyle(article.reads);
        return `
            <div class="artigo-square tooltip ${style.textColor === '#fff' ? 'text-white' : ''}" 
                 style="background-color: ${style.bgColor || ''}"
                 data-law-id="${lawId}" data-article-num="${article.num}">
                <span>${article.num}</span>
                <span class="tooltip-text">Lido ${article.reads} vez(es)${
                    article.reads >= 20 ? ' (Avançado)' : ''
                }</span>
            </div>
        `;
    }

    getEl(selector) {
        return document.querySelector(selector);
    }

    showElement(selector) {
        this.getEl(selector)?.classList.remove('hidden');
    }

    hideElement(selector) {
        this.getEl(selector)?.classList.add('hidden');
    }
}

const App = { state: { currentView: 'dashboard', charts: {}, studyData: [], backups: [], parameters: { subjects: [ { name: "Direito Constitucional", subtopics: ["Controle de Constitucionalidade", "Direitos Fundamentais"] }, { name: "Raciocínio Lógico", subtopics: [] }, { name: "Português", subtopics: [] }, { name: "Direito Administrativo", subtopics: [] } ], tasks: [], youtubeMusic: [], subjectColors: {}, tiposDeAtividade: ["Teoria","Exercícios","Revisão","Simulado", "Lei Seca", "Jurisprudência", "Subjetivas", "Prova Oral"], weeklyGoals: { hours: 35, questions: 250, accuracy: 80, days: 5 }, weekStartDay: 1, concursoInfo: { nome: '', cargo: '', inicio: '', prova: '' }, darkMode: false, leiSeca: { laws: [] }, studyTracker: { subjects: {} } }, db: null, auth: null, authUnsubscribe: null, userId: null, dataLoaded: false, COLOR_PALETTE: ['#3D405B', '#81B29A', '#F2CC8F', '#E07A5F', '#555B6E', '#89B0AE', '#BEE3DB', '#FFD6BA', '#F28F3B', '#C8553D', '#6A7FDB', '#A3A3A3', '#3E5641', '#A24936', '#D36135', '#2E294E', '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf', '#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab', '#003f5c', '#2f4b7c', '#665191', '#a05195', '#d45087', '#f95d6a', '#ff7c43', '#ffa600', '#488f31', '#de425b', '#69b3a2', '#f4a261', '#e76f51', '#2a9d8f', '#264653', '#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4', '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9', '#001219', '#005f73', '#0a9396', '#94d2bd', '#e9d8a6', '#ee9b00', '#ca6702', '#bb3e03', '#ae2012', '#9b2226' ], soundOptions: { notification: ["C5", "G5"], chime: ["C6", "E6", "G6"], simple: ["G5"] }, pomodoro: { isRunning: false, isSessionActive: false, mode: 'work', timeLeft: 25*60, cycleStart: null, intervalId: null, totalCycles: 4, cyclesCompleted: 0, settings: { work: 25, shortBreak: 5, longBreak: 15, autoStart: false, alertTime: null, sound: 'notification' }, sessionSubject: '', sessionSubtopic: '', pendingLogDuration: 0, totalPauseTime: 0, pauseStartTime: null, currentTaskId: null, }, stopwatch: { isRunning: false, startTime: null, elapsedTime: 0, intervalId: null, subject: '', subtopic: '', alertTime: null, alertTriggered: false, settings: { sound: 'notification' }, totalPauseTime: 0, pauseStartTime: null, }, pip: { canvas: null, video: null, ctx: null, isActive: false, }, backgroundAudio: { player: null, volume: null, }, youtubePlayer: null, youtubePlayerState: 'stopped', currentMusicId: null, editingId: null, pendingSession: null, audioInitialized: false, synth: null, activeQuestionInputId: 'questions-total', activeModalQuestionInputId: 'modal-questions-total', questionsEvolutionView: 'relative', debounceTimer: null, lastBackupTime: 0, studyTracker: { selectedSubject: null }, youtubePlayerReady: false, pendingYouTubeTrack: null },
init(){ this.initFirebase(); this.bindAuthForms(); this.checkInitialDarkMode(); },
initFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase SDK não carregado');
        }

        if (!firebase.apps || firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }

        this.state.db = firebase.database();
        this.state.auth = firebase.auth();

        if (typeof this.state.authUnsubscribe === 'function') {
            this.state.authUnsubscribe();
            this.state.authUnsubscribe = null;
        }

        this.state.authUnsubscribe = this.state.auth.onAuthStateChanged(user => {
            if (user) {
                this.state.userId = user.uid;
                document.getElementById('loading-view').classList.remove('hidden');
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('main-nav').style.display = 'flex';
                if (!this.state.dataLoaded) {
                    this.loadData();
                }
            } else {
                this.state.userId = null;
                this.state.dataLoaded = false;
                this.resetState();
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('main-nav').style.display = 'none';
                document.getElementById('auth-view').classList.remove('hidden');
            }
        });
    } catch (e) {
        console.error("Erro ao inicializar o Firebase:", e);
        const errorMessage = "Erro na configuração do Firebase. Verifique o objeto 'firebaseConfig' no código e se os scripts do Firebase foram carregados.";
        alert(errorMessage);
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        if (loginError) loginError.textContent = errorMessage;
        if (registerError) registerError.textContent = errorMessage;
    }
}, initializeApp() { document.getElementById('loading-view').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden');
this.leiSecaController = new LeiSecaController(this);
this.bindNav(); this.bindFilters(); this.bindGeneralActions(); this.bindBackup(); this.bindRegistro(); this.bindPomodoro(); this.bindStopwatch(); this.bindModal(); this.bindNotificationModal(); this.bindConcurso(); this.bindPip(); this.bindBackgroundSounds(); if (window.YT && typeof YT.Player === 'function') { this.initYouTubePlayer(); } this.ensureStudyTrackerData(); this.bindStudyTracker(); this.renderStudyTracker(); this.initCharts(); this.bindCollapsibleSections(); this.updateAllSubjectDropdowns(); this.updateActivityDropdowns(); this.renderSubjectsManagement(); this.bindSubjectManagement(); this.bindTasks(); this.renderTasks(); this.bindYouTubeMusic(); this.renderYouTubeMusicList(); this.resetPomodoro(true); this.setFilterPeriod('week'); this.navigateTo('dashboard'); this.scheduleDailyBackup(); this.renderBackupList();
const searchInput = document.getElementById('log-search-input'); searchInput.addEventListener('input', (e) => { clearTimeout(this.state.debounceTimer); this.state.debounceTimer = setTimeout(() => { this.renderDetailedLog(this.getFilteredData(), e.target.value); },
 300); }); },
bindCollapsibleSections() { document.querySelectorAll('.collapse-toggle-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const header = e.currentTarget.parentElement; const content = header.nextElementSibling; const icon = e.currentTarget.querySelector('i'); if (content && content.classList.contains('collapsible-content')) { content.classList.toggle('hidden'); icon.classList.toggle('fa-chevron-up'); icon.classList.toggle('fa-chevron-down'); } }); }); },
bindAuthForms() { const loginForm = document.getElementById('login-form'); const registerForm = document.getElementById('register-form'); const showRegisterBtn = document.getElementById('show-register'); const showLoginBtn = document.getElementById('show-login'); const logoutBtn = document.getElementById('logout-btn'); const logoutBtnMobile = document.getElementById('logout-btn-mobile'); const forgotPasswordLink = document.getElementById('forgot-password-link');
loginForm.addEventListener('submit', e => { e.preventDefault(); const email = loginForm['login-email'].value; const password = loginForm['login-password'].value; this.handleLogin(email, password); }); forgotPasswordLink.addEventListener('click', e => { e.preventDefault(); this.handleForgotPassword(); });
registerForm.addEventListener('submit', e => { e.preventDefault(); const email = registerForm['register-email'].value; const password = registerForm['register-password'].value; this.handleRegister(email, password); });
showRegisterBtn.addEventListener('click', e => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
showLoginBtn.addEventListener('click', e => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); }); logoutBtn.addEventListener('click', () => this.handleLogout()); logoutBtnMobile.addEventListener('click', () => this.handleLogout()); },
handleLogin(email, password) { const errorP = document.getElementById('login-error'); errorP.textContent = ''; this.state.auth.signInWithEmailAndPassword(email, password) .catch(error => { console.error("Erro de login:", error.message); errorP.textContent = "Email ou senha inválidos."; }); }, handleForgotPassword() { const emailInput = document.getElementById('login-email'); const email = emailInput.value; const errorP = document.getElementById('login-error'); errorP.textContent = '';
if (!email) { errorP.textContent = 'Por favor, insira seu email para redefinir a senha.'; return; }
this.state.auth.sendPasswordResetEmail(email) .then(() => { this.toast('Email de redefinição de senha enviado!'); }) .catch(error => { console.error("Erro ao enviar email de redefinição:", error); errorP.textContent = 'Falha ao enviar. Verifique o email digitado.'; }); },
handleRegister(email, password) { const errorP = document.getElementById('register-error'); errorP.textContent = ''; this.state.auth.createUserWithEmailAndPassword(email, password) .catch(error => { console.error("Erro de cadastro:", error.message); if (error.code == 'auth/weak-password') { errorP.textContent = 'A senha precisa ter no mínimo 6 caracteres.'; } else if (error.code == 'auth/email-already-in-use') { errorP.textContent = 'Este email já está em uso.'; } else { errorP.textContent = 'Ocorreu um erro ao criar a conta.'; } }); },
handleLogout() { this.state.auth.signOut(); },
resetState() { const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; this.state.studyData = []; this.state.parameters = { subjects: [ { name: "Direito Constitucional", subtopics: ["Controle de Constitucionalidade", "Direitos Fundamentais"] }, { name: "Raciocínio Lógico", subtopics: [] }, { name: "Português", subtopics: [] }, { name: "Direito Administrativo", subtopics: [] } ], tasks: [], youtubeMusic: [], subjectColors: {}, tiposDeAtividade: ["Teoria","Exercícios","Revisão","Simulado", "Lei Seca", "Jurisprudência", "Subjetivas", "Prova Oral"], weeklyGoals: { hours: 35, questions: 250, accuracy: 80, days: 5 }, weekStartDay: 1, concursoInfo: { nome: '', cargo: '', inicio: '', prova: '' }, darkMode: localStorage.getItem('darkMode') === 'true' || (localStorage.getItem('darkMode') === null && prefersDark), leiSeca: { laws: [] }, studyTracker: { subjects: {} } }; this.state.studyTracker = { selectedSubject: null }; this.state.youtubePlayer = null; this.state.youtubePlayerReady = false; this.state.pendingYouTubeTrack = null; this.state.youtubePlayerState = 'stopped'; this.state.currentMusicId = null; },
saveData(showToast = false, toastMessage = 'Dados salvos na nuvem!'){ if (!this.state.userId) { if (showToast) this.toast('Erro: Usuário não autenticado. Não foi possível salvar.', false); return; } const dataToSave = { studyData: this.state.studyData, parameters: this.state.parameters, }; this.state.db.ref('users/' + this.state.userId).set(dataToSave) .then(() => { if (showToast) { this.toast(toastMessage); } }) .catch(error => { console.error("Falha ao salvar dados no Firebase:", error); if (showToast) this.toast('Erro ao salvar na nuvem.', false); });
try { localStorage.setItem('studyDashBackupsV30', JSON.stringify(this.state.backups)); } catch(e){ console.error("Falha ao salvar backups locais:", e); } },
loadData(){ if (!this.state.userId) return;
try { const rawBackups = localStorage.getItem('studyDashBackupsV30'); if (rawBackups) { this.state.backups = JSON.parse(rawBackups); } } catch(e) { console.error("Falha ao carregar backups locais:", e); }
this.state.db.ref('users/' + this.state.userId).once('value', snapshot => { const data = snapshot.val(); this.resetState(); if(data){ this.state.studyData = data.studyData || []; if(data.parameters) { if (data.parameters.disciplinas && !data.parameters.subjects) { data.parameters.subjects = data.parameters.disciplinas.map(d => ({ name: d, subtopics: [] })); delete data.parameters.disciplinas; } Object.assign(this.state.parameters, data.parameters);

const defaultActivities = ["Teoria","Exercícios","Revisão","Simulado", "Lei Seca", "Jurisprudência", "Subjetivas", "Prova Oral"];
if (this.state.parameters.tiposDeAtividade && Array.isArray(this.state.parameters.tiposDeAtividade)) {
    const userActivities = new Set(this.state.parameters.tiposDeAtividade);
    defaultActivities.forEach(act => userActivities.add(act));
    this.state.parameters.tiposDeAtividade = [...userActivities].sort((a, b) => defaultActivities.indexOf(a) - defaultActivities.indexOf(b));
} else {
    this.state.parameters.tiposDeAtividade = defaultActivities;
}

if(!this.state.parameters.tasks) this.state.parameters.tasks = []; if(!this.state.parameters.youtubeMusic) this.state.parameters.youtubeMusic = []; if(!this.state.parameters.leiSeca) this.state.parameters.leiSeca = { laws: [] }; if(!this.state.parameters.studyTracker || typeof this.state.parameters.studyTracker !== 'object') this.state.parameters.studyTracker = { subjects: {} }; if(!this.state.parameters.studyTracker.subjects || typeof this.state.parameters.studyTracker.subjects !== 'object') this.state.parameters.studyTracker.subjects = {}; if (this.state.parameters.subjects && typeof this.state.parameters.subjects === 'object' && !Array.isArray(this.state.parameters.subjects)) { console.warn("'subjects' foi carregado como um objeto, convertendo para array."); this.state.parameters.subjects = Object.values(this.state.parameters.subjects); } if (Array.isArray(this.state.parameters.subjects)) { this.state.parameters.subjects.forEach(subject => { if (!subject.subtopics || !Array.isArray(subject.subtopics)) { subject.subtopics = []; } }); } } } this.ensureStudyTrackerData(); this.ensureSubjectColors(); this.setDarkMode(this.state.parameters.darkMode, false); this.state.dataLoaded = true; this.initializeApp(); }); },
ensureSubjectColors() { if (!this.state.parameters.subjectColors) { this.state.parameters.subjectColors = {}; } const subjects = this.state.parameters.subjects.map(s => s.name); let colorIndex = 0; subjects.forEach(subjectName => { if (!this.state.parameters.subjectColors[subjectName]) { this.state.parameters.subjectColors[subjectName] = this.state.COLOR_PALETTE[colorIndex % this.state.COLOR_PALETTE.length]; colorIndex++; } }); },
generateTrackerId() { return Date.now() + Math.floor(Math.random() * 1000); },
ensureStudyTrackerData() {
  if (!this.state.parameters.studyTracker || typeof this.state.parameters.studyTracker !== 'object') {
    this.state.parameters.studyTracker = { subjects: {} };
  }
  if (!this.state.parameters.studyTracker.subjects || typeof this.state.parameters.studyTracker.subjects !== 'object') {
    this.state.parameters.studyTracker.subjects = {};
  }
  const tracker = this.state.parameters.studyTracker.subjects;
  const subjectNames = Array.isArray(this.state.parameters.subjects) ? this.state.parameters.subjects.map(s => s.name) : [];
  subjectNames.forEach(name => this.syncStudyTrackerSubject(name));
  Object.keys(tracker).forEach(name => {
    if (!subjectNames.includes(name)) {
      delete tracker[name];
      if (this.state.studyTracker.selectedSubject === name) {
        this.state.studyTracker.selectedSubject = null;
      }
    }
  });
  Object.values(tracker).forEach(entry => {
    if (!entry || typeof entry !== 'object') return;
    if (!Array.isArray(entry.topics)) entry.topics = [];
    entry.topics = entry.topics.map(topic => this.normalizeStudyTrackerTopic(topic));
  });
  if (!this.state.studyTracker.selectedSubject && subjectNames.length > 0) {
    this.state.studyTracker.selectedSubject = subjectNames[0];
  }
},

syncStudyTrackerSubject(subjectName) {
  const tracker = this.state.parameters.studyTracker.subjects;
  const subject = Array.isArray(this.state.parameters.subjects) ? this.state.parameters.subjects.find(s => s.name === subjectName) : null;
  if (!subject) {
    delete tracker[subjectName];
    return;
  }
  const entry = tracker[subjectName] && typeof tracker[subjectName] === 'object' ? tracker[subjectName] : { topics: [] };
  if (!Array.isArray(entry.topics)) entry.topics = [];
  entry.topics = entry.topics.map(topic => this.normalizeStudyTrackerTopic(topic));
  const subtopicNames = (subject.subtopics || []).map(st => typeof st === 'string' ? st : st?.name).filter(Boolean);
  const existingNames = new Set(entry.topics.map(t => t.name));
  subtopicNames.forEach(name => {
    if (!existingNames.has(name)) {
      entry.topics.push(this.normalizeStudyTrackerTopic({ id: this.generateTrackerId(), name, status: 'pendente', needsReview: false, reviewed: false, questions: 0, revisions: 0, studyMinutes: 0, lastUpdated: null }));
    }
  });
  entry.topics = entry.topics.filter(topic => subtopicNames.includes(topic.name)).map(topic => this.normalizeStudyTrackerTopic(topic));
  tracker[subjectName] = entry;
},

getStudyTrackerEntry(subjectName) { const tracker = this.state.parameters.studyTracker?.subjects || {}; return tracker[subjectName] || { topics: [] }; },
findStudyTrackerTopic(subjectName, topicId) { const entry = this.getStudyTrackerEntry(subjectName); if (!Array.isArray(entry.topics)) return { entry, topic: null }; const topic = entry.topics.find(t => t.id === topicId); return { entry, topic }; },

    bindStudyTracker() {
      const toggleBtn = document.getElementById('study-tracker-toggle-subject-form');
      const form = document.getElementById('study-tracker-add-subject-form');
      const input = document.getElementById('study-tracker-new-subject-name');
      const cancelBtn = form?.querySelector('[data-action="cancel-new-subject"]');

      toggleBtn?.addEventListener('click', () => {
        if (!form) return;
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
          input?.focus();
        }
      });

      cancelBtn?.addEventListener('click', () => {
        if (!form) return;
        form.classList.add('hidden');
        if (input) input.value = '';
      });

      form?.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!input) return;
        const name = input.value.trim();
        if (!name) {
          this.toast('Informe o nome da matéria.', false);
          return;
        }
        const subjects = this.state.parameters.subjects;
        if (subjects.find(s => s.name.toLowerCase() === name.toLowerCase())) {
          this.toast('Matéria já cadastrada.', false);
          return;
        }
        subjects.push({ name, subtopics: [] });
        this.ensureSubjectColors();
        this.ensureStudyTrackerData();
        this.state.studyTracker.selectedSubject = name;
        this.saveData(true, `Matéria "${name}" adicionada.`);
        this.renderSubjectsManagement();
        this.updateAllSubjectDropdowns();
        this.renderStudyTracker();
        input.value = '';
        form.classList.add('hidden');
      });

      const subjectsList = document.getElementById('study-tracker-subjects-list');
      subjectsList?.addEventListener('click', (e) => {
        const selectBtn = e.target.closest('[data-subject-name]');
        if (selectBtn) {
          const name = selectBtn.dataset.subjectName;
          if (name) {
            this.state.studyTracker.selectedSubject = name;
            this.renderStudyTracker();
          }
        }
      });

      const removeSubjectButton = document.getElementById('study-tracker-remove-subject-btn');
      removeSubjectButton?.addEventListener('click', () => {
        const name = removeSubjectButton.dataset.subjectName;
        if (name && confirm(`Tem certeza que deseja remover a matéria "${name}" e todos os dados associados?`)) {
          this.removeSubjectCompletely(name);
        }
      });

      const addTopicForm = document.getElementById('study-tracker-add-topic-form');
      const topicInput = document.getElementById('study-tracker-new-topic');
      addTopicForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const subjectName = this.state.studyTracker.selectedSubject;
        if (!subjectName) {
          this.toast('Selecione uma matéria primeiro.', false);
          return;
        }
        const value = topicInput?.value.trim();
        if (!value) {
          this.toast('Informe o nome do assunto.', false);
          return;
        }
        const subject = this.state.parameters.subjects.find(s => s.name === subjectName);
        if (!subject) return;
        const exists = subject.subtopics.some(st => (typeof st === 'string' ? st : st?.name)?.toLowerCase() === value.toLowerCase());
        if (exists) {
          this.toast('Esse assunto já existe.', false);
          return;
        }
        subject.subtopics.push(value);
        subject.subtopics.sort((a, b) => a.localeCompare(b, 'pt-BR'));
        this.syncStudyTrackerSubject(subjectName);
        if (topicInput) topicInput.value = '';
        this.saveData(true, `Assunto "${value}" adicionado.`);
        this.renderSubjectsManagement();
        this.updateAllSubjectDropdowns();
        this.renderStudyTracker();
      });

      const topicsContainer = document.getElementById('study-tracker-topics-container');
      topicsContainer?.addEventListener('click', (e) => {
        const subjectName = this.state.studyTracker.selectedSubject;
        if (!subjectName) return;
        const statusBtn = e.target.closest('.study-tracker-status-dot');
        if (statusBtn) {
          const topicId = parseInt(statusBtn.dataset.topicId, 10);
          const status = statusBtn.dataset.status;
          if (topicId && status) {
            this.setStudyTrackerTopicStatus(subjectName, topicId, status);
          }
          return;
        }
        const deleteBtn = e.target.closest('[data-action="delete-topic"]');
        if (deleteBtn) {
          const topicId = parseInt(deleteBtn.dataset.topicId, 10);
          if (topicId && confirm('Deseja remover este assunto?')) {
            this.removeStudyTrackerTopic(subjectName, topicId);
          }
          return;
        }
        const reviewBtn = e.target.closest('[data-action="toggle-review"]');
        if (reviewBtn) {
          const topicId = parseInt(reviewBtn.dataset.topicId, 10);
          if (topicId) {
            this.toggleStudyTrackerReview(subjectName, topicId);
          }
          return;
        }
        const reviewedBtn = e.target.closest('[data-action="toggle-reviewed"]');
        if (reviewedBtn) {
          const topicId = parseInt(reviewedBtn.dataset.topicId, 10);
          if (topicId) {
            this.toggleStudyTrackerReviewed(subjectName, topicId);
          }
        }
      });
    },

    renderStudyTracker() {
      const subjectsList = document.getElementById('study-tracker-subjects-list');
      const topicsContainer = document.getElementById('study-tracker-topics-container');
      const selectedLabel = document.getElementById('study-tracker-selected-subject');
      const topicInput = document.getElementById('study-tracker-new-topic');
      const addTopicButton = document.querySelector('#study-tracker-add-topic-form button[type="submit"]');
      const removeSubjectButton = document.getElementById('study-tracker-remove-subject-btn');

      if (!subjectsList || !topicsContainer) {
        return;
      }

      this.ensureStudyTrackerData();
      const subjects = Array.isArray(this.state.parameters.subjects) ? this.state.parameters.subjects : [];
      const tracker = this.state.parameters.studyTracker.subjects || {};

      subjectsList.innerHTML = '';
      topicsContainer.innerHTML = '';

      if (subjects.length === 0) {
        subjectsList.innerHTML = '<p class="study-tracker-empty">Nenhuma matéria cadastrada.</p>';
        topicsContainer.innerHTML = '<p class="study-tracker-empty">Adicione uma matéria para começar.</p>';
        if (selectedLabel) selectedLabel.textContent = '';
        if (topicInput) topicInput.disabled = true;
        if (addTopicButton) addTopicButton.disabled = true;
        if (removeSubjectButton) {
          removeSubjectButton.classList.add('hidden');
          removeSubjectButton.dataset.subjectName = '';
        }
        const emptyStats = this.getEmptyTrackerStats();
        this.updateStudyTrackerStats(emptyStats, this.computeOverallStudyTrackerStats());
        return;
      }

      if (topicInput) topicInput.disabled = false;
      if (addTopicButton) addTopicButton.disabled = false;

      const selectedName = subjects.find(s => s.name === this.state.studyTracker.selectedSubject)
        ? this.state.studyTracker.selectedSubject
        : subjects[0].name;
      this.state.studyTracker.selectedSubject = selectedName;
      if (selectedLabel) selectedLabel.textContent = selectedName || '';
      if (removeSubjectButton) {
        if (selectedName) {
          removeSubjectButton.dataset.subjectName = selectedName;
          removeSubjectButton.classList.remove('hidden');
        } else {
          removeSubjectButton.dataset.subjectName = '';
          removeSubjectButton.classList.add('hidden');
        }
      }

      const subjectFragment = document.createDocumentFragment();
      subjects.forEach(subject => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'study-tracker-subject-btn' + (subject.name === selectedName ? ' active' : '');
        btn.dataset.subjectName = subject.name;
        const entry = tracker[subject.name];
        const total = entry && Array.isArray(entry.topics) ? entry.topics.length : 0;
        btn.innerHTML = `<span class='truncate'>${subject.name}</span><span class='study-tracker-subject-count'>${total}</span>`;
        subjectFragment.appendChild(btn);
      });
      subjectsList.appendChild(subjectFragment);

      const entry = this.getStudyTrackerEntry(selectedName);
      const topics = Array.isArray(entry.topics) ? entry.topics.map(topic => this.normalizeStudyTrackerTopic(topic)) : [];
      topics.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));

      if (topics.length === 0) {
        topicsContainer.innerHTML = '<p class="study-tracker-empty">Nenhum assunto cadastrado.</p>';
        const emptyStats = this.getEmptyTrackerStats(selectedName);
        this.updateStudyTrackerStats(emptyStats, this.computeOverallStudyTrackerStats());
        return;
      }

      const subjectStats = this.getEmptyTrackerStats(selectedName);
      subjectStats.totalTopics = topics.length;
      let lastUpdated = null;
      const topicsFragment = document.createDocumentFragment();

      topics.forEach(topic => {
        if (topic.status === 'concluido') subjectStats.studied += 1;
        else if (topic.status === 'falha') subjectStats.falha += 1;
        else subjectStats.pending += 1;
        if (topic.needsReview) subjectStats.needsReview += 1;
        if (topic.reviewed) subjectStats.reviewed += 1;
        const questionStats = this.getTopicQuestionStats(selectedName, topic.name);
        const totalQuestions = questionStats.total ?? 0;
        const correctQuestions = questionStats.correct ?? 0;
        const accuracy = questionStats.percent;
        subjectStats.questions += totalQuestions || topic.questions || 0;
        subjectStats.revisions += topic.revisions || 0;
        subjectStats.studyMinutes += topic.studyMinutes || 0;
        if (topic.lastUpdated && (!lastUpdated || topic.lastUpdated > lastUpdated)) {
          lastUpdated = topic.lastUpdated;
        }
        if (questionStats.lastUpdated && (!lastUpdated || questionStats.lastUpdated > lastUpdated)) {
          lastUpdated = questionStats.lastUpdated;
        }

        const row = document.createElement('div');
        row.className = `study-tracker-topic-row ${topic.status ? `status-${topic.status}` : ''}`;
        row.dataset.topicId = topic.id;

        const topicCell = document.createElement('div');
        topicCell.className = 'study-tracker-topic-cell topic-main';
        const statusGroup = document.createElement('div');
        statusGroup.className = 'study-tracker-status-group';
        ['falha', 'pendente', 'concluido'].forEach(key => {
          const dot = document.createElement('button');
          dot.type = 'button';
          dot.className = 'study-tracker-status-dot' + (topic.status === key ? ' active' : '');
          dot.dataset.topicId = topic.id;
          dot.dataset.status = key;
          statusGroup.appendChild(dot);
        });

        const nameSpan = document.createElement('span');
        nameSpan.className = 'topic-name';
        nameSpan.textContent = topic.name;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.dataset.action = 'delete-topic';
        removeBtn.dataset.topicId = topic.id;
        removeBtn.className = 'topic-remove';
        removeBtn.textContent = 'Excluir';

        topicCell.appendChild(statusGroup);
        topicCell.appendChild(nameSpan);
        topicCell.appendChild(removeBtn);

        const questionsCell = document.createElement('div');
        questionsCell.className = 'study-tracker-topic-cell study-tracker-questions';
        const accuracySpan = document.createElement('span');
        accuracySpan.className = 'study-tracker-accuracy';
        const accuracyValue = Number.isFinite(accuracy) ? Math.max(0, Math.min(accuracy, 100)) : null;
        accuracySpan.textContent = Number.isFinite(accuracyValue) ? `${accuracyValue}%` : '—';
        const detailSpan = document.createElement('span');
        detailSpan.className = 'study-tracker-questions-detail';
        if (totalQuestions > 0) {
          detailSpan.textContent = `${correctQuestions}/${totalQuestions} acertos`;
        } else if (topic.questions > 0) {
          detailSpan.textContent = `${topic.questions} questões registradas`;
        } else {
          detailSpan.textContent = 'Sem dados registrados';
        }
        const progressBar = document.createElement('div');
        progressBar.className = 'study-tracker-questions-progress';
        const correctFill = document.createElement('div');
        correctFill.className = 'questions-progress-fill correct';
        const incorrectFill = document.createElement('div');
        incorrectFill.className = 'questions-progress-fill incorrect';
        if (Number.isFinite(accuracyValue)) {
          const correctWidth = Math.max(0, Math.min(accuracyValue, 100));
          const incorrectWidth = Math.max(0, Math.min(100 - correctWidth, 100));
          correctFill.style.flexBasis = `${correctWidth}%`;
          incorrectFill.style.flexBasis = `${incorrectWidth}%`;
          correctFill.style.width = `${correctWidth}%`;
          incorrectFill.style.width = `${incorrectWidth}%`;
        } else {
          correctFill.style.flexBasis = '0%';
          incorrectFill.style.flexBasis = '0%';
          correctFill.style.width = '0%';
          incorrectFill.style.width = '0%';
        }
        progressBar.appendChild(correctFill);
        progressBar.appendChild(incorrectFill);
        questionsCell.appendChild(accuracySpan);
        questionsCell.appendChild(detailSpan);
        questionsCell.appendChild(progressBar);

        const reviewCell = document.createElement('div');
        reviewCell.className = 'study-tracker-topic-cell';
        const reviewBtn = document.createElement('button');
        reviewBtn.type = 'button';
        reviewBtn.dataset.action = 'toggle-review';
        reviewBtn.dataset.topicId = topic.id;
        reviewBtn.className = 'study-tracker-review-button' + (topic.needsReview ? ' active' : '');
        reviewBtn.innerHTML = `<span class='icon'>${topic.needsReview ? '✖' : '—'}</span><span class='label'>Revisar</span>`;
        reviewCell.appendChild(reviewBtn);

        const reviewedCell = document.createElement('div');
        reviewedCell.className = 'study-tracker-topic-cell';
        const reviewedBtn = document.createElement('button');
        reviewedBtn.type = 'button';
        reviewedBtn.dataset.action = 'toggle-reviewed';
        reviewedBtn.dataset.topicId = topic.id;
        reviewedBtn.className = 'study-tracker-reviewed-button' + (topic.reviewed ? ' active' : '');
        reviewedBtn.innerHTML = `<span class='icon'>${topic.reviewed ? '✓' : '—'}</span>`;
        reviewedCell.appendChild(reviewedBtn);

        row.appendChild(topicCell);
        row.appendChild(questionsCell);
        row.appendChild(reviewCell);
        row.appendChild(reviewedCell);
        topicsFragment.appendChild(row);
      });

      topicsContainer.appendChild(topicsFragment);

      subjectStats.lastUpdated = lastUpdated;
      const totalTopics = subjectStats.totalTopics || 0;
      if (totalTopics > 0) {
        subjectStats.progressPercent = (subjectStats.studied / totalTopics) * 100;
        subjectStats.averageMinutesPerTopic = subjectStats.studyMinutes / totalTopics;
      } else {
        subjectStats.progressPercent = 0;
        subjectStats.averageMinutesPerTopic = 0;
      }

      const overallStats = this.computeOverallStudyTrackerStats();
      this.updateStudyTrackerStats(subjectStats, overallStats);
    },

    getEmptyTrackerStats(name = '') {
      return {
        name,
        totalTopics: 0,
        studied: 0,
        pending: 0,
        falha: 0,
        needsReview: 0,
        reviewed: 0,
        progressPercent: 0,
        questions: 0,
        revisions: 0,
        studyMinutes: 0,
        averageMinutesPerTopic: 0,
        averageMinutesPerSubject: 0,
        averageProgress: 0,
        lastUpdated: null,
      };
    },

    normalizeStudyTrackerTopic(topic) {
      if (!topic || typeof topic !== 'object') {
        return {
          id: this.generateTrackerId(),
          name: '',
          status: 'pendente',
          needsReview: false,
          reviewed: false,
          questions: 0,
          revisions: 0,
          studyMinutes: 0,
          lastUpdated: null,
        };
      }

      if (!topic.id) topic.id = this.generateTrackerId();
      if (typeof topic.name !== 'string') topic.name = String(topic.name || '');
      const validStatuses = ['falha', 'pendente', 'concluido'];
      if (!validStatuses.includes(topic.status)) topic.status = 'pendente';
      topic.needsReview = Boolean(topic.needsReview);
      topic.reviewed = Boolean(topic.reviewed);
      const sanitize = (value) => {
        const num = Number(value);
        return Number.isFinite(num) && num >= 0 ? num : 0;
      };
      topic.questions = sanitize(topic.questions);
      topic.revisions = sanitize(topic.revisions);
      topic.studyMinutes = sanitize(topic.studyMinutes);
      if (topic.lastUpdated && Number.isNaN(Date.parse(topic.lastUpdated))) {
        topic.lastUpdated = null;
      }
      return topic;
    },

    getTopicQuestionStats(subjectName, topicName) {
      if (!subjectName || !topicName) {
        return { total: 0, correct: 0, percent: null, lastUpdated: null };
      }

      const sessions = Array.isArray(this.state.studyData) ? this.state.studyData : [];
      const normalizedName = topicName.toString().trim().toLocaleLowerCase('pt-BR');
      let total = 0;
      let correct = 0;
      let lastUpdated = null;

      sessions.forEach(session => {
        if (!session || session.subject !== subjectName) return;
        const sessionTopic = (session.subtopic || '').toString().trim().toLocaleLowerCase('pt-BR');
        if (!sessionTopic || sessionTopic !== normalizedName) return;

        const totalQuestions = Number(session.totalQuestions) || 0;
        const correctQuestions = Math.min(Number(session.correctQuestions) || 0, totalQuestions);
        total += totalQuestions;
        correct += correctQuestions;

        const timestamp = Number(session.timestamp) || (session.date ? new Date(session.date).getTime() : null);
        if (timestamp && (!lastUpdated || timestamp > lastUpdated)) {
          lastUpdated = timestamp;
        }
      });

      return {
        total,
        correct,
        percent: total > 0 ? Math.round((correct / total) * 100) : null,
        lastUpdated: lastUpdated ? new Date(lastUpdated).toISOString() : null,
      };
    },

    markStudyTrackerUpdated(topic) {
      if (topic && typeof topic === 'object') {
        topic.lastUpdated = new Date().toISOString();
      }
    },

    formatTrackerDate(iso) {
      if (!iso) return '';
      try {
        return new Date(iso).toLocaleString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
      } catch (error) {
        return '';
      }
    },

    computeOverallStudyTrackerStats() {
      const stats = this.getEmptyTrackerStats();
      const tracker = this.state.parameters.studyTracker?.subjects || {};
      const subjectEntries = Object.entries(tracker);
      let subjectCount = 0;

      subjectEntries.forEach(([subjectName, entry]) => {
        if (!entry || !Array.isArray(entry.topics) || entry.topics.length === 0) return;
        subjectCount += 1;
        let completed = 0;

        entry.topics.forEach(topic => {
          const normalized = this.normalizeStudyTrackerTopic(topic);
          const questionStats = this.getTopicQuestionStats(subjectName, normalized.name);
          stats.totalTopics += 1;
          if (normalized.status === 'concluido') {
            stats.studied += 1;
            completed += 1;
          } else if (normalized.status === 'falha') {
            stats.falha += 1;
          } else {
            stats.pending += 1;
          }

          if (normalized.needsReview) stats.needsReview += 1;
          if (normalized.reviewed) stats.reviewed += 1;
          stats.questions += (questionStats.total ?? normalized.questions ?? 0);
          stats.revisions += normalized.revisions || 0;
          stats.studyMinutes += normalized.studyMinutes || 0;
          if (normalized.lastUpdated && (!stats.lastUpdated || normalized.lastUpdated > stats.lastUpdated)) {
            stats.lastUpdated = normalized.lastUpdated;
          }
          if (questionStats.lastUpdated && (!stats.lastUpdated || questionStats.lastUpdated > stats.lastUpdated)) {
            stats.lastUpdated = questionStats.lastUpdated;
          }
        });

        if (entry.topics.length > 0) {
          stats.averageProgress += completed / entry.topics.length;
        }
      });

      if (stats.totalTopics > 0) {
        stats.progressPercent = (stats.studied / stats.totalTopics) * 100;
        stats.averageMinutesPerTopic = stats.studyMinutes / stats.totalTopics;
      }

      if (subjectCount > 0) {
        stats.averageMinutesPerSubject = stats.studyMinutes / subjectCount;
        stats.averageProgress = (stats.averageProgress / subjectCount) * 100;
      } else {
        stats.averageProgress = 0;
      }

      return stats;
    },

    updateStudyTrackerStats(subjectStats, overallStats = null) {
      const panel = document.getElementById('study-tracker-stats-panel');
      if (!panel) return;

      const subject = subjectStats || this.getEmptyTrackerStats();
      const overall = overallStats || this.computeOverallStudyTrackerStats();
      const formatNumber = (value) => Number(value || 0).toLocaleString('pt-BR');
      const formatPercent = (value) => `${Math.round(value || 0)}%`;
      const formatMinutes = (value) => `${Math.round(value || 0)} min`;
      const formatDate = (value) => (value ? this.formatTrackerDate(value) || '—' : '—');
      const subjectTitle = subject.name ? ` • ${subject.name}` : '';

      panel.innerHTML = `
        <div class="study-tracker-stats-group">
          <strong>Matéria selecionada${subjectTitle}</strong>
          <p>${formatNumber(subject.totalTopics)} assuntos • ${formatNumber(subject.studied)} concluídos (${formatPercent(subject.progressPercent)})</p>
          <p>${formatNumber(subject.needsReview)} precisam revisar • ${formatNumber(subject.reviewed)} revisados</p>
          <p>Tempo médio por assunto: ${formatMinutes(subject.averageMinutesPerTopic)} • Última atualização: ${formatDate(subject.lastUpdated)}</p>
        </div>
        <div class="study-tracker-stats-group">
          <strong>Visão geral</strong>
          <p>${formatNumber(overall.totalTopics)} assuntos registrados • ${formatNumber(overall.studied)} concluídos (${formatPercent(overall.progressPercent)})</p>
          <p>${formatNumber(overall.needsReview)} aguardando revisão • Tempo médio por matéria: ${formatMinutes(overall.averageMinutesPerSubject)}</p>
        </div>
      `;
    },

    promptStudyTrackerMetric(subjectName, topicId, field) {
      const validFields = ['questions', 'revisions', 'minutes'];
      if (!validFields.includes(field)) return;

      const labels = {
        questions: 'Questões',
        revisions: 'Revisões',
        minutes: 'Tempo (min)',
      };

      const { topic } = this.findStudyTrackerTopic(subjectName, topicId);
      if (!topic) return;

      const currentValue = field === 'minutes' ? topic.studyMinutes : field === 'questions' ? topic.questions : topic.revisions;
      const input = prompt(`Atualizar ${labels[field]} do assunto "${topic.name}"`, Number(currentValue || 0));
      if (input === null) return;

      const value = Number(input);
      if (!Number.isFinite(value) || value < 0) {
        this.toast('Informe um número válido.', false);
        return;
      }

      if (field === 'minutes') topic.studyMinutes = Math.round(value);
      else if (field === 'questions') topic.questions = Math.round(value);
      else if (field === 'revisions') topic.revisions = Math.round(value);

      this.markStudyTrackerUpdated(topic);
      this.saveData(true, 'Dados do assunto atualizados.');
      this.renderStudyTracker();
    },

    setStudyTrackerTopicStatus(subjectName, topicId, status) {
      const valid = ['falha', 'pendente', 'concluido'];
      if (!valid.includes(status)) return;

      const { topic } = this.findStudyTrackerTopic(subjectName, topicId);
      if (!topic) return;

      topic.status = status;
      if (status === 'concluido') {
        topic.needsReview = false;
      }

      this.markStudyTrackerUpdated(topic);
      this.saveData();
      this.renderStudyTracker();
    },

    toggleStudyTrackerReview(subjectName, topicId) {
      const { topic } = this.findStudyTrackerTopic(subjectName, topicId);
      if (!topic) return;

      topic.needsReview = !topic.needsReview;
      if (topic.needsReview) {
        topic.reviewed = false;
      }

      this.markStudyTrackerUpdated(topic);
      this.saveData();
      this.renderStudyTracker();
    },

    toggleStudyTrackerReviewed(subjectName, topicId) {
      const { topic } = this.findStudyTrackerTopic(subjectName, topicId);
      if (!topic) return;

      topic.reviewed = !topic.reviewed;
      if (topic.reviewed) {
        topic.needsReview = false;
      }

      this.markStudyTrackerUpdated(topic);
      this.saveData();
      this.renderStudyTracker();
    },

    removeStudyTrackerTopic(subjectName, topicId) {
      const { entry, topic } = this.findStudyTrackerTopic(subjectName, topicId);
      if (!topic) return;

      entry.topics = entry.topics.filter(t => t.id !== topicId);
      const subject = this.state.parameters.subjects.find(s => s.name === subjectName);
      if (subject) {
        subject.subtopics = subject.subtopics.filter(st => (typeof st === 'string' ? st : st?.name) !== topic.name);
      }

      this.syncStudyTrackerSubject(subjectName);
      this.saveData(true, 'Assunto removido.');
      this.renderSubjectsManagement();
      this.updateAllSubjectDropdowns();
      this.renderStudyTracker();
    },

    removeSubjectCompletely(subjectName) {
      this.state.studyData = this.state.studyData.filter(d => d.subject !== subjectName);
      this.state.parameters.subjects = this.state.parameters.subjects.filter(s => s.name !== subjectName);
      delete this.state.parameters.subjectColors[subjectName];

      if (this.state.parameters.studyTracker?.subjects) {
        delete this.state.parameters.studyTracker.subjects[subjectName];
      }

      if (this.state.studyTracker.selectedSubject === subjectName) {
        this.state.studyTracker.selectedSubject = this.state.parameters.subjects[0]?.name || null;
      }

      this.saveData(true, `"${subjectName}" removida.`);
      this.renderSubjectsManagement();
      this.updateAllSubjectDropdowns();
      this.renderStudyTracker();
      if (this.state.currentView === 'dashboard') {
        this.updateDashboard();
      }
    },

bindNav(){ document.querySelectorAll('.nav-link').forEach(link=>{ link.addEventListener('click', (e)=>{ e.preventDefault(); this.navigateTo(e.target.dataset.view); document.getElementById('mobile-menu').classList.add('hidden'); }); }); document.getElementById('mobile-menu-button').addEventListener('click', ()=>{ document.getElementById('mobile-menu').classList.toggle('hidden'); }); document.getElementById('dark-mode-toggle').addEventListener('click', () => this.toggleDarkMode()); document.getElementById('dark-mode-toggle-mobile').addEventListener('click', () => this.toggleDarkMode()); }, navigateTo(view){ this.state.currentView = view; document.querySelectorAll('section[id$="-view"]').forEach(s=>s.classList.add('hidden')); document.getElementById(`${view}-view`).classList.remove('hidden'); document.querySelectorAll('.nav-link').forEach(l=>l.classList.toggle('active', l.dataset.view===view)); if(view==='dashboard'){ this.updateDashboard(); } if(view==='foco'){ this.renderSessionHistory(); this.renderTasks(); this.resetForm(); } if(view==='study-tracker'){ this.renderStudyTracker(); } if(view==='lei-seca') { this.leiSecaController.renderLeiSecaView(); } }, checkInitialDarkMode() { const savedMode = localStorage.getItem('darkMode'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; const useDark = savedMode === 'true' || (savedMode === null && prefersDark); this.setDarkMode(useDark, false); },
    setDarkMode(isDark, shouldSave = true) { this.state.parameters.darkMode = isDark; const icon = isDark ? 'fa-sun' : 'fa-moon'; document.documentElement.classList.toggle('dark-mode', isDark); document.querySelectorAll('#dark-mode-toggle i, #dark-mode-toggle-mobile i').forEach(el => { el.classList.remove('fa-moon', 'fa-sun'); el.classList.add(icon); }); if (shouldSave) { localStorage.setItem('darkMode', isDark); this.saveData(); } if (this.state.dataLoaded) { Object.values(this.state.charts).forEach(chart => { if(chart) chart.destroy(); }); this.initCharts(); this.updateDashboard(); if (this.state.currentView === 'study-tracker') { this.renderStudyTracker(); } } },
toggleDarkMode() { this.setDarkMode(!this.state.parameters.darkMode); },
bindConcurso() { const fields = ['concurso-nome', 'concurso-cargo', 'concurso-inicio', 'concurso-prova']; const concursoInfo = this.state.parameters.concursoInfo;
document.getElementById('concurso-nome').value = concursoInfo.nome || ''; document.getElementById('concurso-cargo').value = concursoInfo.cargo || ''; document.getElementById('concurso-inicio').value = concursoInfo.inicio || ''; document.getElementById('concurso-prova').value = concursoInfo.prova || '';
const update = () => { concursoInfo.nome = document.getElementById('concurso-nome').value; concursoInfo.cargo = document.getElementById('concurso-cargo').value; concursoInfo.inicio = document.getElementById('concurso-inicio').value; concursoInfo.prova = document.getElementById('concurso-prova').value; this.updateCountdown(); this.saveData(); };
fields.forEach(id => document.getElementById(id).addEventListener('change', update)); this.updateCountdown(); },
updateCountdown() { const container = document.getElementById('concurso-countdown'); const provaDate = this.state.parameters.concursoInfo.prova; if (!provaDate) { container.innerHTML = ''; return; } const today = new Date(); today.setHours(0,0,0,0); const targetDate = new Date(provaDate); const userTimezoneOffset = targetDate.getTimezoneOffset() * 60000; const correctedTargetDate = new Date(targetDate.getTime() + userTimezoneOffset); const diffTime = correctedTargetDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
if (diffDays > 0) { container.innerHTML = `Faltam <span class="text-2xl">${diffDays}</span> dias para a prova.`; } else if (diffDays === 0) { container.innerHTML = `É hoje! Boa prova!`; } else { container.innerHTML = `A prova já passou.`; } },
toast(msg, ok=true){ const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('opacity-0','translate-y-2'); t.classList.toggle('bg-red-600', !ok); t.classList.toggle('bg-[color:var(--c1)]', ok); setTimeout(()=> t.classList.add('opacity-0','translate-y-2'), 2500); }, formatTime(seconds, format = 'hms') { if (isNaN(seconds) || seconds < 0) return '00h00m'; seconds = Math.round(seconds); const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = seconds % 60; const hh = String(h).padStart(2, '0'); const mm = String(m).padStart(2, '0'); const ss = String(s).padStart(2, '0'); if (format === 'hms') { return `${hh}h${mm}m`; } if (format === 'hms_seconds') { return `${hh}:${mm}:${ss}`; } if (format === 'ms') { return `${mm}:${ss}`; } return `${hh}h${mm}m`; }, bindGeneralActions() { document.getElementById('export-pdf-btn').addEventListener('click', ()=> this.exportPDF()); document.getElementById('save-all-btn').addEventListener('click', () => { this.saveData(true); }); }, bindBackup() { document.getElementById('export-backup-btn').addEventListener('click', () => this.createBackup('Manual', true)); document.getElementById('import-backup-btn').addEventListener('click', () => document.getElementById('backup-file-input').click()); document.getElementById('backup-file-input').addEventListener('change', (e) => this.importBackup(e)); document.getElementById('create-backup-now-btn').addEventListener('click', () => this.createBackup('Salvo Manualmente', false)); },
createBackup(reason = 'Manual', download = true) { const now = Date.now(); if (now - this.state.lastBackupTime < 2000) { console.warn("Backup request too soon, ignoring."); return; } this.state.lastBackupTime = now; try { const timestamp = new Date(); const dataToBackup = { studyData: this.state.studyData, parameters: this.state.parameters, }; const jsonString = JSON.stringify(dataToBackup, null, 2); const newBackup = { id: timestamp.getTime(), date: timestamp.toISOString(), reason: reason, content: jsonString, };
if (reason.startsWith('Automático')) { this.state.backups = this.state.backups.filter(b => !b.reason.startsWith('Automático')); }
this.state.backups.push(newBackup); this.state.backups.sort((a, b) => new Date(b.date) - new Date(a.date)); this.toast(`Backup local '${reason}' criado com sucesso!`); localStorage.setItem('studyDashBackupsV30', JSON.stringify(this.state.backups)); this.renderBackupList(); if(download) { const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dateStr = timestamp.toISOString().split('T')[0]; a.download = `backup-estudos-${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
} catch (error) { console.error('Erro ao criar backup:', error); this.toast('Falha ao criar backup.', false); } },
scheduleDailyBackup() { const now = new Date(); const noon = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0); let timeToNoon = noon - now; if (timeToNoon < 0) { noon.setDate(noon.getDate() + 1); timeToNoon = noon - now; }
setTimeout(() => { this.createBackup('Automático Diário', false); setInterval(() => { this.createBackup('Automático Diário', false); }, 24 * 60 * 60 * 1000); }, timeToNoon); },
renderBackupList() { const container = document.getElementById('backup-list'); if (!container) return;
if(this.state.backups.length === 0) { container.innerHTML = `<p class="text-sm text-gray-500">Nenhum backup salvo ainda.</p>`; return; }
container.innerHTML = this.state.backups.map(backup => { const date = new Date(backup.date); const formattedDate = `${date.toLocaleDateString('pt-BR')} às ${date.toLocaleTimeString('pt-BR')}`; return ` <div class="flex items-center justify-between bg-[var(--bg)] p-2 rounded-md"> <span class="text-sm"> <i class="fa-solid fa-database mr-2 text-[var(--text-muted)]"></i> Backup ${backup.reason} - ${formattedDate} </span> <div> <button data-backup-id="${backup.id}" class="download-backup-btn btn btn-secondary text-xs py-1 px-2"><i class="fa-solid fa-download"></i></button> <button data-backup-id="${backup.id}" class="delete-backup-btn btn btn-danger text-xs py-1 px-2"><i class="fa-solid fa-trash"></i></button> </div> </div> `; }).join('');
document.querySelectorAll('.download-backup-btn').forEach(btn => { btn.addEventListener('click', (e) => { const backupId = parseInt(e.currentTarget.dataset.backupId, 10); const backup = this.state.backups.find(b => b.id === backupId); if (backup) { const blob = new Blob([backup.content], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dateStr = new Date(backup.date).toISOString().split('T')[0]; a.download = `backup-estudos-${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } }); });
document.querySelectorAll('.delete-backup-btn').forEach(btn => { btn.addEventListener('click', (e) => { if (confirm('Tem certeza que deseja excluir este backup local?')) { const backupId = parseInt(e.currentTarget.dataset.backupId, 10); this.state.backups = this.state.backups.filter(b => b.id !== backupId); localStorage.setItem('studyDashBackupsV30', JSON.stringify(this.state.backups)); this.renderBackupList(); this.toast('Backup excluído.'); } }); }); },
importBackup(event) { const file = event.target.files[0]; if (!file) return;
const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.studyData && data.parameters) { if (confirm('Isso irá substituir seus dados na nuvem pelos dados do arquivo. Deseja continuar?')) { this.state.studyData = data.studyData; this.state.parameters = data.parameters; this.saveData(); this.toast('Backup importado com sucesso! Seus dados na nuvem foram atualizados.'); this.updateDashboard(); location.reload(); } } else { this.toast('Arquivo de backup inválido.', false); } } catch (error) { console.error('Erro ao importar backup:', error); this.toast('Erro ao ler o arquivo de backup.', false); } }; reader.readAsText(file); event.target.value = ''; },
bindFilters(){ document.getElementById('filter-subject').addEventListener('change', ()=> this.updateDashboard()); document.getElementById('filter-activity').addEventListener('change', ()=> this.updateDashboard()); document.getElementById('filter-start-date').addEventListener('change', ()=> this.updateDashboard()); document.getElementById('filter-end-date').addEventListener('change', ()=> this.updateDashboard()); document.querySelectorAll('#period-pills .pill').forEach(btn=>{ btn.addEventListener('click', (e)=> this.setFilterPeriod(e.target.dataset.period)); }); }, setFilterPeriod(period){ document.querySelectorAll('#period-pills .pill').forEach(p => p.classList.remove('active')); document.querySelector(`#period-pills .pill[data-period="${period}"]`).classList.add('active');
const sd = document.getElementById('filter-start-date'); const ed = document.getElementById('filter-end-date'); const today = new Date(); const fmt = d => d.toISOString().split('T')[0]; let start = new Date(); if(period==='today'){ start=today; } else if(period==='week'){ const day = today.getDay(); const weekStartDay = this.state.parameters.weekStartDay; const diff = today.getDate() - day + (day === 0 && weekStartDay === 1 ? -6 : weekStartDay); start = new Date(today.setDate(diff)); } else if(period==='month'){ start=new Date(today.getFullYear(), today.getMonth(), 1); } else if(period==='all'){ sd.value=''; ed.value=fmt(new Date()); this.updateDashboard(); return; } sd.value = fmt(start); ed.value = fmt(new Date()); this.updateDashboard(); }, getFilteredData(){ const subject = document.getElementById('filter-subject').value; const activity = document.getElementById('filter-activity').value; const start = document.getElementById('filter-start-date').value; const end = document.getElementById('filter-end-date').value; let data = this.state.studyData.slice(); if(subject && subject!=='all') data = data.filter(d=> d.subject===subject); if(activity && activity!=='all') data = data.filter(d=> d.activity===activity); if(start) data = data.filter(d=> d.date>=start); if(end) data = data.filter(d=> d.date<=end); return data; }, bindRegistro(){ const form = document.getElementById('study-form'); const cancelBtn = document.getElementById('cancel-edit-btn'); document.getElementById('activity-type').addEventListener('change', this.toggleQuestionsSection.bind(this)); document.getElementById('session-type').addEventListener('change', this.toggleFlowSection.bind(this)); document.getElementById('subject').addEventListener('change', () => this.populateSubtopicDropdown('subject', 'subtopic')); form.addEventListener('focusin', (e) => { if (e.target.matches('.question-input')) { this.state.activeQuestionInputId = e.target.id; } });
form.addEventListener('click', (e) => { if (e.target.classList.contains('duration-btn')) { const hoursInput = document.getElementById('manual-duration-hours'); const minutesInput = document.getElementById('manual-duration-minutes'); let currentH = parseInt(hoursInput.value) || 0; let currentM = parseInt(minutesInput.value) || 0;
if (e.target.dataset.h) { currentH += parseInt(e.target.dataset.h, 10); } if (e.target.dataset.m) { currentM += parseInt(e.target.dataset.m, 10); } hoursInput.value = currentH + Math.floor(currentM / 60); minutesInput.value = currentM % 60; }
if(e.target.classList.contains('question-btn-total') || e.target.classList.contains('question-btn-correct')) { if (this.state.activeQuestionInputId) { const input = document.getElementById(this.state.activeQuestionInputId); const amount = parseInt(e.target.dataset.q, 10); input.value = (parseInt(input.value, 10) || 0) + amount; } } });
document.querySelectorAll('#mood-tracker .mood-square-wrapper').forEach(wrapper => { wrapper.querySelector('button').addEventListener('click', (e) => { document.querySelectorAll('#mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); e.currentTarget.classList.add('selected'); document.getElementById('mood-input').value = e.currentTarget.dataset.mood; }); });
form.addEventListener('submit', (e)=>{ e.preventDefault(); const hours = parseInt(form['manual-duration-hours'].value, 10) || 0; const minutes = parseInt(form['manual-duration-minutes'].value, 10) || 0; const dur = (hours * 3600) + (minutes * 60);
if(dur <= 0) return this.toast('A duração deve ser maior que zero.', false);
const totalQ = parseInt(form['questions-total'].value, 10)||0; const correctQ = parseInt(form['questions-correct'].value, 10)||0; if(correctQ>totalQ) return this.toast('Nº de acertos não pode ser maior que o total.', false); const date = form.date.value; const timestamp = new Date(date); const timeOfDay = form['time-of-day'].value; if (timeOfDay === 'madrugada') timestamp.setHours(3, 0, 0, 0); else if (timeOfDay === 'manha') timestamp.setHours(9, 0, 0, 0); else if (timeOfDay === 'tarde') timestamp.setHours(15, 0, 0, 0); else if (timeOfDay === 'noite') timestamp.setHours(21, 0, 0, 0);
const itemData = { date: date, subject: form.subject.value, subtopic: form.subtopic.value || null, duration: dur, pauseDuration: 0, activity: form['activity-type'].value, totalQuestions: totalQ, correctQuestions: correctQ, accuracy: totalQ > 0 ? correctQ / totalQ : null, mood: form.mood.value || null, sessionType: form['session-type'].value, flowScore: form['session-type'].value === 'focada' ? parseInt(form['flow-score'].value, 10) : null, timestamp: timestamp.getTime(), timeOfDay: timeOfDay };
if(this.state.editingId) { const index = this.state.studyData.findIndex(s => s.id === this.state.editingId); if (index !== -1) { this.state.studyData[index] = { ...this.state.studyData[index], ...itemData }; } this.saveData(true, 'Sessão atualizada!'); this.resetForm(); } else { this.state.studyData.push({ ...itemData, id: Date.now() }); this.saveData(true, 'Sessão registrada!'); this.resetForm(); } this.renderSessionHistory(); if (this.state.currentView === 'dashboard') { this.updateDashboard(); } }); cancelBtn.addEventListener('click', () => this.resetForm()); }, resetForm() { const form = document.getElementById('study-form'); form.reset(); this.state.editingId = null; form.querySelector('button[type="submit"]').textContent = 'Salvar sessão'; document.getElementById('cancel-edit-btn').classList.add('hidden'); document.getElementById('mood-input').value=''; document.querySelectorAll('#mood-tracker .mood-square').forEach(b=> b.classList.remove('selected')); form.date.value = new Date().toISOString().split('T')[0]; this.populateSubtopicDropdown('subject', 'subtopic'); const hour = new Date().getHours(); const select = document.getElementById('time-of-day'); if(hour >= 0 && hour < 6) select.value = 'madrugada'; else if(hour >= 6 && hour < 12) select.value = 'manha'; else if(hour >= 12 && hour < 18) select.value = 'tarde'; else select.value = 'noite';
this.toggleQuestionsSection(); this.toggleFlowSection(); },
toggleQuestionsSection(){ const activity = document.getElementById('activity-type').value; const section = document.getElementById('questions-section'); const modalSection = document.getElementById('modal-questions-section'); const needed = (activity==='Exercícios' || activity==='Simulado'); section.classList.toggle('hidden', !needed); ['questions-total','questions-correct'].forEach(id=>{ const el = document.getElementById(id); el.required = needed; if(!needed){ el.value=''; } });
modalSection.classList.toggle('hidden', !needed); ['modal-questions-total','modal-questions-correct'].forEach(id=>{ const el = document.getElementById(id); el.required = needed; if(!needed){ el.value=''; } }); }, toggleFlowSection(){ const type = document.getElementById('session-type').value; document.getElementById('flow-score-section').classList.toggle('hidden', type!=='focada'); },
bindPomodoro(){ document.getElementById('pomodoro-start-pause').addEventListener('click', ()=> this.togglePomodoro()); document.getElementById('pomodoro-reset').addEventListener('click', ()=> this.resetPomodoro(true)); document.getElementById('pomodoro-skip').addEventListener('click', ()=> this.skipPomodoro()); document.getElementById('pomodoro-subject').addEventListener('change', () => this.populateSubtopicDropdown('pomodoro-subject', 'pomodoro-subtopic')); ['pomodoro-work-duration','pomodoro-short-break-duration','pomodoro-long-break-duration', 'pomodoro-alert-time', 'pomodoro-sound-select'].forEach(id=>{ const el = document.getElementById(id); if (el) el.addEventListener('change', ()=> this.savePomodoroSettings()); }); document.getElementById('pomodoro-auto-start').addEventListener('change', ()=> this.savePomodoroSettings()); }, updateAllSubjectDropdowns(){ const subjects = this.state.parameters.subjects.map(s => s.name); const opts = subjects.map(d=> `<option value="${d}">${d}</option>`).join(''); document.getElementById('subject').innerHTML = opts; this.populateSubtopicDropdown('subject', 'subtopic');
document.getElementById('pomodoro-subject').innerHTML = opts; this.populateSubtopicDropdown('pomodoro-subject', 'pomodoro-subtopic');
document.getElementById('stopwatch-subject').innerHTML = opts; this.populateSubtopicDropdown('stopwatch-subject', 'stopwatch-subtopic');
        document.getElementById('filter-subject').innerHTML = '<option value="all">Todas as disciplinas</option>'+opts; }, populateSubtopicDropdown(subjectDropdownId, subtopicDropdownId) { const subjectName = document.getElementById(subjectDropdownId).value; const subtopicDropdown = document.getElementById(subtopicDropdownId); const subject = this.state.parameters.subjects.find(s => s.name === subjectName); subtopicDropdown.innerHTML = '<option value="">Nenhum</option>'; if(subject && subject.subtopics && subject.subtopics.length > 0) { const opts = subject.subtopics.map(sub => { const name = typeof sub === 'string' ? sub : sub.name; return `<option value="${name}">${name}</option>`; }).join(''); subtopicDropdown.innerHTML += opts; subtopicDropdown.disabled = false; } else { subtopicDropdown.disabled = true; } }, updateActivityDropdowns(){ const a = this.state.parameters.tiposDeAtividade; const opts = a.map(d=> `<option value="${d}">${d}</option>`).join(''); document.getElementById('activity-type').innerHTML = opts; document.getElementById('modal-activity-type').innerHTML = opts; document.getElementById('filter-activity').innerHTML = '<option value="all">Todos os tipos</option>'+opts; }, bindSubjectManagement() {
        document.getElementById('add-subject-btn').addEventListener('click', () => {
            const input = document.getElementById('new-subject-input');
            const name = input.value.trim();
            const subjects = this.state.parameters.subjects;
            if (name && !subjects.find(s => s.name === name)) {
                subjects.push({ name: name, subtopics: [] });
                this.ensureSubjectColors();
                this.ensureStudyTrackerData();
                this.state.studyTracker.selectedSubject = name;
                this.renderSubjectsManagement();
                this.updateAllSubjectDropdowns();
                this.renderStudyTracker();
                this.saveData(true, `Matéria "${name}" adicionada.`);
                input.value = '';
            } else {
                this.toast('Matéria já existe ou é inválida.', false);
            }
        });
        const container = document.getElementById('subjects-management-container');
        container.addEventListener('click', (e) => {
            const subjectCard = e.target.closest('[data-subject-name]');
            if (!subjectCard) return;
            const subjectName = subjectCard.dataset.subjectName;
            const shouldToggle = e.target.classList.contains('toggle-subtopics-btn') || (e.target.closest('.subject-header') && !e.target.closest('button, input, .drag-handle'));
            if (shouldToggle) {
                const subtopicsContainer = subjectCard.querySelector('.subtopics-container');
                if (subtopicsContainer.style.maxHeight) {
                    subtopicsContainer.style.maxHeight = null;
                } else {
                    subtopicsContainer.style.maxHeight = subtopicsContainer.scrollHeight + "px";
                }
                return;
            }
            if (e.target.classList.contains('remove-subject-btn')) {
                if (confirm(`Tem certeza que deseja remover a disciplina "${subjectName}" e TODOS os seus dados e assuntos associados?`)) {
                    this.removeSubjectCompletely(subjectName);
                }
                return;
            }
            if (e.target.classList.contains('add-subtopic-btn')) {
                const input = container.querySelector(`input[data-subtopic-input-for="${subjectName}"]`);
                const subtopicName = input.value.trim();
                const subject = this.state.parameters.subjects.find(s => s.name === subjectName);
                if (subtopicName && subject) {
                    const existingNames = subject.subtopics.map(st => (typeof st === 'string' ? st : st?.name || '').toLowerCase());
                    if (existingNames.includes(subtopicName.toLowerCase())) {
                        this.toast('Assunto já existe ou é inválido.', false);
                        return;
                    }
                    subject.subtopics.push(subtopicName);
                    subject.subtopics.sort((a, b) => {
                        const nameA = typeof a === 'string' ? a : a?.name || '';
                        const nameB = typeof b === 'string' ? b : b?.name || '';
                        return nameA.localeCompare(nameB, 'pt-BR');
                    });
                    this.syncStudyTrackerSubject(subjectName);
                    this.renderSubjectsManagement();
                    this.updateAllSubjectDropdowns();
                    this.renderStudyTracker();
                    this.saveData(true, `Assunto "${subtopicName}" adicionado.`);
                    input.value = '';
                } else {
                    this.toast('Assunto já existe ou é inválido.', false);
                }
                return;
            }
            if (e.target.classList.contains('remove-subtopic-btn')) {
                const subtopicName = e.target.dataset.subtopicName;
                const subject = this.state.parameters.subjects.find(s => s.name === subjectName);
                if (subject) {
                    subject.subtopics = subject.subtopics.filter(st => {
                        const currentName = typeof st === 'string' ? st : st?.name;
                        return currentName !== subtopicName;
                    });
                    this.syncStudyTrackerSubject(subjectName);
                    this.renderSubjectsManagement();
                    this.updateAllSubjectDropdowns();
                    this.renderStudyTracker();
                    this.saveData(true, 'Assunto removido.');
                }
            }
        });
        container.addEventListener('input', (e) => {
            if (e.target.classList.contains('subject-color-input')) {
                const subject = e.target.dataset.subject;
                const color = e.target.value;
                this.state.parameters.subjectColors[subject] = color;
                this.saveData();
                this.updateCharts(this.getFilteredData());
            }
        });
let draggedItem = null;
container.addEventListener('dragstart', (e) => { const target = e.target.closest('[draggable="true"]'); if (!target) return;
draggedItem = target;
setTimeout(() => { draggedItem.classList.add('dragging'); }, 0); });
container.addEventListener('dragend', () => { if(draggedItem) { draggedItem.classList.remove('dragging'); } draggedItem = null; });
const getDragAfterElement = (container, y) => { const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; };
container.addEventListener('dragover', e => { e.preventDefault(); if (!draggedItem) return;
const itemType = draggedItem.dataset.itemType; const dropZone = e.target.closest(itemType === 'subject' ? '#subjects-management-container' : '.subtopics-list'); if (!dropZone) return;
const afterElement = getDragAfterElement(dropZone, e.clientY); if (afterElement == null) { dropZone.appendChild(draggedItem); } else { dropZone.insertBefore(draggedItem, afterElement); } });
container.addEventListener('drop', (e) => {
    e.preventDefault();
    if (!draggedItem) return;
    const itemType = draggedItem.dataset.itemType;
    if (itemType === 'subject') {
        const newOrder = [...container.querySelectorAll('[data-item-type="subject"]')].map(el => el.dataset.subjectName);
        this.state.parameters.subjects.sort((a, b) => newOrder.indexOf(a.name) - newOrder.indexOf(b.name));
        this.saveData(true, "Ordem das matérias atualizada.");
    } else if (itemType === 'subtopic') {
        const subtopicsList = draggedItem.closest('.subtopics-list');
        const parentSubjectName = subtopicsList.dataset.parentSubject;
        const subject = this.state.parameters.subjects.find(s => s.name === parentSubjectName);
        if (subject) {
            const newOrder = [...subtopicsList.querySelectorAll('[data-item-type="subtopic"]')].map(el => el.dataset.subtopicName);
            subject.subtopics = newOrder;
            this.syncStudyTrackerSubject(parentSubjectName);
            this.saveData(true, "Ordem dos assuntos atualizada.");
        }
    }
    this.renderSubjectsManagement();
    this.updateAllSubjectDropdowns();
    this.renderStudyTracker();
});
const weekStartSelect = document.getElementById('week-start-day'); weekStartSelect.value = this.state.parameters.weekStartDay; weekStartSelect.addEventListener('change', (e) => { this.state.parameters.weekStartDay = parseInt(e.target.value, 10); this.saveData(true, 'Início da semana atualizado!'); this.updateDashboard(); });
document.getElementById('reset-all-data-btn').addEventListener('click', ()=>{ if(confirm('ATENÇÃO: Isso apagará TODOS os seus dados de estudo da NUVEM permanentemente. Deseja continuar?')){ const conf = prompt("Para confirmar, digite 'EXCLUIR' em maiúsculas."); if(conf==='EXCLUIR'){ if(this.state.userId) { this.state.db.ref('users/' + this.state.userId).remove() .then(() => { localStorage.removeItem('studyDashBackupsV30'); localStorage.removeItem('darkMode'); location.reload(); }) .catch(e => this.toast('Erro ao excluir dados da nuvem.', false)); } }else{ this.toast('Ação cancelada.', false); } } }); },
renderSubjectsManagement(){ const container = document.getElementById('subjects-management-container'); const openSubjects = new Set(); container.querySelectorAll('.subtopics-container').forEach(cont => { if (cont.style.maxHeight && cont.style.maxHeight !== '0px') { const subjectCard = cont.closest('[data-subject-name]'); if (subjectCard) { openSubjects.add(subjectCard.dataset.subjectName); } } });
container.innerHTML=''; this.state.parameters.subjects.forEach(subject => { const color = this.state.parameters.subjectColors[subject.name] || '#cccccc'; const subjectEl = document.createElement('div'); subjectEl.className = 'bg-[var(--bg)] p-3 rounded-md border border-[var(--border-color)]'; subjectEl.dataset.subjectName = subject.name; subjectEl.dataset.itemType = 'subject'; subjectEl.draggable = true;
const subtopicsHTML = subject.subtopics.map(st => { const name = typeof st === 'string' ? st : (st.name || ''); return ` <li class="flex justify-between items-center p-1 rounded-md hover:bg-[var(--border-color)]" draggable="true" data-item-type="subtopic" data-subtopic-name="${name}"> <span class="flex items-center gap-2"> <i class="fa-solid fa-grip-vertical text-[var(--text-muted)] drag-handle"></i> ${name} </span> <button data-subtopic-name="${name}" class="remove-subtopic-btn text-red-500 hover:text-red-700 text-xs font-bold p-1">&times;</button> </li> `; }).join('');
subjectEl.innerHTML = ` <div class="flex items-center justify-between subject-header cursor-pointer"> <span class="flex items-center gap-3 font-semibold"> <i class="fa-solid fa-grip-vertical text-[var(--text-muted)] drag-handle"></i> <input type="color" value="${color}" data-subject="${subject.name}" class="subject-color-input w-6 h-6 p-0 border-none rounded cursor-pointer"> ${subject.name} </span> <div> <button class="toggle-subtopics-btn btn btn-secondary text-xs py-1 px-2 mr-2">Assuntos</button> <button data-subject="${subject.name}" class="remove-subject-btn btn btn-danger text-xs py-1 px-2">Remover</button> </div> </div> <div class="subtopics-container"> <div class="pl-8 mt-3 pt-3 border-t"> <div class="flex items-center gap-2"> <input type="text" data-subtopic-input-for="${subject.name}" placeholder="Novo assunto" class="flex-grow text-sm shadow-sm"> <button class="add-subtopic-btn btn btn-secondary text-xs py-1 px-2">Adicionar</button> </div> <ul class="mt-2 space-y-1 text-sm text-[var(--text-muted)] subtopics-list" data-parent-subject="${subject.name}"> ${subtopicsHTML} </ul> </div> </div> `; container.appendChild(subjectEl);
if (openSubjects.has(subject.name)) { const subtopicsContainer = subjectEl.querySelector('.subtopics-container'); setTimeout(() => { if (subtopicsContainer) { subtopicsContainer.style.maxHeight = subtopicsContainer.scrollHeight + "px"; } }, 0); } }); },
async initAudio() { if (this.state.audioInitialized || typeof Tone === 'undefined') return; try { await Tone.start(); this.state.synth = new Tone.Synth().toDestination(); this.state.audioInitialized = true; this.state.backgroundAudio.volume = new Tone.Volume(-20).toDestination(); console.log('Audio context started.'); } catch(e) { console.error("Could not start audio context:", e); } },
playNotificationSound(timerType = 'pomodoro') { if (!this.state.audioInitialized || !this.state.synth) return; try { const soundSettings = timerType === 'pomodoro' ? this.state.pomodoro.settings : this.state.stopwatch.settings; const selectedSound = soundSettings.sound || 'notification'; const sequence = this.state.soundOptions[selectedSound]; const now = Tone.now(); sequence.forEach((note, i) => { this.state.synth.triggerAttackRelease(note, "8n", now + i * 0.2); }); } catch (e) { console.error("Error playing sound:", e); } },
resetPomodoro(resetCycles=false){ const p = this.state.pomodoro; clearInterval(p.intervalId); p.isRunning=false; p.isSessionActive=false; p.mode='work'; p.timeLeft = (p.settings.work*60); p.totalPauseTime = 0; p.pauseStartTime = null; p.currentTaskId = null; if(resetCycles){ p.cyclesCompleted = 0; p.pendingLogDuration = 0; } this.renderPomodoro(); this.renderTasks(); if (!this.state.stopwatch.isRunning) { document.title = 'Dashboard de Performance'; } }, savePomodoroSettings(){ const p = this.state.pomodoro; p.settings.work = parseInt(document.getElementById('pomodoro-work-duration').value, 10)||25; p.settings.shortBreak = parseInt(document.getElementById('pomodoro-short-break-duration').value, 10)||5; p.settings.longBreak = parseInt(document.getElementById('pomodoro-long-break-duration').value, 10)||15; p.settings.alertTime = parseInt(document.getElementById('pomodoro-alert-time').value, 10) || null; p.settings.sound = document.getElementById('pomodoro-sound-select').value; p.settings.autoStart = document.getElementById('pomodoro-auto-start').checked; this.saveData(); if(!p.isRunning){ if(p.mode==='work') p.timeLeft=p.settings.work*60; else if(p.mode==='short') p.timeLeft=p.settings.shortBreak*60; else if(p.mode==='long') p.timeLeft=p.settings.longBreak*60; this.renderPomodoro(); } }, togglePomodoro(){ this.initAudio(); const p = this.state.pomodoro; p.isRunning = !p.isRunning;
if(p.isRunning){ if(p.pauseStartTime) { p.totalPauseTime += Date.now() - p.pauseStartTime; p.pauseStartTime = null; } if(!p.isSessionActive){ p.isSessionActive=true; p.cycleStart = Date.now(); p.totalCycles = parseInt(document.getElementById('pomodoro-cycles').value, 10) || 4; p.sessionSubject = document.getElementById('pomodoro-subject').value; p.sessionSubtopic = document.getElementById('pomodoro-subtopic').value; } this.playNotificationSound('pomodoro'); p.intervalId = setInterval(()=> this.tickPomodoro(), 1000); }else{ clearInterval(p.intervalId); p.pauseStartTime = Date.now(); } this.renderPomodoro(); }, skipPomodoro(){ const p = this.state.pomodoro; clearInterval(p.intervalId); p.isRunning = false; p.pauseStartTime = null; this.playNotificationSound('pomodoro'); if(p.isSessionActive && p.mode === 'work'){ this.handlePomodoroWorkEnd(); } else { this.showNotificationModal('Pausa pulada!', ''); this.advancePomodoro(); } }, tickPomodoro(){ const p = this.state.pomodoro; if (!p.isRunning) return;
p.timeLeft--; const alertTimeInSeconds = p.settings.alertTime ? p.settings.alertTime * 60 : null; if(alertTimeInSeconds && p.timeLeft === alertTimeInSeconds) { this.playNotificationSound('pomodoro'); this.showNotificationModal('Atenção!', `Faltam ${p.settings.alertTime} minutos para acabar o ${p.mode === 'work' ? 'foco' : 'descanso'}.`); } if(p.timeLeft <= 0){ p.timeLeft = 0; this.renderPomodoro(); clearInterval(p.intervalId); p.isRunning = false; p.pauseStartTime = null; this.playNotificationSound('pomodoro'); if (p.mode === 'work') { this.handlePomodoroWorkEnd(); } else { this.showNotificationModal('Pausa finalizada!', 'Hora de voltar ao foco.'); this.advancePomodoro(); if(p.settings.autoStart){ setTimeout(() => this.togglePomodoro(), 500); } } return; } this.renderPomodoro(); }, handlePomodoroWorkEnd() { const p = this.state.pomodoro; const durationOfWorkCycle = p.settings.work * 60; p.pendingLogDuration += durationOfWorkCycle;
if(p.currentTaskId) { const task = this.state.parameters.tasks.find(t => t.id === p.currentTaskId); if(task) { task.completedPomodoros = (task.completedPomodoros || 0) + 1; if(task.completedPomodoros >= task.estPomodoros && !task.isComplete) { this.toggleTaskComplete(task.id); this.toast(`Tarefa "${task.name}" concluída!`);
const tasks = this.state.parameters.tasks; const currentIndex = tasks.findIndex(t => t.id === task.id); let nextTask = null;
for (let i = currentIndex + 1; i < tasks.length; i++) { if (!tasks[i].isComplete) { nextTask = tasks[i]; break; } }
if (!nextTask) { for (let i = 0; i < currentIndex; i++) { if (!tasks[i].isComplete) { nextTask = tasks[i]; break; } } }
if (nextTask) { p.currentTaskId = nextTask.id; this.toast(`Próxima tarefa: ${nextTask.name}`); } else { p.currentTaskId = null; } } this.renderTasks(); this.saveData(); } } this.advancePomodoro();
if(p.settings.autoStart && p.mode !== 'work'){ setTimeout(() => this.togglePomodoro(), 500); } }, advancePomodoro(){ const p = this.state.pomodoro; clearInterval(p.intervalId); p.isRunning = false; p.pauseStartTime = null; p.cycleStart = Date.now();
if(p.mode==='work'){ p.cyclesCompleted++; const isLongBreak = (p.cyclesCompleted > 0 && p.cyclesCompleted % p.totalCycles === 0); p.mode = isLongBreak ? 'long' : 'short'; if (isLongBreak && p.pendingLogDuration > 0) {
const totalDurationInSeconds = p.pendingLogDuration + (p.totalPauseTime / 1000); const pauseDurationInSeconds = p.totalPauseTime / 1000; this.openSessionModal(totalDurationInSeconds, p.sessionSubject, p.sessionSubtopic, pauseDurationInSeconds); p.pendingLogDuration = 0; p.totalPauseTime = 0; }
} else { p.mode='work'; } p.timeLeft = this.modeSeconds(p.mode); this.renderPomodoro(); }, modeSeconds(mode){ const s = this.state.pomodoro.settings; if(mode==='work') return s.work*60; if(mode==='short') return s.shortBreak*60; if(mode==='long') return s.longBreak*60; return 0; }, renderPomodoro(){ const p = this.state.pomodoro; document.getElementById('pomodoro-timer-display').textContent = this.formatTime(p.timeLeft, 'ms'); if(p.isRunning || p.isSessionActive) { document.title = `${this.formatTime(p.timeLeft, 'ms')} - ${p.mode==='work' ? 'Foco' : 'Pausa'}`; } else if (!this.state.stopwatch.isRunning) { document.title = 'Dashboard de Performance'; } const pauseDisplay = document.getElementById('pomodoro-pause-display'); if (p.totalPauseTime > 0 || p.pauseStartTime) { let currentPause = p.totalPauseTime; if (p.pauseStartTime) currentPause += Date.now() - p.pauseStartTime; pauseDisplay.textContent = `Pausa total: ${this.formatTime(currentPause / 1000, 'hms_seconds')}`; } else { pauseDisplay.textContent = ''; }
let statusText = 'Pronto para começar'; if(p.isSessionActive) { if (p.mode === 'work') statusText = 'Foco'; else if (p.mode === 'short') statusText = 'Pausa Curta'; else if (p.mode === 'long') statusText = 'Pausa Longa'; } document.getElementById('pomodoro-status').textContent = statusText;
if(p.isRunning){ document.getElementById('pomodoro-start-pause').textContent='Pausar'; const end = new Date(Date.now()+p.timeLeft*1000); const hh = String(end.getHours()).padStart(2,'0'); const mm2 = String(end.getMinutes()).padStart(2,'0'); document.getElementById('pomodoro-end-time').textContent = `Termina às ${hh}:${mm2}`; }else{ document.getElementById('pomodoro-start-pause').textContent= p.isSessionActive ? 'Retomar' : 'Iniciar'; document.getElementById('pomodoro-end-time').textContent = ''; }
const dots = document.getElementById('pomodoro-cycle-dots'); dots.innerHTML=''; const total = p.totalCycles; for(let i=0; i<total; i++){ const d = document.createElement('div'); d.className = 'cycle-dot' + (i < p.cyclesCompleted ? ' done' : '') + (i === p.cyclesCompleted && p.mode === 'work' && p.isSessionActive ? ' active':''); dots.appendChild(d); }
const currentTaskDisplay = document.getElementById('current-task-display'); if(p.currentTaskId) { const task = this.state.parameters.tasks.find(t => t.id === p.currentTaskId); if(task) { currentTaskDisplay.textContent = `Foco em: ${task.name}`; } else { currentTaskDisplay.textContent = 'Nenhuma tarefa selecionada'; } } else { currentTaskDisplay.textContent = 'Nenhuma tarefa selecionada'; }
this.updatePipView(); }, bindStopwatch() { document.getElementById('stopwatch-start-pause').addEventListener('click', () => this.toggleStopwatch()); document.getElementById('stopwatch-log').addEventListener('click', () => this.logStopwatch()); document.getElementById('stopwatch-reset').addEventListener('click', () => this.resetStopwatch()); document.getElementById('stopwatch-subject').addEventListener('change', () => this.populateSubtopicDropdown('stopwatch-subject', 'stopwatch-subtopic')); document.getElementById('stopwatch-alert-hours').addEventListener('change', () => this.setStopwatchAlert()); document.getElementById('stopwatch-alert-minutes').addEventListener('change', () => this.setStopwatchAlert()); document.getElementById('stopwatch-sound-select').addEventListener('change', (e) => { this.state.stopwatch.settings.sound = e.target.value; this.saveData(); }); }, toggleStopwatch() { this.initAudio(); const sw = this.state.stopwatch; sw.isRunning = !sw.isRunning; if (sw.isRunning) { if(sw.pauseStartTime) { const pauseDuration = Date.now() - sw.pauseStartTime; sw.totalPauseTime += pauseDuration; sw.startTime += pauseDuration; sw.pauseStartTime = null; } else { if(sw.elapsedTime === 0){ this.playNotificationSound('stopwatch'); } sw.startTime = Date.now() - sw.elapsedTime; } sw.intervalId = setInterval(() => this.tickStopwatch(), 1000); document.getElementById('stopwatch-start-pause').textContent = 'Pausar'; } else { clearInterval(sw.intervalId); sw.pauseStartTime = Date.now(); document.getElementById('stopwatch-start-pause').textContent = 'Retomar'; } }, resetStopwatch() { const sw = this.state.stopwatch; clearInterval(sw.intervalId); sw.isRunning = false; sw.elapsedTime = 0; sw.alertTime = null; sw.alertTriggered = false; sw.totalPauseTime = 0; sw.pauseStartTime = null; this.renderStopwatch(); document.getElementById('stopwatch-start-pause').textContent = 'Iniciar'; document.getElementById('stopwatch-alert-hours').value = ''; document.getElementById('stopwatch-alert-minutes').value = ''; document.title = 'Dashboard de Performance'; }, tickStopwatch() { const sw = this.state.stopwatch; if (!sw.isRunning) return; sw.elapsedTime = Date.now() - sw.startTime; if (sw.alertTime && !sw.alertTriggered && (sw.elapsedTime / 1000) >= sw.alertTime) { this.playNotificationSound('stopwatch'); this.showNotificationModal('Cronômetro', 'O tempo definido foi atingido!'); sw.alertTriggered = true; } this.renderStopwatch(); }, renderStopwatch() { const sw = this.state.stopwatch; const time = sw.elapsedTime; const timeString = this.formatTime(time / 1000, 'hms_seconds'); document.getElementById('stopwatch-display').textContent = timeString;
const pauseDisplay = document.getElementById('stopwatch-pause-display'); if (sw.totalPauseTime > 0 || sw.pauseStartTime) { let currentPause = sw.totalPauseTime; if (sw.pauseStartTime) currentPause += Date.now() - sw.pauseStartTime; pauseDisplay.textContent = `Pausa total: ${this.formatTime(currentPause / 1000, 'hms_seconds')}`; } else { pauseDisplay.textContent = ''; }
if (sw.isRunning || sw.elapsedTime > 0) { document.title = `${timeString} - Cronômetro`; } else if (!this.state.pomodoro.isRunning && !this.state.pomodoro.isSessionActive) { document.title = 'Dashboard de Performance'; }
this.updatePipView(); }, logStopwatch() { const sw = this.state.stopwatch; const totalDuration = sw.elapsedTime; if (totalDuration < 60000) return this.toast('A sessão precisa ter no mínimo 1 minuto de tempo total.', false); clearInterval(sw.intervalId); this.playNotificationSound('stopwatch'); const durationInSeconds = Math.floor(totalDuration / 1000); const pauseInSeconds = Math.floor(sw.totalPauseTime / 1000); const subject = document.getElementById('stopwatch-subject').value; const subtopic = document.getElementById('stopwatch-subtopic').value; this.openSessionModal(durationInSeconds, subject, subtopic, pauseInSeconds); this.resetStopwatch(); }, setStopwatchAlert() { const sw = this.state.stopwatch; const hours = parseInt(document.getElementById('stopwatch-alert-hours').value, 10) || 0;
const minutes = parseInt(document.getElementById('stopwatch-alert-minutes').value, 10) || 0; const totalSeconds = (hours * 3600) + (minutes * 60);
if (totalSeconds > 0 && totalSeconds > (sw.elapsedTime / 1000)) { sw.alertTime = totalSeconds; sw.alertTriggered = false; this.toast('Alerta definido!'); } else { sw.alertTime = null; sw.alertTriggered = false; if (hours > 0 || minutes > 0) { this.toast('Tempo de alerta inválido ou já passou.', false); } } }, bindModal() { const form = document.getElementById('modal-session-form'); document.getElementById('modal-cancel-btn').addEventListener('click', () => this.closeSessionModal(true)); document.getElementById('session-modal-backdrop').addEventListener('click', () => this.closeSessionModal(true)); document.getElementById('modal-activity-type').addEventListener('change', (e) => { const section = document.getElementById('modal-questions-section'); const needed = (e.target.value === 'Exercícios' || e.target.value === 'Simulado'); section.classList.toggle('hidden', !needed); });
form.addEventListener('focusin', (e) => { if (e.target.matches('.modal-question-input')) { this.state.activeModalQuestionInputId = e.target.id; } });
form.addEventListener('click', (e) => { if(e.target.classList.contains('modal-question-btn-total')) { const qTotalInput = document.getElementById('modal-questions-total'); const amount = parseInt(e.target.dataset.q, 10); qTotalInput.value = (parseInt(qTotalInput.value, 10) || 0) + amount; } if(e.target.classList.contains('modal-question-btn-correct')) { const qCorrectInput = document.getElementById('modal-questions-correct'); const amount = parseInt(e.target.dataset.q, 10); qCorrectInput.value = (parseInt(qCorrectInput.value, 10) || 0) + amount; } });
document.querySelectorAll('#modal-mood-tracker .mood-square-wrapper').forEach(wrapper => { wrapper.querySelector('button').addEventListener('click', (e) => { document.querySelectorAll('#modal-mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); e.currentTarget.classList.add('selected'); document.getElementById('modal-mood-input').value = e.currentTarget.dataset.mood; }); });
form.addEventListener('submit', (e) => { e.preventDefault(); const session = this.state.pendingSession; if (!session) return;
const totalQ = parseInt(form['modal-questions-total'].value, 10) || 0; const correctQ = parseInt(form['modal-questions-correct'].value, 10) || 0; if (correctQ > totalQ) return this.toast('Nº de acertos não pode ser maior que o total.', false); const hour = new Date().getHours(); let timeOfDay = 'manha'; if(hour >= 0 && hour < 6) timeOfDay = 'madrugada'; else if(hour >= 12 && hour < 18) timeOfDay = 'tarde'; else if (hour >= 18) timeOfDay = 'noite';
const finalSession = { ...session, activity: form['modal-activity-type'].value, totalQuestions: totalQ, correctQuestions: correctQ, accuracy: totalQ > 0 ? correctQ / totalQ : null, mood: form['modal-mood-input'].value || null, flowScore: parseInt(form['modal-flow-score'].value, 10), sessionType: 'focada', timestamp: Date.now(), timeOfDay: timeOfDay };
this.state.studyData.push(finalSession); this.saveData(true, 'Sessão registrada com sucesso!'); this.closeSessionModal(false); if (this.state.currentView === 'dashboard') { this.updateDashboard(); } this.renderSessionHistory(); }); },
openSessionModal(durationInSeconds, subject, subtopic = null, pauseDurationInSeconds = 0) { this.state.pendingSession = { id: Date.now(), date: new Date().toISOString().split('T')[0], duration: durationInSeconds, pauseDuration: pauseDurationInSeconds, subject: subject, subtopic: subtopic || null }; const subtopicText = subtopic ? ` (${subtopic})` : ''; document.getElementById('modal-session-info').textContent = `Registrando ${this.formatTime(durationInSeconds)} para ${subject}${subtopicText}`; document.getElementById('modal-session-form').reset(); document.querySelectorAll('#modal-mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); document.getElementById('modal-questions-section').classList.add('hidden');
document.getElementById('session-modal-backdrop').classList.remove('hidden'); document.getElementById('session-modal-panel').classList.remove('hidden'); },
closeSessionModal(isCancel) { this.state.pendingSession = null; document.getElementById('session-modal-backdrop').classList.add('hidden'); document.getElementById('session-modal-panel').classList.add('hidden'); if (this.state.pomodoro.isSessionActive) { if (isCancel) { this.toast('Sessão não registrada.', false); } if (this.state.pomodoro.settings.autoStart && this.state.pomodoro.mode !== 'work') { this.togglePomodoro(); } } }, bindNotificationModal() { document.getElementById('notification-ok-btn').addEventListener('click', () => this.closeNotificationModal()); document.getElementById('notification-modal-backdrop').addEventListener('click', () => this.closeNotificationModal()); }, showNotificationModal(title, message) { document.getElementById('notification-title').textContent = title; document.getElementById('notification-message').textContent = message; document.getElementById('notification-modal-backdrop').classList.remove('hidden'); document.getElementById('notification-modal-panel').classList.remove('hidden'); }, closeNotificationModal() { document.getElementById('notification-modal-backdrop').classList.add('hidden'); document.getElementById('notification-modal-panel').classList.add('hidden'); },
bindPip() { const pip = this.state.pip; pip.video = document.getElementById('pip-video'); pip.canvas = document.getElementById('pip-canvas'); pip.ctx = pip.canvas.getContext('2d'); document.getElementById('pomodoro-open-mini').addEventListener('click', () => this.togglePictureInPicture()); document.getElementById('stopwatch-open-mini').addEventListener('click', () => this.togglePictureInPicture());
pip.video.addEventListener('leavepictureinpicture', () => { pip.isActive = false; }); },
async togglePictureInPicture() { const pip = this.state.pip; this.updatePipView();
try { if (document.pictureInPictureElement) { await document.exitPictureInPicture(); pip.isActive = false; } else { if (!pip.video.srcObject) { const stream = pip.canvas.captureStream(); pip.video.srcObject = stream; } await pip.video.play(); await pip.video.requestPictureInPicture(); pip.isActive = true; } } catch (error) { console.error("Erro ao controlar Picture-in-Picture:", error); this.toast('Seu navegador não suporta o timer flutuante, ou a permissão foi negada.', false); } },
updatePipView() { if (!this.state.pip.canvas) return; const pip = this.state.pip; const ctx = pip.ctx; ctx.clearRect(0, 0, pip.canvas.width, pip.canvas.height); ctx.fillStyle = this.state.parameters.darkMode ? '#1e1e1e' : '#FDFBF7'; ctx.fillRect(0, 0, pip.canvas.width, pip.canvas.height);
let title = 'Timer'; let timeString = '00:00'; let subjectString = 'Nenhuma sessão ativa';
if (this.state.pomodoro.isSessionActive || this.state.pomodoro.isRunning) { const p = this.state.pomodoro; timeString = this.formatTime(p.timeLeft, 'ms'); title = p.mode === 'work' ? 'Foco' : (p.mode === 'short' ? 'Pausa Curta' : 'Pausa Longa'); subjectString = p.sessionSubject || 'Pomodoro'; } else if (this.state.stopwatch.isRunning || this.state.stopwatch.elapsedTime > 0) { const sw = this.state.stopwatch; timeString = this.formatTime(sw.elapsedTime/1000, 'hms_seconds'); title = 'Cronômetro'; subjectString = document.getElementById('stopwatch-subject').value || 'Sessão livre'; }
ctx.fillStyle = this.state.parameters.darkMode ? '#e0e0e0' : '#3D405B'; ctx.textAlign = 'center'; ctx.font = '600 24px Inter'; ctx.fillText(title, 150, 45); ctx.font = '900 80px Inter'; ctx.fillText(timeString, 150, 125); ctx.font = '500 18px Inter'; ctx.fillStyle = this.state.parameters.darkMode ? '#9ca3af' : '#6B7280'; ctx.fillText(subjectString, 150, 160); },
bindBackgroundSounds() { const controls = document.getElementById('background-sound-controls'); const volumeSlider = document.getElementById('background-sound-volume');
controls.addEventListener('click', async (e) => { const button = e.target.closest('.sound-btn'); if (!button) return;
await this.initAudio();
const soundType = button.dataset.soundType || 'noise'; const soundKey = button.dataset.sound;
document.querySelectorAll('.sound-btn').forEach(btn => btn.classList.remove('active'));
button.classList.add('active');
this.stopBackgroundAudio();
if (soundType !== 'off') {
if(this.state.youtubePlayer && typeof this.state.youtubePlayer.stopVideo === 'function'){ this.stopYouTubeVideo({ keepSelection: false }); }
if (soundType === 'noise') { const noiseType = soundKey || 'white'; try { this.state.backgroundAudio.player = new Tone.Noise(noiseType).connect(this.state.backgroundAudio.volume); this.state.backgroundAudio.player.start(); } catch (error) { console.error('Erro ao iniciar ruído de fundo:', error); this.toast('Não foi possível iniciar o ruído de fundo.', false); } }
else if (soundType === 'track') { const url = button.dataset.soundUrl; if (url) { try { this.state.backgroundAudio.player = new Tone.Player({ url, loop: true, autostart: true, onerror: () => this.toast('Não foi possível carregar o áudio ambiente.', false) }).connect(this.state.backgroundAudio.volume); } catch (error) { console.error('Erro ao carregar som ambiente:', error); this.toast('Não foi possível tocar o som ambiente.', false); } } }
} });
volumeSlider.addEventListener('input', async (e) => { await this.initAudio(); const value = parseFloat(e.target.value); if(this.state.backgroundAudio.volume) { this.state.backgroundAudio.volume.volume.value = value; } if(this.state.youtubePlayer && typeof this.state.youtubePlayer.setVolume === 'function') { const newVolume = Math.max(0, Math.min(100, Math.round(100 * Math.pow(10, value / 20)))); this.state.youtubePlayer.setVolume(newVolume); } }); },
stopBackgroundAudio() { if (this.state.backgroundAudio.player) { try { this.state.backgroundAudio.player.stop(); } catch (error) { console.warn('Erro ao parar áudio de fundo:', error); } if (typeof this.state.backgroundAudio.player.dispose === 'function') { this.state.backgroundAudio.player.dispose(); } this.state.backgroundAudio.player = null; } },
bindTasks() { document.getElementById('add-task-form').addEventListener('submit', (e) => { e.preventDefault(); const nameInput = document.getElementById('new-task-input'); const pomodorosInput = document.getElementById('new-task-pomodoros'); const name = nameInput.value.trim(); const estPomodoros = parseInt(pomodorosInput.value, 10) || 1; if (name) { this.state.parameters.tasks.push({ id: Date.now(), name, estPomodoros, completedPomodoros: 0, isComplete: false }); nameInput.value = ''; pomodorosInput.value = '1'; this.renderTasks(); this.saveData(); } });
document.getElementById('task-list-container').addEventListener('click', (e) => { const taskItem = e.target.closest('.task-item'); if (!taskItem) return; const taskId = parseInt(taskItem.dataset.taskId, 10);
if (e.target.closest('.task-complete-btn')) { this.toggleTaskComplete(taskId); } else if (e.target.closest('.delete-task-btn')) { if (confirm('Tem certeza que deseja remover esta tarefa?')) { this.state.parameters.tasks = this.state.parameters.tasks.filter(t => t.id !== taskId); if (this.state.pomodoro.currentTaskId === taskId) { this.state.pomodoro.currentTaskId = null; } this.renderTasks(); this.renderPomodoro(); this.saveData(); } } else if (e.target.closest('.edit-task-btn')) { const task = this.state.parameters.tasks.find(t => t.id === taskId); if(task) { const newName = prompt('Editar nome da tarefa:', task.name); const newEst = prompt('Editar pomodoros estimados:', task.estPomodoros); if (newName !== null && newName.trim() !== '') { task.name = newName.trim(); } if (newEst !== null && !isNaN(parseInt(newEst, 10)) && parseInt(newEst, 10) > 0) { task.estPomodoros = parseInt(newEst, 10); } this.renderTasks(); this.saveData(); } } else { this.selectTask(taskId); } });
document.getElementById('clear-completed-tasks-btn').addEventListener('click', () => { this.state.parameters.tasks = this.state.parameters.tasks.filter(t => !t.isComplete); this.renderTasks(); this.saveData(); }); document.getElementById('clear-all-tasks-btn').addEventListener('click', () => { if (confirm('Tem certeza que deseja remover TODAS as tarefas?')) { this.state.parameters.tasks = []; this.state.pomodoro.currentTaskId = null; this.renderTasks(); this.renderPomodoro(); this.saveData(); } }); },
renderTasks() { const container = document.getElementById('task-list-container'); container.innerHTML = ''; const tasks = this.state.parameters.tasks; if (tasks.length === 0) { container.innerHTML = `<p class="text-sm text-center text-[var(--text-muted)]">Nenhuma tarefa adicionada ainda.</p>`; return; }
tasks.forEach(task => { const item = document.createElement('div'); item.className = 'task-item'; item.dataset.taskId = task.id; if (task.isComplete) item.classList.add('completed'); if (task.id === this.state.pomodoro.currentTaskId) item.classList.add('selected');
item.innerHTML = ` <button class="task-complete-btn"> ${task.isComplete ? '<i class="fa-solid fa-check"></i>' : ''} </button> <span class="task-name">${task.name}</span> <span class="task-item-pomodoros">${task.completedPomodoros} / ${task.estPomodoros}</span> <div class="task-actions"> <button class="edit-task-btn" title="Editar tarefa"><i class="fa-solid fa-pencil"></i></button> <button class="delete-task-btn" title="Remover tarefa"><i class="fa-solid fa-trash"></i></button> </div> `;
container.appendChild(item); }); },
selectTask(taskId) { this.state.pomodoro.currentTaskId = taskId; this.renderTasks(); this.renderPomodoro(); },
toggleTaskComplete(taskId) { const task = this.state.parameters.tasks.find(t => t.id === taskId); if (task) { task.isComplete = !task.isComplete; } this.renderTasks(); this.saveData(); },
    initYouTubePlayer() { if (this.state.youtubePlayer || typeof YT === 'undefined' || typeof YT.Player !== 'function') { return; } this.state.youtubePlayerReady = false; this.state.youtubePlayer = new YT.Player('youtube-player', { height: '0', width: '0', playerVars: { autoplay: 0, rel: 0, playsinline: 1 }, events: { 'onReady': (event) => this.onYouTubePlayerReady(event), 'onStateChange': (event) => this.onPlayerStateChange(event) } }); },
async bindYouTubeMusic() { document.getElementById('add-youtube-url-btn').addEventListener('click', async () => { const input = document.getElementById('youtube-url-input'); const url = input.value.trim(); const videoId = this.extractYouTubeVideoID(url); if (videoId) { try { const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`); const data = await response.json(); const title = data.title || videoId; this.state.parameters.youtubeMusic.push({ id: Date.now(), videoId, name: title }); this.saveData(); this.renderYouTubeMusicList(); input.value = ''; } catch(e) { this.toast('Não foi possível buscar o título do vídeo.', false); this.state.parameters.youtubeMusic.push({ id: Date.now(), videoId, name: videoId }); this.saveData(); this.renderYouTubeMusicList(); input.value = ''; } } else { this.toast('URL do YouTube inválida.', false); } });
document.getElementById('youtube-music-list').addEventListener('click', e => { const item = e.target.closest('.youtube-music-item'); if(!item) return; const musicId = parseInt(item.dataset.musicId, 10);
if(e.target.closest('.play-youtube-btn')) { const videoId = item.dataset.videoId; this.playYouTubeVideo(videoId, musicId); } else if (e.target.closest('.delete-youtube-btn')) { if(this.state.currentMusicId === musicId) this.stopYouTubeVideo(); this.state.parameters.youtubeMusic = this.state.parameters.youtubeMusic.filter(m => m.id !== musicId); this.saveData(); this.renderYouTubeMusicList(); } else if(e.target.closest('.edit-youtube-btn')) { const music = this.state.parameters.youtubeMusic.find(m => m.id === musicId); if(music) { const newName = prompt('Editar nome da música:', music.name); if(newName && newName.trim() !== ''){ music.name = newName.trim(); this.saveData(); this.renderYouTubeMusicList(); } } } }); document.getElementById('skip-youtube-btn').addEventListener('click', () => this.playNextYouTubeVideo()); },
renderYouTubeMusicList() { const container = document.getElementById('youtube-music-list'); if (!container) return; container.innerHTML = ''; if (this.state.parameters.youtubeMusic.length === 0) { container.innerHTML = '<p class="text-xs text-center text-gray-400">Nenhuma música salva.</p>'; return; }
    this.state.parameters.youtubeMusic.forEach(music => { const item = document.createElement('div'); const playerState = this.state.youtubePlayerState; const isActive = music.id === this.state.currentMusicId; const isPlaying = isActive && (playerState === 'playing' || playerState === 'buffering'); const isPaused = isActive && playerState === 'paused'; const classes = ['youtube-music-item', 'flex', 'justify-between', 'items-center', 'p-1', 'rounded', 'hover:bg-[var(--border-color)]']; if (isPlaying) { classes.push('active'); } else if (isPaused) { classes.push('paused'); } item.className = classes.join(' '); item.dataset.videoId = music.videoId; item.dataset.musicId = music.id; const iconClass = isPlaying ? 'fa-pause' : 'fa-play'; const buttonTitle = isPlaying ? 'Pausar' : 'Reproduzir'; item.innerHTML = ` <span class="truncate text-xs flex-grow ml-2">${music.name}</span> <div class="flex-shrink-0"> <button class="play-youtube-btn p-1 text-gray-500 hover:text-green-500" title="${buttonTitle}"><i class="fa-solid ${iconClass}"></i></button> <button class="edit-youtube-btn p-1 text-gray-500 hover:text-blue-500" title="Renomear"><i class="fa-solid fa-pencil"></i></button> <button class="delete-youtube-btn p-1 text-gray-500 hover:text-red-500" title="Remover"><i class="fa-solid fa-trash"></i></button> </div> `; container.appendChild(item); }); },
    onYouTubePlayerReady(event) {
        this.state.youtubePlayerReady = true;
        if (event && event.target) {
            this.state.youtubePlayer = event.target;
        }
        const slider = document.getElementById('background-sound-volume');
        if (slider && this.state.youtubePlayer && typeof this.state.youtubePlayer.setVolume === 'function') {
            const value = parseFloat(slider.value);
            if (!isNaN(value)) {
                const newVolume = Math.max(0, Math.min(100, Math.round(100 * Math.pow(10, value / 20))));
                this.state.youtubePlayer.setVolume(newVolume);
            }
        }
        if (this.state.pendingYouTubeTrack) {
            const { videoId, musicId } = this.state.pendingYouTubeTrack;
            this.state.pendingYouTubeTrack = null;
            this.playYouTubeVideo(videoId, musicId);
        } else {
            this.renderYouTubeMusicList();
        }
    },
    playYouTubeVideo(videoId, musicId) {
        if (!videoId || !musicId) return;
        if (!this.state.youtubePlayer && typeof YT !== 'undefined' && typeof YT.Player === 'function') {
            this.initYouTubePlayer();
        }
        if (!this.state.youtubePlayerReady) {
            this.state.pendingYouTubeTrack = { videoId, musicId };
            this.state.currentMusicId = musicId;
            this.state.youtubePlayerState = 'buffering';
            document.querySelectorAll('.sound-btn').forEach(btn => btn.classList.remove('active'));
            this.renderYouTubeMusicList();
            return;
        }
        if (!this.state.youtubePlayer || typeof this.state.youtubePlayer.playVideo !== 'function') return;
        const sameTrack = this.state.currentMusicId === musicId;
        if (sameTrack) {
            const playerState = typeof this.state.youtubePlayer.getPlayerState === 'function' ? this.state.youtubePlayer.getPlayerState() : null;
            if (typeof YT !== 'undefined') {
                if (playerState === YT.PlayerState.PLAYING || playerState === YT.PlayerState.BUFFERING) {
                    this.state.youtubePlayer.pauseVideo();
                    this.state.youtubePlayerState = 'paused';
                } else if (playerState === YT.PlayerState.PAUSED) {
                    this.stopBackgroundAudio();
                    this.state.youtubePlayer.playVideo();
                    this.state.youtubePlayerState = 'playing';
                } else {
                    if (typeof this.state.youtubePlayer.loadVideoById === 'function') {
                        this.state.youtubePlayer.loadVideoById(videoId);
                    } else if (typeof this.state.youtubePlayer.cueVideoById === 'function') {
                        this.state.youtubePlayer.cueVideoById(videoId);
                    }
                    this.stopBackgroundAudio();
                    this.state.youtubePlayer.playVideo();
                    this.state.youtubePlayerState = 'playing';
                }
            } else {
                this.state.youtubePlayer.playVideo();
                this.state.youtubePlayerState = 'playing';
            }
        } else {
            this.stopBackgroundAudio();
            this.state.currentMusicId = musicId;
            this.state.youtubePlayerState = 'buffering';
            if (typeof this.state.youtubePlayer.loadVideoById === 'function') {
                this.state.youtubePlayer.loadVideoById(videoId);
            }
            if (typeof this.state.youtubePlayer.playVideo === 'function') {
                this.state.youtubePlayer.playVideo();
            }
        }
        this.state.pendingYouTubeTrack = null;
        document.querySelectorAll('.sound-btn').forEach(btn => btn.classList.remove('active'));
        this.renderYouTubeMusicList();
    },
    stopYouTubeVideo(options = {}){ const { keepSelection = false } = options; if(this.state.youtubePlayer && typeof this.state.youtubePlayer.stopVideo === 'function'){ this.state.youtubePlayer.stopVideo(); } if(!keepSelection){ this.state.currentMusicId = null; } this.state.pendingYouTubeTrack = null; this.state.youtubePlayerState = 'stopped'; this.renderYouTubeMusicList(); },
onPlayerStateChange(event) { if (typeof YT !== 'undefined') { const state = event.data; if (state === YT.PlayerState.PLAYING) { this.state.youtubePlayerState = 'playing'; } else if (state === YT.PlayerState.PAUSED) { this.state.youtubePlayerState = 'paused'; } else if (state === YT.PlayerState.BUFFERING) { this.state.youtubePlayerState = 'buffering'; } else if (state === YT.PlayerState.ENDED) { this.state.youtubePlayerState = 'ended'; } else { this.state.youtubePlayerState = 'stopped'; } if (state === YT.PlayerState.ENDED) { this.playNextYouTubeVideo(); } } else { this.state.youtubePlayerState = 'stopped'; } this.renderYouTubeMusicList(); },
playNextYouTubeVideo() { const musicList = this.state.parameters.youtubeMusic; if (musicList.length === 0) return; const currentIndex = musicList.findIndex(m => m.id === this.state.currentMusicId); let nextIndex = currentIndex + 1; if (nextIndex >= musicList.length) { nextIndex = 0; } if(musicList[nextIndex]) { const nextMusic = musicList[nextIndex]; this.playYouTubeVideo(nextMusic.videoId, nextMusic.id); } },
    extractYouTubeVideoID(url) { if (!url) return null; const trimmed = url.trim(); if (/^[\w-]{11}$/.test(trimmed)) { return trimmed; } const ensureProtocol = (value) => { if (/^https?:\/\//i.test(value)) return value; return `https://${value}`; }; try { const parsed = new URL(ensureProtocol(trimmed)); const host = parsed.hostname.replace('www.', ''); if (host === 'youtu.be') { const candidate = parsed.pathname.split('/').filter(Boolean)[0]; return candidate && /^[\w-]{11}$/.test(candidate) ? candidate : null; } if (host.endsWith('youtube.com')) { const paramsId = parsed.searchParams.get('v'); if (paramsId && /^[\w-]{11}$/.test(paramsId)) { return paramsId; } const pathSegments = parsed.pathname.split('/').filter(Boolean); for (const segment of pathSegments) { if (/^[\w-]{11}$/.test(segment)) { return segment; } if (segment.toLowerCase() === 'shorts' || segment.toLowerCase() === 'live' || segment.toLowerCase() === 'embed' || segment.toLowerCase() === 'v') { continue; } } } } catch (e) { const fallback = trimmed.match(/([\w-]{11})/); return fallback ? fallback[1] : null; } const fallback = trimmed.match(/([\w-]{11})/); return fallback ? fallback[1] : null; },
renderSessionHistory() { const listContainer = document.getElementById('session-history-list'); if (!listContainer) return; listContainer.innerHTML = '';
const sortedData = [...this.state.studyData].sort((a, b) => b.id - a.id);
if (sortedData.length === 0) { listContainer.innerHTML = '<p class="text-sm text-[var(--text-muted)]">Nenhuma sessão registrada ainda.</p>'; return; }
sortedData.slice(0, 10).forEach(session => { const el = document.createElement('div'); el.className = 'flex items-center justify-between bg-[var(--bg)] p-3 rounded-md text-sm transition-all hover:bg-[var(--border-color)]'; const sessionDate = new Date(session.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); const sessionTime = this.formatTime(session.duration); const subtopicText = session.subtopic ? ` <span class="text-[var(--text-muted)] text-xs">(${session.subtopic})</span>` : ''; el.innerHTML = ` <div> <span class="font-semibold">${session.subject}</span>${subtopicText} <span class="text-[var(--text-muted)] ml-2">${sessionDate} - ${sessionTime}</span> </div> <div class="flex gap-2"> <button class="edit-btn btn btn-secondary text-xs py-1 px-2">Editar</button> <button class="delete-btn btn btn-danger text-xs py-1 px-2">Excluir</button> </div> `;
el.querySelector('.delete-btn').addEventListener('click', () => { if (confirm('Tem certeza que deseja excluir esta sessão?')) { this.state.studyData = this.state.studyData.filter(s => s.id !== session.id); this.saveData(true, 'Sessão excluída.'); this.renderSessionHistory(); this.updateDashboard(); } });
el.querySelector('.edit-btn').addEventListener('click', () => { this.state.editingId = session.id; const form = document.getElementById('study-form'); form.date.value = session.date; form.subject.value = session.subject; this.populateSubtopicDropdown('subject', 'subtopic'); form.subtopic.value = session.subtopic || '';
form['manual-duration-hours'].value = Math.floor(session.duration / 3600); form['manual-duration-minutes'].value = Math.round((session.duration % 3600) / 60); form['activity-type'].value = session.activity; form['session-type'].value = session.sessionType; form['time-of-day'].value = session.timeOfDay || 'manha'; this.toggleQuestionsSection(); this.toggleFlowSection(); form['questions-total'].value = session.totalQuestions || ''; form['questions-correct'].value = session.correctQuestions || ''; form['flow-score'].value = session.flowScore || 3; document.querySelectorAll('#mood-tracker .mood-square').forEach(b => b.classList.remove('selected')); if (session.mood) { const moodBtn = document.querySelector(`#mood-tracker .mood-square[data-mood="${session.mood}"]`); if (moodBtn) moodBtn.classList.add('selected'); } document.getElementById('mood-input').value = session.mood || '';
form.querySelector('button[type="submit"]').textContent = 'Atualizar Sessão'; document.getElementById('cancel-edit-btn').classList.remove('hidden'); document.getElementById('registration-card').scrollIntoView({ behavior: 'smooth', block: 'center' }); });
listContainer.appendChild(el); }); },
updateDashboard(){ if(this.state.currentView !== 'dashboard' || !this.state.dataLoaded) return; const data = this.getFilteredData(); const allData = this.state.studyData; const sd = document.getElementById('filter-start-date').value; const ed = document.getElementById('filter-end-date').value; const pd = document.getElementById('dashboard-period-display'); if(sd && ed){ const start = new Date(sd).toLocaleDateString('pt-BR',{timeZone:'UTC'}); const end = new Date(ed).toLocaleDateString('pt-BR',{timeZone:'UTC'}); pd.textContent = `Exibindo dados de ${start} a ${end}.`; } else { pd.textContent = `Exibindo todos os dados.`; }
const metrics = this.precomputeMetrics(data, allData); document.getElementById('total-hours').textContent = this.formatTime(metrics.totalSec); document.getElementById('avg-accuracy').textContent = `${(metrics.accAvg*100).toFixed(0)}%`; document.getElementById('avg-session-duration').textContent = this.formatTime(metrics.avgSessSec); document.getElementById('deep-work-ratio').textContent = `${metrics.deepRatio.toFixed(0)}%`;
this.updatePersonalBests(allData); this.updateWeeklyGoals(allData); this.updateStreaksAndHeatmap(allData); this.updateCharts(data, allData); this.updateStrengthsWeaknessesDetails(allData); this.generateInsights(data, allData); this.renderDetailedLog(data); this.renderBackupList(); }, precomputeMetrics(data, allData) { const totalSec = data.reduce((s,i)=>s+i.duration,0); const sessionsWithAcc = data.filter(i => typeof i.accuracy === 'number'); const totalAccuracySum = sessionsWithAcc.reduce((sum, item) => sum + item.accuracy, 0); const accAvg = sessionsWithAcc.length > 0 ? totalAccuracySum / sessionsWithAcc.length : 0;
const avgSessSec = data.length? totalSec/data.length : 0; const deepSec = data.filter(s=> s.sessionType==='focada').reduce((x,y)=>x+y.duration,0); const deepRatio = totalSec? (deepSec/totalSec)*100:0; return { totalSec, accAvg, avgSessSec, deepRatio }; },
updatePersonalBests(allData) { const records = { hoursDay: { value: 0, date: '-' }, accuracy: { value: 0, date: '-' }, hoursMonth: { value: 0, date: '-' } };
if (allData.length > 0) { const hoursByDay = allData.reduce((acc, s) => { acc[s.date] = (acc[s.date] || 0) + s.duration; return acc; }, {}); for (const date in hoursByDay) { if (hoursByDay[date] > records.hoursDay.value) { records.hoursDay.value = hoursByDay[date]; records.hoursDay.date = new Date(date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); } } allData.forEach(s => { if (s.accuracy !== null && s.accuracy > records.accuracy.value) { records.accuracy.value = s.accuracy; records.accuracy.date = new Date(s.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); } }); const hoursByMonth = allData.reduce((acc, s) => { const month = s.date.substring(0, 7); acc[month] = (acc[month] || 0) + s.duration; return acc; }, {}); for (const month in hoursByMonth) { if (hoursByMonth[month] > records.hoursMonth.value) { records.hoursMonth.value = hoursByMonth[month]; records.hoursMonth.date = month; } } }
document.getElementById('record-hours-day').innerHTML = `${this.formatTime(records.hoursDay.value)} <div class="record-date">${records.hoursDay.date}</div>`; document.getElementById('record-accuracy').innerHTML = `${(records.accuracy.value * 100).toFixed(0)}% <div class="record-date">${records.accuracy.date}</div>`; document.getElementById('record-hours-month').innerHTML = `${this.formatTime(records.hoursMonth.value)} <div class="record-date">${records.hoursMonth.date}</div>`; }, getWeekDateRange(date = new Date()) { const d = new Date(date); const startDay = this.state.parameters.weekStartDay; const currentDay = d.getDay(); const diff = d.getDate() - currentDay + (currentDay === 0 && startDay === 1 ? -6 : startDay); const startDate = new Date(d.setDate(diff)); startDate.setHours(0, 0, 0, 0);
const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999);
return { startDate, endDate }; }, updateWeeklyGoals(allData){ const g = this.state.parameters.weeklyGoals; const displayContainer = document.getElementById('goals-display-view'); const daysTrackerContainer = document.getElementById('weekly-days-tracker'); const { startDate, endDate } = this.getWeekDateRange(); const fmt = d => d.toISOString().split('T')[0]; const todayStr = new Date().toISOString().split('T')[0];
document.getElementById('weekly-goals-title').textContent = `Metas da Semana (${startDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})} - ${endDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})})`;
const weekData = allData.filter(s => s.date >= fmt(startDate) && s.date <= fmt(endDate)); const studiedDays = new Set(weekData.map(s => s.date));
daysTrackerContainer.innerHTML = ''; const dayLabels = this.state.parameters.weekStartDay === 1 ? ['S', 'T', 'Q', 'Q', 'S', 'S', 'D'] : ['D', 'S', 'T', 'Q', 'Q', 'S', 'S']; for (let i = 0; i < 7; i++) { const day = new Date(startDate); day.setDate(startDate.getDate() + i); const dayStr = fmt(day); const dot = document.createElement('div'); dot.textContent = dayLabels[i]; dot.className = 'day-tracker-dot';
if (studiedDays.has(dayStr)) { dot.classList.add('done'); } else if (dayStr < todayStr) { dot.classList.add('missed'); } if (dayStr === todayStr) { dot.classList.add('today'); } daysTrackerContainer.appendChild(dot); } displayContainer.innerHTML = '';
const goals = [ { id: 'hours', label: 'Horas de estudo', unit: 'h' }, { id: 'questions', label: 'Questões', unit: '' }, { id: 'accuracy', label: '% de acerto', unit: '%' }, { id: 'days', label: 'Dias/semana', unit: ' dias' } ];
const currentValues = { hours: weekData.reduce((a, b) => a + b.duration, 0) / 3600, questions: weekData.reduce((a, b) => a + (b.totalQuestions || 0), 0), accuracy: (() => { const sessionsWithAcc = weekData.filter(s => typeof s.accuracy === 'number'); return sessionsWithAcc.length > 0 ? (sessionsWithAcc.reduce((sum, s) => sum + s.accuracy, 0) / sessionsWithAcc.length * 100) : 0; })(), days: studiedDays.size };
goals.forEach(goalInfo => { const target = g[goalInfo.id]; const current = currentValues[goalInfo.id]; const progress = target > 0 ? Math.min(100, (current / target) * 100) : 0; const el = document.createElement('div'); el.innerHTML = ` <div class="flex justify-between text-sm font-medium text-[var(--text-muted)]"> <span>${goalInfo.label}</span> <span>${current.toFixed(goalInfo.id === 'hours' ? 1 : 0)}${goalInfo.unit} / ${target}${goalInfo.unit} (${progress.toFixed(0)}%)</span> </div> <div class="progress-bar mt-1"> <div class="progress-fill" style="width:${progress}%"></div> </div> `; displayContainer.appendChild(el); }); const buttonContainer = document.createElement('div'); buttonContainer.className = 'pt-2'; buttonContainer.innerHTML = `<button id="edit-goals-btn" class="btn btn-secondary py-2 px-3 w-full">Editar Metas</button>`; displayContainer.appendChild(buttonContainer);
document.getElementById('edit-goals-btn').onclick = ()=>{ document.getElementById('goal-hours-input').value = g.hours; document.getElementById('goal-questions-input').value = g.questions; document.getElementById('goal-accuracy-input').value = g.accuracy; document.getElementById('goal-days-input').value = g.days; document.getElementById('goals-display-view').classList.add('hidden'); document.getElementById('weekly-days-tracker').classList.add('hidden'); document.getElementById('goals-edit-view').classList.remove('hidden'); }; document.getElementById('save-goals-btn').onclick = ()=>{ g.hours = parseInt(document.getElementById('goal-hours-input').value, 10) || 0; g.questions = parseInt(document.getElementById('goal-questions-input').value, 10) || 0; g.accuracy = parseInt(document.getElementById('goal-accuracy-input').value, 10) || 0; g.days = parseInt(document.getElementById('goal-days-input').value, 10) || 0; this.saveData(true, 'Metas atualizadas!'); document.getElementById('goals-edit-view').classList.add('hidden'); document.getElementById('goals-display-view').classList.remove('hidden'); document.getElementById('weekly-days-tracker').classList.remove('hidden'); this.updateWeeklyGoals(allData); }; }, calculateStreak(allData) { if (allData.length === 0) return { current: 0, longest: 0 }; const allDates = [...new Set(allData.map(s => s.date))].sort(); let longestStreak = 0; let currentStreak = 0;
if (allDates.length > 0) { longestStreak = 1; currentStreak = 1; const today = new Date(); const yesterday = new Date(); yesterday.setDate(today.getDate() - 1); const todayStr = today.toISOString().split('T')[0]; const yesterdayStr = yesterday.toISOString().split('T')[0]; const lastDate = allDates[allDates.length - 1]; if (lastDate !== todayStr && lastDate !== yesterdayStr) { currentStreak = 0; }
for (let i = allDates.length - 1; i > 0; i--) { const currDate = new Date(allDates[i]); const prevDate = new Date(allDates[i-1]); const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24)); if (diffDays === 1) { if(lastDate === todayStr || lastDate === yesterdayStr) currentStreak++; } else { break; } } } let overallLongest = 0; if (allDates.length > 0) { overallLongest = 1; let tempStreak = 1; for (let i = 1; i < allDates.length; i++) { const prevDate = new Date(allDates[i-1]); const currDate = new Date(allDates[i]); const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24)); if (diffDays === 1) { tempStreak++; } else { overallLongest = Math.max(overallLongest, tempStreak); tempStreak = 1; } } overallLongest = Math.max(overallLongest, tempStreak); }
return { current: currentStreak, longest: overallLongest }; }, updateStreaksAndHeatmap(allData){ const { longest } = this.calculateStreak(allData); document.getElementById('record-streak').innerHTML = `${longest} dias`;
const container = document.getElementById('consistency-tracker'); container.innerHTML = '';
const today = new Date(); const startDate = new Date(); startDate.setDate(today.getDate() - 364);
const studyByDate = allData.reduce((acc, session) => { const date = session.date; acc[date] = (acc[date] || 0) + session.duration; return acc; }, {});
const allSeconds = Object.values(studyByDate).filter(s => s > 0); const maxSeconds = allSeconds.length > 0 ? Math.max(...allSeconds) : 1;
const getColorLevel = (seconds) => { if (!seconds || seconds === 0) return 0; const ratio = seconds / maxSeconds; if (ratio > 0.75) return 4; if (ratio > 0.50) return 3; if (ratio > 0.25) return 2; return 1; };
const heatmapGrid = document.createElement('div'); heatmapGrid.className = 'grid grid-flow-col grid-rows-7 gap-1'; const tempDate = new Date(startDate); const dayOfWeekOffset = tempDate.getUTCDay(); for (let i = 0; i < dayOfWeekOffset; i++) { const pad = document.createElement('div'); pad.className = 'w-3 h-3'; heatmapGrid.appendChild(pad); }
for (let i = 0; i < 365; i++) { const dateString = tempDate.toISOString().split('T')[0]; const seconds = studyByDate[dateString] || 0; const colorLevel = getColorLevel(seconds);
const cell = document.createElement('div'); cell.className = `w-3 h-3 rounded-sm heatmap-level-${colorLevel}`; cell.title = `${tempDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' })}: ${this.formatTime(seconds)}`; heatmapGrid.appendChild(cell);
tempDate.setDate(tempDate.getDate() + 1); } container.appendChild(heatmapGrid);
const legend = document.createElement('div'); legend.className = 'flex items-center justify-end gap-2 text-xs text-[var(--text-muted)] mt-2 w-full pr-4'; legend.innerHTML = ` <span>Menos</span> <div class="w-3 h-3 rounded-sm heatmap-level-0 border border-gray-400"></div> <div class="w-3 h-3 rounded-sm heatmap-level-1"></div> <div class="w-3 h-3 rounded-sm heatmap-level-2"></div> <div class="w-3 h-3 rounded-sm heatmap-level-3"></div> <div class="w-3 h-3 rounded-sm heatmap-level-4"></div> <span>Mais</span> `; container.appendChild(legend); },
initCharts(){ const isDark = this.state.parameters.darkMode; const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; const textColor = isDark ? '#e0e0e0' : '#6B7280'; Chart.defaults.color = textColor; const base = { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{font:{family:'Inter'}, color: textColor}}}, scales:{y:{beginAtZero:true,ticks:{font:{family:'Inter'}, color: textColor}, grid: {color: gridColor}},x:{ticks:{font:{family:'Inter'}, color: textColor}, grid: {color: gridColor}}} }; this.state.charts.hoursBySubject = new Chart(document.getElementById('hoursBySubjectChart'), { type:'pie', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.performanceBySubject = new Chart(document.getElementById('performanceBySubjectChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.studyEvolution = new Chart(document.getElementById('studyEvolutionChart'), { type:'line', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}, elements:{line:{tension:.1}}} }); this.state.charts.productivityByDay = new Chart(document.getElementById('productivityByDayChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.moodVsPerformance = new Chart(document.getElementById('moodVsPerformanceChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}, scales:{...base.scales, y:{...base.scales.y, max:1, ticks:{...base.scales.y.ticks, callback: v => `${(v*100)}%`}}}} }); this.state.charts.monthlyStudyEvolution = new Chart(document.getElementById('monthlyStudyEvolutionChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.performanceByTimeOfDay = new Chart(document.getElementById('performanceByTimeOfDayChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{display:false}}} }); this.state.charts.strengthsWeaknesses = new Chart(document.getElementById('strengthsWeaknessesChart'), { type:'radar', data:{labels:[],datasets:[]}, options: {...base, scales: { r: { beginAtZero: true, max: 100, ticks: { backdropColor: 'transparent', color: textColor }, pointLabels: { color: textColor }, grid: {color: gridColor}, angleLines: {color: gridColor} } }} }); this.state.charts.questionsEvolution = new Chart(document.getElementById('questionsEvolutionChart'), { type:'line', data:{labels:[],datasets:[]}, options: {...base, elements:{line:{tension:.2, fill: 'start'}}} }); this.state.charts.activityDistribution = new Chart(document.getElementById('activityDistributionChart'), { type:'doughnut', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.flowVsPerformance = new Chart(document.getElementById('flowVsPerformanceChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins: {...base.plugins, legend:{display:false}}, scales:{...base.scales, x:{...base.scales.x, title:{display:true, text:'Nível de Flow', color: textColor}}, y:{...base.scales.y, max: 1, ticks:{...base.scales.y.ticks, callback: v => `${(v*100)}%`}, title: {display: true, text: 'Desempenho Médio', color: textColor}}}}});
this.state.charts.moodCount = new Chart(document.getElementById('moodCountChart'), { type:'pie', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.flowCount = new Chart(document.getElementById('flowCountChart'), { type:'pie', data:{labels:[],datasets:[]}, options:{...base, plugins:{...base.plugins, legend:{position:'right'}}} }); this.state.charts.focusPercentage = new Chart(document.getElementById('focusPercentageChart'), { type:'doughnut', data:{labels:[],datasets:[]}, options:{...base, cutout: '70%', plugins:{...base.plugins, legend:{position:'bottom'}}} }); this.state.charts.performanceByActivity = new Chart(document.getElementById('performanceByActivityChart'), { type:'bar', data:{labels:[],datasets:[]}, options:{...base, plugins: {...base.plugins, legend:{display:false}}, scales:{...base.scales, y:{...base.scales.y, max: 1, ticks:{...base.scales.y.ticks, callback: v => `${(v*100)}%`}}}}}); document.getElementById('questions-evolution-toggle').addEventListener('change', e => { this.state.questionsEvolutionView = e.target.value; this.updateQuestionsEvolutionChart(this.state.studyData); }); }, updateCharts(data, allData){ this.updateHoursBySubjectChart(data); this.updatePerformanceBySubjectChart(data); this.updateStudyEvolutionChart(data); this.updateProductivityByDayChart(data); this.updateMoodVsPerformanceChart(data); this.updateMonthlyStudyEvolutionChart(data); this.updatePerformanceByTimeOfDayChart(data); this.updateWeeklyEvolutionTable(allData); this.updateStrengthsWeaknessesChart(allData); this.updateQuestionsEvolutionChart(allData); this.updateActivityDistributionChart(data); this.updateFlowVsPerformanceChart(data); this.updateMoodCountChart(data); this.updateFlowCountChart(data); this.updateFocusPercentageChart(data); this.updatePerformanceByActivityChart(data); }, updateHoursBySubjectChart(data){ const filterSubject = document.getElementById('filter-subject').value; const ch = this.state.charts.hoursBySubject; let map, labels, values, bgColors;
if (filterSubject && filterSubject !== 'all') { document.getElementById('hours-by-subject-title').textContent = `Distribuição de horas por assunto (${filterSubject})`; map = data.filter(i => i.subject === filterSubject) .reduce((acc, i) => { const key = i.subtopic || 'Geral'; acc[key] = (acc[key] || 0) + i.duration; return acc; }, {}); labels = Object.keys(map); bgColors = labels.map((_, index) => this.state.COLOR_PALETTE[index % this.state.COLOR_PALETTE.length]); } else { document.getElementById('hours-by-subject-title').textContent = 'Distribuição de horas por disciplina'; map = data.reduce((acc,i)=>{ acc[i.subject]=(acc[i.subject]||0)+i.duration; return acc; },{}); labels = Object.keys(map); bgColors = labels.map(label => this.state.parameters.subjectColors[label] || '#cccccc'); } values = Object.values(map); const totalDuration = values.reduce((sum, val) => sum + val, 0);
ch.data.labels = labels.map(l => { const percentage = totalDuration > 0 ? ((map[l] / totalDuration) * 100).toFixed(0) : 0; return `${l} (${percentage}%)`; }); ch.data.datasets = [{ label:'Horas de estudo', data:values, borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth:2, backgroundColor: bgColors }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.chart.data.labels[context.dataIndex].split(' (')[0]; const value = context.chart.data.datasets[0].data[context.dataIndex]; const percentage = totalDuration > 0 ? ((value / totalDuration) * 100).toFixed(1) : 0; return `${label}: ${this.formatTime(value)} (${percentage}%)`; }; ch.update(); }, updatePerformanceBySubjectChart(data){ const filterSubject = document.getElementById('filter-subject').value; const ch = this.state.charts.performanceBySubject; let perf = {}; let labels, values, bgColors;
if (filterSubject && filterSubject !== 'all') { document.getElementById('performance-by-subject-title').textContent = `Desempenho por assunto (${filterSubject})`; data.filter(d => d.subject === filterSubject && typeof d.accuracy === 'number').forEach(i => { const key = i.subtopic || 'Geral'; if (!perf[key]) perf[key] = { sum: 0, cnt: 0 }; perf[key].sum += i.accuracy; perf[key].cnt += 1; }); labels = Object.keys(perf); bgColors = labels.map((_, index) => this.state.COLOR_PALETTE[index % this.state.COLOR_PALETTE.length]); } else { document.getElementById('performance-by-subject-title').textContent = 'Desempenho médio por disciplina'; data.filter(d => typeof d.accuracy === "number").forEach(i=>{ if(!perf[i.subject]) perf[i.subject]={sum:0,cnt:0}; perf[i.subject].sum += i.accuracy; perf[i.subject].cnt += 1; }); labels = Object.keys(perf); bgColors = labels.map(label => this.state.parameters.subjectColors[label] || '#cccccc'); } values = labels.map(s=> perf[s] && perf[s].cnt > 0 ? perf[s].sum / perf[s].cnt : 0); ch.data.labels = labels; ch.data.datasets = [{label:'% de acertos', data:values, backgroundColor: bgColors}]; ch.options.scales.y.max = 1; ch.options.scales.y.ticks.callback = v=> `${(v*100).toFixed(0)}%`; ch.update(); },
updateStrengthsWeaknessesChart(allData) {
    const ch = this.state.charts.strengthsWeaknesses;
    const labels = this.state.parameters.subjects.map(s => s.name);

    const accuracyData = labels.map(subject => {
        const subjectSessions = allData.filter(s => s.subject === subject && typeof s.accuracy === 'number');
        if (subjectSessions.length === 0) return 0;
        const avgAccuracy = subjectSessions.reduce((sum, s) => sum + s.accuracy, 0) / subjectSessions.length;
        return avgAccuracy * 100;
    });

    ch.data.labels = labels;
    ch.data.datasets = [
        {
            label: 'Desempenho (%)',
            data: accuracyData,
            backgroundColor: 'rgba(129, 178, 154, 0.2)',
            borderColor: 'rgba(129, 178, 154, 1)',
            pointBackgroundColor: 'rgba(129, 178, 154, 1)',
        }
    ];
    ch.options.plugins.legend.display = false;
    ch.update();
},
updateStrengthsWeaknessesDetails(allData) { const container = document.getElementById('strengths-weaknesses-details'); container.innerHTML = '';
this.state.parameters.subjects.forEach(subject => { const subjectData = allData.filter(s => s.subject === subject.name && (s.activity === 'Exercícios' || s.activity === 'Simulado')); const totalQuestions = subjectData.reduce((sum, s) => sum + (s.totalQuestions || 0), 0); if (totalQuestions === 0) return;
const correctQuestions = subjectData.reduce((sum, s) => sum + (s.correctQuestions || 0), 0); const incorrectQuestions = totalQuestions - correctQuestions; const performance = totalQuestions > 0 ? (correctQuestions / totalQuestions) * 100 : 0;
const correctPercent = totalQuestions > 0 ? (correctQuestions / totalQuestions) * 100 : 0; const incorrectPercent = totalQuestions > 0 ? (incorrectQuestions / totalQuestions) * 100 : 0;
const el = document.createElement('div'); el.innerHTML = ` <div class="flex justify-between items-center text-sm mb-1"> <span class="font-semibold">${subject.name}</span> <span class="text-xs text-[var(--text-muted)]">${totalQuestions} questões</span> </div> <div class="performance-bar"> <div class="bar-correct" style="width: ${correctPercent}%"></div> <div class="bar-incorrect" style="width: ${incorrectPercent}%"></div> </div> <div class="flex justify-between items-center text-xs text-[var(--text-muted)] mt-1"> <span>Desempenho: <span class="font-bold text-green-600">${performance.toFixed(0)}%</span></span> <span>${correctQuestions} acertos / ${incorrectQuestions} erros</span> </div> `; container.appendChild(el); });
if (container.innerHTML === '') { container.innerHTML = `<p class="text-sm text-[var(--text-muted)] text-center">Sem dados de exercícios ou simulados para exibir.</p>`; } }, updateStudyEvolutionChart(data){ const map = data.reduce((acc,i)=>{ acc[i.date]=(acc[i.date]||0)+i.duration; return acc; },{}); const dates = Object.keys(map).sort((a,b)=> new Date(a)-new Date(b)); const ch = this.state.charts.studyEvolution; ch.data.labels = dates.map(d=> new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit', timeZone:'UTC'})); ch.data.datasets = [{ label:'Horas estudadas', data: dates.map(d=> map[d]), borderColor:'#81B29A', backgroundColor:'rgba(129,178,154,.12)', fill:true, pointBackgroundColor:'#81B29A', pointRadius:4, pointHoverRadius:6 }]; ch.options.scales.y.ticks.callback = (value) => this.formatTime(value); ch.options.plugins.tooltip.callbacks.label = (context) => `Tempo: ${this.formatTime(context.raw)}`; ch.update(); const totalSec = data.reduce((s,i)=>s+i.duration,0); const uniqueDays = new Set(data.map(i=> i.date)).size; const avg = uniqueDays? totalSec/uniqueDays : 0; document.getElementById('average-time-display').textContent = this.formatTime(avg); }, updateQuestionsEvolutionChart(allData) { const ch = this.state.charts.questionsEvolution; const view = this.state.questionsEvolutionView;
const dataByMonth = allData.reduce((acc, s) => { if (s.totalQuestions > 0) { const month = s.date.substring(0, 7); if (!acc[month]) { acc[month] = { total: 0, correct: 0 }; } acc[month].total += s.totalQuestions || 0; acc[month].correct += s.correctQuestions || 0; } return acc; }, {});
const labels = Object.keys(dataByMonth).sort(); if (view === 'absolute') { const correctData = labels.map(m => dataByMonth[m].correct); const incorrectData = labels.map(m => dataByMonth[m].total - dataByMonth[m].correct); ch.data.datasets = [ { label: 'Acertos', data: correctData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)' }, { label: 'Erros', data: incorrectData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)' } ]; ch.options.scales.y.ticks.callback = value => value; ch.options.plugins.tooltip.callbacks.label = context => `${context.dataset.label}: ${context.raw}`;
} else { const performanceData = labels.map(m => { const month = dataByMonth[m]; return month.total > 0 ? (month.correct / month.total) * 100 : 0; }); const totalData = labels.map(m => dataByMonth[m].total); ch.data.datasets = [ { label: 'Desempenho (%)', data: performanceData, borderColor: '#81B29A', backgroundColor: 'rgba(129, 178, 154, 0.2)' }, { label: 'Total de Questões', data: totalData, borderColor: '#F2CC8F', backgroundColor: 'rgba(242, 204, 143, 0.2)', yAxisID: 'y1' } ]; ch.options.scales.y.ticks.callback = value => `${value.toFixed(0)}%`; ch.options.plugins.tooltip.callbacks.label = context => { if(context.dataset.label === 'Desempenho (%)') return `${context.dataset.label}: ${context.raw.toFixed(1)}%`; return `${context.dataset.label}: ${context.raw}`; }; } ch.data.labels = labels; ch.update(); }, updateProductivityByDayChart(data){ const arr = [0,0,0,0,0,0,0]; data.forEach(i=>{ const d=new Date(i.date).getUTCDay(); arr[d]+= i.duration; }); const ch = this.state.charts.productivityByDay; ch.data.labels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb']; ch.data.datasets = [{ label:'Horas', data:arr, backgroundColor:'#F2CC8F'}]; ch.options.scales.y.ticks.callback = (value) => this.formatTime(value); ch.options.plugins.tooltip.callbacks.label = (context) => `Tempo: ${this.formatTime(context.raw)}`; ch.update(); }, updateMoodVsPerformanceChart(data){ const perf = { ruim: { sum: 0, cnt: 0 }, medio: { sum: 0, cnt: 0 }, bom: { sum: 0, cnt: 0 }}; data.filter(s => s.mood && typeof s.accuracy === 'number').forEach(s => { perf[s.mood].sum += s.accuracy; perf[s.mood].cnt++; }); const labels = ['Ruim', 'Médio', 'Bom']; const values = [ perf.ruim.cnt > 0 ? perf.ruim.sum / perf.ruim.cnt : 0, perf.medio.cnt > 0 ? perf.medio.sum / perf.medio.cnt : 0, perf.bom.cnt > 0 ? perf.bom.sum / perf.bom.cnt : 0, ]; const ch = this.state.charts.moodVsPerformance; ch.data.labels = labels; ch.data.datasets = [{ label: '% de Acertos', data: values, backgroundColor: ['#E07A5F', '#F2CC8F', '#81B29A'] }]; ch.update(); }, updateMonthlyStudyEvolutionChart(data) { const map = data.reduce((acc, i) => { const month = i.date.substring(0, 7); acc[month] = (acc[month] || 0) + i.duration; return acc; }, {}); const labels = Object.keys(map).sort(); const values = labels.map(m => map[m]); const ch = this.state.charts.monthlyStudyEvolution; ch.data.labels = labels; ch.data.datasets = [{ label: 'Horas Estudadas', data: values, backgroundColor: '#3D405B' }]; ch.options.scales.y.ticks.callback = (value) => this.formatTime(value); ch.options.plugins.tooltip.callbacks.label = (context) => `Tempo: ${this.formatTime(context.raw)}`; ch.update(); }, updatePerformanceByTimeOfDayChart(data) { const periods = { 'madrugada': { sum: 0, cnt: 0 }, 'manha': { sum: 0, cnt: 0 }, 'tarde': { sum: 0, cnt: 0 }, 'noite': { sum: 0, cnt: 0 } }; data.filter(d => typeof d.accuracy === 'number' && d.timeOfDay).forEach(s => { periods[s.timeOfDay].sum += s.accuracy; periods[s.timeOfDay].cnt++; }); const labels = ['Madrugada (0-6)', 'Manhã (6-12)', 'Tarde (12-18)', 'Noite (18-24)']; const values = ['madrugada', 'manha', 'tarde', 'noite'].map(p => periods[p].cnt > 0 ? periods[p].sum / periods[p].cnt : 0); const ch = this.state.charts.performanceByTimeOfDay; ch.data.labels = labels; ch.data.datasets = [{ label: '% de Acertos', data: values, backgroundColor: '#F2CC8F' }]; ch.options.scales.y.max = 1; ch.options.scales.y.ticks.callback = v => `${(v * 100).toFixed(0)}%`; ch.update(); }, updateWeeklyEvolutionTable(allData) { const tableContainer = document.getElementById('weekly-evolution-table'); tableContainer.innerHTML = ''; const today = new Date(); let weeksData = [];
for (let i = 0; i < 4; i++) { const currentWeekDate = new Date(); currentWeekDate.setDate(today.getDate() - (i * 7)); const { startDate, endDate } = this.getWeekDateRange(currentWeekDate);
const weekData = allData.filter(s => { const sessionDate = new Date(s.date); return sessionDate >= startDate && sessionDate <= endDate; });
const hours = weekData.reduce((sum, s) => sum + s.duration, 0); const totalQ = weekData.reduce((sum, s) => sum + (s.totalQuestions || 0), 0); const correctQ = weekData.reduce((sum, s) => sum + (s.correctQuestions || 0), 0); const accuracy = totalQ > 0 ? (correctQ / totalQ) * 100 : 0;
weeksData.push({ period: `${startDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})} - ${endDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})}`, hours: this.formatTime(hours), questions: totalQ, accuracy: `${accuracy.toFixed(0)}%` }); } let tableHTML = `<table class="w-full text-sm text-left text-[var(--text-muted)]"> <thead class="text-xs text-[var(--text-primary)] uppercase bg-[var(--bg)]"> <tr> <th scope="col" class="px-6 py-3">Período</th> <th scope="col" class="px-6 py-3">Horas</th> <th scope="col" class="px-6 py-3">Questões</th> <th scope="col" class="px-6 py-3">Acertos</th> </tr> </thead> <tbody>`; weeksData.forEach(w => { tableHTML += `<tr class="border-b border-[var(--border-color)]"> <td class="px-6 py-4 font-medium text-[var(--text-secondary)] whitespace-nowrap">${w.period}</td> <td class="px-6 py-4">${w.hours}</td> <td class="px-6 py-4">${w.questions}</td> <td class="px-6 py-4">${w.accuracy}</td> </tr>`; }); tableHTML += `</tbody></table>`; tableContainer.innerHTML = tableHTML; }, updateActivityDistributionChart(data) { const ch = this.state.charts.activityDistribution; const map = data.reduce((acc, i) => { acc[i.activity] = (acc[i.activity] || 0) + i.duration; return acc; }, {}); const labels = Object.keys(map); const values = Object.values(map); const totalDuration = values.reduce((sum, val) => sum + val, 0); ch.data.labels = labels.map(l => { const percentage = totalDuration > 0 ? ((map[l] / totalDuration) * 100).toFixed(0) : 0; return `${l} (${percentage}%)`; });
ch.data.datasets = [{ label: 'Horas por Atividade', data: values, backgroundColor: ['#555B6E', '#89B0AE', '#BEE3DB', '#FFD6BA'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.chart.data.labels[context.dataIndex].split(' (')[0]; const value = context.chart.data.datasets[0].data[context.dataIndex]; const percentage = totalDuration > 0 ? ((value / totalDuration) * 100).toFixed(1) : 0; return `${label}: ${this.formatTime(value)} (${percentage}%)`; }; ch.update(); },
updateFlowVsPerformanceChart(data) { const ch = this.state.charts.flowVsPerformance; const perfByFlow = {};
data.filter(s => s.flowScore && typeof s.accuracy === 'number').forEach(s => { const score = s.flowScore; if (!perfByFlow[score]) { perfByFlow[score] = { sum: 0, cnt: 0 }; } perfByFlow[score].sum += s.accuracy; perfByFlow[score].cnt++; });
const labels = ['1', '2', '3', '4', '5']; const values = labels.map(score => { const stats = perfByFlow[score]; return (stats && stats.cnt > 0) ? (stats.sum / stats.cnt) : 0; }); ch.data.labels = labels; ch.data.datasets = [{ label: 'Desempenho Médio', data: values, backgroundColor: '#81B29A', borderColor: '#6A947E', borderWidth: 1 }]; ch.update(); },
updateMoodCountChart(data) { const ch = this.state.charts.moodCount; const counts = { bom: 0, medio: 0, ruim: 0, 'N/A': 0 }; data.forEach(s => { if (s.mood) counts[s.mood]++; else counts['N/A']++; }); const totalWithMood = counts.bom + counts.medio + counts.ruim; if (totalWithMood === 0 && counts['N/A'] > 0) { ch.data.labels = ['N/A (100%)']; ch.data.datasets = [{ data: [counts['N/A']], backgroundColor: ['#a9a9a9'] }]; } else { const labelsWithPercentages = { 'Bom': `Bom (${totalWithMood > 0 ? (counts.bom / totalWithMood * 100).toFixed(0) : 0}%)`, 'Médio': `Médio (${totalWithMood > 0 ? (counts.medio / totalWithMood * 100).toFixed(0) : 0}%)`, 'Ruim': `Ruim (${totalWithMood > 0 ? (counts.ruim / totalWithMood * 100).toFixed(0) : 0}%)`, }; ch.data.labels = [labelsWithPercentages.Bom, labelsWithPercentages.Médio, labelsWithPercentages.Ruim]; ch.data.datasets = [{ data: [counts.bom, counts.medio, counts.ruim], backgroundColor: ['#81B29A', '#F2CC8F', '#E07A5F'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; } ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.label.split(' (')[0]; const value = context.raw; const percentage = totalWithMood > 0 ? (value / totalWithMood * 100).toFixed(1) : 0; return `${label}: ${value} sessões (${percentage}%)`; }; ch.update(); },
updateFlowCountChart(data) { const ch = this.state.charts.flowCount; const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0}; const sessionsWithFlow = data.filter(s => s.sessionType === 'focada' && s.flowScore); const total = sessionsWithFlow.length;
sessionsWithFlow.forEach(s => { if (s.flowScore) counts[s.flowScore]++; });
const labelsWithPercentages = [1,2,3,4,5].map(level => { const count = counts[level]; const percentage = total > 0 ? (count / total * 100).toFixed(0) : 0; return `Flow ${level} (${percentage}%)`; });
ch.data.labels = labelsWithPercentages; ch.data.datasets = [{ data: [counts[1], counts[2], counts[3], counts[4], counts[5]], backgroundColor: ['#E07A5F', '#F2CC8F', '#BEE3DB', '#81B29A', '#3D405B'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.label.split(' (')[0]; const value = context.raw; const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0; return `${label}: ${value} sessões (${percentage}%)`; }; ch.update(); }, updateFocusPercentageChart(data) { const ch = this.state.charts.focusPercentage; const totalDuration = data.reduce((sum, s) => sum + (s.duration || 0), 0); const totalPause = data.reduce((sum, s) => sum + (s.pauseDuration || 0), 0);
const focusTime = totalDuration - totalPause;
if (totalDuration > 0) { const focusPercentage = ((focusTime / totalDuration) * 100).toFixed(0); const pausePercentage = ((totalPause / totalDuration) * 100).toFixed(0);
ch.data.labels = [`Foco (${focusPercentage}%)`, `Pausa (${pausePercentage}%)`]; ch.data.datasets = [{ data: [focusTime, totalPause], backgroundColor: ['#81B29A', '#E07A5F'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; ch.options.plugins.tooltip.callbacks.label = (context) => { const label = context.label.split(' (')[0]; const value = context.raw; return `${label}: ${this.formatTime(value)}`; }; } else { ch.data.labels = ['Sem dados']; ch.data.datasets = [{ data: [1], backgroundColor: ['#9ca3af'], borderColor: this.state.parameters.darkMode ? '#1e1e1e' : '#fff', borderWidth: 2 }]; } ch.update(); },

updatePerformanceByActivityChart(data) {
    const ch = this.state.charts.performanceByActivity;
    const perf = {};
    const activitiesWithQuestions = data.filter(s => typeof s.accuracy === 'number');
    activitiesWithQuestions.forEach(s => {
        if (!perf[s.activity]) perf[s.activity] = { sum: 0, count: 0 };
        perf[s.activity].sum += s.accuracy;
        perf[s.activity].count++;
    });
    const labels = Object.keys(perf);
    const values = labels.map(activity => perf[activity].sum / perf[activity].count);
    ch.data.labels = labels;
    ch.data.datasets = [{
        label: 'Desempenho Médio',
        data: values,
        backgroundColor: '#89B0AE',
    }];
    ch.update();
},

generateInsights(data, allData) { const container = document.getElementById('insights-container'); container.innerHTML = ''; let insights = []; if(data.length > 0) { const hoursBySubject = data.reduce((acc, i) => { acc[i.subject] = (acc[i.subject] || 0) + i.duration; return acc; }, {}); if(Object.keys(hoursBySubject).length > 0) { const [topSubject, topHours] = Object.entries(hoursBySubject).sort(([,a],[,b]) => b-a)[0]; insights.push({title: 'Foco Principal', text: `Sua disciplina mais estudada foi <strong>${topSubject}</strong> com ${this.formatTime(topHours)}.`}); }
const hoursByDay = [0,0,0,0,0,0,0]; data.forEach(i=>{ const d=new Date(i.date).getUTCDay(); hoursByDay[d]+= i.duration; }); if(hoursByDay.some(h => h > 0)) { const bestDayIndex = hoursByDay.indexOf(Math.max(...hoursByDay)); const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado']; insights.push({title: 'Pico de Produtividade', text: `Seu dia mais produtivo é <strong>${days[bestDayIndex]}</strong>.`}); } const perfBySubject = {}; data.filter(d => typeof d.accuracy === 'number' && d.totalQuestions >= 10).forEach(i => { if (!perfBySubject[i.subject]) perfBySubject[i.subject] = { sum: 0, cnt: 0 }; perfBySubject[i.subject].sum += i.accuracy; perfBySubject[i.subject].cnt++; }); const subjectsWithPerf = Object.entries(perfBySubject).map(([sub, stats]) => ({ subject: sub, avg: stats.sum / stats.cnt })); if (subjectsWithPerf.length > 1) { const bestPerf = subjectsWithPerf.sort((a,b) => b.avg - a.avg)[0]; const worstPerf = subjectsWithPerf.sort((a,b) => a.avg - b.avg)[0]; if (bestPerf.subject !== worstPerf.subject) { insights.push({title: 'Pontos de Atenção', text: `Seu melhor desempenho é em <strong>${bestPerf.subject}</strong> (${(bestPerf.avg*100).toFixed(0)}%). Considere revisar <strong>${worstPerf.subject}</strong>.`}); } } const perfByTime = { 'madrugada': { sum: 0, cnt: 0 }, 'manha': { sum: 0, cnt: 0 }, 'tarde': { sum: 0, cnt: 0 }, 'noite': { sum: 0, cnt: 0 } }; data.filter(d => typeof d.accuracy === 'number' && d.timeOfDay).forEach(s => { perfByTime[s.timeOfDay].sum += s.accuracy; perfByTime[s.timeOfDay].cnt++; }); const perfByTimeArray = Object.entries(perfByTime).map(([p, s]) => ({period: p, avg: s.cnt > 0 ? s.sum/s.cnt : 0, count: s.cnt})); if(perfByTimeArray.some(p => p.count > 0)) { const bestTime = perfByTimeArray.sort((a,b) => b.avg - a.avg)[0]; if(bestTime.count > 0) insights.push({title: 'Melhor Horário', text: `Você tende a ter um melhor desempenho no período da <strong>${bestTime.period}</strong>.`}); } const timeByActivity = data.reduce((acc, i) => { acc[i.activity] = (acc[i.activity] || 0) + i.duration; return acc; }, {}); if(Object.keys(timeByActivity).length > 0) { const [topActivity] = Object.entries(timeByActivity).sort(([,a],[,b]) => b-a)[0]; insights.push({title: 'Tipo de Estudo', text: `A maior parte do seu tempo é dedicada a <strong>${topActivity}</strong>.`}); } const { startDate } = this.getWeekDateRange(); const lastWeekStartDate = new Date(startDate); lastWeekStartDate.setDate(startDate.getDate() - 7); const currentWeekHours = allData.filter(s => new Date(s.date) >= startDate).reduce((sum, s) => sum + s.duration, 0); const lastWeekHours = allData.filter(s => new Date(s.date) >= lastWeekStartDate && new Date(s.date) < startDate).reduce((sum, s) => sum + s.duration, 0); if(lastWeekHours > 0) { const diff = ((currentWeekHours - lastWeekHours) / lastWeekHours) * 100; const trend = diff > 5 ? `<strong class="text-green-600">aumentando</strong>` : (diff < -5 ? `<strong class="text-red-600">diminuindo</strong>` : '<strong>mantendo</strong>'); insights.push({title: 'Consistência Semanal', text: `Você está ${trend} seu volume de estudos em relação à semana passada.`}); } }
if (insights.length === 0) { container.innerHTML = `<p class="col-span-full text-center text-gray-500">Registre mais sessões para receber insights detalhados.</p>`; } else { insights.sort(() => 0.5 - Math.random()); container.innerHTML = insights.slice(0,3).map(i => `<div class="border-l-4 border-[color:var(--c2)] pl-3 py-1 bg-[var(--c2)]/10 rounded-r-md"> <h4 class="font-semibold text-[var(--text-secondary)]">${i.title}</h4> <p>${i.text}</p> </div>`).join(''); } },
renderDetailedLog(data, searchTerm = '') { const container = document.getElementById('detailed-log-table-container'); container.innerHTML = ` <table class="w-full text-left text-[var(--text-muted)]"> <thead class="text-xs text-[var(--text-primary)] uppercase bg-[var(--bg)] sticky top-0"> <tr> <th class="px-4 py-3">Data</th> <th class="px-4 py-3">Disciplina/Assunto</th> <th class="px-4 py-3">Duração</th> <th class="px-4 py-3">Atividade</th> <th class="px-4 py-3">Questões (C/T)</th> <th class="px-4 py-3">Acertos</th> </tr> </thead> <tbody></tbody> </table> `; const newTableBody = container.querySelector('tbody'); let filteredData = data; if (searchTerm) { const term = searchTerm.toLowerCase(); filteredData = data.filter(s => s.subject.toLowerCase().includes(term) || (s.subtopic && s.subtopic.toLowerCase().includes(term)) ); }
if (filteredData.length === 0) { const row = newTableBody.insertRow(); const cell = row.insertCell(); cell.colSpan = 6; cell.className = 'text-center text-gray-500 py-4'; cell.textContent = 'Nenhuma sessão encontrada.'; return; } const fragment = document.createDocumentFragment(); filteredData.sort((a, b) => b.id - a.id).forEach(s => { const row = document.createElement('tr'); row.className = 'border-b border-[var(--border-color)] hover:bg-[var(--bg)] text-sm'; const subtopicText = s.subtopic ? `<br><span class="text-xs text-[var(--text-muted)]">${s.subtopic}</span>` : ''; row.innerHTML = ` <td class="px-4 py-3">${new Date(s.date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td> <td class="px-4 py-3 font-semibold">${s.subject}${subtopicText}</td> <td class="px-4 py-3">${this.formatTime(s.duration)}</td> <td class="px-4 py-3">${s.activity}</td> <td class="px-4 py-3">${s.totalQuestions > 0 ? `${s.correctQuestions}/${s.totalQuestions}` : '-'}</td> <td class="px-4 py-3">${typeof s.accuracy === 'number' ? `${(s.accuracy*100).toFixed(0)}%` : '-'}</td> `; fragment.appendChild(row); }); newTableBody.appendChild(fragment); },

async exportPDF(){ this.toast('Gerando PDF, por favor aguarde...'); const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit: 'pt', format: 'a4' }); const margin = 40; let y = margin; const tableOptions = { startY: y, theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [61, 64, 91] } };
const addTitle = (t, size=14) => { if (y > doc.internal.pageSize.getHeight() - 80) { doc.addPage(); y = margin; } doc.setFont('helvetica', 'bold'); doc.setFontSize(size); doc.text(t, margin, y); y += (size * 1.5); }; const addSubTitle = (t) => { doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.text(t, margin, y); y += 16; }; addTitle('Relatório de performance de estudos', 18); const sd = document.getElementById('filter-start-date').value; const ed = document.getElementById('filter-end-date').value; const range = (sd && ed) ? `Período: ${new Date(sd).toLocaleDateString('pt-BR',{timeZone:'UTC'})} a ${new Date(ed).toLocaleDateString('pt-BR',{timeZone:'UTC'})}` : 'Período: todos os dados'; addSubTitle(range); const now = new Date(); addSubTitle(`Gerado em: ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR')}`); y += 10; const data = this.getFilteredData(); const totalSec = data.reduce((s, i) => s + i.duration, 0);
addTitle('Novas estatísticas do período'); const reviewTime = data.filter(s => s.activity === 'Revisão').reduce((sum, s) => sum + s.duration, 0); const reviewRate = totalSec > 0 ? (reviewTime / totalSec) * 100 : 0; const questionTimeHours = data.filter(s => ['Exercícios', 'Simulado'].includes(s.activity)).reduce((sum, s) => sum + s.duration, 0) / 3600; const totalQuestions = data.reduce((sum, s) => sum + (s.totalQuestions || 0), 0); const efficiency = questionTimeHours > 0 ? (totalQuestions / questionTimeHours) : 0;
doc.autoTable({ ...tableOptions, startY: y, head: [['Estatística', 'Valor']], body: [ ['Taxa de Revisão', `${reviewRate.toFixed(1)}% do tempo total`], ['Eficiência (Questões)', `${efficiency.toFixed(1)} questões por hora`], ] }); y = doc.lastAutoTable.finalY + 25;
addTitle('Ranking pessoal de disciplinas'); const subjectStats = {}; this.state.parameters.subjects.forEach(s => subjectStats[s.name] = { time: 0, accuracy: [], totalQ: 0 }); data.forEach(s => { subjectStats[s.subject].time += s.duration; if (typeof s.accuracy === 'number') subjectStats[s.subject].accuracy.push(s.accuracy); subjectStats[s.subject].totalQ += s.totalQuestions || 0; });
const maxTime = Math.max(...Object.values(subjectStats).map(s => s.time)); const rankedSubjects = Object.entries(subjectStats) .filter(([,stats]) => stats.time > 0) .map(([name, stats]) => { const avgAccuracy = stats.accuracy.length > 0 ? stats.accuracy.reduce((a, b) => a + b, 0) / stats.accuracy.length : 0; const normalizedTime = maxTime > 0 ? (stats.time / maxTime) : 0; const score = (normalizedTime * 0.4) + (avgAccuracy * 0.6); return { name, score, time: stats.time, accuracy: avgAccuracy, totalQ: stats.totalQ }; }) .sort((a, b) => b.score - a.score);
doc.autoTable({ ...tableOptions, startY: y, head: [['#', 'Disciplina', 'Pontuação', 'Tempo', '% Acertos', 'Questões']], body: rankedSubjects.map((s, i) => [ i + 1, s.name, s.score.toFixed(2), this.formatTime(s.time), `${(s.accuracy * 100).toFixed(0)}%`, s.totalQ ]) }); y = doc.lastAutoTable.finalY + 25;
if (y > doc.internal.pageSize.getHeight() - 150) { doc.addPage(); y = margin; } const moodCounts = data.reduce((acc, s) => { acc[s.mood || 'N/A'] = (acc[s.mood || 'N/A'] || 0) + 1; return acc; }, {}); const flowCounts = data.reduce((acc, s) => { acc[s.flowScore || 'N/A'] = (acc[s.flowScore || 'N/A'] || 0) + 1; return acc; }, {}); addTitle('Sessões por humor'); doc.autoTable({ ...tableOptions, startY: y, head: [['Humor', 'Nº de Sessões']], body: Object.entries(moodCounts) }); y = doc.lastAutoTable.finalY + 25;
addTitle('Sessões por flow'); doc.autoTable({ ...tableOptions, startY: y, head: [['Nível de Flow', 'Nº de Sessões']], body: Object.entries(flowCounts).sort() }); y = doc.lastAutoTable.finalY + 25; doc.addPage(); y = margin; addTitle('Indicadores chave do período'); const sessionsWithAcc = data.filter(i => typeof i.accuracy === 'number'); const accAvg = sessionsWithAcc.length ? (sessionsWithAcc.reduce((s,i)=>s+i.accuracy,0)/sessionsWithAcc.length) : 0; const avgSessSec = data.length ? totalSec/data.length : 0; doc.autoTable({ ...tableOptions, startY: y, head: [['Indicador', 'Valor']], body: [ ['Total de horas', this.formatTime(totalSec)], ['Média de acertos', `${(accAvg*100).toFixed(0)}%`], ['Sessão média', this.formatTime(avgSessSec)], ['Total de questões', data.reduce((s, i) => s + (i.totalQuestions || 0), 0).toString()], ] }); y = doc.lastAutoTable.finalY + 25;
addTitle('Desempenho por disciplina'); const perSubject = {}; this.state.parameters.subjects.forEach(s => perSubject[s.name] = { sec: 0, qTotal: 0, qCorrect: 0, sessions: 0 }); data.forEach(d => { if (!perSubject[d.subject]) perSubject[d.subject] = { sec: 0, qTotal: 0, qCorrect: 0, sessions: 0 }; perSubject[d.subject].sec += d.duration; perSubject[d.subject].qTotal += d.totalQuestions || 0; perSubject[d.subject].qCorrect += d.correctQuestions || 0; perSubject[d.subject].sessions++; }); const subjectRows = Object.entries(perSubject).map(([sub, stats]) => { const acc = stats.qTotal > 0 ? (stats.qCorrect / stats.qTotal * 100).toFixed(0) + '%' : 'N/A'; return [sub, this.formatTime(stats.sec), stats.sessions, stats.qTotal, acc]; }).filter(row => row[2] > 0);
doc.autoTable({ ...tableOptions, startY: y, head: [['Disciplina', 'Tempo total', 'Nº de sessões', 'Nº de questões', '% Acertos']], body: subjectRows.length ? subjectRows : [['Nenhum dado no período', '', '', '', '']], }); y = doc.lastAutoTable.finalY + 25; if (y > doc.internal.pageSize.getHeight() - 100) { doc.addPage(); y = margin; }
addTitle('Evolução diária'); const byDate = {}; data.forEach(d => { if (!byDate[d.date]) byDate[d.date] = { sec: 0, qTotal: 0, qCorrect: 0 }; byDate[d.date].sec += d.duration; byDate[d.date].qTotal += d.totalQuestions || 0; byDate[d.date].qCorrect += d.correctQuestions || 0; }); const evolutionRows = Object.keys(byDate).sort().map(date => { const stats = byDate[date]; const acc = stats.qTotal > 0 ? (stats.qCorrect / stats.qTotal * 100).toFixed(0) + '%' : 'N/A'; const fDate = new Date(date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }); return [fDate, this.formatTime(stats.sec), stats.qTotal, acc]; }); doc.autoTable({ ...tableOptions, startY: y, head: [['Data', 'Tempo de estudo', 'Nº de questões', '% Acertos']], body: evolutionRows.length ? evolutionRows : [['Nenhum dado no período', '', '', '']], }); doc.save(`relatorio_estudos_${new Date().toISOString().split('T')[0]}.pdf`); } };

function onYouTubeIframeAPIReady() {
    App.initYouTubePlayer();
}

window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
if (window.YT && typeof YT.Player === 'function') {
    App.initYouTubePlayer();
}

window.addEventListener('DOMContentLoaded', ()=> App.init()); </script></body></html>
